<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toji's Bodyweight Training Plan</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèãÔ∏è</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js and Pose Detection for AI Form Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.15.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.15.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.15.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Theme tokens for Neon Gym */
      :root {
        --bg: #0f1724; /* deep charcoal */
        --primary-red: #ef4444; /* kept for legacy rules but primary accent is cyan */
        --accent-cyan: #00f5ff;
        --muted-white: #f8fafc;
        --panel-bg: rgba(17, 24, 39, 0.55);
      }

      /* legacy red-focused utilities are used throughout the markup; keep default behavior */

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg);
        color: var(--muted-white);
      }
      .font-bebas {
        font-family: "Bebas Neue", sans-serif;
      }
      .modal-content::-webkit-scrollbar,
      .timer-modal-content::-webkit-scrollbar {
        width: 8px;
      }
      .modal-content::-webkit-scrollbar-track,
      .timer-modal-content::-webkit-scrollbar-track {
        background: #2d3748;
      }
      .modal-content::-webkit-scrollbar-thumb,
      .timer-modal-content::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }
      .modal-content::-webkit-scrollbar-thumb:hover,
      .timer-modal-content::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
      .day-card.completed {
        background-color: rgba(16, 24, 32, 0.7);
        border-color: #10b981;
        box-shadow: 0 8px 32px rgba(0, 245, 255, 0.06);
      }
      .difficulty-btn:disabled,
      .set-btn:disabled,
      #complete-workout-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      /* Primary CTA (complete workout, save buttons) */
      .btn-primary {
        background: linear-gradient(180deg, var(--primary-red), #d33b2a);
        color: white;
        font-weight: 700;
        padding: 0.6rem 1rem;
        border-radius: 0.375rem;
        box-shadow: 0 8px 28px rgba(14, 165, 233, 0.06);
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--muted-white);
        padding: 0.5rem 0.9rem;
        border-radius: 0.375rem;
      }
      .toast {
        animation: fadeInOut 3s forwards;
        border-left: 6px solid var(--primary-red);
        padding-left: 1rem;
        background: rgba(255, 255, 255, 0.03);
      }
      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
          transform: translateY(20px);
        }
        10%,
        90% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Neon Gym tab styling */
      .tab-btn {
        padding: 0.45rem 1rem;
        border-radius: 0.5rem;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.06em;
        color: var(--muted-white);
        background: rgba(255, 255, 255, 0.02);
        border: none;
        transition: box-shadow 180ms ease, transform 120ms ease;
      }
      .tab-btn:focus {
        outline: none;
        box-shadow: 0 0 20px rgba(0, 245, 255, 0.14);
      }
      .tab-btn.active {
        border-bottom: 4px solid var(--primary-red);
        color: white;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(0, 0, 0, 0)
        );
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      #body-scan-svg-male .body-part,
      #body-scan-svg-female .body-part {
        transition: transform 0.3s ease-in-out;
      }
      .body-type-btn.active {
        background-color: #ef4444;
        color: white;
      }
      .rating-btn.selected {
        background: linear-gradient(180deg, var(--primary-red), #d33b2a);
        color: white;
        border-color: var(--primary-red);
      }
      .assessment-radio:checked + label {
        background: linear-gradient(180deg, var(--primary-red), #d33b2a);
        color: white;
        border-color: var(--primary-red);
      }
      /* Focus outline for keyboard users (red accent) */
      :focus {
        outline: 3px solid rgba(239, 68, 68, 0.95);
        outline-offset: 2px;
      }
      /* Prefer focus-visible where supported */
      :focus:not(:focus-visible) {
        outline: none;
      }

      /* Glass panel day card for Neon Gym */
      .day-card {
        position: relative;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(6px);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 1rem;
        overflow: hidden;
      }
      .day-card::before {
        content: "";
        display: block;
        position: absolute;
        left: 0.75rem;
        top: 1rem;
        bottom: 1rem;
        width: 6px;
        background: linear-gradient(180deg, var(--primary-red), #d33b2a);
        border-radius: 3px;
      }
      
      /* Muscle Group Visualization Styles */
      .muscle-highlight {
        fill: #ef4444 !important;
        opacity: 0.9 !important;
        animation: muscle-pulse 2s ease-in-out infinite;
      }
      
      .muscle-highlight-secondary {
        fill: #f97316 !important;
        opacity: 0.7 !important;
        animation: muscle-pulse 2s ease-in-out infinite;
      }
      
      @keyframes muscle-pulse {
        0%, 100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }
      
      .muscle-view.hidden {
        display: none;
      }
      
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .animate-fade-in {
        animation: fade-in 0.3s ease-out;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100">
    <!-- Loading State -->
    <div
      id="loading-state"
      class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50"
    >
      <svg
        class="animate-spin h-12 w-12 text-red-500"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <p class="mt-4 text-lg text-gray-400">Initializing...</p>
    </div>

    <!-- Auth State -->
    <div
      id="auth-container"
      class="hidden min-h-screen flex items-center justify-center p-4"
    >
      <div
        class="max-w-md w-full bg-[rgba(255,255,255,0.03)] p-6 sm:p-8 rounded-lg shadow-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
      >
        <h2
          class="font-bebas text-4xl text-center text-red-500 tracking-wider mb-2"
        >
          Join the Regimen
        </h2>
        <p class="text-center text-gray-400 mb-6">
          Sign in or create an account to track your progress.
        </p>
        <div class="space-y-4">
          <input
            type="email"
            id="email-input"
            placeholder="Email"
            aria-label="Email address"
            aria-describedby="auth-error"
            class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-red-500 focus:border-red-500"
          />
          <input
            type="password"
            id="password-input"
            placeholder="Password"
            aria-label="Password"
            aria-describedby="auth-error"
            class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-red-500 focus:border-red-500"
          />
        </div>
        <p id="auth-error" class="text-red-400 text-sm mt-3 h-4"></p>
        <div class="mt-4 flex flex-col sm:flex-row gap-4">
          <button
            id="login-btn"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition"
          >
            Login
          </button>
          <button
            id="signup-btn"
            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition"
          >
            Sign Up
          </button>
        </div>
      </div>
    </div>

    <!-- Main App Container -->
    <div
      id="app-container"
      class="container mx-auto px-4 py-6 sm:py-8 md:py-12 hidden"
    >
      <!-- Header Section -->
      <header class="text-center mb-6">
        <h1
          class="font-bebas text-4xl sm:text-5xl md:text-7xl tracking-wider text-red-500"
        >
          TOJI'S TRAINING REGIMEN
        </h1>
        <p
          class="mt-2 text-base sm:text-lg md:text-xl text-gray-400 max-w-2xl mx-auto"
        >
          Bodyweight edition: Forge overwhelming physical power.
        </p>
      </header>

      <!-- Tab Navigation -->
      <div
        class="mb-8 flex flex-wrap justify-center gap-3 items-center border-b border-gray-700 py-3"
      >
        <button
          class="tab-btn active text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="home"
        >
          üè† Home
        </button>
        <button
          class="tab-btn text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="workout"
        >
          üí™ Workout
        </button>
        <button
          class="tab-btn text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="analytics"
        >
          üìä Analytics
        </button>
        <button
          class="tab-btn text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="nutrition"
        >
          üçé Nutrition
        </button>
        <button
          class="tab-btn text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="resources"
        >
          üìö Resources
        </button>
        <button
          class="tab-btn text-lg font-bebas tracking-wider py-2 px-4 sm:px-6 border-b-2 border-transparent text-gray-400 hover:text-white transition"
          data-tab="settings"
        >
          ‚öôÔ∏è Settings
        </button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content-container">
        <!-- Home Tab (Check-in + Dashboard) -->
        <div id="home-content" class="tab-content active">
          <!-- Check-in Section -->
          <h2
            id="checkin-title"
            class="font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center"
          >
            Pre-Workout Check-in
          </h2>
          <div
            class="max-w-xl mx-auto bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
          >
            <form id="assessment-form" class="space-y-6">
              <div>
                <label
                  for="workout-day-select"
                  class="font-semibold text-gray-300"
                  >Select Workout Day</label
                >
                <select
                  id="workout-day-select"
                  class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-red-500 focus:border-red-500"
                >
                  <!-- Options will be populated by JS -->
                </select>
              </div>
              <!-- Removed stray inline JS text that was previously visible here -->
              <div>
                <label class="font-semibold text-gray-300">Energy Level</label>
                <div class="flex justify-between mt-2">
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="energy-1"
                      name="energy"
                      value="1"
                      class="hidden assessment-radio"
                    /><label
                      for="energy-1"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >Low</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="energy-3"
                      name="energy"
                      value="3"
                      class="hidden assessment-radio"
                      checked
                    /><label
                      for="energy-3"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >Medium</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="energy-5"
                      name="energy"
                      value="5"
                      class="hidden assessment-radio"
                    /><label
                      for="energy-5"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >High</label
                    >
                  </div>
                </div>
              </div>
              <div>
                <label class="font-semibold text-gray-300"
                  >Hours of Sleep Last Night</label
                >
                <div class="flex justify-between mt-2">
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="sleep-1"
                      name="sleep"
                      value="<6"
                      class="hidden assessment-radio"
                    /><label
                      for="sleep-1"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >&lt;6</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="sleep-2"
                      name="sleep"
                      value="6-7"
                      class="hidden assessment-radio"
                    /><label
                      for="sleep-2"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >6-7</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="sleep-3"
                      name="sleep"
                      value="7-8"
                      class="hidden assessment-radio"
                      checked
                    /><label
                      for="sleep-3"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >7-8</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="sleep-4"
                      name="sleep"
                      value="8+"
                      class="hidden assessment-radio"
                    /><label
                      for="sleep-4"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >8+</label
                    >
                  </div>
                </div>
              </div>
              <div>
                <label class="font-semibold text-gray-300">Overall Mood</label>
                <div class="flex justify-between mt-2">
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="mood-1"
                      name="mood"
                      value="bad"
                      class="hidden assessment-radio"
                    /><label
                      for="mood-1"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition text-2xl"
                      >üòû</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="mood-2"
                      name="mood"
                      value="ok"
                      class="hidden assessment-radio"
                      checked
                    /><label
                      for="mood-2"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition text-2xl"
                      >üòê</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="mood-3"
                      name="mood"
                      value="good"
                      class="hidden assessment-radio"
                    /><label
                      for="mood-3"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition text-2xl"
                      >üôÇ</label
                    >
                  </div>
                </div>
              </div>
              <div>
                <label class="font-semibold text-gray-300"
                  >Soreness Level</label
                >
                <div class="flex justify-between mt-2">
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="soreness-0"
                      name="soreness"
                      value="0"
                      class="hidden assessment-radio"
                      checked
                    /><label
                      for="soreness-0"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >None</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="soreness-1"
                      name="soreness"
                      value="1"
                      class="hidden assessment-radio"
                    /><label
                      for="soreness-1"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >Low</label
                    >
                  </div>
                  <div class="flex-1 text-center">
                    <input
                      type="radio"
                      id="soreness-2"
                      name="soreness"
                      value="2"
                      class="hidden assessment-radio"
                    /><label
                      for="soreness-2"
                      class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition"
                      >High</label
                    >
                  </div>
                </div>
              </div>
              <div id="sore-muscles-group" class="hidden">
                <label class="font-semibold text-gray-300"
                  >Which muscles are sore?</label
                >
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="chest"
                      id="sore-chest"
                      class="mr-2"
                    /><label for="sore-chest">Chest</label>
                  </div>
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="back"
                      id="sore-back"
                      class="mr-2"
                    /><label for="sore-back">Back</label>
                  </div>
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="shoulders"
                      id="sore-shoulders"
                      class="mr-2"
                    /><label for="sore-shoulders">Shoulders</label>
                  </div>
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="arms"
                      id="sore-arms"
                      class="mr-2"
                    /><label for="sore-arms">Arms</label>
                  </div>
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="core"
                      id="sore-core"
                      class="mr-2"
                    /><label for="sore-core">Core</label>
                  </div>
                  <div>
                    <input
                      type="checkbox"
                      name="sore-muscle"
                      value="legs"
                      id="sore-legs"
                      class="mr-2"
                    /><label for="sore-legs">Legs</label>
                  </div>
                </div>
              </div>
              
              <!-- Flexibility & Posture Assessment -->
              <div class="pt-4 border-t border-gray-700">
                <h3 class="font-semibold text-gray-300 mb-4">Flexibility & Posture Assessment</h3>
                
                <!-- Desk Work Hours -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">Hours spent at desk/computer daily</label>
                  <div class="flex justify-between mt-2">
                    <div class="flex-1 text-center">
                      <input type="radio" id="desk-0" name="desk-hours" value="0-2" class="hidden assessment-radio" />
                      <label for="desk-0" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">0-2h</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="desk-1" name="desk-hours" value="3-5" class="hidden assessment-radio" />
                      <label for="desk-1" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">3-5h</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="desk-2" name="desk-hours" value="6-8" class="hidden assessment-radio" checked />
                      <label for="desk-2" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">6-8h</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="desk-3" name="desk-hours" value="8+" class="hidden assessment-radio" />
                      <label for="desk-3" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">8+h</label>
                    </div>
                  </div>
                </div>

                <!-- Forward Head Posture -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">Do you experience forward head posture or "tech neck"?</label>
                  <div class="flex justify-between mt-2">
                    <div class="flex-1 text-center">
                      <input type="radio" id="tech-neck-0" name="tech-neck" value="never" class="hidden assessment-radio" />
                      <label for="tech-neck-0" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Never</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="tech-neck-1" name="tech-neck" value="sometimes" class="hidden assessment-radio" checked />
                      <label for="tech-neck-1" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Sometimes</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="tech-neck-2" name="tech-neck" value="often" class="hidden assessment-radio" />
                      <label for="tech-neck-2" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Often</label>
                    </div>
                  </div>
                </div>

                <!-- Shoulder Tension -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">Upper back/shoulder tension level</label>
                  <div class="flex justify-between mt-2">
                    <div class="flex-1 text-center">
                      <input type="radio" id="shoulder-tension-0" name="shoulder-tension" value="low" class="hidden assessment-radio" />
                      <label for="shoulder-tension-0" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Low</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="shoulder-tension-1" name="shoulder-tension" value="moderate" class="hidden assessment-radio" checked />
                      <label for="shoulder-tension-1" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Moderate</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="shoulder-tension-2" name="shoulder-tension" value="high" class="hidden assessment-radio" />
                      <label for="shoulder-tension-2" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">High</label>
                    </div>
                  </div>
                </div>

                <!-- Hip Flexibility -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">Can you sit in a deep squat comfortably for 30 seconds?</label>
                  <div class="flex justify-between mt-2">
                    <div class="flex-1 text-center">
                      <input type="radio" id="deep-squat-0" name="deep-squat" value="yes" class="hidden assessment-radio" />
                      <label for="deep-squat-0" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Yes, easily</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="deep-squat-1" name="deep-squat" value="somewhat" class="hidden assessment-radio" checked />
                      <label for="deep-squat-1" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">Somewhat</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="deep-squat-2" name="deep-squat" value="no" class="hidden assessment-radio" />
                      <label for="deep-squat-2" class="cursor-pointer border-2 border-gray-600 rounded-lg px-4 py-2 transition">No, difficult</label>
                    </div>
                  </div>
                </div>

                <!-- Flexibility Problem Areas -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">Which areas feel tight or restricted? (Check all that apply)</label>
                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">
                    <div>
                      <input type="checkbox" name="tight-area" value="neck" id="tight-neck" class="mr-2" />
                      <label for="tight-neck">Neck</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="shoulders" id="tight-shoulders" class="mr-2" />
                      <label for="tight-shoulders">Shoulders</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="chest" id="tight-chest" class="mr-2" />
                      <label for="tight-chest">Chest</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="upper-back" id="tight-upper-back" class="mr-2" />
                      <label for="tight-upper-back">Upper Back</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="lower-back" id="tight-lower-back" class="mr-2" />
                      <label for="tight-lower-back">Lower Back</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="hip-flexors" id="tight-hip-flexors" class="mr-2" />
                      <label for="tight-hip-flexors">Hip Flexors</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="hamstrings" id="tight-hamstrings" class="mr-2" />
                      <label for="tight-hamstrings">Hamstrings</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="calves" id="tight-calves" class="mr-2" />
                      <label for="tight-calves">Calves</label>
                    </div>
                    <div>
                      <input type="checkbox" name="tight-area" value="ankles" id="tight-ankles" class="mr-2" />
                      <label for="tight-ankles">Ankles</label>
                    </div>
                  </div>
                </div>

                <!-- Stretching Frequency -->
                <div class="mb-4">
                  <label class="font-semibold text-gray-300">How often do you currently stretch or do mobility work?</label>
                  <div class="flex justify-between mt-2">
                    <div class="flex-1 text-center">
                      <input type="radio" id="stretch-freq-0" name="stretch-frequency" value="never" class="hidden assessment-radio" />
                      <label for="stretch-freq-0" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">Never</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="stretch-freq-1" name="stretch-frequency" value="rarely" class="hidden assessment-radio" checked />
                      <label for="stretch-freq-1" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">Rarely</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="stretch-freq-2" name="stretch-frequency" value="weekly" class="hidden assessment-radio" />
                      <label for="stretch-freq-2" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">Weekly</label>
                    </div>
                    <div class="flex-1 text-center">
                      <input type="radio" id="stretch-freq-3" name="stretch-frequency" value="daily" class="hidden assessment-radio" />
                      <label for="stretch-freq-3" class="cursor-pointer border-2 border-gray-600 rounded-lg px-3 py-2 transition text-sm">Daily</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="pt-4 border-t border-gray-700">
                <button type="submit" class="w-full btn-primary">
                  Analyze & Start Workout
                </button>
              </div>
            </form>
          </div>

          <!-- Dashboard Section -->
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-4 mt-12 text-center"
          >
            Dashboard
          </h2>
          <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <!-- Weekly Progress -->
            <div
              class="bg-[rgba(255,255,255,0.03)] p-4 sm:p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <h2 class="font-bebas text-3xl text-red-500 tracking-wide mb-4">
                Weekly Progress
              </h2>
              <p class="text-gray-400 mb-2">
                Workouts Completed This Week:
                <span id="workouts-completed" class="font-bold text-white"
                  >0</span
                >/5
              </p>
              <div class="w-full bg-gray-700 rounded-full h-4">
                <div
                  id="progress-bar"
                  class="bg-red-600 h-4 rounded-full transition-all duration-500"
                ></div>
              </div>
            </div>

            <!-- User Level & XP -->
            <div
              class="bg-[rgba(255,255,255,0.03)] p-4 sm:p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <h2 class="font-bebas text-3xl text-blue-500 tracking-wide mb-4">
                Fitness Level
              </h2>
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400">Level</span>
                <span id="user-level" class="font-bold text-white text-xl">1</span>
              </div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400">XP</span>
                <span id="user-xp" class="font-bold text-blue-400">0</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-3">
                <div
                  id="xp-progress-bar"
                  class="bg-blue-500 h-3 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
              <p class="text-xs text-gray-500 mt-1" id="xp-next-level">Next level at 100 XP</p>
            </div>
          </section>

          <!-- Enhanced Features Section -->
          <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
            <!-- Achievement Gallery -->
            <div
              class="bg-[rgba(255,255,255,0.03)] p-4 sm:p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <h2 class="font-bebas text-3xl text-yellow-500 tracking-wide mb-4">
                üèÜ Achievements
              </h2>
              <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                <!-- Achievements will be populated here -->
              </div>
              <div class="mt-4">
                <button id="view-all-achievements-btn"
                  class="text-yellow-400 hover:text-yellow-300 text-sm underline">
                  View All Achievements
                </button>
              </div>
            </div>

            <!-- Current Goals -->
            <div
              class="bg-[rgba(255,255,255,0.03)] p-4 sm:p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <h2 class="font-bebas text-3xl text-green-500 tracking-wide mb-4">
                üéØ Current Goals
              </h2>
              <div id="goals-container">
                <!-- Goals will be populated here -->
              </div>
              <button id="set-new-goal-btn"
                class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                Set New Goal
              </button>
            </div>
          </section>

          <!-- EXTREME MODE: Workout Streak & PR Tracking -->
          <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Workout Streak Tracker -->
            <div class="bg-gradient-to-br from-orange-900/30 to-red-700/20 p-4 sm:p-6 rounded-lg border border-orange-500/30 backdrop-blur">
              <h2 class="font-bebas text-2xl text-orange-400 tracking-wide mb-3">
                üî• Workout Streak
              </h2>
              <div class="text-center">
                <div id="streak-count" class="text-6xl font-bold text-orange-500 mb-2">0</div>
                <p class="text-gray-400 text-sm mb-3">Days in a row</p>
                <div id="streak-flames" class="text-3xl">
                  <!-- Fire emojis will be added dynamically -->
                </div>
                <p id="streak-message" class="text-xs text-orange-300 mt-2">Start your streak today!</p>
              </div>
            </div>

            <!-- Personal Records (PRs) -->
            <div class="bg-gradient-to-br from-yellow-900/30 to-amber-700/20 p-4 sm:p-6 rounded-lg border border-yellow-500/30 backdrop-blur">
              <h2 class="font-bebas text-2xl text-yellow-400 tracking-wide mb-3">
                üèÖ Personal Records
              </h2>
              <div id="pr-container" class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Total PRs Set:</span>
                  <span id="total-prs" class="text-yellow-400 font-bold">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">This Week:</span>
                  <span id="prs-this-week" class="text-green-400 font-bold">0</span>
                </div>
                <button onclick="showPRHistory()" class="w-full mt-3 bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-3 rounded text-xs transition">
                  View All PRs
                </button>
              </div>
            </div>

            <!-- Fatigue & Recovery Score -->
            <div class="bg-gradient-to-br from-indigo-900/30 to-purple-700/20 p-4 sm:p-6 rounded-lg border border-indigo-500/30 backdrop-blur">
              <h2 class="font-bebas text-2xl text-indigo-400 tracking-wide mb-3">
                ‚ö° Fatigue Score
              </h2>
              <div class="text-center">
                <div id="fatigue-score" class="text-6xl font-bold mb-2">
                  <span id="fatigue-value" class="text-green-400">0</span>
                  <span class="text-gray-500 text-3xl">/100</span>
                </div>
                <p id="fatigue-status" class="text-sm text-green-400 mb-2">Fresh & Ready!</p>
                <div class="w-full bg-gray-700 rounded-full h-2">
                  <div id="fatigue-bar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="fatigue-recommendation" class="text-xs text-gray-400 mt-2">Keep pushing hard!</p>
              </div>
            </div>
          </section>

          <!-- Quick Actions & Features -->
          <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Weekly Challenge -->
            <div
              class="bg-gradient-to-br from-purple-900/30 to-purple-700/20 p-4 sm:p-6 rounded-lg border border-purple-500/30 backdrop-blur"
            >
              <h2 class="font-bebas text-2xl text-purple-400 tracking-wide mb-3">
                ‚ö° Weekly Challenge
              </h2>
              <div id="weekly-challenge">
                <!-- Challenge will be populated here -->
              </div>
            </div>

            <!-- Advanced Analytics Button -->
            <div
              class="bg-gradient-to-br from-blue-900/30 to-blue-700/20 p-4 sm:p-6 rounded-lg border border-blue-500/30 backdrop-blur flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 transition"
              onclick="showAdvancedAnalytics()"
            >
              <div class="text-5xl mb-2">üìà</div>
              <h3 class="font-bebas text-xl text-blue-400 tracking-wide">Advanced Analytics</h3>
              <p class="text-sm text-gray-400 text-center mt-2">View detailed performance insights</p>
            </div>

            <!-- Personalized Workout -->
            <div
              class="bg-gradient-to-br from-green-900/30 to-green-700/20 p-4 sm:p-6 rounded-lg border border-green-500/30 backdrop-blur flex flex-col items-center justify-center cursor-pointer hover:border-green-400 transition"
              onclick="generateAndShowPersonalizedWorkout()"
            >
              <div class="text-5xl mb-2">ü§ñ</div>
              <h3 class="font-bebas text-xl text-green-400 tracking-wide">AI Workout</h3>
              <p class="text-sm text-gray-400 text-center mt-2">Generate personalized routine</p>
            </div>
          </section>

          <!-- EXTREME MODE: Intensity Tracking -->
          <section class="grid grid-cols-1 gap-6 mb-10">
            <!-- Workout Intensity Meter -->
            <div class="bg-gradient-to-br from-red-900/30 to-pink-700/20 p-4 sm:p-6 rounded-lg border border-red-500/30 backdrop-blur max-w-2xl mx-auto w-full">
              <h2 class="font-bebas text-2xl text-red-400 tracking-wide mb-4">
                üí• Today's Intensity
              </h2>
              <div class="relative">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                  <span>Easy</span>
                  <span>Moderate</span>
                  <span>Beast Mode</span>
                </div>
                <div class="w-full h-8 bg-gradient-to-r from-green-500 via-yellow-500 to-red-600 rounded-full relative overflow-hidden">
                  <div id="intensity-marker" class="absolute top-0 bottom-0 w-1 bg-white shadow-lg transition-all duration-500" style="left: 0%">
                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-white font-bold text-xl">‚ñº</div>
                  </div>
                </div>
                <div class="mt-4 text-center">
                  <div id="intensity-value" class="text-4xl font-bold text-red-400">0</div>
                  <p class="text-sm text-gray-400">Intensity Score</p>
                </div>
              </div>
            </div>
          </section>

          <!-- AI & Wearable Integration Section -->
          <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <!-- AI Form Check -->
            <div class="bg-gradient-to-br from-teal-900/30 to-cyan-700/20 p-4 sm:p-6 rounded-lg border border-teal-500/30 backdrop-blur">
              <h2 class="font-bebas text-2xl text-teal-400 tracking-wide mb-4">
                üìπ AI Form Check
              </h2>
              <div class="space-y-3">
                <p class="text-sm text-gray-400">Use your camera to get real-time form feedback</p>
                <div id="form-check-status" class="text-center py-3">
                  <div class="text-4xl mb-2">üé•</div>
                  <p class="text-xs text-gray-500">Camera not active</p>
                </div>
                <button onclick="startFormCheck()" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 px-3 rounded text-sm transition">
                  Start Form Analysis
                </button>
                <div id="form-feedback" class="hidden mt-3 p-3 bg-gray-800/50 rounded border border-teal-500/20">
                  <p class="text-xs text-teal-400 font-semibold mb-1">Last Analysis:</p>
                  <p id="form-feedback-text" class="text-xs text-gray-300">No feedback yet</p>
                </div>
              </div>
            </div>

            <!-- Wearable Device Integration -->
            <div class="bg-gradient-to-br from-pink-900/30 to-rose-700/20 p-4 sm:p-6 rounded-lg border border-pink-500/30 backdrop-blur">
              <h2 class="font-bebas text-2xl text-pink-400 tracking-wide mb-4">
                ‚åö Health Tracker
              </h2>
              <div class="space-y-3">
                <div id="wearable-status" class="flex items-center justify-between p-2 bg-gray-800/50 rounded">
                  <div class="flex items-center gap-2">
                    <div id="wearable-indicator" class="w-3 h-3 rounded-full bg-gray-600"></div>
                    <span id="wearable-device-name" class="text-sm text-gray-400">No device connected</span>
                  </div>
                  <button onclick="connectWearable()" class="text-xs bg-pink-600 hover:bg-pink-700 text-white py-1 px-3 rounded transition">
                    Connect
                  </button>
                </div>
                <div id="wearable-data" class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Heart Rate:</span>
                    <span id="wearable-hr" class="text-pink-400 font-bold">--</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Steps Today:</span>
                    <span id="wearable-steps" class="text-pink-400 font-bold">--</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Calories Burned:</span>
                    <span id="wearable-calories" class="text-pink-400 font-bold">--</span>
                  </div>
                </div>
                <button onclick="syncWearableData()" class="w-full bg-pink-600 hover:bg-pink-700 text-white py-2 px-3 rounded text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" id="sync-wearable-btn" disabled>
                  Sync Data
                </button>
              </div>
            </div>
          </section>
        </div>
        <!-- Workout Tab -->
        <div id="workout-content" class="tab-content">
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center"
          >
            Weekly Schedule
          </h2>
          <main
            id="schedule-grid"
            class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"
          >
            <!-- Day cards will be injected here by JavaScript -->
          </main>
        </div>

        <!-- Analytics Tab (History + Progress) -->
        <div id="analytics-content" class="tab-content">
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center"
          >
            üìä Analytics & Performance
          </h2>
          
          <!-- Advanced Analytics Quick Access -->
          <div class="mb-8">
            <button
              onclick="showAdvancedAnalytics()"
              class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-lg transition flex items-center justify-center gap-2"
            >
              <span class="text-2xl">üìà</span>
              <span>View Advanced Analytics Dashboard</span>
            </button>
          </div>

          <!-- Workout History Section -->
          <div class="mb-10">
            <h3 class="font-bebas text-3xl text-red-500 tracking-wide mb-4">
              Workout History
            </h3>
            <div id="history-container" class="space-y-4">
              <!-- History will be populated by JS -->
            </div>
          </div>

          <!-- Progress Tracking Section -->
          <h3 class="font-bebas text-3xl text-red-500 tracking-wide mb-6">
            Progress Tracking
          </h3>
          <div class="max-w-4xl mx-auto">
            <div
              class="bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <!-- Body Stats & Measurements -->
              <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                  <h4
                    class="font-bebas text-2xl text-blue-500 tracking-wide"
                  >
                    Body Measurements
                  </h4>
                  <button
                    id="toggle-measurements-btn"
                    class="text-blue-400 hover:text-blue-300 text-sm underline"
                  >
                    Show/Hide
                  </button>
                </div>
                <div id="measurements-section" class="hidden">
                  <p class="text-sm text-gray-400 mb-4">
                    Track your body measurements over time. Updates saved
                    automatically.
                  </p>
                  <div
                    class="grid grid-cols-2 sm:grid-cols-3 gap-4"
                    id="measurements-inputs-analytics"
                  >
                    <!-- Measurement inputs will be injected here -->
                  </div>
                </div>
              </div>
              <button
                id="save-measurements-btn"
                class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md transition"
              >
                Save All Progress Data
              </button>
            </div>
          </div>
        </div>

        <!-- Nutrition Tab -->
        <div id="nutrition-content" class="tab-content">
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center"
          >
            üçé Nutrition Tracking
          </h2>

          <!-- Today's Summary -->
          <div class="max-w-6xl mx-auto mb-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gradient-to-br from-green-900/30 to-green-700/20 p-4 rounded-lg border border-green-500/30">
                <div class="text-sm text-gray-400">Calories Today</div>
                <div class="text-3xl font-bold text-green-400" id="calories-today">0</div>
                <div class="text-xs text-gray-500">Goal: <span id="calorie-goal">2500</span></div>
              </div>
              <div class="bg-gradient-to-br from-blue-900/30 to-blue-700/20 p-4 rounded-lg border border-blue-500/30">
                <div class="text-sm text-gray-400">Protein</div>
                <div class="text-3xl font-bold text-blue-400"><span id="protein-today">0</span>g</div>
                <div class="text-xs text-gray-500">Goal: <span id="protein-goal">150</span>g</div>
              </div>
              <div class="bg-gradient-to-br from-yellow-900/30 to-yellow-700/20 p-4 rounded-lg border border-yellow-500/30">
                <div class="text-sm text-gray-400">Carbs</div>
                <div class="text-3xl font-bold text-yellow-400"><span id="carbs-today">0</span>g</div>
                <div class="text-xs text-gray-500">Goal: <span id="carbs-goal">300</span>g</div>
              </div>
              <div class="bg-gradient-to-br from-orange-900/30 to-orange-700/20 p-4 rounded-lg border border-orange-500/30">
                <div class="text-sm text-gray-400">Fats</div>
                <div class="text-3xl font-bold text-orange-400"><span id="fats-today">0</span>g</div>
                <div class="text-xs text-gray-500">Goal: <span id="fats-goal">70</span>g</div>
              </div>
            </div>
          </div>

          <!-- Add Meal Section -->
          <div class="max-w-2xl mx-auto mb-10">
            <div class="bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur">
              <h3 class="font-bebas text-2xl text-red-500 tracking-wide mb-4">Log a Meal</h3>
              <form id="meal-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-300">Meal Name</label>
                    <input
                      type="text"
                      id="meal-name"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                      placeholder="e.g., Chicken Breast"
                      required
                    />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-300">Meal Type</label>
                    <select
                      id="meal-type"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                    >
                      <option value="breakfast">Breakfast</option>
                      <option value="lunch">Lunch</option>
                      <option value="dinner">Dinner</option>
                      <option value="snack">Snack</option>
                    </select>
                  </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-300">Calories</label>
                    <input
                      type="number"
                      id="meal-calories"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                      placeholder="250"
                      required
                    />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-300">Protein (g)</label>
                    <input
                      type="number"
                      id="meal-protein"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                      placeholder="30"
                      required
                    />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-300">Carbs (g)</label>
                    <input
                      type="number"
                      id="meal-carbs"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                      placeholder="10"
                      required
                    />
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-300">Fats (g)</label>
                    <input
                      type="number"
                      id="meal-fats"
                      class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"
                      placeholder="5"
                      required
                    />
                  </div>
                </div>
                <button
                  type="submit"
                  class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition"
                >
                  + Add Meal
                </button>
              </form>
            </div>
          </div>

          <!-- Today's Meals -->
          <div class="max-w-4xl mx-auto mb-10">
            <h3 class="font-bebas text-3xl text-red-500 tracking-wide mb-4">Today's Meals</h3>
            <div id="meals-today-container" class="space-y-3">
              <p class="text-gray-400 text-center py-8">No meals logged yet today. Start by adding your first meal above!</p>
            </div>
          </div>

          <!-- Weekly Nutrition Overview -->
          <div class="max-w-6xl mx-auto">
            <h3 class="font-bebas text-3xl text-red-500 tracking-wide mb-4">Weekly Overview</h3>
            <div class="bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <h4 class="font-semibold text-gray-300 mb-3">Average Daily Macros</h4>
                  <div class="space-y-2">
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-400">Protein</span>
                        <span class="text-blue-400" id="avg-protein">0g</span>
                      </div>
                      <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="avg-protein-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                      </div>
                    </div>
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-400">Carbs</span>
                        <span class="text-yellow-400" id="avg-carbs">0g</span>
                      </div>
                      <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="avg-carbs-bar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                      </div>
                    </div>
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-400">Fats</span>
                        <span class="text-orange-400" id="avg-fats">0g</span>
                      </div>
                      <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="avg-fats-bar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-300 mb-3">Nutrition Stats</h4>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-400">Avg Daily Calories</span>
                      <span class="text-white font-semibold" id="avg-calories">0</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-400">Days Tracked This Week</span>
                      <span class="text-white font-semibold" id="days-tracked">0</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-400">Total Meals Logged</span>
                      <span class="text-white font-semibold" id="total-meals-week">0</span>
                    </div>
                  </div>
                </div>
              </div>
              <button
                onclick="viewNutritionHistory()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition"
              >
                üìä View Full Nutrition History
              </button>
            </div>
          </div>
        </div>

        <!-- Resources Tab (Library + Body Scan) -->
        <div id="resources-content" class="tab-content">
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center"
          >
            üìö Resources & Tools
          </h2>

          <!-- Exercise Library Section -->
          <div class="mb-10">
            <h3 class="font-bebas text-3xl text-blue-500 tracking-wide mb-4">
              Exercise Library
            </h3>
            <div id="library-content-section">
              <!-- Content will be populated by JS -->
            </div>
          </div>

          <!-- Body Scan Section -->
          <h3 class="font-bebas text-3xl text-red-500 tracking-wide mb-6">
            Body Scan & Posture Analysis
          </h3>
          <div class="flex flex-col lg:flex-row gap-8 items-start">
            <!-- Left Panel: SVG -->
            <div
              class="w-full lg:w-1/3 bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] flex flex-col items-center justify-center sticky top-8 backdrop-blur"
            >
              <div class="w-full">
                <svg
                  id="body-scan-svg-male"
                  viewBox="0 0 200 400"
                  class="max-h-[500px] w-auto"
                >
                  <g
                    class="body-part"
                    id="svg-male-head"
                    data-origin-x="100"
                    data-origin-y="50"
                  >
                    <ellipse cx="100" cy="50" rx="25" ry="30" fill="#fca5a5" />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-neck"
                    data-origin-x="100"
                    data-origin-y="90"
                  >
                    <rect
                      x="90"
                      y="82.5"
                      width="20"
                      height="15"
                      fill="#dc2626"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-chest"
                    data-origin-x="100"
                    data-origin-y="125"
                  >
                    <rect
                      x="60"
                      y="95"
                      width="80"
                      height="60"
                      rx="5"
                      fill="#ef4444"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-waist"
                    data-origin-x="100"
                    data-origin-y="170"
                  >
                    <rect
                      x="70"
                      y="155"
                      width="60"
                      height="30"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-hips"
                    data-origin-x="100"
                    data-origin-y="197.5"
                  >
                    <rect
                      x="65"
                      y="185"
                      width="70"
                      height="25"
                      rx="5"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-left-bicep"
                    data-origin-x="45"
                    data-origin-y="122.5"
                  >
                    <rect
                      x="30"
                      y="95"
                      width="30"
                      height="55"
                      rx="15"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-right-bicep"
                    data-origin-x="155"
                    data-origin-y="122.5"
                  >
                    <rect
                      x="140"
                      y="95"
                      width="30"
                      height="55"
                      rx="15"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-left-forearm"
                    data-origin-x="45"
                    data-origin-y="177.5"
                  >
                    <rect
                      x="32.5"
                      y="150"
                      width="25"
                      height="55"
                      rx="12"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-right-forearm"
                    data-origin-x="155"
                    data-origin-y="177.5"
                  >
                    <rect
                      x="142.5"
                      y="150"
                      width="25"
                      height="55"
                      rx="12"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-left-thigh"
                    data-origin-x="77.5"
                    data-origin-y="250"
                  >
                    <rect
                      x="60"
                      y="210"
                      width="35"
                      height="80"
                      rx="17"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-right-thigh"
                    data-origin-x="122.5"
                    data-origin-y="250"
                  >
                    <rect
                      x="105"
                      y="210"
                      width="35"
                      height="80"
                      rx="17"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-left-calf"
                    data-origin-x="77.5"
                    data-origin-y="325"
                  >
                    <rect
                      x="65"
                      y="295"
                      width="25"
                      height="60"
                      rx="12"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-male-right-calf"
                    data-origin-x="122.5"
                    data-origin-y="325"
                  >
                    <rect
                      x="110"
                      y="295"
                      width="25"
                      height="60"
                      rx="12"
                      fill="#991b1b"
                    />
                  </g>
                </svg>
                <svg
                  id="body-scan-svg-female"
                  viewBox="0 0 200 400"
                  class="max-h-[500px] w-auto hidden"
                >
                  <g
                    class="body-part"
                    id="svg-female-head"
                    data-origin-x="100"
                    data-origin-y="50"
                  >
                    <ellipse cx="100" cy="50" rx="23" ry="28" fill="#fca5a5" />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-neck"
                    data-origin-x="100"
                    data-origin-y="88"
                  >
                    <rect x="92" y="81" width="16" height="14" fill="#dc2626" />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-chest"
                    data-origin-x="100"
                    data-origin-y="125"
                  >
                    <path
                      d="M 65 95 C 70 140, 130 140, 135 95 L 115 95 L 100 155 L 85 95 Z"
                      fill="#ef4444"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-waist"
                    data-origin-x="100"
                    data-origin-y="170"
                  >
                    <rect
                      x="75"
                      y="155"
                      width="50"
                      height="30"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-hips"
                    data-origin-x="100"
                    data-origin-y="197.5"
                  >
                    <rect
                      x="60"
                      y="185"
                      width="80"
                      height="25"
                      rx="12"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-left-bicep"
                    data-origin-x="48"
                    data-origin-y="122.5"
                  >
                    <rect
                      x="35"
                      y="95"
                      width="26"
                      height="55"
                      rx="13"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-right-bicep"
                    data-origin-x="152"
                    data-origin-y="122.5"
                  >
                    <rect
                      x="139"
                      y="95"
                      width="26"
                      height="55"
                      rx="13"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-left-forearm"
                    data-origin-x="48"
                    data-origin-y="177.5"
                  >
                    <rect
                      x="38"
                      y="150"
                      width="20"
                      height="55"
                      rx="10"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-right-forearm"
                    data-origin-x="152"
                    data-origin-y="177.5"
                  >
                    <rect
                      x="142"
                      y="150"
                      width="20"
                      height="55"
                      rx="10"
                      fill="#b91c1c"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-left-thigh"
                    data-origin-x="75"
                    data-origin-y="250"
                  >
                    <rect
                      x="58"
                      y="210"
                      width="34"
                      height="80"
                      rx="17"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-right-thigh"
                    data-origin-x="125"
                    data-origin-y="250"
                  >
                    <rect
                      x="108"
                      y="210"
                      width="34"
                      height="80"
                      rx="17"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-left-calf"
                    data-origin-x="75"
                    data-origin-y="325"
                  >
                    <rect
                      x="63"
                      y="295"
                      width="24"
                      height="60"
                      rx="12"
                      fill="#991b1b"
                    />
                  </g>
                  <g
                    class="body-part"
                    id="svg-female-right-calf"
                    data-origin-x="125"
                    data-origin-y="325"
                  >
                    <rect
                      x="113"
                      y="295"
                      width="24"
                      height="60"
                      rx="12"
                      fill="#991b1b"
                    />
                  </g>
                </svg>
              </div>
              <div class="mt-4 flex justify-center">
                <div
                  class="inline-flex rounded-md shadow-sm bg-gray-700 border border-gray-600"
                >
                  <button
                    id="figure-male-btn"
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 border-r border-gray-600 rounded-l-md focus:z-10 focus:ring-2 focus:ring-red-500 transition"
                  >
                    Male
                  </button>
                  <button
                    id="figure-female-btn"
                    class="px-4 py-2 text-sm font-medium text-gray-400 bg-transparent rounded-r-md hover:bg-gray-600 focus:z-10 focus:ring-2 focus:ring-red-500 transition"
                  >
                    Female
                  </button>
                </div>
              </div>
            </div>
            <!-- Right Panel: Inputs -->
            <div
              class="w-full lg:w-2/3 bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <div
                class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4"
              >
                <h3 class="font-bebas text-3xl text-red-500 tracking-wide">
                  Vitals & Measurements
                </h3>
                <div
                  class="inline-flex rounded-md shadow-sm bg-gray-700 border border-gray-600"
                >
                  <button
                    id="body-type-ectomorph"
                    data-type="ectomorph"
                    class="body-type-btn px-3 py-1 text-xs font-medium text-gray-300 bg-transparent rounded-l-md hover:bg-gray-600 focus:z-10 focus:ring-2 focus:ring-red-500 transition"
                  >
                    Ectomorph
                  </button>
                  <button
                    id="body-type-mesomorph"
                    data-type="mesomorph"
                    class="body-type-btn px-3 py-1 text-xs font-medium text-gray-300 bg-transparent border-r border-l border-gray-600 hover:bg-gray-600 focus:z-10 focus:ring-2 focus:ring-red-500 transition"
                  >
                    Mesomorph
                  </button>
                  <button
                    id="body-type-endomorph"
                    data-type="endomorph"
                    class="body-type-btn px-3 py-1 text-xs font-medium text-gray-300 bg-transparent rounded-r-md hover:bg-gray-600 focus:z-10 focus:ring-2 focus:ring-red-500 transition"
                  >
                    Endomorph
                  </button>
                </div>
              </div>
              <div class="space-y-4">
                <div>
                  <h4 class="font-semibold text-gray-300 mb-2">Vitals</h4>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label
                        for="measure-height"
                        class="text-sm font-medium text-gray-400"
                        >Height (in)</label
                      >
                      <input
                        type="number"
                        step="0.1"
                        id="measure-height"
                        data-part="height"
                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-red-500 focus:border-red-500"
                        placeholder="70"
                      />
                    </div>
                    <div>
                      <label
                        for="measure-weight"
                        class="text-sm font-medium text-gray-400"
                        >Weight (lbs)</label
                      >
                      <input
                        type="number"
                        step="0.1"
                        id="measure-weight"
                        data-part="weight"
                        class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-red-500 focus:border-red-500"
                        placeholder="180"
                      />
                    </div>
                  </div>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-300 mb-2">
                    Measurements (inches)
                  </h4>
                  <div
                    class="grid grid-cols-2 sm:grid-cols-3 gap-4"
                    id="measurements-inputs-resources"
                  >
                    <!-- Measurement inputs will be injected here -->
                  </div>
                </div>
              </div>
              <button
                id="save-measurements-btn"
                class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md transition"
              >
                Save All Body Data
              </button>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-content" class="tab-content">
          <h2
            class="font-bebas text-4xl text-red-500 tracking-wide mb-4 text-center"
          >
            Settings & Principles
          </h2>
          <section class="grid md:grid-cols-2 gap-6">
            <div
              class="bg-[rgba(255,255,255,0.03)] p-6 rounded-lg border border-[rgba(255,255,255,0.04)] backdrop-blur"
            >
              <h2 class="font-bebas text-3xl text-red-500 tracking-wide mb-4">
                Principles for Power
              </h2>
              <div
                class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-300 text-sm"
              >
                <div>
                  <h3 class="font-semibold text-white">Caloric Surplus</h3>
                  <p>Consume 300-500 more calories than you burn daily.</p>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Prioritize Protein</h3>
                  <p>Aim for 0.7-1.0g of protein per pound of body weight.</p>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Progressive Overload</h3>
                  <p>Continuously make your workouts more challenging.</p>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Rest is a Weapon</h3>
                  <p>
                    Prioritize 7-9 hours of sleep; muscles grow during recovery.
                  </p>
                </div>
              </div>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
              <h2 class="font-bebas text-3xl text-gray-400 tracking-wide mb-4">
                App Settings
              </h2>
              <div id="user-info" class="mb-4 text-center"></div>
              
              <!-- Enhanced Settings -->
              <div class="space-y-4 mb-6">
                <!-- Voice Commands -->
                <div class="flex items-center justify-between">
                  <div>
                    <label class="text-white font-medium">üé§ Voice Commands</label>
                    <p class="text-gray-400 text-xs">Control workouts with voice</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="voice-commands-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
                <button
                  onclick="showVoiceCommandsHelp()"
                  class="w-full text-left text-blue-400 hover:text-blue-300 text-sm underline pl-4"
                >
                  üìñ View Available Voice Commands
                </button>

                <!-- Achievement Sharing -->
                <div class="flex items-center justify-between">
                  <div>
                    <label class="text-white font-medium">üèÜ Share Achievements</label>
                    <p class="text-gray-400 text-xs">Auto-share achievements</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="share-achievements-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>

                <!-- Weekly Challenges -->
                <div class="flex items-center justify-between">
                  <div>
                    <label class="text-white font-medium">‚ö° Weekly Challenges</label>
                    <p class="text-gray-400 text-xs">Participate in challenges</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="weekly-challenges-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>

                <!-- AI Recommendations -->
                <div class="flex items-center justify-between">
                  <div>
                    <label class="text-white font-medium">ü§ñ AI Recommendations</label>
                    <p class="text-gray-400 text-xs">Personalized suggestions</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="ai-recommendations-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="space-y-3">
                <button onclick="showAdvancedAnalytics()" 
                  class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded transition-colors">
                  üìà Advanced Analytics
                </button>
              </div>

              <div class="flex flex-col items-center justify-center mt-6">
                <button
                  id="logout-btn"
                  class="mb-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition"
                >
                  Logout
                </button>
                <button
                  id="reset-progress-btn"
                  class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg transition"
                >
                  Reset All Progress
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">
                  Permanently deletes workout and weight data for your account.
                </p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Workout Detail Modal -->
    <div
      id="workout-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-2xl transform scale-95 transition-all duration-300"
        id="modal-content-container"
      >
        <div
          class="p-4 sm:p-6 border-b border-gray-700 flex justify-between items-center"
        >
          <div>
            <h2
              id="modal-title"
              class="font-bebas text-3xl sm:text-4xl text-red-500 tracking-wider"
              tabindex="-1"
            ></h2>
            <p
              id="modal-subtitle"
              class="text-gray-400 text-base sm:text-lg"
            ></p>
          </div>
          <button
            id="close-modal"
            class="text-gray-400 hover:text-white transition"
            aria-label="Close workout dialog"
            title="Close"
          >
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div
          id="modal-content"
          class="p-4 sm:p-6 max-h-[60vh] overflow-y-auto modal-content"
        ></div>
        <div
          class="p-4 bg-gray-900/50 rounded-b-lg flex flex-col sm:flex-row gap-4 justify-between items-center"
        >
          <div id="daily-task-tracker" class="w-full hidden">
            <label class="font-bold text-red-300 text-sm"
              >Daily Task: 500 Push-ups</label
            >
            <div class="flex items-center gap-2 mt-1">
              <input
                type="number"
                id="pushup-input"
                placeholder="Add reps"
                class="w-24 bg-gray-700 border border-gray-600 rounded-md p-1 text-sm focus:ring-red-500 focus:border-red-500"
              />
              <button
                id="add-pushups-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm transition"
              >
                +
              </button>
              <div class="flex-grow bg-gray-700 rounded-full h-4">
                <div
                  id="pushup-progress-bar"
                  class="bg-red-600 h-4 rounded-full transition-all duration-500 text-xs text-white text-center font-bold leading-4"
                >
                  0
                </div>
              </div>
              <span
                id="pushup-count-text"
                class="text-sm font-semibold w-20 text-right"
                >0 / 500</span
              >
            </div>
          </div>
          <button
            id="start-workout-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition w-full sm:w-auto"
          >
            Start Workout
          </button>
          <button
            id="complete-workout-btn"
            class="btn-primary w-full sm:w-auto mt-2 sm:mt-0 hidden"
          >
            Mark as Complete
          </button>
        </div>
      </div>
    </div>

    <!-- Alternative Exercise Modal -->
    <div
      id="alternative-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="alternative-modal-title"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300"
        id="alternative-modal-container"
      >
        <div
          class="p-4 sm:p-6 border-b border-gray-700 flex justify-between items-center"
        >
          <h2
            id="alternative-modal-title"
            class="font-bebas text-3xl text-red-500 tracking-wider"
          >
            Choose an Alternative
          </h2>
          <button
            id="close-alternative-modal"
            class="text-gray-400 hover:text-white transition"
            aria-label="Close alternative dialog"
            title="Close"
          >
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div
          id="alternative-modal-content"
          class="p-4 sm:p-6 flex flex-col gap-3"
        >
          <!-- Alternatives will be injected here -->
        </div>
      </div>
    </div>

    <!-- Timer Modal -->
    <div
      id="timer-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="timer-modal-title"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300"
        id="timer-modal-container"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center"
        >
          <h2
            id="timer-modal-title"
            class="font-bebas text-3xl text-red-500 tracking-wider"
            tabindex="-1"
          >
            Workout Timer
          </h2>
          <button
            id="close-timer-modal"
            class="text-gray-400 hover:text-white transition"
            aria-label="Close timer dialog"
            title="Close"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="p-4 sm:p-6 text-center timer-modal-content">
          <div
            id="timer-display"
            class="font-bebas text-7xl sm:text-8xl text-white mb-4"
          >
            00:00:00
          </div>
          <div id="timer-controls" class="flex justify-center gap-4"></div>
          <!-- This container will hold the dynamic content for the rest timer -->
          <div id="rest-timer-dynamic-content"></div>
          <div id="tabata-display" class="hidden text-white">
            <p class="text-3xl sm:text-4xl font-bold" id="tabata-state">
              PREPARE
            </p>
            <p class="text-xl sm:text-2xl mt-2">
              Round: <span id="tabata-round">1</span>/8
            </p>
          </div>
          <div id="endurance-display" class="hidden text-white">
            <p class="text-3xl sm:text-4xl font-bold" id="endurance-state">
              PREPARE
            </p>
            <p class="text-xl sm:text-2xl mt-2">
              Set: <span id="endurance-round">1</span>/4
            </p>
          </div>
          <div id="hiit-display" class="hidden text-white">
            <p class="text-3xl sm:text-4xl font-bold" id="hiit-state">
              PREPARE
            </p>
            <p class="text-xl sm:text-2xl mt-2">
              Sprint: <span id="hiit-round">1</span>/12
            </p>
          </div>
          <div
            id="countdown-input-container"
            class="hidden flex-col items-center gap-2"
          >
            <label for="countdown-minutes" class="text-lg">Set Minutes:</label>
            <input
              type="number"
              id="countdown-minutes"
              min="0"
              value="5"
              aria-label="Countdown minutes"
              class="w-32 bg-gray-700 text-white p-2 rounded-md text-center"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Muscle Group Visualization Modal -->
    <div
      id="muscle-group-modal"
      class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 hidden z-50"
    >
      <div class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-4xl">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
          <h2 class="font-bebas text-3xl text-red-500 tracking-wider">
            üí™ Muscles Being Worked
          </h2>
          <button
            id="close-muscle-modal"
            class="text-gray-400 hover:text-white transition"
            onclick="closeMuscleGroupModal()"
          >
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Left: Muscle Diagram -->
            <div class="flex flex-col items-center justify-center bg-gray-900/50 p-4 rounded-lg">
              <h3 id="muscle-exercise-name" class="text-xl font-bold text-white mb-4">Exercise Name</h3>
              <svg id="muscle-diagram" viewBox="0 0 200 400" class="max-h-[450px] w-auto">
                <!-- Front Body -->
                <g id="muscle-front" class="muscle-view">
                  <!-- Head -->
                  <ellipse cx="100" cy="40" rx="20" ry="25" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Neck -->
                  <rect x="92" y="65" width="16" height="15" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Chest/Pecs -->
                  <path id="muscle-chest" d="M 70 80 Q 100 90, 130 80 L 130 110 Q 100 115, 70 110 Z" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Shoulders -->
                  <ellipse id="muscle-shoulders-front" cx="60" cy="85" rx="15" ry="20" fill="#4b5563" opacity="0.6"/>
                  <ellipse cx="140" cy="85" rx="15" ry="20" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Arms (Biceps/Triceps) -->
                  <rect id="muscle-biceps-left" x="40" y="90" width="18" height="50" rx="9" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-biceps-right" x="142" y="90" width="18" height="50" rx="9" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Forearms -->
                  <rect id="muscle-forearms-left" x="42" y="140" width="14" height="45" rx="7" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-forearms-right" x="144" y="140" width="14" height="45" rx="7" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Core/Abs -->
                  <rect id="muscle-core" x="75" y="115" width="50" height="60" rx="8" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Hips/Glutes front view -->
                  <rect id="muscle-hips-front" x="70" y="175" width="60" height="30" rx="10" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Quads -->
                  <rect id="muscle-quads-left" x="65" y="205" width="28" height="85" rx="14" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-quads-right" x="107" y="205" width="28" height="85" rx="14" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Calves -->
                  <rect id="muscle-calves-left" x="70" y="295" width="20" height="60" rx="10" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-calves-right" x="110" y="295" width="20" height="60" rx="10" fill="#4b5563" opacity="0.6"/>
                </g>
                
                <!-- Back Body (Hidden by default) -->
                <g id="muscle-back" class="muscle-view hidden">
                  <!-- Head -->
                  <ellipse cx="100" cy="40" rx="20" ry="25" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Neck -->
                  <rect x="92" y="65" width="16" height="15" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Upper Back/Traps -->
                  <path id="muscle-traps" d="M 60 75 L 80 85 L 100 80 L 120 85 L 140 75 L 130 95 L 70 95 Z" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Lats -->
                  <path id="muscle-lats" d="M 70 95 L 50 120 L 55 155 L 75 145 L 75 115 Z" fill="#4b5563" opacity="0.6"/>
                  <path d="M 130 95 L 150 120 L 145 155 L 125 145 L 125 115 Z" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Lower Back -->
                  <rect id="muscle-lower-back" x="75" y="140" width="50" height="35" rx="8" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Shoulders back -->
                  <ellipse id="muscle-shoulders-back" cx="60" cy="85" rx="15" ry="20" fill="#4b5563" opacity="0.6"/>
                  <ellipse cx="140" cy="85" rx="15" ry="20" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Triceps -->
                  <rect id="muscle-triceps-left" x="40" y="95" width="18" height="45" rx="9" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-triceps-right" x="142" y="95" width="18" height="45" rx="9" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Glutes -->
                  <ellipse id="muscle-glutes-left" cx="80" cy="190" rx="18" ry="22" fill="#4b5563" opacity="0.6"/>
                  <ellipse id="muscle-glutes-right" cx="120" cy="190" rx="18" ry="22" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Hamstrings -->
                  <rect id="muscle-hamstrings-left" x="65" y="210" width="28" height="80" rx="14" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-hamstrings-right" x="107" y="210" width="28" height="80" rx="14" fill="#4b5563" opacity="0.6"/>
                  
                  <!-- Calves back -->
                  <rect id="muscle-calves-back-left" x="70" y="295" width="20" height="60" rx="10" fill="#4b5563" opacity="0.6"/>
                  <rect id="muscle-calves-back-right" x="110" y="295" width="20" height="60" rx="10" fill="#4b5563" opacity="0.6"/>
                </g>
              </svg>
              
              <!-- Toggle View Button -->
              <button
                id="toggle-muscle-view"
                onclick="toggleMuscleView()"
                class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
              >
                üîÑ Show Back View
              </button>
            </div>
            
            <!-- Right: Muscle Group Info -->
            <div class="flex flex-col">
              <h3 class="font-bebas text-2xl text-blue-500 tracking-wide mb-3">Active Muscle Groups</h3>
              <div id="muscle-groups-list" class="space-y-2 mb-4">
                <!-- Muscle groups will be listed here -->
              </div>
              
              <div class="mt-auto bg-gradient-to-br from-red-900/30 to-red-700/20 p-4 rounded-lg border border-red-500/30">
                <h4 class="font-semibold text-red-400 mb-2">üí° Pro Tip</h4>
                <p id="muscle-tip" class="text-sm text-gray-300">
                  Focus on feeling the contraction in the highlighted muscle groups during each rep.
                </p>
              </div>
              
              <button
                onclick="closeMuscleGroupModal()"
                class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition"
              >
                Got It!
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div
      id="reset-confirm-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="reset-modal-title"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300"
        id="reset-modal-container"
      >
        <div class="p-6 text-center">
          <svg
            class="w-16 h-16 mx-auto text-red-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            ></path>
          </svg>
          <h3
            id="reset-modal-title"
            class="font-bebas text-3xl mt-4 text-white"
            tabindex="-1"
          >
            Are you sure?
          </h3>
          <p class="text-gray-400 mt-2">
            This action cannot be undone. All your progress will be lost.
          </p>
          <div class="mt-6 flex justify-center gap-4">
            <button
              id="cancel-reset-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md transition"
            >
              Cancel
            </button>
            <button
              id="confirm-reset-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition"
            >
              Confirm Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Single Delete Confirmation Modal -->
    <div
      id="delete-confirm-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="delete-modal-title"
      class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300 opacity-0"
    >
      <div
        class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300"
        id="delete-modal-container"
      >
        <div class="p-6 text-center">
          <svg
            class="w-16 h-16 mx-auto text-red-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
          <h3
            id="delete-modal-title"
            class="font-bebas text-3xl mt-4 text-white"
            tabindex="-1"
          >
            Delete Workout?
          </h3>
          <p class="text-gray-400 mt-2">
            This will remove the workout from your history. You can undo for a
            few seconds after deletion.
          </p>
          <div class="mt-6 flex justify-center gap-4">
            <button
              id="cancel-delete-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md transition"
            >
              Cancel
            </button>
            <button
              id="confirm-delete-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Floating Mic Button for Voice Commands -->
    <button
      id="floating-mic-btn"
      title="Toggle Voice Commands"
      style="position: fixed; bottom: 90px; right: 32px; z-index: 1000; background: #4f46e5; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 16px rgba(79,70,229,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: background 0.2s;"
    >
      <span id="mic-icon">üé§</span>
    </button>

    <!-- Toast Notification Container -->
    <div
      id="toast-container"
      class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"
    ></div>

<script>
// --- Floating Mic Button Logic ---
document.addEventListener('DOMContentLoaded', () => {
  const micBtn = document.getElementById('floating-mic-btn');
  const micIcon = document.getElementById('mic-icon');
  let micActive = false;

  if (micBtn) {
    micBtn.addEventListener('click', () => {
      if (!micActive) {
        startVoiceRecognition();
        micActive = true;
        micBtn.style.background = '#22c55e';
        micIcon.textContent = 'üü¢';
        showToast('üé§ Listening for commands...', 'info');
      } else {
        stopVoiceRecognition();
        micActive = false;
        micBtn.style.background = '#4f46e5';
        micIcon.textContent = 'üé§';
        showToast('üé§ Voice commands stopped', 'info');
      }
    });
  }
});
</script>

    <!-- Workout Timer Widget -->
    <div
      id="workout-timer-widget"
      class="hidden fixed top-20 right-5 z-40 bg-gradient-to-br from-red-600 to-red-700 text-white px-6 py-4 rounded-lg shadow-2xl border-2 border-red-400"
    >
      <div class="flex items-center gap-3">
        <div class="text-2xl">‚è±Ô∏è</div>
        <div>
          <div class="text-xs uppercase tracking-wide opacity-80">Workout Time</div>
          <div id="workout-timer-display" class="text-2xl font-bold font-mono">00:00:00</div>
        </div>
        <button
          id="pause-workout-timer-btn"
          onclick="togglePauseWorkoutTimer()"
          class="ml-2 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors"
          title="Pause/Resume timer"
        >
          ‚è∏Ô∏è
        </button>
        <button
          onclick="stopWorkoutTimer()"
          class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition-colors"
          title="Stop workout timer"
        >
          ‚èπÔ∏è
        </button>
      </div>
    </div>

    <!-- Debug panel removed -->

    <!-- Firebase SDK -->
    <script type="module">
      // Emergency fallback - hide loading after 3 seconds if auth doesn't respond
      let authStateResolved = false;
      setTimeout(() => {
        if (!authStateResolved) {
          console.warn('‚ö†Ô∏è Auth state timeout - forcing loading screen hide');
          const loadingEl = document.getElementById("loading-state");
          if (loadingEl) {
            loadingEl.classList.add("hidden");
            console.log('‚úÖ Loading screen force-hidden after timeout');
          }
        }
      }, 3000);

      // Immediate DOM check
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded - checking elements');
        console.log('Loading state exists:', !!document.getElementById("loading-state"));
        console.log('Auth container exists:', !!document.getElementById("auth-container"));
        console.log('App container exists:', !!document.getElementById("app-container"));
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        limit,
        addDoc,
        serverTimestamp,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // IMPORTANT: Replace with your actual Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyC9yMJC3n4jhrSRB5H4ub98HB9NGl6gfBM",
        authDomain: "toji-workout-app.firebaseapp.com",
        projectId: "toji-workout-app",
        storageBucket: "toji-workout-app.firebasestorage.app",
        messagingSenderId: "842979075459",
        appId: "1:842979075459:web:1e27e781fe06b8ff1502b6",
        measurementId: "G-B0383HKNB9",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let userId = null;
      let unsubscribeDbListener = null;

      // Timer variables - declared early to ensure availability (v2.1)
      let timerInterval = null;
      
      // Initialize timer functions with proper scoping
      window.timerInterval = timerInterval;

      // --- DATA ---
      let workoutPlan;

      const originalWorkoutPlan = {
        monday: {
          day: "Monday",
          title: "Strength & Size",
          subtitle: "Upper Body Push/Pull",
          warmup: [
            "5 min Light Movement (marching in place or easy walking)",
            "Neck Rolls & Shoulder Shrugs (10 each direction)",
            "Doorway Chest Stretch (30s each arm position)",
            "Cat-Cow Stretch (10 slow reps - spinal mobility)",
            "Arm Circles & Cross-Body Shoulder Stretch (30s each)",
            "Upper Trap Stretch (20s each side)",
            "Thoracic Spine Rotation (10 each side)",
          ],
          exercises: [
            {
              name: "Inverted Rows",
              baseName: "Inverted Rows",
              difficulty: "intermediate",
              sets: "4",
              reps: "10-15",
              rest: 90,
              note: "Use a sturdy table or two chairs.",
              variations: {
                easier: [
                  {
                    name: "Towel Rows",
                    difficulty: "beginner",
                    note: "Use a towel wrapped around a sturdy pole or door handles. Focus on squeezing your back.",
                  },
                  {
                    name: "Back Widows",
                    difficulty: "beginner",
                    note: "Lie on your back, bend your elbows to 90 degrees, and press them into the floor to lift your chest. Great for scapular retraction.",
                  },
                  {
                    name: "Bent Knee Inverted Rows",
                    difficulty: "beginner",
                    note: "Perform an inverted row with your knees bent at 90 degrees to reduce the amount of bodyweight you are lifting.",
                  },
                ],
                harder: [
                  {
                    name: "Feet Elevated Inverted Rows",
                    difficulty: "intermediate",
                    note: "Place your feet on a chair or box to increase the angle and the percentage of bodyweight you are pulling.",
                  },
                  {
                    name: "Archer Rows",
                    difficulty: "expert",
                    note: "A unilateral variation where one arm pulls while the other remains straight, increasing the load on the working side.",
                  },
                  {
                    name: "Single-Arm Inverted Row Negatives",
                    difficulty: "expert",
                    note: "Pull up with two arms and slowly lower yourself down using only one arm to build eccentric strength.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Pull-Ups",
                  difficulty: "expert",
                  note: "A challenging upper body exercise targeting the lats and biceps. Pull your chin over the bar.",
                },
                {
                  name: "Chin-Ups",
                  difficulty: "intermediate",
                  note: "Similar to pull-ups but with an underhand grip, placing more emphasis on the biceps.",
                },
                {
                  name: "Resistance Band Rows",
                  difficulty: "beginner",
                  note: "Use a resistance band anchored to a door or stable object. Pull the handles toward your chest, squeezing shoulder blades together.",
                },
                {
                  name: "Reverse Fly with Towel",
                  difficulty: "beginner",
                  note: "Hold a towel with arms extended, pull it apart by squeezing shoulder blades. Great for rear delts and rhomboids.",
                },
                {
                  name: "Superman Pulls",
                  difficulty: "beginner",
                  note: "Lie face down, extend arms forward, then pull elbows back while lifting chest. Mimics rowing motion without equipment.",
                },
                {
                  name: "Door Frame Rows",
                  difficulty: "beginner",
                  note: "Stand in a doorway, grab the frame with both hands and lean back to perform rowing motion. Adjust angle for difficulty.",
                },
                {
                  name: "Wall Handstand Push-Ups (Back Focus)",
                  difficulty: "expert",
                  note: "Against a wall, focus on pulling motion during the negative phase to engage back muscles.",
                },
                {
                  name: "Prone Y-T-W Raises",
                  difficulty: "intermediate",
                  note: "Lie face down, lift arms in Y, T, and W positions to target different parts of the back and shoulders.",
                },
              ],
            },
            {
              name: "Pike Push-Ups",
              baseName: "Pike Push-Ups",
              difficulty: "intermediate",
              sets: "4",
              reps: "8-12",
              rest: 90,
              note: "Elevate feet for more difficulty.",
              variations: {
                easier: [
                  {
                    name: "Incline Push-ups",
                    difficulty: "beginner",
                    note: "Perform push-ups with your hands on an elevated surface like a bench or wall to reduce the difficulty.",
                  },
                  {
                    name: "Regular Push-ups",
                    difficulty: "beginner",
                    note: "The standard push-up, a foundational bodyweight exercise for chest, shoulders, and triceps.",
                  },
                  {
                    name: "Decline Push-Ups",
                    difficulty: "intermediate",
                    note: "Perform push-ups with your feet elevated to shift more focus to the upper chest and shoulders.",
                  },
                ],
                harder: [
                  {
                    name: "Feet Elevated Pike Push-ups",
                    difficulty: "intermediate",
                    note: "Increase the difficulty of pike push-ups by elevating your feet on a box or chair.",
                  },
                  {
                    name: "Wall Handstand Push-Up Negatives",
                    difficulty: "expert",
                    note: "Kick up into a handstand against a wall and slowly lower yourself down to build strength for the full movement.",
                  },
                  {
                    name: "Wall Handstand Push-Ups",
                    difficulty: "expert",
                    note: "Perform a full push-up while in a handstand against a wall. A key exercise for shoulder strength.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Hindu Push-Ups",
                  difficulty: "intermediate",
                  note: "A fluid push-up variation that improves flexibility and strength, moving from a downward dog to a cobra pose.",
                },
                {
                  name: "Dive Bomber Push-Ups",
                  difficulty: "intermediate",
                  note: "Similar to Hindu push-ups but includes a reverse motion, increasing the challenge on shoulders and chest.",
                },
              ],
            },
            {
              name: "Archer Push-Ups",
              baseName: "Archer Push-Ups",
              difficulty: "expert",
              sets: "3",
              reps: "5-8 per side",
              rest: 120,
              note: "Builds unilateral chest strength.",
              variations: {
                easier: [
                  {
                    name: "Wide Push-Ups",
                    difficulty: "beginner",
                    note: "Place your hands wider than shoulder-width to target the chest more.",
                  },
                  {
                    name: "Staggered Hand Push-Ups",
                    difficulty: "intermediate",
                    note: "Place one hand slightly in front of the other to alter the muscular emphasis.",
                  },
                  {
                    name: "Uneven Push-Ups",
                    difficulty: "intermediate",
                    note: "Perform a push-up with one hand on an elevated surface to increase the load on the other arm.",
                  },
                ],
                harder: [
                  {
                    name: "Typewriter Push-Ups",
                    difficulty: "expert",
                    note: "From a wide push-up position, slide your weight from side to side at the bottom of the movement.",
                  },
                  {
                    name: "One-Arm Push-Up Negatives",
                    difficulty: "expert",
                    note: "Lower yourself down slowly using only one arm to build eccentric strength for the one-arm push-up.",
                  },
                  {
                    name: "One-Arm Push-ups (assisted)",
                    difficulty: "expert",
                    note: "Perform a one-arm push-up with assistance from your other hand or by using an incline.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Typewriter Push-Ups",
                  difficulty: "expert",
                  note: "From a wide push-up position, shift your weight from one side to the other, keeping your chest low. Great for unilateral strength.",
                },
                {
                  name: "Uneven Push-Ups",
                  difficulty: "intermediate",
                  note: "Perform a push-up with one hand elevated on a block or book to shift focus to one side of the chest.",
                },
              ],
            },
            {
              name: "Dips",
              baseName: "Dips",
              difficulty: "intermediate",
              sets: "3",
              reps: "10-15",
              rest: 90,
              note: "Use chairs or parallel bars. Keep your chest up.",
              variations: {
                easier: [
                  {
                    name: "Chair Dips (feet on floor)",
                    difficulty: "beginner",
                    note: "Perform dips on a chair or bench with your feet on the floor to support some of your bodyweight.",
                  },
                  {
                    name: "Bench Dips",
                    difficulty: "beginner",
                    note: "A slightly more challenging version of chair dips, often with feet elevated.",
                  },
                  {
                    name: "Negative Dips (on parallel bars)",
                    difficulty: "intermediate",
                    note: "Jump to the top of the dip position and lower yourself down as slowly as possible.",
                  },
                ],
                harder: [
                  {
                    name: "L-Sit Dips",
                    difficulty: "expert",
                    note: "Perform dips while holding your legs straight out in an L-sit position, adding a significant core challenge.",
                  },
                  {
                    name: "Weighted Dips",
                    difficulty: "expert",
                    note: "Add weight using a dip belt or a weighted vest to increase the resistance.",
                  },
                  {
                    name: "Ring Dips",
                    difficulty: "expert",
                    note: "Performed on gymnastic rings, this variation adds instability, requiring more shoulder and core stabilization.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Ring Dips",
                  difficulty: "expert",
                  note: "Performed on gymnastic rings, this variation adds instability, requiring more shoulder and core stabilization.",
                },
                {
                  name: "Bulgarian Dips",
                  difficulty: "intermediate",
                  note: "A dip variation performed on parallel bars with a forward lean to target the chest more effectively.",
                },
                {
                  name: "Korean Dips",
                  difficulty: "expert",
                  note: "A challenging dip variation focusing on the triceps, performed with hands behind the back on a low bar.",
                },
              ],
            },
            {
              name: "Pseudo Planche Push-Ups",
              baseName: "Pseudo Planche Push-Ups",
              difficulty: "expert",
              sets: "3",
              reps: "8-12",
              rest: 90,
              note: "Lean your body forward to target shoulders.",
              variations: {
                easier: [
                  {
                    name: "Regular Push-Ups",
                    difficulty: "beginner",
                    note: "Master the standard push-up before attempting planche variations.",
                  },
                  {
                    name: "Planche Leans (on knees)",
                    difficulty: "intermediate",
                    note: "Practice the forward lean of a planche from a kneeling position to reduce the load.",
                  },
                  {
                    name: "Planche Leans",
                    difficulty: "intermediate",
                    note: "From a push-up position, lean your body as far forward as possible to build shoulder strength and wrist conditioning.",
                  },
                ],
                harder: [
                  {
                    name: "Tuck Planche Holds",
                    difficulty: "expert",
                    note: "A static hold where you balance on your hands with your knees tucked to your chest.",
                  },
                  {
                    name: "Tuck Planche Push-Ups",
                    difficulty: "expert",
                    note: "Perform push-ups while holding a tuck planche position.",
                  },
                  {
                    name: "Advanced Tuck Planche Push-ups",
                    difficulty: "expert",
                    note: "A tuck planche push-up with the back more parallel to the ground, increasing the difficulty.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Planche Leans",
                  difficulty: "intermediate",
                  note: "A static hold that builds shoulder and wrist strength for the planche. Lean forward as much as possible with straight arms.",
                },
                {
                  name: "Tuck Planche Holds",
                  difficulty: "intermediate",
                  note: "An intermediate static hold for the planche, with knees tucked towards the chest to reduce leverage.",
                },
              ],
            },
          ],
          cooldown: [
            "5 min Slow Walk or Gentle Movement",
            "Doorway Chest Stretch (45s each arm position)",
            "Upper Trap & Neck Stretch (30s each side)",
            "Lat Stretch Against Wall (45s each side)",
            "Tricep & Rear Delt Stretch (30s each arm)",
            "Seated Spinal Twist (30s each direction)",
            "Child's Pose with Side Reach (45s each side)",
          ],
        },
        tuesday: {
          day: "Tuesday",
          title: "Explosive Power",
          subtitle: "Full Body Plyometrics",
          warmup: [
            "3 min Gentle Movement (light jogging or marching)",
            "Hip Circles & Leg Swings (10 each direction)",
            "Dynamic Hip Flexor Stretch (30s each leg)",
            "Standing Forward Fold to Flat Back (10 reps)",
            "Torso Twists with Arm Extension (15 each side)",
            "Ankle Circles & Calf Raises (15 each)",
            "Bodyweight Squats with Reach (10 reps)",
          ],
          exercises: [
            {
              name: "Burpee Broad Jumps",
              baseName: "Burpee Broad Jumps",
              difficulty: "intermediate",
              sets: "5",
              reps: "5",
              rest: 180,
              note: "Combine a burpee with a maximal horizontal jump.",
              variations: {
                easier: [
                  {
                    name: "Squat Thrusts",
                    difficulty: "beginner",
                    note: "A simplified burpee without the push-up or jump. Focus on speed.",
                  },
                  {
                    name: "Burpees (no jump)",
                    difficulty: "beginner",
                    note: "Perform a burpee with a push-up but without the final explosive jump.",
                  },
                  {
                    name: "Broad Jumps",
                    difficulty: "intermediate",
                    note: "Practice the horizontal jump portion of the exercise on its own.",
                  },
                ],
                harder: [
                  {
                    name: "Burpee with Tuck Jump",
                    difficulty: "intermediate",
                    note: "Add a vertical tuck jump at the end of each burpee for extra explosive power.",
                  },
                  {
                    name: "Burpee to Box Jump",
                    difficulty: "intermediate",
                    note: "Perform a burpee and then immediately transition into a jump onto a plyo box.",
                  },
                  {
                    name: "Double Burpee",
                    difficulty: "intermediate",
                    note: "Perform two push-ups at the bottom of each burpee to increase the upper body challenge.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Box Jumps",
                  difficulty: "intermediate",
                  note: "An explosive plyometric exercise. Jump onto a sturdy box or platform, focusing on height and a soft landing.",
                },
                {
                  name: "Knee-to-Feet Jumps",
                  difficulty: "intermediate",
                  note: "A powerful lower body exercise starting from a kneeling position and jumping to a squat.",
                },
              ],
            },
            {
              name: "Tuck Jumps",
              baseName: "Tuck Jumps",
              difficulty: "intermediate",
              sets: "4",
              reps: "8",
              rest: 120,
              note: "Jump as high as possible, bringing knees to chest.",
              variations: {
                easier: [
                  {
                    name: "High Knees",
                    difficulty: "beginner",
                    note: "A less intense version that mimics the knee-tuck motion without the high-impact jump.",
                  },
                  {
                    name: "Jumping Squats",
                    difficulty: "beginner",
                    note: "A foundational plyometric exercise to build the power needed for tuck jumps.",
                  },
                  {
                    name: "Box Jumps (low box)",
                    difficulty: "beginner",
                    note: "Jump onto a low box to practice explosive movement with a clear target.",
                  },
                ],
                harder: [
                  {
                    name: "Depth Jumps",
                    difficulty: "intermediate",
                    note: "Step off a low box and immediately explode into a maximal vertical jump upon landing.",
                  },
                  {
                    name: "Knee-to-Feet Jumps",
                    difficulty: "intermediate",
                    note: "A powerful plyometric exercise that develops the explosive strength needed for high jumps.",
                  },
                  {
                    name: "Double Tuck Jumps",
                    difficulty: "expert",
                    note: "Perform a small hop followed immediately by a maximal tuck jump.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Box Jumps",
                  difficulty: "intermediate",
                  note: "An explosive plyometric exercise. Jump onto a sturdy box or platform, focusing on height and a soft landing.",
                },
                {
                  name: "Jumping Squats",
                  difficulty: "beginner",
                  note: "A bodyweight squat followed by an explosive jump. Great for building lower body power.",
                },
                {
                  name: "Star Jumps",
                  difficulty: "beginner",
                  note: "A full-body plyometric exercise. Jump while extending arms and legs out into a star shape.",
                },
              ],
            },
            {
              name: "Explosive Push-Ups",
              baseName: "Explosive Push-Ups",
              difficulty: "intermediate",
              sets: "4",
              reps: "6-10",
              rest: 120,
              note: "Push with enough force for your hands to leave the ground.",
              variations: {
                easier: [
                  {
                    name: "Knee Plyo Push-ups",
                    difficulty: "beginner",
                    note: "Perform explosive push-ups from your knees to reduce the load.",
                  },
                  {
                    name: "Incline Explosive Push-Ups",
                    difficulty: "beginner",
                    note: "Use an elevated surface to make the explosive push-up easier.",
                  },
                  {
                    name: "Standard Push-Ups (fast concentric)",
                    difficulty: "beginner",
                    note: "Perform regular push-ups with a focus on pushing up as fast as possible.",
                  },
                ],
                harder: [
                  {
                    name: "Clapping Push-Ups",
                    difficulty: "intermediate",
                    note: "Explode up with enough force to clap your hands together before landing.",
                  },
                  {
                    name: "Double Clapping Push-Ups",
                    difficulty: "expert",
                    note: "An advanced variation where you clap twice (e.g., behind your back) before landing.",
                  },
                  {
                    name: "Superman Push-Ups",
                    difficulty: "expert",
                    note: "A highly advanced plyo push-up where both hands and feet leave the ground.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Plyo Push-Ups",
                  difficulty: "intermediate",
                  note: "A general term for push-ups where hands leave the ground. Focus on maximum explosive power.",
                },
                {
                  name: "Superman Push-Ups",
                  difficulty: "expert",
                  note: "An advanced plyometric push-up where both hands and feet leave the ground.",
                },
              ],
            },
            {
              name: "Single Leg Hops",
              baseName: "Single Leg Hops",
              difficulty: "beginner",
              sets: "3",
              reps: "5 per leg",
              rest: 120,
              note: "Focus on distance and landing softly.",
              variations: {
                easier: [
                  {
                    name: "Forward Hops (two feet)",
                    difficulty: "beginner",
                    note: "Practice the hopping motion using both feet for better balance and less impact.",
                  },
                  {
                    name: "Single Leg Calf Raises",
                    difficulty: "beginner",
                    note: "Strengthen the calf muscles, which are crucial for explosive hopping.",
                  },
                  {
                    name: "Alternating Lunges",
                    difficulty: "beginner",
                    note: "Build unilateral leg strength and stability as a foundation for single-leg plyometrics.",
                  },
                ],
                harder: [
                  {
                    name: "Bounding",
                    difficulty: "intermediate",
                    note: "Exaggerated running strides focusing on maximizing air time and distance with each step.",
                  },
                  {
                    name: "Pistol Squat Jumps",
                    difficulty: "expert",
                    note: "An extremely advanced exercise combining a single-leg squat with an explosive jump.",
                  },
                  {
                    name: "Single Leg Depth Jumps",
                    difficulty: "expert",
                    note: "Step off a low box on one leg and immediately explode into a maximal jump.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Skater Jumps",
                  difficulty: "intermediate",
                  note: "A lateral plyometric jump that builds power and stability in the hips and legs.",
                },
                {
                  name: "Pistol Squat Jumps",
                  difficulty: "expert",
                  note: "An advanced, single-leg squat jump that requires significant strength, balance, and power.",
                },
              ],
            },
            {
              name: "High Knees (Sprint in Place)",
              baseName: "High Knees (Sprint in Place)",
              difficulty: "beginner",
              sets: "8",
              reps: "30s On, 15s Off",
              rest: 0,
              note: "Perform with max effort for 30s, then rest for 15s. This is one round.",
              variations: {
                easier: [
                  {
                    name: "Marching in place",
                    difficulty: "beginner",
                    note: "A low-impact version of high knees, focusing on the movement pattern without the intensity.",
                  },
                  {
                    name: "Slow Butt Kicks",
                    difficulty: "beginner",
                    note: "Gently bring your heels towards your glutes to stretch the quads and warm up the hamstrings.",
                  },
                  {
                    name: "Jumping Jacks",
                    difficulty: "beginner",
                    note: "A full-body cardio exercise that is less intense on the hip flexors than high knees.",
                  },
                ],
                harder: [
                  {
                    name: "Burpees",
                    difficulty: "intermediate",
                    note: "A full-body exercise that is more metabolically demanding than high knees.",
                  },
                  {
                    name: "Mountain Climbers (max speed)",
                    difficulty: "intermediate",
                    note: "A high-intensity core and cardio exercise that can be a substitute for high-knee sprints.",
                  },
                  {
                    name: "Tuck Jump Burpees",
                    difficulty: "expert",
                    note: "Combine a burpee with a tuck jump for a highly demanding plyometric and conditioning exercise.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Sprints (if space allows)",
                  difficulty: "intermediate",
                  note: "Run at maximum speed over a short distance to develop power and anaerobic fitness.",
                },
                {
                  name: "Mountain Climbers (fast)",
                  difficulty: "intermediate",
                  note: "Perform mountain climbers at maximum speed to elevate heart rate and build core strength.",
                },
                {
                  name: "Burpees",
                  difficulty: "intermediate",
                  note: "A full-body conditioning exercise. Perform them quickly for a metabolic boost.",
                },
              ],
            },
          ],
          cooldown: [
            "5 min Easy Walking or Light Movement",
            "Standing Forward Fold (45s - let gravity work)",
            "Figure-4 Hip Stretch (30s each side)",
            "Standing Quad Stretch (30s each side)",
            "Calf Stretch Against Wall (45s each side)",
            "Standing Hamstring Stretch (30s each side)",
            "Deep Breathing with Arm Overhead Reach (1 min)",
          ],
        },
        wednesday: {
          day: "Wednesday",
          title: "Strength & Size",
          subtitle: "Lower Body & Core",
          warmup: [
            "3 min Gentle Movement (easy walking or marching)",
            "Hip Flexor Stretch (30s each leg)",
            "Hip Circles & Figure-4 Stretch (10 circles, 20s hold each)",
            "Glute Bridges with Pause (10 reps, 2s hold)",
            "Dynamic Leg Swings (10 each direction per leg)",
            "Bodyweight Squats with Reach (10 reps)",
            "Seated Spinal Twist (20s each side)",
          ],
          exercises: [
            {
              name: "Pistol Squats",
              baseName: "Pistol Squats",
              difficulty: "expert",
              sets: "4",
              reps: "5-8 per leg",
              rest: 120,
              note: "Master the progression. Use support if needed.",
              variations: {
                easier: [
                  {
                    name: "Assisted Pistol Squats",
                    difficulty: "intermediate",
                    note: "Hold onto a door frame or TRX for balance and support as you perform the squat.",
                  },
                  {
                    name: "Negative Pistol Squats",
                    difficulty: "intermediate",
                    note: "Lower yourself down slowly on one leg and stand back up with two.",
                  },
                  {
                    name: "Box Pistol Squats",
                    difficulty: "intermediate",
                    note: "Squat down to a box or chair to control the depth and build strength in a specific range of motion.",
                  },
                ],
                harder: [
                  {
                    name: "Pistol Squats with Jump",
                    difficulty: "expert",
                    note: "Add an explosive jump at the top of the pistol squat for a plyometric challenge.",
                  },
                  {
                    name: "Weighted Pistol Squats",
                    difficulty: "expert",
                    note: "Hold a weight (e.g., a dumbbell or kettlebell) to increase the resistance.",
                  },
                  {
                    name: "Dragon Squats",
                    difficulty: "expert",
                    note: "A complex single-leg squat variation that requires significant flexibility and balance.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Shrimp Squats",
                  difficulty: "expert",
                  note: "A challenging single-leg squat where the non-working leg is held behind the body.",
                },
                {
                  name: "Cossack Squats",
                  difficulty: "intermediate",
                  note: "A deep lateral squat that improves hip mobility and inner thigh flexibility.",
                },
                {
                  name: "Skater Squats",
                  difficulty: "intermediate",
                  note: "A single-leg squat variation that builds stability and strength, similar to a pistol but with the leg reaching back.",
                },
              ],
            },
            {
              name: "Bulgarian Split Squats",
              baseName: "Bulgarian Split Squats",
              difficulty: "intermediate",
              sets: "3",
              reps: "10-15 per leg",
              rest: 90,
              note: "Use a chair or couch to elevate your back foot.",
              variations: {
                easier: [
                  {
                    name: "Static Lunge Holds",
                    difficulty: "beginner",
                    note: "Hold the bottom position of a lunge to build isometric strength and stability.",
                  },
                  {
                    name: "Reverse Lunges",
                    difficulty: "beginner",
                    note: "Step backward into a lunge, which can be easier on the knees than a forward lunge.",
                  },
                  {
                    name: "Split Squats (no elevation)",
                    difficulty: "beginner",
                    note: "Perform a split squat with your back foot on the floor to master the movement before elevating it.",
                  },
                ],
                harder: [
                  {
                    name: "Weighted Bulgarian Split Squats",
                    difficulty: "expert",
                    note: "Hold dumbbells or a kettlebell to add resistance to the exercise.",
                  },
                  {
                    name: "Deficit Bulgarian Split Squats",
                    difficulty: "intermediate",
                    note: "Stand on a small platform to increase the range of motion and challenge your mobility.",
                  },
                  {
                    name: "Plyometric Bulgarian Split Squats",
                    difficulty: "expert",
                    note: "Add a jump at the top of the movement for an explosive challenge.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Lunges",
                  difficulty: "beginner",
                  note: "A fundamental lower body exercise. Step forward and lower your hips until both knees are bent at a 90-degree angle.",
                },
                {
                  name: "Step-Ups",
                  difficulty: "beginner",
                  note: "Step onto a box or bench, driving through your lead leg. A great exercise for glutes and quads.",
                },
              ],
            },
            {
              name: "Nordic Hamstring Curls",
              baseName: "Nordic Hamstring Curls",
              difficulty: "expert",
              sets: "3",
              reps: "5-8",
              rest: 120,
              note: "Anchor your feet and control the negative.",
              variations: {
                easier: [
                  {
                    name: "Glute Bridges",
                    difficulty: "beginner",
                    note: "A foundational exercise to activate and strengthen the glutes and hamstrings.",
                  },
                  {
                    name: "Single-Leg Glute Bridges",
                    difficulty: "beginner",
                    note: "Perform a glute bridge on one leg to increase the unilateral challenge.",
                  },
                  {
                    name: "Slider Leg Curls (with towels)",
                    difficulty: "intermediate",
                    note: "Use sliders or towels on a smooth floor to perform a concentric and eccentric hamstring curl.",
                  },
                ],
                harder: [
                  {
                    name: "Single Leg Nordic Curls",
                    difficulty: "expert",
                    note: "An extremely advanced variation performed with one leg at a time.",
                  },
                  {
                    name: "Nordic Curls with added weight",
                    difficulty: "expert",
                    note: "Hold a weight plate against your chest to increase the resistance.",
                  },
                  {
                    name: "Razor Curls",
                    difficulty: "expert",
                    note: "A variation of the Nordic curl that involves hinging at the hips, targeting the hamstrings differently.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Glute-Ham Raises",
                  difficulty: "expert",
                  note: "A powerful exercise for the posterior chain, typically requiring a GHD machine.",
                },
                {
                  name: "Single-Leg RDL (bodyweight)",
                  difficulty: "intermediate",
                  note: "A bodyweight hinge movement that challenges balance and hamstring strength.",
                },
                {
                  name: "Slider Leg Curls",
                  difficulty: "intermediate",
                  note: "Use sliders or towels on a smooth floor to mimic a hamstring curl motion.",
                },
              ],
            },
            {
              name: "Hanging Knee Raises",
              baseName: "Hanging Knee Raises",
              difficulty: "intermediate",
              sets: "4",
              reps: "15-20",
              rest: 60,
              note: "Avoid swinging. If no bar, do lying leg raises.",
              variations: {
                easier: [
                  {
                    name: "Lying Knee Tucks",
                    difficulty: "beginner",
                    note: "Lie on your back and bring your knees to your chest to mimic the movement without the grip strength requirement.",
                  },
                  {
                    name: "Reverse Crunches",
                    difficulty: "beginner",
                    note: "Lie on your back and lift your hips off the floor, bringing your knees towards your chest.",
                  },
                  {
                    name: "Chair Knee Raises",
                    difficulty: "beginner",
                    note: "Sit on the edge of a chair and raise your knees to your chest to work the lower abs.",
                  },
                ],
                harder: [
                  {
                    name: "Hanging Leg Raises",
                    difficulty: "intermediate",
                    note: "Perform the movement with straight legs to increase the lever length and difficulty.",
                  },
                  {
                    name: "Windshield Wipers (hanging)",
                    difficulty: "expert",
                    note: "From a hanging leg raise position, rotate your legs from side to side like windshield wipers.",
                  },
                  {
                    name: "Toes-to-Bar",
                    difficulty: "expert",
                    note: "A CrossFit staple, bring your toes all the way up to touch the bar you are hanging from.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Lying Leg Raises",
                  difficulty: "beginner",
                  note: "Lie on your back and raise your legs towards the ceiling to target the lower abs.",
                },
                {
                  name: "Reverse Crunches",
                  difficulty: "beginner",
                  note: "Lie on your back and bring your knees towards your chest, lifting your hips off the floor.",
                },
                {
                  name: "V-Ups",
                  difficulty: "intermediate",
                  note: "A challenging core exercise where you simultaneously lift your legs and torso to form a 'V' shape.",
                },
              ],
            },
            {
              name: "Plank",
              baseName: "Plank",
              sets: "3",
              reps: "60 seconds",
              rest: 60,
              note: "Keep a straight line from head to heels.",
              variations: {
                easier: [
                  {
                    name: "Knee Plank",
                    difficulty: "beginner",
                    note: "Perform the plank on your knees to reduce the load on your core.",
                  },
                  {
                    name: "Incline Plank",
                    difficulty: "beginner",
                    note: "Place your hands on an elevated surface to decrease the difficulty.",
                  },
                  {
                    name: "Forearm Plank",
                    difficulty: "beginner",
                    note: "Perform the plank on your forearms, which can be more stable for some people than a high plank.",
                  },
                ],
                harder: [
                  {
                    name: "Plank with Arm/Leg Lift",
                    difficulty: "intermediate",
                    note: "From a plank position, lift one arm or leg off the ground to challenge your stability.",
                  },
                  {
                    name: "Long Lever Plank",
                    difficulty: "intermediate",
                    note: "Walk your hands or elbows further forward to increase the lever and the demand on your core.",
                  },
                  {
                    name: "RKC Plank",
                    difficulty: "intermediate",
                    note: "A high-tension plank where you actively squeeze all your muscles, making it much more challenging for a shorter duration.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Side Plank",
                  difficulty: "intermediate",
                  note: "An isometric core exercise that targets the obliques and improves lateral stability.",
                },
                {
                  name: "Hollow Body Hold",
                  difficulty: "intermediate",
                  note: "A fundamental gymnastics core exercise. Lie on your back and lift your arms and legs off the floor, creating a 'hollow' shape.",
                },
                {
                  name: "Plank with Shoulder Taps",
                  difficulty: "intermediate",
                  note: "From a plank position, slowly tap each shoulder with the opposite hand, focusing on core stability.",
                },
              ],
            },
          ],
          cooldown: [
            "5 min Gentle Walking or Movement",
            "Seated Forward Fold (60s - deep breathing)",
            "Pigeon Pose with Forward Fold (45s each side)",
            "Supine Figure-4 Stretch (30s each side)",
            "Lying Spinal Twist with Extended Arms (45s each side)",
            "Legs Up Wall Pose or Bent Knees to Chest (60s)",
          ],
        },
        thursday: {
          day: "Thursday",
          title: "Endurance & Conditioning",
          subtitle: "Metabolic Circuit",
          warmup: [
            "3 min Light Movement (marching or easy stepping)",
            "Arm Swings & Shoulder Rolls (30s each direction)",
            "Hip Circles & Gentle Leg Swings (10 each direction)",
            "Torso Twists with Reach (15 each side)",
            "Jumping Jacks or Step-Touches (45s)",
            "Mountain Climbers or Marching in Place (30s)",
          ],
          exercises: [
            {
              name: "Burpees",
              baseName: "Burpees",
              difficulty: "intermediate",
              sets: "3-5",
              reps: "15",
              note: "Full range of motion, chest to ground.",
              variations: {
                easier: [
                  {
                    name: "Squat Thrusts",
                    difficulty: "beginner",
                    note: "A simplified burpee without the push-up or jump.",
                  },
                  {
                    name: "No-Push-up Burpees",
                    difficulty: "beginner",
                    note: "Perform the burpee but omit the push-up at the bottom.",
                  },
                  {
                    name: "Step-Back Burpees",
                    difficulty: "beginner",
                    note: "Instead of jumping your feet back, step them back one at a time for a lower-impact version.",
                  },
                ],
                harder: [
                  {
                    name: "Burpee with Tuck Jump",
                    difficulty: "intermediate",
                    note: "Add a high tuck jump at the end of each burpee.",
                  },
                  {
                    name: "Burpee Pull-up",
                    difficulty: "expert",
                    note: "Perform a burpee under a pull-up bar and jump into a pull-up at the end.",
                  },
                  {
                    name: "One-Legged Burpee",
                    difficulty: "expert",
                    note: "Perform the entire burpee on one leg for a serious balance and strength challenge.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Squat Thrusts",
                  difficulty: "beginner",
                  note: "A simpler version of a burpee without the push-up or jump. Focus on speed and continuous movement.",
                },
                {
                  name: "Jumping Jacks with Push-up",
                  difficulty: "intermediate",
                  note: "Perform a jumping jack, then drop down for a push-up. A great conditioning combo.",
                },
              ],
            },
            {
              name: "Jumping Lunges",
              baseName: "Jumping Lunges",
              difficulty: "intermediate",
              sets: "3-5",
              reps: "30",
              note: "Explode up and switch legs mid-air.",
              variations: {
                easier: [
                  {
                    name: "Alternating Lunges",
                    difficulty: "beginner",
                    note: "A non-plyometric version where you step into each lunge.",
                  },
                  {
                    name: "Reverse Lunges",
                    difficulty: "beginner",
                    note: "Step backward into a lunge, which can be easier on the knees.",
                  },
                  {
                    name: "Static Lunge",
                    difficulty: "beginner",
                    note: "Hold the lunge position for time to build isometric strength.",
                  },
                ],
                harder: [
                  {
                    name: "Scissor Jumps",
                    difficulty: "intermediate",
                    note: "A faster, shorter-range version of jumping lunges, focusing on speed.",
                  },
                  {
                    name: "Weighted Jumping Lunges",
                    difficulty: "expert",
                    note: "Hold dumbbells or wear a weighted vest to increase the intensity.",
                  },
                  {
                    name: "Jumping Lunge with Twist",
                    difficulty: "intermediate",
                    note: "Add a torso twist at the bottom of each lunge to engage the core.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Alternating Lunges",
                  difficulty: "beginner",
                  note: "A less explosive version of jumping lunges. Focus on controlled movement and proper form.",
                },
                {
                  name: "Squat Jumps",
                  difficulty: "beginner",
                  note: "A powerful lower body plyometric exercise that serves as a great alternative for conditioning.",
                },
              ],
            },
            {
              name: "Mountain Climbers",
              baseName: "Mountain Climbers",
              difficulty: "beginner",
              sets: "3-5",
              reps: "50",
              note: "Keep your hips low and core tight.",
              variations: {
                easier: [
                  {
                    name: "Slow Mountain Climbers",
                    difficulty: "beginner",
                    note: "Perform the movement slowly and deliberately to focus on core engagement.",
                  },
                  {
                    name: "Incline Mountain Climbers",
                    difficulty: "beginner",
                    note: "Place your hands on an elevated surface to reduce the load.",
                  },
                  {
                    name: "Standing High Knees",
                    difficulty: "beginner",
                    note: "A standing version that removes the upper body and core stability challenge.",
                  },
                ],
                harder: [
                  {
                    name: "Cross-Body Mountain Climbers",
                    difficulty: "intermediate",
                    note: "Bring your knee to the opposite elbow to engage the obliques more.",
                  },
                  {
                    name: "Spider-Man Climbers",
                    difficulty: "intermediate",
                    note: "Bring your knee to the outside of your elbow, opening up the hips.",
                  },
                  {
                    name: "Decline Mountain Climbers",
                    difficulty: "intermediate",
                    note: "Place your feet on an elevated surface to increase the challenge on your core and shoulders.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "High Knees",
                  difficulty: "beginner",
                  note: "A standing alternative to mountain climbers that keeps the heart rate high.",
                },
                {
                  name: "Plank Jacks",
                  difficulty: "intermediate",
                  note: "From a plank position, jump your feet wide and then back together, challenging the core and cardio.",
                },
              ],
            },
            {
              name: "Push-ups",
              baseName: "Push-ups",
              difficulty: "beginner",
              sets: "3-5",
              reps: "25",
              note: "Break into smaller sets if needed.",
              variations: {
                easier: [
                  {
                    name: "Knee Push-ups",
                    difficulty: "beginner",
                    note: "Perform push-ups on your knees to reduce the amount of bodyweight you're lifting.",
                  },
                  {
                    name: "Incline Push-ups",
                    difficulty: "beginner",
                    note: "Place your hands on a wall or bench to make the push-up easier.",
                  },
                  {
                    name: "Wall Push-ups",
                    difficulty: "beginner",
                    note: "The easiest variation, performed standing against a wall.",
                  },
                ],
                harder: [
                  {
                    name: "Decline Push-ups",
                    difficulty: "intermediate",
                    note: "Elevate your feet to shift more emphasis to the upper chest and shoulders.",
                  },
                  {
                    name: "Diamond Push-ups",
                    difficulty: "intermediate",
                    note: "Place your hands close together in a diamond shape to target the triceps.",
                  },
                  {
                    name: "Clapping Push-ups",
                    difficulty: "intermediate",
                    note: "An explosive variation where you clap your hands at the top of the movement.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Knee Push-ups",
                  difficulty: "beginner",
                  note: "A modified push-up performed on the knees to reduce the overall weight being lifted.",
                },
                {
                  name: "Incline Push-ups",
                  difficulty: "beginner",
                  note: "Perform push-ups with your hands on an elevated surface to make the exercise easier.",
                },
              ],
            },
          ],
          cooldown: [
            "5 min Slow Walking with Deep Breathing",
            "Standing Forward Fold with Sway (60s)",
            "Doorway Chest Stretch (45s each arm position)",
            "Upper Trap & Neck Release (30s each side)",
            "Standing Quad & Hip Flexor Stretch (30s each side)",
            "Gentle Spinal Twist Seated or Standing (30s each side)",
            "Deep Breathing with Progressive Muscle Relaxation (2 min)",
          ],
        },
        friday: {
          day: "Friday",
          title: "Strength & Size",
          subtitle: "Full Body",
          warmup: [
            "5 min Easy Movement (light jogging or dynamic walking)",
            "Full Body Stretch Sequence - Inchworms (8 reps)",
            "World's Greatest Stretch - Hip Flexor & Rotation (30s each side)",
            "Scapular Wall Slides or Pull-up Bar Hangs (10 reps or 20s hold)",
            "Thoracic Spine Extension over Chair/Ball (10 reps)",
            "Shoulder Dislocations with Band or Towel (15 reps)",
          ],
          exercises: [
            {
              name: "Handstand Push-ups",
              baseName: "Handstand Push-ups",
              difficulty: "expert",
              sets: "3",
              reps: "5-10",
              rest: 120,
              note: "Against a wall. A key for shoulder strength.",
              variations: {
                easier: [
                  {
                    name: "Pike Push-Ups",
                    difficulty: "intermediate",
                    note: "Elevate your hips to create a V-shape with your body, placing more emphasis on the shoulders.",
                  },
                  {
                    name: "Decline Pike Push-ups",
                    difficulty: "intermediate",
                    note: "Perform pike push-ups with your feet on a box to increase the angle and difficulty.",
                  },
                  {
                    name: "Wall Walks",
                    difficulty: "intermediate",
                    note: "Start in a push-up position and walk your feet up a wall to get comfortable being inverted.",
                  },
                ],
                harder: [
                  {
                    name: "Freestanding Handstand Push-Up Negatives",
                    difficulty: "expert",
                    note: "Kick up to a freestanding handstand and slowly lower yourself down.",
                  },
                  {
                    name: "90-Degree Push-ups",
                    difficulty: "expert",
                    note: "A highly advanced movement involving a transition from a handstand to a planche.",
                  },
                  {
                    name: "Full Freestanding Handstand Push-ups",
                    difficulty: "expert",
                    note: "The ultimate bodyweight shoulder exercise, performed without wall support.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Pike Push-ups",
                  difficulty: "intermediate",
                  note: "A progression towards handstand push-ups that elevates the hips to place more emphasis on the shoulders.",
                },
                {
                  name: "Decline Pike Push-ups",
                  difficulty: "intermediate",
                  note: "Perform pike push-ups with your feet on a box to increase the angle and difficulty.",
                },
              ],
            },
            {
              name: "Inverted Rows",
              baseName: "Inverted Rows",
              difficulty: "intermediate",
              sets: "3",
              reps: "To Failure",
              rest: 120,
              note: "Pull your chest towards the edge of the table.",
              variations: {
                easier: [
                  {
                    name: "Towel Rows",
                    difficulty: "beginner",
                    note: "A versatile pulling exercise using a towel, great for grip strength.",
                  },
                  {
                    name: "Wall Pull-downs",
                    difficulty: "beginner",
                    note: "Stand facing a wall and mimic a lat pull-down motion to activate the back muscles.",
                  },
                  {
                    name: "Bent Knee Inverted Rows",
                    difficulty: "beginner",
                    note: "Bend your knees to 90 degrees to make the inverted row easier.",
                  },
                ],
                harder: [
                  {
                    name: "Feet Elevated Inverted Rows",
                    difficulty: "intermediate",
                    note: "Increase the difficulty by placing your feet on an elevated surface.",
                  },
                  {
                    name: "Archer Rows",
                    difficulty: "expert",
                    note: "A unilateral variation that increases the load on one arm at a time.",
                  },
                  {
                    name: "Single-Arm Inverted Rows",
                    difficulty: "expert",
                    note: "Perform the entire row using only one arm, a significant challenge for back and grip strength.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Resistance Band Rows",
                  difficulty: "beginner",
                  note: "Use a resistance band anchored to a door or stable object. Pull handles toward chest while squeezing shoulder blades.",
                },
                {
                  name: "Towel Rows",
                  difficulty: "beginner",
                  note: "Use a towel hooked around a pole or door handle to perform a horizontal pulling motion.",
                },
                {
                  name: "Pull-Ups",
                  difficulty: "intermediate",
                  note: "A challenging vertical pulling exercise for the back and biceps.",
                },
                {
                  name: "Chin-Ups",
                  difficulty: "beginner",
                  note: "Pull-ups with underhand grip, emphasizing biceps and allowing easier progression for beginners.",
                },
                {
                  name: "Assisted Pull-Ups",
                  difficulty: "beginner",
                  note: "Use a resistance band or have someone assist to make pull-ups more accessible while building strength.",
                },
                {
                  name: "Negative Pull-Ups",
                  difficulty: "beginner",
                  note: "Jump or step up to the top position and slowly lower yourself down. Builds eccentric strength.",
                },
                {
                  name: "Dead Hangs",
                  difficulty: "beginner",
                  note: "Simply hang from a bar to build grip strength and prepare for pull-ups. Progress to scapular pulls.",
                },
                {
                  name: "Scapular Pull-Ups",
                  difficulty: "beginner",
                  note: "Hang from bar and pull shoulder blades down and back without bending elbows. Great for activation.",
                },
              ],
            },
            {
              name: "Bodyweight Squats (Tempo)",
              baseName: "Bodyweight Squats (Tempo)",
              difficulty: "beginner",
              sets: "3",
              reps: "15",
              rest: 90,
              note: "Slow on the way down (3 sec), pause (1 sec), explode up.",
              variations: {
                easier: [
                  {
                    name: "Assisted Squats",
                    difficulty: "beginner",
                    note: "Hold onto a support for balance while you perform the squat.",
                  },
                  {
                    name: "Box Squats",
                    difficulty: "beginner",
                    note: "Squat down to a box or chair to ensure consistent depth and provide a brief rest.",
                  },
                  {
                    name: "Regular Bodyweight Squats",
                    difficulty: "beginner",
                    note: "Perform squats at a normal pace without the specific tempo.",
                  },
                ],
                harder: [
                  {
                    name: "Pause Squats",
                    difficulty: "intermediate",
                    note: "Hold the bottom position of the squat for a few seconds to increase time under tension.",
                  },
                  {
                    name: "Jump Squats",
                    difficulty: "intermediate",
                    note: "Add an explosive jump at the top of the squat to make it plyometric.",
                  },
                  {
                    name: "Weighted Squats (backpack)",
                    difficulty: "intermediate",
                    note: "Wear a backpack with some weight in it to increase the resistance.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Pause Squats",
                  difficulty: "intermediate",
                  note: "Hold the bottom position of the squat for a few seconds to increase time under tension.",
                },
                {
                  name: "Goblet Squats (with backpack)",
                  difficulty: "intermediate",
                  note: "Hold a weight (like a backpack) at chest level while squatting to add resistance.",
                },
              ],
            },
            {
              name: "Glute Bridges (Single Leg)",
              baseName: "Glute Bridges (Single Leg)",
              difficulty: "intermediate",
              sets: "3",
              reps: "12-15 per leg",
              rest: 60,
              note: "Squeeze your glutes at the top.",
              variations: {
                easier: [
                  {
                    name: "Short-Lever Glute Bridge",
                    difficulty: "beginner",
                    note: "Bend your knees more and bring your feet closer to your glutes to make the bridge easier.",
                  },
                  {
                    name: "Marching Glute Bridge",
                    difficulty: "beginner",
                    note: "From a standard glute bridge, alternate lifting one knee at a time.",
                  },
                  {
                    name: "Glute Bridges (both legs)",
                    difficulty: "beginner",
                    note: "The standard two-legged glute bridge, a great starting point.",
                  },
                ],
                harder: [
                  {
                    name: "Hip Thrusts (elevated back)",
                    difficulty: "intermediate",
                    note: "Place your upper back on a bench to increase the range of motion.",
                  },
                  {
                    name: "Weighted Single Leg Glute Bridge",
                    difficulty: "expert",
                    note: "Place a weight on your hips to increase the resistance.",
                  },
                  {
                    name: "Single Leg Hip Thrusts",
                    difficulty: "expert",
                    note: "Perform a hip thrust on one leg with your back elevated for maximum difficulty.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Hip Thrusts (on floor)",
                  difficulty: "intermediate",
                  note: "Similar to a glute bridge but with a larger range of motion, often performed with the back on a bench.",
                },
                {
                  name: "Step-Ups",
                  difficulty: "beginner",
                  note: "A great unilateral exercise for building glute and leg strength. Step onto a stable platform.",
                },
                {
                  name: "Reverse Lunges",
                  difficulty: "beginner",
                  note: "Step backward into a lunge. This variation can be easier on the knees than a forward lunge.",
                },
              ],
            },
            {
              name: "Diamond Push-ups",
              baseName: "Diamond Push-ups",
              sets: "3",
              reps: "To Failure",
              rest: 90,
              note: "Keep your hands close to target the triceps.",
              variations: {
                easier: [
                  {
                    name: "Incline Diamond Push-ups",
                    difficulty: "beginner",
                    note: "Perform diamond push-ups with your hands on an elevated surface.",
                  },
                  {
                    name: "Knee Diamond Push-ups",
                    difficulty: "beginner",
                    note: "Perform diamond push-ups on your knees to reduce the load.",
                  },
                  {
                    name: "Close-Grip Push-ups",
                    difficulty: "beginner",
                    note: "A slightly easier variation where your hands are close but not touching.",
                  },
                ],
                harder: [
                  {
                    name: "Decline Diamond Push-ups",
                    difficulty: "intermediate",
                    note: "Elevate your feet to increase the load on your triceps and upper chest.",
                  },
                  {
                    name: "Weighted Diamond Push-ups",
                    difficulty: "expert",
                    note: "Wear a weighted vest or have a plate on your back to add resistance.",
                  },
                  {
                    name: "One-Arm Diamond Push-up (assisted)",
                    difficulty: "expert",
                    note: "A very advanced progression towards a one-arm push-up with a triceps focus.",
                  },
                ],
              },
              alternatives: [
                {
                  name: "Tricep Extensions (on floor)",
                  difficulty: "intermediate",
                  note: "Lie on your back and use your triceps to push your body up from your elbows.",
                },
                {
                  name: "Bench Dips",
                  difficulty: "beginner",
                  note: "Use a bench or chair to perform dips, a classic triceps-building exercise.",
                },
              ],
            },
          ],
          cooldown: [
            "10 min Slow Walk",
            "Shoulder Stretches (30s each)",
            "Quad & Hamstring Stretches",
            "Child's Pose (60s)",
          ],
        },
        saturday: {
          day: "Saturday",
          title: "Active Recovery & Posture",
          subtitle: "Repair, Mobilize & Correct",
          warmup: [
            "5 min Gentle Movement (walking or easy stretching)",
            "Deep Breathing with Posture Check (2 min)",
            "Gentle Neck Rolls & Shoulder Shrugs (1 min)",
          ],
          exercises: [
            {
              name: "Posture Correction Sequence",
              baseName: "Posture Correction Sequence",
              sets: "3",
              reps: "15-20 mins",
              note: "Focus on upper crossed syndrome: doorway chest stretch, chin tucks, wall angels, thoracic extension.",
              variations: {
                easier: [],
                harder: [],
              },
              alternatives: [
                {
                  name: "Desk Worker Stretch Routine",
                  difficulty: "beginner",
                  note: "Hip flexor stretches, seated spinal twists, neck stretches, and shoulder blade squeezes.",
                },
                {
                  name: "Forward Head Posture Correction",
                  difficulty: "beginner",
                  note: "Chin tucks, upper trap stretches, and strengthening rear delts and deep neck flexors.",
                },
              ],
            },
            {
              name: "Deep Myofascial Release",
              baseName: "Deep Myofascial Release",
              sets: "-",
              reps: "15-20 mins",
              note: "Target tight areas: IT band, calves, upper traps, chest, and hip flexors. Use tennis ball or foam roller.",
              variations: {
                easier: [],
                harder: [],
              },
              alternatives: [
                {
                  name: "Tennis Ball Trigger Points",
                  difficulty: "beginner",
                  note: "Use tennis ball against wall for upper back, under foot for plantar fascia, and lying down for glutes.",
                },
                {
                  name: "Dynamic Stretching Flow",
                  difficulty: "beginner",
                  note: "Perform cat-cow, hip circles, arm swings, and gentle spinal rotations.",
                },
              ],
            },
            {
              name: "Meditation with Body Scan",
              baseName: "Meditation with Body Scan",
              sets: "-",
              reps: "10-15 mins",
              note: "Mindful awareness of posture and tension areas. Focus on releasing stress-held patterns.",
              variations: {
                easier: [],
                harder: [],
              },
              alternatives: [
                {
                  name: "Progressive Muscle Relaxation",
                  difficulty: "beginner",
                  note: "Systematically tense and release muscle groups to identify and release chronic tension.",
                },
                {
                  name: "Breathing with Postural Awareness",
                  difficulty: "beginner",
                  note: "Practice diaphragmatic breathing while maintaining optimal spine alignment.",
                },
              ],
            },
          ],
          cooldown: [
            "Gentle Full Body Stretch (10 min)",
            "Legs Up Wall Pose (5 min)",
            "Final Relaxation with Deep Breathing (5 min)",
          ],
        },
        sunday: {
          day: "Sunday",
          title: "Complete Rest",
          subtitle: "Eat, Hydrate, Recover",
          warmup: [],
          exercises: [
            { name: "Mental Training", note: "Visualize your goals." },
            { name: "Meal Prep", note: "Prepare meals to stay on track." },
            { name: "Hydrate", note: "Drink plenty of water." },
          ],
          cooldown: [],
        },
      };
      workoutPlan = JSON.parse(JSON.stringify(originalWorkoutPlan));
      
      // Make workoutPlan globally accessible
      window.workoutPlan = workoutPlan;

      const allExercisesMasterList = Object.values(originalWorkoutPlan)
        .flatMap((day) => day.exercises || [])
        .reduce((acc, ex) => {
          if (ex.baseName) {
            if (!acc[ex.name]) {
              // Use ex.name to ensure base exercises are added
              acc[ex.name] = JSON.parse(JSON.stringify(ex));
            }
            if (ex.variations) {
              // Handle easier and harder variations as arrays of objects
              ["easier", "harder"].forEach((diff) => {
                if (Array.isArray(ex.variations[diff])) {
                  ex.variations[diff].forEach((variationObj) => {
                    if (variationObj && variationObj.name && !acc[variationObj.name]) {
                      const variationEx = {
                        ...JSON.parse(JSON.stringify(ex)),
                        name: variationObj.name,
                        note: variationObj.note, // Use the specific note for the variation
                        baseName: ex.baseName, // Link back to the base
                        variations: ex.variations, // Keep variations for further swaps
                      };
                      acc[variationObj.name] = variationEx;
                    }
                  });
                }
              });
            }
            if (ex.alternatives) {
              ex.alternatives.forEach((alt) => {
                if (!acc[alt.name]) {
                  const otherAlts = ex.alternatives
                    .filter((a) => a.name !== alt.name)
                    .map((a) => ({ name: a.name, note: a.note }));

                  const altEx = {
                    ...JSON.parse(JSON.stringify(ex)),
                    name: alt.name,
                    note: alt.note, // Use the specific note from the alternative
                    baseName: alt.name, // Treat it as its own base
                    variations: {}, // Alternatives typically don't have variations in this model
                    alternatives: [
                      { name: ex.name, note: ex.note }, // Add the original exercise
                      ...otherAlts,
                    ],
                  };
                  acc[alt.name] = altEx;
                }
              });
            }
          }
          return acc;
        }, {});

      // Make allExercisesMasterList globally accessible
      window.allExercisesMasterList = allExercisesMasterList;

      // --- Muscle Group Mapping System ---
      const muscleGroupMapping = {
        // Push Exercises
        "Push-ups": { primary: ["muscle-chest"], secondary: ["muscle-shoulders-front", "muscle-triceps-left", "muscle-triceps-right", "muscle-core"], view: "front", tip: "Keep your core tight and lower slowly for maximum chest activation." },
        "Standard Push-ups": { primary: ["muscle-chest"], secondary: ["muscle-shoulders-front", "muscle-triceps-left", "muscle-triceps-right", "muscle-core"], view: "front", tip: "Maintain a straight line from head to heels throughout the movement." },
        "Wide Push-ups": { primary: ["muscle-chest"], secondary: ["muscle-shoulders-front"], view: "front", tip: "Wide hand placement emphasizes outer chest development." },
        "Diamond Push-ups": { primary: ["muscle-triceps-left", "muscle-triceps-right"], secondary: ["muscle-chest"], view: "back", tip: "Keep elbows tucked close to your body for maximum tricep engagement." },
        "Pike Push-ups": { primary: ["muscle-shoulders-front"], secondary: ["muscle-triceps-left", "muscle-triceps-right"], view: "front", tip: "Form an inverted V with your body for optimal shoulder activation." },
        "Archer Push-ups": { primary: ["muscle-chest"], secondary: ["muscle-shoulders-front", "muscle-triceps-left", "muscle-triceps-right"], view: "front", tip: "Shift your weight side to side for unilateral chest development." },
        "Explosive Push-ups": { primary: ["muscle-chest"], secondary: ["muscle-shoulders-front", "muscle-triceps-left", "muscle-triceps-right"], view: "front", tip: "Generate explosive power from your chest to propel yourself upward." },
        
        // Pull Exercises
        "Pull-ups": { primary: ["muscle-lats", "muscle-traps"], secondary: ["muscle-biceps-left", "muscle-biceps-right", "muscle-shoulders-back"], view: "back", tip: "Pull with your back muscles, not just your arms. Imagine pulling your elbows down." },
        "Chin-ups": { primary: ["muscle-biceps-left", "muscle-biceps-right"], secondary: ["muscle-lats", "muscle-traps"], view: "back", tip: "Underhand grip increases bicep activation. Focus on the squeeze at the top." },
        "Australian Pull-ups": { primary: ["muscle-lats", "muscle-traps"], secondary: ["muscle-biceps-left", "muscle-biceps-right"], view: "back", tip: "Keep body straight and pull chest to the bar for optimal back engagement." },
        "Door Frame Rows": { primary: ["muscle-lats", "muscle-traps"], secondary: ["muscle-biceps-left", "muscle-biceps-right"], view: "back", tip: "Pull your shoulder blades together at the peak contraction." },
        "Scapular Pull-ups": { primary: ["muscle-traps", "muscle-shoulders-back"], secondary: ["muscle-lats"], view: "back", tip: "Focus purely on shoulder blade depression and retraction." },
        
        // Leg Exercises
        "Squats": { primary: ["muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right", "muscle-core"], view: "front", tip: "Keep weight on your heels and push through the floor to stand." },
        "Bulgarian Split Squats": { primary: ["muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right"], view: "front", tip: "Keep torso upright and drive through the front heel." },
        "Lunges": { primary: ["muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right"], view: "front", tip: "Take a full stride forward and drop your back knee toward the ground." },
        "Jump Squats": { primary: ["muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right", "muscle-calves-left", "muscle-calves-right"], view: "front", tip: "Land softly and immediately descend into the next rep." },
        "Pistol Squats": { primary: ["muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right", "muscle-core"], view: "front", tip: "Extend your non-working leg forward for balance. This is an advanced movement." },
        "Calf Raises": { primary: ["muscle-calves-left", "muscle-calves-right"], secondary: [], view: "front", tip: "Rise onto your toes and hold the peak contraction for a second." },
        "Nordic Curls": { primary: ["muscle-hamstrings-left", "muscle-hamstrings-right"], secondary: ["muscle-glutes-left", "muscle-glutes-right"], view: "back", tip: "Control the eccentric portion slowly to maximize hamstring development." },
        "Glute Bridges": { primary: ["muscle-glutes-left", "muscle-glutes-right"], secondary: ["muscle-hamstrings-left", "muscle-hamstrings-right", "muscle-lower-back"], view: "back", tip: "Squeeze your glutes at the top and hold for a second." },
        "Single-Leg Glute Bridges": { primary: ["muscle-glutes-left", "muscle-glutes-right"], secondary: ["muscle-hamstrings-left", "muscle-hamstrings-right"], view: "back", tip: "Keep hips level throughout the movement for balanced glute development." },
        
        // Core Exercises
        "Plank": { primary: ["muscle-core"], secondary: ["muscle-shoulders-front", "muscle-glutes-left", "muscle-glutes-right"], view: "front", tip: "Maintain a straight line from head to heels. Don't let your hips sag." },
        "Side Plank": { primary: ["muscle-core"], secondary: ["muscle-shoulders-front"], view: "front", tip: "Stack your feet and keep your body in a straight line." },
        "Mountain Climbers": { primary: ["muscle-core"], secondary: ["muscle-shoulders-front", "muscle-quads-left", "muscle-quads-right"], view: "front", tip: "Drive your knees toward your chest while maintaining plank position." },
        "Bicycle Crunches": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Twist your torso to bring opposite elbow to knee. Focus on the obliques." },
        "Russian Twists": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Rotate your torso fully from side to side for oblique activation." },
        "Leg Raises": { primary: ["muscle-core"], secondary: ["muscle-hips-front"], view: "front", tip: "Keep lower back pressed to the floor and control the descent." },
        "V-Ups": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Reach for your toes while keeping legs straight for maximum core engagement." },
        "Dead Bug": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Keep your lower back pressed to the floor throughout the movement." },
        "Bird Dog": { primary: ["muscle-core", "muscle-lower-back"], secondary: ["muscle-glutes-left", "muscle-glutes-right"], view: "back", tip: "Extend opposite arm and leg while keeping your core braced." },
        "Hollow Body Hold": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Press your lower back into the floor and maintain the hollow position." },
        
        // Full Body
        "Burpees": { primary: ["muscle-chest", "muscle-quads-left", "muscle-quads-right"], secondary: ["muscle-shoulders-front", "muscle-core", "muscle-calves-left", "muscle-calves-right"], view: "front", tip: "Move explosively and maintain proper push-up form." },
        "Turkish Get-ups": { primary: ["muscle-core", "muscle-shoulders-front"], secondary: ["muscle-quads-left", "muscle-quads-right", "muscle-glutes-left", "muscle-glutes-right"], view: "front", tip: "Move slowly and deliberately through each phase of the movement." },
        "Jumping Jacks": { primary: ["muscle-shoulders-front", "muscle-calves-left", "muscle-calves-right"], secondary: ["muscle-core"], view: "front", tip: "Keep a steady rhythm and fully extend arms overhead." },
        
        // Shoulder Specific
        "Pike Push-ups": { primary: ["muscle-shoulders-front"], secondary: ["muscle-triceps-left", "muscle-triceps-right"], view: "front", tip: "Keep hips high and push through your shoulders." },
        "Handstand Push-ups": { primary: ["muscle-shoulders-front"], secondary: ["muscle-triceps-left", "muscle-triceps-right", "muscle-core"], view: "front", tip: "Advanced movement - ensure proper technique against a wall first." },
        "Shoulder Taps": { primary: ["muscle-shoulders-front"], secondary: ["muscle-core", "muscle-chest"], view: "front", tip: "Minimize hip rotation while alternating shoulder taps." },
        
        // Default fallback
        "default": { primary: ["muscle-core"], secondary: [], view: "front", tip: "Focus on proper form and controlled movement throughout each rep." }
      };

      // Muscle Group Modal Functions
      let currentMuscleView = "front";
      
      window.showMuscleGroupModal = function(exerciseName) {
        const modal = document.getElementById("muscle-group-modal");
        const exerciseNameEl = document.getElementById("muscle-exercise-name");
        const muscleGroupsList = document.getElementById("muscle-groups-list");
        const muscleTip = document.getElementById("muscle-tip");
        
        // Get muscle mapping or use default
        const mapping = muscleGroupMapping[exerciseName] || muscleGroupMapping["default"];
        
        // Set exercise name
        exerciseNameEl.textContent = exerciseName;
        
        // Set tip
        muscleTip.textContent = mapping.tip;
        
        // Reset view to preferred view for this exercise
        currentMuscleView = mapping.view;
        updateMuscleView();
        
        // Highlight muscles
        highlightMuscles(mapping.primary, mapping.secondary);
        
        // Build muscle groups list
        const primaryNames = getMuscleGroupNames(mapping.primary);
        const secondaryNames = getMuscleGroupNames(mapping.secondary);
        
        muscleGroupsList.innerHTML = `
          <div class="bg-red-900/20 p-3 rounded-lg border border-red-500/30">
            <h4 class="font-bold text-red-400 mb-2">üéØ Primary Muscles</h4>
            <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
              ${primaryNames.map(name => `<li>${name}</li>`).join('')}
            </ul>
          </div>
          ${secondaryNames.length > 0 ? `
            <div class="bg-orange-900/20 p-3 rounded-lg border border-orange-500/30">
              <h4 class="font-bold text-orange-400 mb-2">‚ûï Secondary Muscles</h4>
              <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                ${secondaryNames.map(name => `<li>${name}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        `;
        
        // Show modal
        modal.classList.remove("hidden");
      };
      
      window.closeMuscleGroupModal = function() {
        const modal = document.getElementById("muscle-group-modal");
        modal.classList.add("hidden");
        
        // Reset all muscle highlights
        document.querySelectorAll('.muscle-highlight, .muscle-highlight-secondary').forEach(el => {
          el.classList.remove('muscle-highlight', 'muscle-highlight-secondary');
        });
      };
      
      window.toggleMuscleView = function() {
        currentMuscleView = currentMuscleView === "front" ? "back" : "front";
        updateMuscleView();
      };
      
      function updateMuscleView() {
        const frontView = document.getElementById("muscle-front");
        const backView = document.getElementById("muscle-back");
        const toggleBtn = document.getElementById("toggle-muscle-view");
        
        if (currentMuscleView === "front") {
          frontView.classList.remove("hidden");
          backView.classList.add("hidden");
          toggleBtn.textContent = "üîÑ Show Back View";
        } else {
          frontView.classList.add("hidden");
          backView.classList.remove("hidden");
          toggleBtn.textContent = "üîÑ Show Front View";
        }
      }
      
      function highlightMuscles(primary, secondary) {
        // Reset all highlights first
        document.querySelectorAll('.muscle-highlight, .muscle-highlight-secondary').forEach(el => {
          el.classList.remove('muscle-highlight', 'muscle-highlight-secondary');
        });
        
        // Highlight primary muscles
        primary.forEach(muscleId => {
          const element = document.getElementById(muscleId);
          if (element) {
            element.classList.add('muscle-highlight');
          }
        });
        
        // Highlight secondary muscles
        secondary.forEach(muscleId => {
          const element = document.getElementById(muscleId);
          if (element) {
            element.classList.add('muscle-highlight-secondary');
          }
        });
      }
      
      function getMuscleGroupNames(muscleIds) {
        const names = {
          "muscle-chest": "Chest (Pectorals)",
          "muscle-shoulders-front": "Shoulders (Deltoids)",
          "muscle-shoulders-back": "Shoulders (Deltoids)",
          "muscle-biceps-left": "Biceps",
          "muscle-biceps-right": "Biceps",
          "muscle-triceps-left": "Triceps",
          "muscle-triceps-right": "Triceps",
          "muscle-forearms-left": "Forearms",
          "muscle-forearms-right": "Forearms",
          "muscle-core": "Core (Abs & Obliques)",
          "muscle-lats": "Lats (Back)",
          "muscle-traps": "Traps (Upper Back)",
          "muscle-lower-back": "Lower Back",
          "muscle-quads-left": "Quadriceps",
          "muscle-quads-right": "Quadriceps",
          "muscle-hamstrings-left": "Hamstrings",
          "muscle-hamstrings-right": "Hamstrings",
          "muscle-glutes-left": "Glutes",
          "muscle-glutes-right": "Glutes",
          "muscle-calves-left": "Calves",
          "muscle-calves-right": "Calves",
          "muscle-calves-back-left": "Calves",
          "muscle-calves-back-right": "Calves",
          "muscle-hips-front": "Hip Flexors"
        };
        
        // Deduplicate names
        const uniqueNames = new Set();
        muscleIds.forEach(id => {
          if (names[id]) {
            uniqueNames.add(names[id]);
          }
        });
        
        return Array.from(uniqueNames);
      }

      // --- Accessibility: Focus trap for modals ---
      function trapFocus(modalEl) {
        if (!modalEl)
          return {
            release: () => {},
          };
        const focusableSelectors =
          'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])';
        const nodes = Array.from(
          modalEl.querySelectorAll(focusableSelectors)
        ).filter((n) => n.offsetParent !== null);
        if (!nodes.length) return { release: () => {} };
        let first = nodes[0];
        let last = nodes[nodes.length - 1];
        function handleKey(e) {
          if (e.key === "Tab") {
            if (e.shiftKey) {
              if (document.activeElement === first) {
                e.preventDefault();
                last.focus();
              }
            } else {
              if (document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          }
          if (e.key === "Escape") {
            // Let existing Escape handlers close the modal
          }
        }
        document.addEventListener("keydown", handleKey);
        // Focus the first element
        first.focus();
        return {
          release() {
            document.removeEventListener("keydown", handleKey);
          },
        };
      }

      // --- Generic modal open/close helpers ---
      // store last-focused element so we can restore focus after closing modal
      let _lastFocusedElement = null;
      function openGenericModal(modalEl, containerEl) {
        if (!modalEl) return;
        try {
          _lastFocusedElement = document.activeElement;
        } catch (e) {
          _lastFocusedElement = null;
        }

        // Defensive: if computed style hides the modal, force a visible display
        try {
          const cs =
            window.getComputedStyle && window.getComputedStyle(modalEl);
          if (cs && cs.display === "none") {
            modalEl.style.display = "flex";
          }
        } catch (e) {
          // ignore computedStyle failures
        }

        modalEl.classList.remove("hidden");
        // remove initial hiding classes
        modalEl.classList.remove("opacity-0");
        if (containerEl) containerEl.classList.remove("scale-95");
        // classes removed; proceed with trap and focus
        setTimeout(() => {
          modalEl.classList.remove("opacity-0");
          if (containerEl) containerEl.classList.remove("scale-95");
          try {
            if (_activeModalTrap && _activeModalTrap.release)
              _activeModalTrap.release();
          } catch (e) {}
          // Resolve trapFocus defensively
          const _trap =
            typeof trapFocus !== "undefined"
              ? trapFocus
              : window && window.trapFocus
              ? window.trapFocus
              : null;
          try {
            _activeModalTrap = _trap ? _trap(modalEl) : null;
          } catch (e) {}
          // Try to focus the modal's title for screen readers. Prefer aria-labelledby target if present.
          try {
            const labelledBy =
              modalEl.getAttribute && modalEl.getAttribute("aria-labelledby");
            let titleEl = null;
            if (labelledBy) titleEl = document.getElementById(labelledBy);
            // fallbacks for common IDs
            if (!titleEl)
              titleEl = modalEl.querySelector(
                '[id*="-title"],[id*="-modal-title"]'
              );
            if (titleEl && titleEl.focus) titleEl.focus();
          } catch (e) {}
        }, 10);
      }

      // intentionally do not expose internal helpers on window to keep global scope clean

      function closeGenericModal(modalEl, containerEl) {
        // reuse the existing closeModal which also releases the trap
        if (!modalEl) return;
        closeModal(modalEl, containerEl);
        // restore focus to the element that had focus before the modal opened
        setTimeout(() => {
          try {
            if (_lastFocusedElement && _lastFocusedElement.focus) {
              _lastFocusedElement.focus();
            }
          } catch (e) {}
          _lastFocusedElement = null;
        }, 320);
      }

      // --- DOM ELEMENTS ---
      const loadingState = document.getElementById("loading-state");
      const authContainer = document.getElementById("auth-container");
      const appContainer = document.getElementById("app-container");
      const emailInput = document.getElementById("email-input");
      const passwordInput = document.getElementById("password-input");
      const loginBtn = document.getElementById("login-btn");
      const signupBtn = document.getElementById("signup-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const authError = document.getElementById("auth-error");
      const userInfo = document.getElementById("user-info");

      const grid = document.getElementById("schedule-grid");
      const modal = document.getElementById("workout-modal");
      const modalContainer = document.getElementById("modal-content-container");
      const closeModalBtn = document.getElementById("close-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalSubtitle = document.getElementById("modal-subtitle");
      const modalContent = document.getElementById("modal-content");
      const completeWorkoutBtn = document.getElementById(
        "complete-workout-btn"
      );
      const startWorkoutBtn = document.getElementById("start-workout-btn");
      const progressBar = document.getElementById("progress-bar");
      const workoutsCompletedSpan =
        document.getElementById("workouts-completed");

      const timerModal = document.getElementById("timer-modal");
      const timerModalContainer = document.getElementById(
        "timer-modal-container"
      );
      const timerModalTitle = document.getElementById("timer-modal-title");
      const closeTimerModalBtn = document.getElementById("close-timer-modal");
      const timerDisplay = document.getElementById("timer-display");
      const timerControls = document.getElementById("timer-controls");
      // Startup debug removed
      const countdownInputContainer = document.getElementById(
        "countdown-input-container"
      );
      const tabataDisplay = document.getElementById("tabata-display");
      const enduranceDisplay = document.getElementById("endurance-display");
      const hiitDisplay = document.getElementById("hiit-display");
      const resetProgressBtn = document.getElementById("reset-progress-btn");
      const resetConfirmModal = document.getElementById("reset-confirm-modal");
      const resetModalContainer = document.getElementById(
        "reset-modal-container"
      );
      const cancelResetBtn = document.getElementById("cancel-reset-btn");
      const confirmResetBtn = document.getElementById("confirm-reset-btn");
      const toastContainer = document.getElementById("toast-container");
      // pending undo queue for recently-deleted workout history items
      let pendingUndos = [];
      // Single-delete confirmation modal elements
      const deleteConfirmModal = document.getElementById(
        "delete-confirm-modal"
      );
      const deleteModalContainer = document.getElementById(
        "delete-modal-container"
      );
      const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
      const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
      // holder for the doc snapshot that's pending user confirmation
      let __pendingDelete = null;
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      const pushupInput = document.getElementById("pushup-input");
      const addPushupsBtn = document.getElementById("add-pushups-btn");
      const pushupProgressBar = document.getElementById("pushup-progress-bar");
      const pushupCountText = document.getElementById("pushup-count-text");
      const dailyTaskTracker = document.getElementById("daily-task-tracker");
      const measurementsInputsAnalytics = document.getElementById(
        "measurements-inputs-analytics"
      );
      const measurementsInputsResources = document.getElementById(
        "measurements-inputs-resources"
      );
      const saveMeasurementsBtn = document.getElementById(
        "save-measurements-btn"
      );
      const alternativeModal = document.getElementById("alternative-modal");
      const alternativeModalContainer = document.getElementById(
        "alternative-modal-container"
      );
      const closeAlternativeModalBtn = document.getElementById(
        "close-alternative-modal"
      );
      const alternativeModalContent = document.getElementById(
        "alternative-modal-content"
      );
      const libraryContent = document.getElementById("library-content-section");
      const historyContainer = document.getElementById("history-container");
      const restTimerDynamicContent = document.getElementById(
        "rest-timer-dynamic-content"
      );
      const assessmentForm = document.getElementById("assessment-form");

      // --- APP STATE ---
      let state = {
        // Use a Set for fast has/size semantics; persist as array when saving to Firestore
        completedWorkouts: new Set(),
        pushupCounters: {},
        measurements: { figureType: "male", bodyType: "mesomorph" }, // Default states
        activeDay: null,
        activeExercise: null, // { dayKey, index }
        loggedSets: {}, // { [dayKey]: { [exerciseIndex]: [reps1, reps2, ...] } }
        currentWeek: null, // Track current week for automatic weekly reset
        timer: {
          interval: null,
          type: null,
          startTime: 0,
          elapsedTime: 0,
          running: false,
        },
        workoutStartTime: null, // Track when current workout was started
        workoutInProgress: false, // Track if user has started the workout (timer running)
        checkedInDay: null, // Track which day has completed check-in (only that day can be accessed)
        // ML-Enhanced Data Collection
        performanceHistory: [], // Historical workout data for ML analysis
        userPreferences: {
          preferredDifficulty: 'medium', // easy, medium, hard
          fitnessGoals: [], // strength, endurance, weight_loss, muscle_gain, flexibility
          timeAvailable: 30, // preferred workout duration in minutes
          injuryHistory: [], // body parts to avoid or modify
          equipmentAvailable: [], // available equipment
        },
        workoutFeedback: {}, // { [workoutId]: { enjoyment, difficulty, effectiveness, fatigue } }
        exerciseProgress: {}, // { [exerciseName]: { progressScore, lastModified, adaptations } }
        mlInsights: {
          strengthAreas: [], // exercises/muscle groups user excels at
          weaknessAreas: [], // exercises/muscle groups needing improvement
          recommendedFocus: null, // current recommended training focus
          lastAnalysis: null, // timestamp of last ML analysis
        },
        // Enhanced features
        unlockedAchievements: [], // Achievement IDs unlocked by user
        totalXP: 0, // Total experience points earned
        level: 1, // Current user level
        userGoals: [], // Personal fitness goals set by user
        weeklyChallenge: null, // Current weekly challenge
        nutritionData: null, // Nutrition and wellness tracking
        voiceCommandsEnabled: false, // Voice command preference
        socialSettings: { // Social and sharing preferences
          shareAchievements: true,
          publicProfile: false,
          joinChallenges: true
        },
        // EXTREME MODE TRACKING
        workoutStreak: 0, // Current consecutive workout days
        lastWorkoutDate: null, // Track for streak calculation
        personalRecords: {}, // Track PRs per exercise { exerciseName: { reps: X, date: 'YYYY-MM-DD', weight: X } }
        prHistory: [], // Array of all PR events
        fatigueScore: 0, // 0-100, calculated from recent workout intensity
        fatigueHistory: [], // Track fatigue over time
        intensityScores: [], // Daily workout intensity scores
        comboChains: [], // Track workout sequences for bonuses
        timeUnderTension: {}, // Track TUT per exercise
        sorenessHeatmap: {}, // Predicted muscle soreness by muscle group
        // AI Form Check
        formCheckActive: false,
        formCheckStream: null,
        formCheckHistory: [],
        // Wearable Integration
        wearableConnected: false,
        wearableDevice: null,
        wearableData: {
          heartRate: null,
          steps: 0,
          caloriesBurned: 0,
          lastSync: null
        }
      };

      // Make state globally accessible
      window.state = state;

      const measurementPartsMale = {
        neck: { label: "Neck", base: 15 },
        chest: { label: "Chest", base: 40 },
        waist: { label: "Waist", base: 32 },
        hips: { label: "Hips", base: 38 },
        leftBicep: { label: "Left Bicep", base: 14 },
        rightBicep: { label: "Right Bicep", base: 14 },
        leftForearm: { label: "Left Forearm", base: 12 },
        rightForearm: { label: "Right Forearm", base: 12 },
        leftThigh: { label: "Left Thigh", base: 22 },
        rightThigh: { label: "Right Thigh", base: 22 },
        leftCalf: { label: "Left Calf", base: 15 },
        rightCalf: { label: "Right Calf", base: 15 },
      };
      const vitalsMale = {
        height: { label: "Height (in)", base: 70 },
        weight: { label: "Weight (lbs)", base: 180 },
      };
      const measurementPartsFemale = {
        neck: { label: "Neck", base: 13 },
        chest: { label: "Bust", base: 36 },
        waist: { label: "Waist", base: 28 },
        hips: { label: "Hips", base: 40 },
        leftBicep: { label: "Left Bicep", base: 12 },
        rightBicep: { label: "Right Bicep", base: 12 },
        leftForearm: { label: "Left Forearm", base: 10 },
        rightForearm: { label: "Right Forearm", base: 10 },
        leftThigh: { label: "Left Thigh", base: 23 },
        rightThigh: { label: "Right Thigh", base: 23 },
        leftCalf: { label: "Left Calf", base: 14 },
        rightCalf: { label: "Right Calf", base: 14 },
      };
      const vitalsFemale = {
        height: { label: "Height (in)", base: 65 },
        weight: { label: "Weight (lbs)", base: 140 },
      };
      const bodyTypeScales = {
        ectomorph: { width: 0.9, height: 1.05 },
        mesomorph: { width: 1.0, height: 1.0 },
        endomorph: { width: 1.1, height: 0.95 },
      };

      // --- AUTHENTICATION ---
      onAuthStateChanged(auth, (user) => {
        console.log('üîê Auth state changed:', user ? 'logged in' : 'not logged in');
        authStateResolved = true; // Mark auth as resolved
        
        // Always hide loading state first
        loadingState.classList.add("hidden");
        console.log('‚úÖ Loading screen hidden by auth state change');
        
        if (user) {
          console.log('User logged in:', user.email);
          userId = user.uid;
          userInfo.textContent = `Logged in as: ${user.email}`;
          
          // Show app, hide auth
          authContainer.classList.add("hidden");
          authContainer.style.display = 'none';
          
          appContainer.classList.remove("hidden");
          appContainer.style.display = 'block';
          
          console.log('App container should now be visible');
          console.log('App container classes:', appContainer.className);
          
          setupDbListener();
          initApp();
          
          // Attach modal button listeners after app is visible
          setTimeout(() => {
            if (typeof attachModalButtonListeners === 'function') {
              attachModalButtonListeners();
              console.log('Modal button listeners attached after app visible');
            }
          }, 100);
        } else {
          console.log('User not logged in');
          userId = null;
          if (unsubscribeDbListener) unsubscribeDbListener();
          resetLocalState();
          
          // Show auth, hide app
          appContainer.classList.add("hidden");
          appContainer.style.display = 'none';
          
          authContainer.classList.remove("hidden");
          authContainer.style.display = 'flex';
        }
        
        console.log('Auth state change complete');
      });

      // Fallback: Hide loading screen after 5 seconds if Firebase doesn't respond
      setTimeout(() => {
        if (!loadingState.classList.contains("hidden")) {
          console.log('Firebase auth timeout - showing auth screen');
          loadingState.classList.add("hidden");
          loadingState.style.display = 'none';
          
          appContainer.classList.add("hidden");
          appContainer.style.display = 'none';
          
          authContainer.classList.remove("hidden");
          authContainer.style.display = 'flex';
        }
      }, 5000);

      async function handleAuth(action) {
        console.log(`Attempting ${action} with Firebase`);
        
        if (!emailInput || !passwordInput || !authError) {
          console.error('Auth form elements not found');
          return;
        }
        
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!email || !password) {
          authError.textContent = "Please enter both email and password";
          return;
        }
        
        authError.textContent = "";
        
        try {
          const userCredential = action === "login"
            ? await signInWithEmailAndPassword(auth, email, password)
            : await createUserWithEmailAndPassword(auth, email, password);
          
          console.log(`${action} successful:`, userCredential.user.email);
          
        } catch (error) {
          console.error(`${action} error:`, error);
          authError.textContent = error.message;
        }
      }

      // Add event listeners with debugging
      if (loginBtn) {
        loginBtn.addEventListener("click", (e) => {
          e.preventDefault();
          console.log('Login button clicked');
          handleAuth("login");
        });
        console.log('Login button listener added');
      } else {
        console.error('Login button not found');
      }
      
      if (signupBtn) {
        signupBtn.addEventListener("click", (e) => {
          e.preventDefault();
          console.log('Signup button clicked');
          handleAuth("signup");
        });
        console.log('Signup button listener added');
      } else {
        console.error('Signup button not found');
      }
      
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          console.log('Logout button clicked');
          signOut(auth);
        });
        console.log('Logout button listener added');
      }
      
      // Allow Enter key to submit login
      if (emailInput) {
        emailInput.addEventListener("keypress", (e) => {
          if (e.key === 'Enter') {
            handleAuth("login");
          }
        });
      }
      
      if (passwordInput) {
        passwordInput.addEventListener("keypress", (e) => {
          if (e.key === 'Enter') {
            handleAuth("login");
          }
        });
      }

      // --- FIRESTORE DATABASE ---
      function getDocRef() {
        return doc(db, "users", userId, "workoutState", "main");
      }

      function setupDbListener() {
        if (!userId) return;
        if (unsubscribeDbListener) unsubscribeDbListener();
        const docRef = getDocRef();
        unsubscribeDbListener = onSnapshot(
          docRef,
          async (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              state.completedWorkouts = new Set(data.completedWorkouts || []);
              state.pushupCounters = data.pushupCounters || {
                monday: 0,
                tuesday: 0,
                wednesday: 0,
                thursday: 0,
                friday: 0,
              };
              state.measurements = data.measurements || {
                figureType: "male",
                bodyType: "mesomorph",
              };
              state.loggedSets = data.loggedSets || {};
              state.currentWeek = data.currentWeek || null;
              state.checkedInDay = data.checkedInDay || null;
              state.workoutStartTime = data.workoutStartTime || null;
              state.workoutInProgress = data.workoutInProgress || false;
              
              // If workout was in progress, resume the timer widget
              if (state.workoutInProgress && state.workoutStartTime) {
                if (typeof startWorkoutTimer === 'function') {
                  startWorkoutTimer();
                }
              }
              
              // Load ML-Enhanced Data
              state.performanceHistory = data.performanceHistory || [];
              state.userPreferences = data.userPreferences || {
                preferredDifficulty: 'medium',
                fitnessGoals: [],
                timeAvailable: 30,
                injuryHistory: [],
                equipmentAvailable: [],
              };
              state.workoutFeedback = data.workoutFeedback || {};
              state.exerciseProgress = data.exerciseProgress || {};
              state.mlInsights = data.mlInsights || {
                strengthAreas: [],
                weaknessAreas: [],
                recommendedFocus: null,
                lastAnalysis: null,
              };
              
              // Load Gamification Data
              state.totalXP = data.totalXP || 0;
              state.level = data.level || 1;
              state.unlockedAchievements = data.unlockedAchievements || [];
              state.userGoals = data.userGoals || [];
              state.weeklyChallenge = data.weeklyChallenge || null;
              state.retroactiveXPCalculated = data.retroactiveXPCalculated || false;
              state.retroactiveAchievementsUnlocked = data.retroactiveAchievementsUnlocked || false;
              state.voiceCommandsEnabled = data.voiceCommandsEnabled || false;
              
              if (!state.measurements.figureType)
                state.measurements.figureType = "male";
              if (!state.measurements.bodyType)
                state.measurements.bodyType = "mesomorph";
            } else {
              resetLocalState();
            }
            
            // Unlock retroactive achievements (runs once)
            if (typeof unlockRetroactiveAchievements === 'function') {
              unlockRetroactiveAchievements();
            }
            
            // Calculate retroactive XP for past workouts (runs once)
            if (typeof calculateRetroactiveXP === 'function') {
              calculateRetroactiveXP();
            }
            
            // Check for weekly reset after state is loaded
            const resetOccurred = await checkAndResetWeekly();
            
            renderAll();
            
            // If a reset occurred, render again to ensure UI is updated
            if (resetOccurred) {
              setTimeout(() => renderAll(), 100);
            }
            // Load history view after initial render
            populateWorkoutHistory();
            
            // Auto-start voice recognition if user had it enabled
            if (state.voiceCommandsEnabled && typeof startVoiceRecognition === 'function') {
              setTimeout(() => {
                startVoiceRecognition();
                console.log('Voice recognition auto-started');
              }, 1000);
            }
          },
          (error) => {
            console.error("Error listening to database:", error);
            showToast("Error connecting to database.", "error");
          }
        );
      }

      async function saveStateToFirestore() {
        if (!userId) return;
        const stateToSave = {
          completedWorkouts: Array.from(state.completedWorkouts),
          pushupCounters: state.pushupCounters,
          measurements: state.measurements,
          checkedInDay: state.checkedInDay,
          workoutStartTime: state.workoutStartTime,
          workoutInProgress: state.workoutInProgress,
          // Persist logged sets so workouts-in-progress are saved
          loggedSets: state.loggedSets || {},
          currentWeek: state.currentWeek,
          // ML-Enhanced Data
          performanceHistory: state.performanceHistory || [],
          userPreferences: state.userPreferences || {},
          workoutFeedback: state.workoutFeedback || {},
          exerciseProgress: state.exerciseProgress || {},
          mlInsights: state.mlInsights || {},
          // Gamification Data
          totalXP: state.totalXP || 0,
          level: state.level || 1,
          unlockedAchievements: state.unlockedAchievements || [],
          userGoals: state.userGoals || [],
          weeklyChallenge: state.weeklyChallenge || null,
          retroactiveXPCalculated: state.retroactiveXPCalculated || false,
          retroactiveAchievementsUnlocked: state.retroactiveAchievementsUnlocked || false,
          voiceCommandsEnabled: state.voiceCommandsEnabled || false,
        };
        try {
          await setDoc(getDocRef(), stateToSave, { merge: true });
        } catch (error) {
          console.error("Error saving state:", error);
          showToast("Failed to save progress.", "error");
        }
      }

      async function resetProgressInFirestore() {
        if (!userId) return;
        try {
          await deleteDoc(getDocRef());
          const historyCollectionRef = collection(
            db,
            "users",
            userId,
            "workoutHistory"
          );
          const q = query(historyCollectionRef);
          const querySnapshot = await getDocs(q);
          const deletePromises = [];
          querySnapshot.forEach((doc) => {
            deletePromises.push(deleteDoc(doc.ref));
          });
          await Promise.all(deletePromises);

          resetLocalState();
          renderAll();
          populateWorkoutHistory(); // Repopulate to show it's empty
          showToast("Progress has been reset.", "info");
        } catch (error) {
          console.error("Error resetting progress:", error);
          showToast("Failed to reset progress.", "error");
        }
      }

      async function saveWorkoutHistory() {
        if (!userId || !state.activeDay || !state.loggedSets[state.activeDay])
          return;
        try {
          const historyCollectionRef = collection(
            db,
            "users",
            userId,
            "workoutHistory"
          );
          
          // Calculate workout duration in seconds
          let duration = null;
          if (state.workoutStartTime) {
            duration = Math.floor((Date.now() - state.workoutStartTime) / 1000);
          }
          
          await addDoc(historyCollectionRef, {
            day: state.activeDay,
            completedAt: serverTimestamp(),
            duration: duration, // Duration in seconds
            assessment: state.preWorkoutAssessment || {},
            exercises: workoutPlan[state.activeDay].exercises.map(
              (ex, index) => ({
                name: ex.name,
                baseName: ex.baseName,
                sets: state.loggedSets[state.activeDay][index] || [],
              })
            ),
          });
          // Refresh local history view after saving
          populateWorkoutHistory();
        } catch (error) {
          console.error("Error saving workout history:", error);
        }
      }

      // --- HISTORY RENDERING ---
      function formatTimestamp(ts) {
        if (!ts) return "-";
        try {
          const d = ts.toDate ? ts.toDate() : new Date(ts);
          return d.toLocaleString();
        } catch (e) {
          return String(ts);
        }
      }
      
      function formatDuration(seconds) {
        if (!seconds || seconds < 0) return "0s";
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
          return `${hours}h ${minutes}m ${secs}s`;
        } else if (minutes > 0) {
          return `${minutes}m ${secs}s`;
        } else {
          return `${secs}s`;
        }
      }
      window.formatDuration = formatDuration;

      async function populateWorkoutHistory() {
        while (historyContainer.firstChild)
          historyContainer.removeChild(historyContainer.firstChild);
        if (!userId) {
          const p = document.createElement("p");
          p.className = "text-gray-400";
          p.textContent = "Log in to see your workout history.";
          historyContainer.appendChild(p);
          return;
        }

        try {
          const historyCollectionRef = collection(
            db,
            "users",
            userId,
            "workoutHistory"
          );
          const q = query(historyCollectionRef, orderBy("completedAt", "desc"));
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) {
            const p = document.createElement("p");
            p.className = "text-gray-400";
            p.textContent = "No workout history yet.";
            historyContainer.appendChild(p);
            return;
          }

          querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const card = document.createElement("div");
            card.className =
              "bg-[rgba(255,255,255,0.03)] p-4 rounded-lg border border-[rgba(255,255,255,0.04)]";
            const completedAt = formatTimestamp(data.completedAt);

            const top = document.createElement("div");
            top.className = "flex justify-between items-start";
            const left = document.createElement("div");
            const dayDiv = document.createElement("div");
            dayDiv.className = "text-red-500 font-bebas text-xl";
            dayDiv.textContent = workoutPlan[data.day]?.day || data.day || "";
            const assessDiv = document.createElement("div");
            assessDiv.className = "text-gray-400 text-sm";
            assessDiv.textContent = data.assessment
              ? "Check-in data saved"
              : "";
            left.appendChild(dayDiv);
            left.appendChild(assessDiv);
            
            // Add workout duration if available
            if (data.duration) {
              const durationDiv = document.createElement("div");
              durationDiv.className = "text-blue-400 text-sm mt-1";
              durationDiv.innerHTML = `‚è±Ô∏è ${formatDuration(data.duration)}`;
              left.appendChild(durationDiv);
            }

            const right = document.createElement("div");
            right.className = "text-sm text-gray-300 flex items-start gap-3";
            const timeSpan = document.createElement("div");
            timeSpan.textContent = completedAt;
            // Delete button
            const delBtn = document.createElement("button");
            delBtn.className = "ml-2 text-xs text-red-400 hover:text-red-600";
            delBtn.title = "Delete this workout";
            delBtn.textContent = "Delete";
            delBtn.addEventListener("click", (ev) => {
              ev.stopPropagation();
              // set pending delete and open confirmation modal
              __pendingDelete = { id: docSnap.id, data: docSnap.data() };
              if (!deleteConfirmModal) {
                // fallback to confirm if modal not present
                if (!confirm("Delete this workout?")) return;
                (async () => {
                  try {
                    await deleteDoc(docSnap.ref);
                    showToast("Workout deleted", "info");
                    populateWorkoutHistory();
                  } catch (err) {
                    console.error("Failed to delete workout:", err);
                    showToast("Failed to delete workout", "error");
                  }
                })();
                return;
              }
              openGenericModal(deleteConfirmModal, deleteModalContainer);
            });
            right.appendChild(timeSpan);
            right.appendChild(delBtn);

            top.appendChild(left);
            top.appendChild(right);
            card.appendChild(top);

            const exercisesWrap = document.createElement("div");
            exercisesWrap.className = "mt-3";
            if (Array.isArray(data.exercises)) {
              data.exercises.forEach((ex) => {
                const exWrap = document.createElement("div");
                exWrap.className = "mb-2";
                const exTitle = document.createElement("div");
                exTitle.className = "text-white font-semibold";
                exTitle.textContent = ex.name || ex.baseName || "";
                exWrap.appendChild(exTitle);
                const ul = document.createElement("ul");
                ul.className = "ml-4 list-disc";
                if (Array.isArray(ex.sets)) {
                  ex.sets.forEach((s, i) => {
                    if (!s) return;
                    const li = document.createElement("li");
                    li.className = "text-sm text-gray-300";
                    li.textContent = `Set ${i + 1}: ${
                      s.reps || "-"
                    } reps ‚Äî Rating: ${s.rating || "-"}`;
                    ul.appendChild(li);
                  });
                }
                exWrap.appendChild(ul);
                exercisesWrap.appendChild(exWrap);
              });
            }
            card.appendChild(exercisesWrap);

            historyContainer.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading workout history:", error);
          const p = document.createElement("p");
          p.className = "text-red-400";
          p.textContent = "Failed to load history.";
          while (historyContainer.firstChild)
            historyContainer.removeChild(historyContainer.firstChild);
          historyContainer.appendChild(p);
        }
      }

      async function isDeloadWeek() {
        if (!userId) return false;

        const historyCollectionRef = collection(
          db,
          "users",
          userId,
          "workoutHistory"
        );
        const q = query(historyCollectionRef, orderBy("completedAt", "asc"));

        try {
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) {
            return false; // No history, not a deload week
          }

          const workouts = querySnapshot.docs.map((doc) =>
            doc.data().completedAt.toDate()
          );

          const getWeek = (date) => {
            const d = new Date(
              Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())
            );
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
            return `${d.getUTCFullYear()}-${weekNo}`;
          };

          const completedWeeks = new Set();
          workouts.forEach((workoutDate) => {
            completedWeeks.add(getWeek(workoutDate));
          });

          const lastWorkoutWeek = getWeek(workouts[workouts.length - 1]);
          const thisWeek = getWeek(new Date());

          if (lastWorkoutWeek === thisWeek) {
            // If we've already logged a workout this week, the deload status is already set for this week.
            return completedWeeks.size % 4 === 0;
          } else {
            // This is the first workout of a new week. Check if the number of *previous* weeks makes this a deload.
            return completedWeeks.size % 4 === 3;
          }
        } catch (error) {
          console.error("Error checking for deload week:", error);
          return false;
        }
      }

      function getWeekIdentifier(date = new Date()) {
        // Get the Monday of the current week as the week identifier
        const d = new Date(date);
        const day = d.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        const monday = new Date(d.setDate(diff));
        monday.setHours(0, 0, 0, 0); // Set to beginning of day
        return monday.toISOString().split('T')[0]; // Return YYYY-MM-DD format
      }

      // Manual reset function for testing (can be called from browser console)
      async function manualWeeklyReset() {
        console.log("Manual weekly reset triggered");
        state.completedWorkouts.clear();
        state.pushupCounters = {
          monday: 0,
          tuesday: 0,
          wednesday: 0,
          thursday: 0,
          friday: 0,
        };
        state.loggedSets = {};
        
        await saveStateToFirestore();
        showToast("Manual reset completed! All exercise data and progress cleared.", "info");
        
        // Force complete UI refresh
        setTimeout(() => {
          renderAll();
          if (state.activeDay && document.querySelector('.workout-content:not(.hidden)')) {
            renderWorkoutDay(state.activeDay);
          }
        }, 50);
      }
      
      // Debug function to check current week status
      function checkWeekStatus() {
        const currentWeekId = getWeekIdentifier();
        const today = new Date();
        console.log("Week Status Debug:", {
          currentWeekId,
          savedWeek: state.currentWeek,
          loggedSetsCount: Object.keys(state.loggedSets).length,
          completedWorkouts: Array.from(state.completedWorkouts),
          pushupCounters: state.pushupCounters,
          isMonday: today.getDay() === 1,
          todayDate: today.toDateString(),
          weekComparison: state.currentWeek === currentWeekId
        });
        return {
          currentWeekId,
          savedWeek: state.currentWeek,
          needsReset: !state.currentWeek || state.currentWeek !== currentWeekId,
          hasLoggedSets: Object.keys(state.loggedSets).length > 0,
          isMonday: today.getDay() === 1
        };
      }
      
      // Test week identifier for different dates
      function testWeekIdentifier() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const lastWeek = new Date(today);
        lastWeek.setDate(today.getDate() - 7);
        
        console.log("Week Identifier Test:", {
          today: getWeekIdentifier(today),
          yesterday: getWeekIdentifier(yesterday), 
          lastWeek: getWeekIdentifier(lastWeek),
          savedWeek: state.currentWeek
        });
      }
      
      // Make functions globally accessible for console testing
      window.manualWeeklyReset = manualWeeklyReset;
      window.checkWeekStatus = checkWeekStatus;
      window.testWeekIdentifier = testWeekIdentifier;

      async function checkAndResetWeekly() {
        const currentWeekId = getWeekIdentifier();
        let resetOccurred = false;
        
        console.log("Weekly reset check:", {
          currentWeekId,
          savedWeek: state.currentWeek,
          needsReset: !state.currentWeek || state.currentWeek !== currentWeekId,
          today: new Date().toISOString(),
          todayDate: new Date().toDateString()
        });
        
        // Force reset if it's Monday and we have logged sets from previous week
        const today = new Date();
        const isMonday = today.getDay() === 1;
        const hasLoggedSets = Object.keys(state.loggedSets).length > 0;
        
        console.log("Monday check:", {
          isMonday,
          hasLoggedSets,
          dayOfWeek: today.getDay(),
          shouldForceReset: isMonday && hasLoggedSets && state.currentWeek
        });
        
        // Force reset on Monday if we have logged sets (fallback for missed automatic resets)
        if (isMonday && hasLoggedSets && state.currentWeek && state.currentWeek !== currentWeekId) {
          console.log("Forcing Monday reset due to detected old data");
          state.completedWorkouts.clear();
          state.pushupCounters = {
            monday: 0,
            tuesday: 0,
            wednesday: 0,
            thursday: 0,
            friday: 0,
          };
          state.loggedSets = {};
          state.currentWeek = currentWeekId;
          showToast("Monday reset applied! Previous week's exercise data cleared.", "info");
          resetOccurred = true;
        }
        // If this is the first time running or a new week has started
        else if (!state.currentWeek || state.currentWeek !== currentWeekId) {
          // If we had a previous week (not first run), reset completed workouts, push-up counters, and exercise data
          if (state.currentWeek) {
            state.completedWorkouts.clear();
            // Reset push-up counters for the new week
            state.pushupCounters = {
              monday: 0,
              tuesday: 0,
              wednesday: 0,
              thursday: 0,
              friday: 0,
            };
            // Reset exercise rep data for the new week
            state.loggedSets = {};
            showToast("New week started! Weekly progress, push-up counters, and exercise data have been reset.", "info");
            resetOccurred = true;
          } else {
            // If this is the first time with the new feature and user has completed workouts,
            // they might be from a previous week, so reset to be safe
            if (state.completedWorkouts.size > 0) {
              state.completedWorkouts.clear();
              // Also reset push-up counters on first activation
              state.pushupCounters = {
                monday: 0,
                tuesday: 0,
                wednesday: 0,
                thursday: 0,
                friday: 0,
              };
              // Reset exercise rep data on first activation
              state.loggedSets = {};
              showToast("Weekly reset feature activated! Progress, push-up counters, and exercise data reset for fresh start.", "info");
              resetOccurred = true;
            }
          }
          
          // Update current week
          state.currentWeek = currentWeekId;
          
          // Save the state to persist the new week and reset
          await saveStateToFirestore();
          
          // If a reset occurred, force a complete UI refresh to clear any cached exercise data
          if (resetOccurred) {
            // Clear any cached DOM elements that might still show completed reps
            setTimeout(() => {
              renderAll();
              // Also trigger a specific refresh for exercise views
              if (state.activeDay && document.querySelector('.workout-content:not(.hidden)')) {
                renderWorkoutDay(state.activeDay);
              }
            }, 50);
          }
        }
        
        return resetOccurred;
      }



      // --- INITIALIZATION ---
      function initApp() {
        addEventListeners();
        populateExerciseLibrary();
      }

      function renderAll() {
        renderSchedule();
        renderWeeklyProgress();
        renderMeasurementInputs();
        renderBodyScan();
        renderProgressData();
        renderMLInsights();
        renderEnhancedFeatures();
      }

      // ===== NEW ENHANCED UI RENDERING FUNCTIONS =====
      
      function renderEnhancedFeatures() {
        renderUserLevelXP();
        renderAchievements();
        renderCurrentGoals();
        renderWeeklyChallenge();
        updateSettingsToggles();
        // EXTREME MODE displays
        displayWorkoutStreak();
        updatePRDisplay();
        displayFatigueScore();
        updateIntensityDisplay();
      }

      function renderUserLevelXP() {
        const userLevel = calculateLevel(state.totalXP || 0);
        const currentXP = state.totalXP || 0;
        const nextLevelXP = getXPForNextLevel(userLevel);
        const currentLevelXP = userLevel > 1 ? getXPForNextLevel(userLevel - 1) : 0;
        const progressPercent = ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;

        document.getElementById('user-level').textContent = userLevel;
        document.getElementById('user-xp').textContent = currentXP;
        document.getElementById('xp-progress-bar').style.width = `${Math.min(progressPercent, 100)}%`;
        document.getElementById('xp-next-level').textContent = `Next level at ${nextLevelXP} XP`;
      }

      function renderAchievements() {
        const achievementsGrid = document.getElementById('achievements-grid');
        if (!achievementsGrid) return;

        achievementsGrid.innerHTML = '';
        
        const recentAchievements = (state.unlockedAchievements || []).slice(-8);
        const totalAchievements = Object.keys(achievements).length;
        
        recentAchievements.forEach(achievementId => {
          const achievement = achievements[achievementId];
          if (achievement) {
            const achievementEl = document.createElement('div');
            achievementEl.className = 'bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3 text-center cursor-pointer hover:bg-yellow-500/30 transition-colors';
            achievementEl.innerHTML = `
              <div class="text-2xl mb-1">${achievement.icon}</div>
              <div class="text-xs text-yellow-400 font-medium">${achievement.name}</div>
            `;
            achievementEl.onclick = () => showAchievementDetails(achievementId);
            achievementsGrid.appendChild(achievementEl);
          }
        });

        // Fill remaining slots with locked achievements
        const lockedCount = Math.min(8 - recentAchievements.length, 4);
        for (let i = 0; i < lockedCount; i++) {
          const lockedEl = document.createElement('div');
          lockedEl.className = 'bg-gray-700/50 border border-gray-600 rounded-lg p-3 text-center';
          lockedEl.innerHTML = `
            <div class="text-2xl mb-1 opacity-30">üîí</div>
            <div class="text-xs text-gray-500">Locked</div>
          `;
          achievementsGrid.appendChild(lockedEl);
        }
      }

      function calculateGoalProgress(goal) {
        let current = 0;
        
        switch (goal.type) {
          case 'weekly_workouts':
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            current = state.performanceHistory.filter(w => new Date(w.date) >= weekStart).length;
            break;
            
          case 'total_workouts':
            current = state.performanceHistory?.length || 0;
            break;
            
          case 'workout_streak':
            current = getCurrentStreak();
            break;
            
          case 'exercises_mastered':
            const uniqueExercises = new Set();
            state.performanceHistory?.forEach(workout => {
              workout.exercises?.forEach(ex => {
                const name = ex.baseName || ex.name;
                if (name) uniqueExercises.add(name);
              });
            });
            current = uniqueExercises.size;
            break;
            
          default:
            current = goal.current || 0;
        }
        
        return {
          current: current,
          target: goal.target
        };
      }

      function renderCurrentGoals() {
        const goalsContainer = document.getElementById('goals-container');
        if (!goalsContainer) return;

        const activeGoals = (state.userGoals || []).filter(goal => !goal.isCompleted);
        
        if (activeGoals.length === 0) {
          goalsContainer.innerHTML = `
            <div class="text-center py-4">
              <div class="text-gray-500 mb-2">üéØ</div>
              <p class="text-gray-400 text-sm">No active goals</p>
              <p class="text-gray-500 text-xs">Set a goal to track your progress!</p>
            </div>
          `;
          return;
        }

        goalsContainer.innerHTML = '';
        
        activeGoals.slice(0, 3).forEach(goal => {
          const progress = calculateGoalProgress(goal);
          const progressPercent = Math.min((progress.current / progress.target) * 100, 100);
          const goalType = goalTypes[goal.type];
          
          const goalEl = document.createElement('div');
          goalEl.className = 'bg-gray-800/50 rounded-lg p-3 mb-3 border border-gray-700';
          goalEl.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-white flex items-center">
                ${goalType ? goalType.icon : 'üéØ'} ${goalType ? goalType.name : goal.type}
              </span>
              <span class="text-xs text-gray-400">${progress.current}/${progress.target}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">${Math.round(progressPercent)}% complete</div>
          `;
          goalsContainer.appendChild(goalEl);
        });
      }

      function renderWeeklyChallenge() {
        const challengeContainer = document.getElementById('weekly-challenge');
        if (!challengeContainer) {
          console.warn('Weekly challenge container not found');
          return;
        }

        try {
          if (!state.weeklyChallenge) {
            state.weeklyChallenge = weeklyChallenge.generateChallenge();
          }

          const challenge = state.weeklyChallenge;
          let progress;
          try {
            progress = weeklyChallenge.checkProgress(challenge, getUserStats());
          } catch (err) {
            // Fallback if no data
            progress = { current: 0, target: challenge.target, percentage: 0 };
          }

          challengeContainer.innerHTML = `
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-white">${challenge.description}</h3>
              <span class="text-sm bg-purple-600 text-white px-3 py-1 rounded-full">+${challenge.reward} XP</span>
            </div>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-300">Progress</span>
                <span class="text-white">${progress.current}/${progress.target}</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-3">
                <div class="bg-purple-500 h-3 rounded-full transition-all duration-500" style="width: ${progress.percentage}%"></div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs text-gray-400">Resets every Monday</span>
              ${progress.percentage === 100 ? 
                '<span class="text-green-400 text-sm font-bold">‚úÖ Completed!</span>' : 
                `<span class="text-gray-300 text-sm">${Math.round(progress.percentage)}% done</span>`
              }
            </div>
          `;
        } catch (error) {
          console.error('Error rendering weekly challenge:', error);
          challengeContainer.innerHTML = '<p class="text-gray-400 text-sm">Challenge loading...</p>';
        }
      }

      function updateSettingsToggles() {
        const voiceToggle = document.getElementById('voice-commands-toggle');
        const shareToggle = document.getElementById('share-achievements-toggle');
        const challengesToggle = document.getElementById('weekly-challenges-toggle');
        const aiToggle = document.getElementById('ai-recommendations-toggle');

        if (voiceToggle) voiceToggle.checked = state.voiceCommandsEnabled || false;
        if (shareToggle) shareToggle.checked = state.socialSettings?.shareAchievements !== false;
        if (challengesToggle) challengesToggle.checked = state.socialSettings?.joinChallenges !== false;
        if (aiToggle) aiToggle.checked = true; // Always enabled for now
      }

      // ===== MODAL AND INTERACTION FUNCTIONS =====
      
      function showAllAchievements() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        
        const allAchievementsList = Object.entries(achievements).map(([id, achievement]) => {
          const isUnlocked = (state.unlockedAchievements || []).includes(id);
          return `
            <div class="flex items-center p-3 rounded-lg border ${isUnlocked ? 'bg-yellow-500/10 border-yellow-500/30' : 'bg-gray-800/50 border-gray-700'} mb-2">
              <div class="text-3xl mr-4 ${isUnlocked ? '' : 'opacity-30'}">${isUnlocked ? achievement.icon : 'üîí'}</div>
              <div class="flex-1">
                <h4 class="font-bold ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}">${achievement.name}</h4>
                <p class="text-sm text-gray-400">${achievement.description}</p>
                <span class="text-xs ${isUnlocked ? 'text-yellow-300' : 'text-gray-600'}">+${achievement.points} XP</span>
              </div>
            </div>
          `;
        }).join('');

        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-md w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
              <h3 class="text-lg font-bold text-white">üèÜ All Achievements</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto max-h-96">
              ${allAchievementsList}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function showGoalCreationModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        
        const goalTypeOptions = Object.entries(goalTypes).map(([type, info]) => 
          `<option value="${type}">${info.icon} ${info.name}</option>`
        ).join('');

        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-white">üéØ Set New Goal</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <form id="goal-creation-form" class="space-y-4">
              <div>
                <label class="block text-white font-medium mb-2">Goal Type</label>
                <select id="goal-type-select" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white">
                  ${goalTypeOptions}
                </select>
              </div>
              
              <div>
                <label class="block text-white font-medium mb-2">Target Value</label>
                <input type="number" id="goal-target-input" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white" placeholder="e.g., 5" required>
              </div>
              
              <div>
                <label class="block text-white font-medium mb-2">Timeframe</label>
                <select id="goal-timeframe-select" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white">
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                </select>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button type="button" onclick="this.closest('.fixed').remove()" 
                  class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
                  Cancel
                </button>
                <button type="submit" 
                  class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                  Create Goal
                </button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('goal-creation-form').addEventListener('submit', (e) => {
          e.preventDefault();
          const goalType = document.getElementById('goal-type-select').value;
          const targetValue = parseInt(document.getElementById('goal-target-input').value);
          const timeframe = document.getElementById('goal-timeframe-select').value;
          
          setUserGoal(goalType, targetValue, timeframe);
          modal.remove();
          displayUserGoals();
          showToast('üéØ New goal created successfully!', 'success');
        });
      }

      function setUserGoal(goalType, targetValue, timeframe) {
        const newGoal = {
          id: Date.now().toString(),
          type: goalType,
          target: targetValue,
          current: 0,
          timeframe: timeframe,
          isCompleted: false,
          createdAt: new Date().toISOString()
        };
        
        if (!state.userGoals) state.userGoals = [];
        state.userGoals.push(newGoal);
        
        // Save to storage
        if (typeof saveStateToFirestore === 'function') {
          saveStateToFirestore();
        }
        
        return newGoal;
      }

      function generateExercisePerformanceHTML() {
        if (!state.mlInsights?.exercisePerformance || state.mlInsights.exercisePerformance.length === 0) {
          return '<p class="text-gray-400 text-sm">Complete workouts to see exercise-specific performance data</p>';
        }
        
        const sorted = [...state.mlInsights.exercisePerformance]
          .sort((a, b) => b.avgCompletion - a.avgCompletion)
          .slice(0, 10);
        
        return sorted.map(ex => {
          const percentage = Math.round(ex.avgCompletion * 100);
          const barColor = percentage >= 80 ? 'bg-green-500' : percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500';
          
          return `
            <div class="bg-gray-700/50 rounded p-2">
              <div class="flex justify-between items-center mb-1">
                <span class="text-white text-sm font-medium">${ex.name}</span>
                <span class="text-gray-300 text-xs">${percentage}%</span>
              </div>
              <div class="w-full bg-gray-600 rounded-full h-2">
                <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
              </div>
              <div class="text-gray-400 text-xs mt-1">${ex.sessions} sessions ‚Ä¢ ${ex.avgReps.toFixed(1)} avg reps</div>
            </div>
          `;
        }).join('');
      }
      
      // Progressive Overload Analysis Function
      function analyzeProgressiveOverload() {
        try {
          console.log('Analyzing progressive overload...');
          console.log('State:', state);
          console.log('Performance history:', state.performanceHistory);
          
          if (!state.performanceHistory || state.performanceHistory.length < 2) {
            console.log('Not enough performance history');
            return {
              exercises: [],
              summary: { improving: 0, stagnant: 0, declining: 0 }
            };
          }
          
          const exerciseProgress = {};
          const summary = { improving: 0, stagnant: 0, declining: 0 };
          
          // Group workouts by exercise
          state.performanceHistory.forEach(workout => {
            if (!workout.exercises || !Array.isArray(workout.exercises)) {
              console.warn('Workout missing exercises array:', workout);
              return;
            }
            
            workout.exercises.forEach(exercise => {
              const key = exercise.baseName || exercise.name;
              if (!exerciseProgress[key]) {
                exerciseProgress[key] = {
                  name: key,
                  sessions: [],
                  latestDifficulty: exercise.difficulty
                };
              }
              
              exerciseProgress[key].sessions.push({
                date: workout.date,
                setsCompleted: exercise.setsCompleted || 0,
                targetSets: exercise.targetSets || 0,
                avgReps: exercise.avgReps || 0,
                completionRate: exercise.completionRate || 0,
                difficulty: exercise.difficulty
              });
            });
          });
          
          // Analyze each exercise for progressive overload
          const results = Object.values(exerciseProgress).map(ex => {
            if (ex.sessions.length < 2) return null;
            
            // Get last 3 sessions for trend analysis
            const recentSessions = ex.sessions.slice(-3);
            const firstSession = recentSessions[0];
            const lastSession = recentSessions[recentSessions.length - 1];
            
            // Calculate average metrics
            const avgSets = recentSessions.reduce((sum, s) => sum + s.setsCompleted, 0) / recentSessions.length;
            const avgReps = recentSessions.reduce((sum, s) => sum + s.avgReps, 0) / recentSessions.length;
            const avgCompletion = recentSessions.reduce((sum, s) => sum + s.completionRate, 0) / recentSessions.length;
            
            // Determine progression status
            let status = 'stagnant';
            let recommendation = '';
            
            // Check for improvement (more reps, better completion)
            const repsImproved = lastSession.avgReps > firstSession.avgReps;
            const completionImproved = lastSession.completionRate > firstSession.completionRate + 0.1;
            const completionHigh = avgCompletion > 0.9;
            
            // Check for decline
            const repsDeclined = lastSession.avgReps < firstSession.avgReps - 1;
            const completionDeclined = lastSession.completionRate < firstSession.completionRate - 0.15;
            
            if (completionHigh && repsImproved) {
              status = 'ready_for_progression';
              recommendation = 'üéØ Ready to increase difficulty! Consider a harder variation.';
              summary.improving++;
            } else if (repsImproved || completionImproved) {
              status = 'improving';
              recommendation = '‚úÖ Making progress! Keep it up.';
              summary.improving++;
            } else if (repsDeclined || completionDeclined) {
              status = 'declining';
              recommendation = '‚ö†Ô∏è Performance declining. Consider more rest or easier variation.';
              summary.declining++;
            } else if (avgCompletion < 0.6) {
              status = 'struggling';
              recommendation = 'üí° Consider switching to an easier variation.';
              summary.declining++;
            } else {
              status = 'maintaining';
              recommendation = '‚û°Ô∏è Maintaining current level. Try adding 1-2 more reps next time.';
              summary.stagnant++;
            }
            
            return {
              name: ex.name,
              status,
              recommendation,
              stats: {
                sessions: ex.sessions.length,
                avgSets: avgSets.toFixed(1),
                avgReps: avgReps.toFixed(1),
                avgCompletion: (avgCompletion * 100).toFixed(0) + '%',
                latestDifficulty: ex.latestDifficulty
              },
              recentPerformance: recentSessions.map(s => ({
                date: new Date(s.date).toLocaleDateString(),
                reps: s.avgReps.toFixed(1),
                completion: (s.completionRate * 100).toFixed(0) + '%'
              }))
            };
          }).filter(Boolean);
          
          return {
            exercises: results.sort((a, b) => {
              // Sort by status priority
              const priority = {
                'ready_for_progression': 0,
                'improving': 1,
                'maintaining': 2,
                'stagnant': 3,
                'struggling': 4,
                'declining': 5
              };
              return (priority[a.status] || 10) - (priority[b.status] || 10);
            }),
            summary
          };
        } catch (error) {
          console.error('Error in analyzeProgressiveOverload:', error);
          return {
            exercises: [],
            summary: { improving: 0, stagnant: 0, declining: 0 }
          };
        }
      }
      
      function generateProgressiveOverloadHTML() {
        try {
          console.log('Generating progressive overload HTML...');
          console.log('Performance history:', state.performanceHistory);
          
          const overloadData = analyzeProgressiveOverload();
          console.log('Overload data:', overloadData);
          
          if (!overloadData || !overloadData.exercises || overloadData.exercises.length === 0) {
            return '<p class="text-gray-400 text-sm">Complete at least 2 workouts to see progressive overload analysis</p>';
          }
          
          const { exercises, summary } = overloadData;
          
          // Summary cards
          let html = `
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="bg-green-500/10 border border-green-500/20 rounded p-3 text-center">
                <div class="text-2xl font-bold text-green-400">${summary.improving}</div>
                <div class="text-xs text-green-300">Improving</div>
              </div>
              <div class="bg-blue-500/10 border border-blue-500/20 rounded p-3 text-center">
                <div class="text-2xl font-bold text-blue-400">${summary.stagnant}</div>
                <div class="text-xs text-blue-300">Maintaining</div>
              </div>
              <div class="bg-orange-500/10 border border-orange-500/20 rounded p-3 text-center">
                <div class="text-2xl font-bold text-orange-400">${summary.declining}</div>
                <div class="text-xs text-orange-300">Need Attention</div>
              </div>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
          `;
          
          // Exercise cards
          exercises.forEach(ex => {
            const statusColors = {
              'ready_for_progression': 'bg-green-500/10 border-green-500/30',
              'improving': 'bg-green-500/10 border-green-500/20',
              'maintaining': 'bg-blue-500/10 border-blue-500/20',
              'stagnant': 'bg-blue-500/10 border-blue-500/20',
              'struggling': 'bg-orange-500/10 border-orange-500/20',
              'declining': 'bg-red-500/10 border-red-500/20'
            };
            
            const statusClass = statusColors[ex.status] || 'bg-gray-700/50 border-gray-600';
            
            html += `
              <div class="border rounded-lg p-3 ${statusClass}">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-semibold text-white">${ex.name}</div>
                  <div class="text-xs text-gray-400">${ex.stats.sessions} sessions</div>
                </div>
                <div class="text-sm text-gray-300 mb-2">${ex.recommendation}</div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                  <div>
                    <div class="text-gray-400">Avg Sets</div>
                    <div class="text-white font-medium">${ex.stats.avgSets}</div>
                  </div>
                  <div>
                    <div class="text-gray-400">Avg Reps</div>
                    <div class="text-white font-medium">${ex.stats.avgReps}</div>
                  </div>
                  <div>
                    <div class="text-gray-400">Completion</div>
                    <div class="text-white font-medium">${ex.stats.avgCompletion}</div>
                  </div>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          return html;
        } catch (error) {
          console.error('Error generating progressive overload HTML:', error);
          return '<p class="text-red-400 text-sm">Error loading progressive overload data</p>';
        }
      }

      function showAdvancedAnalytics() {
        try {
          const analytics = generateProgressCharts();
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
          
          // Calculate advanced metrics
          const totalWorkouts = state.performanceHistory?.length || 0;
          const avgCompletion = totalWorkouts > 0 ? 
            (state.performanceHistory.reduce((sum, w) => sum + (w.completionRate || 0), 0) / totalWorkouts * 100).toFixed(1) : 0;
          const recentWorkouts = state.performanceHistory?.slice(-7) || [];
          const weeklyAvg = recentWorkouts.length > 0 ?
            (recentWorkouts.reduce((sum, w) => sum + (w.completionRate || 0), 0) / recentWorkouts.length * 100).toFixed(1) : 0;
          
          console.log('Analytics data:', { totalWorkouts, avgCompletion, weeklyAvg, analytics });
        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
              <h3 class="text-lg font-bold text-white">üìà Advanced Analytics Dashboard</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[calc(90vh-60px)]">
              <!-- Summary Cards -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-4 shadow-lg">
                  <div class="text-blue-100 text-xs mb-1">Total Workouts</div>
                  <div class="text-3xl font-bold text-white">${totalWorkouts}</div>
                </div>
                <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-4 shadow-lg">
                  <div class="text-green-100 text-xs mb-1">Avg Completion</div>
                  <div class="text-3xl font-bold text-white">${avgCompletion}%</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-lg p-4 shadow-lg">
                  <div class="text-yellow-100 text-xs mb-1">Achievements</div>
                  <div class="text-3xl font-bold text-white">${state.unlockedAchievements?.length || 0}/${Object.keys(achievements).length}</div>
                </div>
                <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-4 shadow-lg">
                  <div class="text-purple-100 text-xs mb-1">Current Level</div>
                  <div class="text-3xl font-bold text-white">${state.level || 1}</div>
                </div>
              </div>
              
              <!-- Performance Chart -->
              <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-white mb-3">ÔøΩ Performance Trend (Last 12 Weeks)</h4>
                <canvas id="analytics-performance-chart" width="600" height="200"></canvas>
              </div>
              
              <!-- Consistency Chart -->
              <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-white mb-3">üî• Workout Consistency</h4>
                <canvas id="analytics-consistency-chart" width="600" height="200"></canvas>
              </div>
              
              <!-- Exercise Performance Breakdown -->
              <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-white mb-3">üí™ Exercise Performance Breakdown</h4>
                <div id="exercise-performance-list" class="space-y-2 max-h-60 overflow-y-auto">
                  ${generateExercisePerformanceHTML()}
                </div>
              </div>
              
              <!-- Progressive Overload Tracker -->
              <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-white mb-3">üìä Progressive Overload Analysis</h4>
                <div id="progressive-overload-section">
                  ${generateProgressiveOverloadHTML()}
                </div>
              </div>
              
              <!-- ML Insights -->
              <div class="bg-gray-800 rounded-lg p-4">
                <h4 class="font-bold text-white mb-3">ü§ñ AI-Powered Insights</h4>
                <div class="space-y-3">
                  <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3">
                    <div class="font-semibold text-blue-400 mb-1">Recommended Focus</div>
                    <p class="text-blue-300 text-sm">
                      ${state.mlInsights?.recommendedFocus ? 
                        state.mlInsights.recommendedFocus.charAt(0).toUpperCase() + state.mlInsights.recommendedFocus.slice(1) : 
                        'Complete more workouts for personalized recommendations'
                      }
                    </p>
                  </div>
                  ${state.mlInsights?.strengthAreas?.length > 0 ? `
                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                      <div class="font-semibold text-green-400 mb-1">üí™ Your Strengths</div>
                      <p class="text-green-300 text-sm">${state.mlInsights.strengthAreas.slice(0, 3).join(', ')}</p>
                    </div>
                  ` : ''}
                  ${state.mlInsights?.weaknessAreas?.length > 0 ? `
                    <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3">
                      <div class="font-semibold text-orange-400 mb-1">üéØ Areas to Improve</div>
                      <p class="text-orange-300 text-sm">${state.mlInsights.weaknessAreas.slice(0, 3).join(', ')}</p>
                    </div>
                  ` : ''}
                  <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
                    <div class="font-semibold text-purple-400 mb-1">üìà Recent Progress</div>
                    <p class="text-purple-300 text-sm">7-Day Average: ${weeklyAvg}% completion rate</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Render charts after modal is in DOM
        setTimeout(() => {
          renderPerformanceChart(analytics);
          renderConsistencyChart(analytics);
        }, 50);
        } catch (error) {
          console.error('Error showing advanced analytics:', error);
          showToast('Error loading analytics. Please try again.', 'error');
        }
      }
      
      // Export immediately for onclick handlers
      window.showAdvancedAnalytics = showAdvancedAnalytics;
      
      function renderPerformanceChart(analytics) {
        const canvas = document.getElementById('analytics-performance-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;
        
        // Clear canvas
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(0, 0, width, height);
        
        if (analytics.consistencyTrend.length === 0) {
          ctx.fillStyle = '#9ca3af';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data available yet', width / 2, height / 2);
          return;
        }
        
        // Draw axes
        ctx.strokeStyle = '#4b5563';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();
        
        // Get data points
        const data = analytics.consistencyTrend.map(d => d.avgCompletion * 100);
        const maxValue = Math.max(...data, 100);
        const stepX = chartWidth / (data.length - 1 || 1);
        
        // Draw grid lines
        ctx.strokeStyle = '#374151';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
          const y = padding + (chartHeight * i / 4);
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();
          
          // Y-axis labels
          ctx.fillStyle = '#9ca3af';
          ctx.font = '10px sans-serif';
          ctx.textAlign = 'right';
          ctx.fillText(`${Math.round((1 - i / 4) * 100)}%`, padding - 5, y + 3);
        }
        
        // Draw line chart
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        data.forEach((value, index) => {
          const x = padding + (index * stepX);
          const y = padding + chartHeight - ((value / maxValue) * chartHeight);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
        
        // Draw data points
        data.forEach((value, index) => {
          const x = padding + (index * stepX);
          const y = padding + chartHeight - ((value / maxValue) * chartHeight);
          
          ctx.fillStyle = '#3b82f6';
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        });
      }
      
      function renderConsistencyChart(analytics) {
        const canvas = document.getElementById('analytics-consistency-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;
        
        // Clear canvas
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(0, 0, width, height);
        
        if (analytics.consistencyTrend.length === 0) {
          ctx.fillStyle = '#9ca3af';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data available yet', width / 2, height / 2);
          return;
        }
        
        // Draw axes
        ctx.strokeStyle = '#4b5563';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();
        
        // Get data
        const data = analytics.consistencyTrend.map(d => d.workouts);
        const maxValue = Math.max(...data, 5);
        const barWidth = chartWidth / data.length * 0.8;
        const barGap = chartWidth / data.length * 0.2;
        
        // Draw grid lines
        ctx.strokeStyle = '#374151';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
          const y = padding + (chartHeight * i / 4);
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();
          
          // Y-axis labels
          ctx.fillStyle = '#9ca3af';
          ctx.font = '10px sans-serif';
          ctx.textAlign = 'right';
          ctx.fillText(Math.round((1 - i / 4) * maxValue), padding - 5, y + 3);
        }
        
        // Draw bars
        data.forEach((value, index) => {
          const x = padding + (index * (barWidth + barGap)) + barGap / 2;
          const barHeight = (value / maxValue) * chartHeight;
          const y = height - padding - barHeight;
          
          // Gradient fill
          const gradient = ctx.createLinearGradient(x, y, x, height - padding);
          gradient.addColorStop(0, '#10b981');
          gradient.addColorStop(1, '#059669');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x, y, barWidth, barHeight);
          
          // Bar border
          ctx.strokeStyle = '#047857';
          ctx.lineWidth = 1;
          ctx.strokeRect(x, y, barWidth, barHeight);
        });
      }

      // ===== HELPER FUNCTIONS =====
      
      function getCurrentStreak() {
        if (!state.performanceHistory || state.performanceHistory.length === 0) return 0;
        
        let streak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Sort workouts by date (newest first)
        const sortedWorkouts = [...state.performanceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        for (let i = 0; i < sortedWorkouts.length; i++) {
          const workoutDate = new Date(sortedWorkouts[i].date);
          workoutDate.setHours(0, 0, 0, 0);
          
          const daysDiff = Math.floor((today - workoutDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff === streak) {
            streak++;
          } else if (daysDiff > streak) {
            break;
          }
        }
        
        return streak;
      }

      function getUserStats() {
        return {
          totalWorkouts: state.performanceHistory?.length || 0,
          currentStreak: getCurrentStreak(),
          totalXP: state.totalXP || 0,
          level: state.level || 1,
          unlockedAchievements: state.unlockedAchievements || [],
          completedGoals: (state.userGoals || []).filter(g => g.isCompleted).length
        };
      }

      function getExerciseHistory(exerciseName) {
        if (!state.performanceHistory) return [];
        
        return state.performanceHistory.flatMap(workout => 
          workout.exercises?.filter(ex => 
            (ex.baseName || ex.name) === exerciseName
          ) || []
        );
      }

      function countProgressions(workouts) {
        // Count how many times user progressed to harder variations
        let progressions = 0;
        workouts.forEach(workout => {
          workout.exercises?.forEach(exercise => {
            if (exercise.difficulty === 'intermediate' || exercise.difficulty === 'expert') {
              progressions++;
            }
          });
        });
        return progressions;
      }

      // Retroactively unlock achievements based on past workouts
      function unlockRetroactiveAchievements() {
        console.log('üèÜ Checking for retroactive achievements...');
        
        if (!state.performanceHistory || state.performanceHistory.length === 0) {
          console.log('No workout history found');
          return;
        }
        
        // Check if we've already done this (flag in state)
        if (state.retroactiveAchievementsUnlocked) {
          console.log('Retroactive achievements already unlocked');
          return;
        }
        
        const newlyUnlocked = [];
        
        // First workout
        if (state.performanceHistory.length >= 1 && !state.unlockedAchievements.includes('first_workout')) {
          state.unlockedAchievements.push('first_workout');
          newlyUnlocked.push('first_workout');
        }
        
        // Check for week warrior (5 workouts in any 7-day period)
        for (let i = 0; i < state.performanceHistory.length; i++) {
          const startDate = new Date(state.performanceHistory[i].date);
          const endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          const workoutsInWeek = state.performanceHistory.filter(w => {
            const wDate = new Date(w.date);
            return wDate >= startDate && wDate < endDate;
          });
          if (workoutsInWeek.length >= 5 && !state.unlockedAchievements.includes('week_warrior')) {
            state.unlockedAchievements.push('week_warrior');
            newlyUnlocked.push('week_warrior');
            break;
          }
        }
        
        // Consistency king (10-day streak)
        const streak = getCurrentStreak();
        if (streak >= 10 && !state.unlockedAchievements.includes('consistency_king')) {
          state.unlockedAchievements.push('consistency_king');
          newlyUnlocked.push('consistency_king');
        }
        
        // Early bird / Night owl
        state.performanceHistory.forEach(workout => {
          const hour = new Date(workout.date).getHours();
          if (hour < 8 && !state.unlockedAchievements.includes('early_bird')) {
            state.unlockedAchievements.push('early_bird');
            newlyUnlocked.push('early_bird');
          }
          if (hour >= 20 && !state.unlockedAchievements.includes('night_owl')) {
            state.unlockedAchievements.push('night_owl');
            newlyUnlocked.push('night_owl');
          }
        });
        
        // Perfect form (95%+ completion rate in any workout)
        state.performanceHistory.forEach(workout => {
          if (workout.completionRate >= 0.95 && !state.unlockedAchievements.includes('perfect_form')) {
            state.unlockedAchievements.push('perfect_form');
            newlyUnlocked.push('perfect_form');
          }
        });
        
        // Mark as done
        state.retroactiveAchievementsUnlocked = true;
        
        if (newlyUnlocked.length > 0) {
          console.log(`‚úÖ Unlocked ${newlyUnlocked.length} retroactive achievements:`, newlyUnlocked);
          
          // Award XP for achievements
          let achievementXP = 0;
          newlyUnlocked.forEach(achId => {
            achievementXP += achievements[achId]?.points || 0;
          });
          state.totalXP = (state.totalXP || 0) + achievementXP;
          state.level = Math.floor(Math.sqrt(state.totalXP / 100)) + 1;
          
          console.log(`   Achievement XP awarded: ${achievementXP}`);
          showToast(`üèÜ Unlocked ${newlyUnlocked.length} achievements! +${achievementXP} XP`, 'success', 5000);
        } else {
          console.log('No new achievements to unlock');
        }
      }

      // Retroactively calculate and award XP for past workouts
      function calculateRetroactiveXP() {
        console.log('üîÑ Calculating retroactive XP from past workouts...');
        
        if (!state.performanceHistory || state.performanceHistory.length === 0) {
          console.log('No workout history found');
          return;
        }
        
        // Check if we've already done this (flag in state)
        if (state.retroactiveXPCalculated) {
          console.log('Retroactive XP already calculated');
          return;
        }
        
        let totalXPAwarded = 0;
        const workoutCount = state.performanceHistory.length;
        
        // Award base XP per workout
        const baseXPPerWorkout = 50;
        totalXPAwarded += workoutCount * baseXPPerWorkout;
        
        // Calculate total sets across all workouts
        let totalSets = 0;
        state.performanceHistory.forEach(workout => {
          if (workout.sets && Array.isArray(workout.sets)) {
            totalSets += workout.sets.length;
          }
        });
        
        // Award XP per set (5 XP per set)
        const xpPerSet = 5;
        totalXPAwarded += totalSets * xpPerSet;
        
        // Count unique exercises mastered
        const uniqueExercises = new Set();
        state.performanceHistory.forEach(workout => {
          if (workout.exercises && Array.isArray(workout.exercises)) {
            workout.exercises.forEach(ex => {
              const exerciseName = ex.baseName || ex.name;
              if (exerciseName) uniqueExercises.add(exerciseName);
            });
          }
          if (workout.sets && Array.isArray(workout.sets)) {
            workout.sets.forEach(set => {
              if (set.exercise) uniqueExercises.add(set.exercise);
            });
          }
        });
        
        // Award XP for exercise variety (10 XP per unique exercise)
        const xpPerExercise = 10;
        totalXPAwarded += uniqueExercises.size * xpPerExercise;
        
        // Update state
        const oldXP = state.totalXP || 0;
        state.totalXP = (state.totalXP || 0) + totalXPAwarded;
        state.level = Math.floor(state.totalXP / 100) + 1;
        state.retroactiveXPCalculated = true;
        
        console.log(`‚úÖ Retroactive XP calculation complete!`);
        console.log(`   Workouts: ${workoutCount} √ó ${baseXPPerWorkout} XP = ${workoutCount * baseXPPerWorkout} XP`);
        console.log(`   Sets: ${totalSets} √ó ${xpPerSet} XP = ${totalSets * xpPerSet} XP`);
        console.log(`   Unique Exercises: ${uniqueExercises.size} √ó ${xpPerExercise} XP = ${uniqueExercises.size * xpPerExercise} XP`);
        console.log(`   Total XP Awarded: ${totalXPAwarded} XP`);
        console.log(`   Previous XP: ${oldXP} ‚Üí New XP: ${state.totalXP}`);
        console.log(`   New Level: ${state.level}`);
        
        // Save to Firestore
        if (typeof saveStateToFirestore === 'function') {
          saveStateToFirestore();
        }
        
        // Update UI
        if (typeof updateDashboardStats === 'function') {
          updateDashboardStats();
        }
        
        // Show notification
        showToast(`üéâ ${totalXPAwarded} XP awarded for ${workoutCount} past workouts! You're now Level ${state.level}!`, 'success', 5000);
      }

      function showLevelUpModal(newLevel) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 level-up-modal';
        modal.innerHTML = `
          <div class="bg-gradient-to-br from-blue-600 to-purple-600 border-2 border-blue-400 rounded-lg p-6 max-w-sm mx-4 text-center animate-pulse">
            <div class="text-6xl mb-4">üöÄ</div>
            <h3 class="text-2xl font-bold text-white mb-2">LEVEL UP!</h3>
            <h4 class="text-xl font-semibold text-blue-100 mb-2">Level ${newLevel}</h4>
            <p class="text-blue-200 text-sm mb-4">You're getting stronger!</p>
            <button onclick="this.closest('.level-up-modal').remove()" 
              class="bg-white text-blue-700 px-6 py-2 rounded-full font-semibold hover:bg-blue-100 transition-colors">
              Continue Training!
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-remove after 5 seconds
        setTimeout(() => modal.remove(), 5000);
      }

      function showGoalCompletionModal(goal) {
        const goalType = goalTypes[goal.type];
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 goal-completion-modal';
        modal.innerHTML = `
          <div class="bg-gradient-to-br from-green-600 to-emerald-600 border-2 border-green-400 rounded-lg p-6 max-w-sm mx-4 text-center animate-bounce">
            <div class="text-6xl mb-4">üéØ</div>
            <h3 class="text-xl font-bold text-white mb-2">Goal Achieved!</h3>
            <h4 class="text-lg font-semibold text-green-100 mb-2">${goalType?.name || goal.type}</h4>
            <p class="text-green-200 text-sm mb-4">Target: ${goal.target} ${goalType?.unit || ''}</p>
            <div class="text-green-100 font-bold mb-4">Congratulations! üéâ</div>
            <button onclick="this.closest('.goal-completion-modal').remove()" 
              class="bg-white text-green-700 px-6 py-2 rounded-full font-semibold hover:bg-green-100 transition-colors">
              Set New Goal
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-remove after 5 seconds
        setTimeout(() => modal.remove(), 5000);
      }

      function showAchievementDetails(achievementId) {
        const achievement = achievements[achievementId];
        if (!achievement) return;
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-sm w-full mx-4 p-6 text-center">
            <div class="text-6xl mb-4">${achievement.icon}</div>
            <h3 class="text-xl font-bold text-yellow-400 mb-2">${achievement.name}</h3>
            <p class="text-gray-300 text-sm mb-4">${achievement.description}</p>
            <div class="text-yellow-300 font-bold mb-4">+${achievement.points} XP</div>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" 
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
                Close
              </button>
              <button onclick="shareWorkoutAchievement(achievements['${achievementId}']); this.closest('.fixed').remove();" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
                Share
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function resetLocalState() {
        state = {
          completedWorkouts: new Set(),
          pushupCounters: {
            monday: 0,
            tuesday: 0,
            wednesday: 0,
            thursday: 0,
            friday: 0,
          },
          measurements: { figureType: "male", bodyType: "mesomorph" },
          activeDay: null,
          activeExercise: null,
          loggedSets: {},
          timer: {
            interval: null,
            type: null,
            startTime: 0,
            elapsedTime: 0,
            running: false,
          },
        };
      }

      // --- RENDER FUNCTIONS ---
      function renderSchedule() {
        grid.innerHTML = "";
        const dayOrder = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];
        const dayMap = [
          "sunday",
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
        ];
        const todayKey = dayMap[new Date().getDay()];
        const todayIndexInOrder = dayOrder.indexOf(todayKey);
        const reorderedDays =
          todayIndexInOrder === -1
            ? dayOrder
            : dayOrder
                .slice(todayIndexInOrder)
                .concat(dayOrder.slice(0, todayIndexInOrder));

        reorderedDays.forEach((dayKey) => {
          const dayData = workoutPlan[dayKey];
          const isToday = dayKey === todayKey;
          const isCheckedIn = state.checkedInDay === dayKey;
          const isLocked = !isCheckedIn && dayKey !== "saturday" && dayKey !== "sunday";
          
          const card = document.createElement("div");
          card.className = `day-card bg-gray-800 rounded-lg p-5 flex flex-col border-2 transition-all duration-300 ${
            isLocked ? "opacity-60 cursor-not-allowed" : "cursor-pointer"
          } shadow-lg ${
            isToday
              ? "border-red-500"
              : "border-gray-700 hover:border-red-500 hover:scale-105"
          }`;
          
          // Accessibility: expose as button to keyboard users
          card.setAttribute("role", "button");
          card.tabIndex = isLocked ? -1 : 0;
          card.dataset.day = dayKey;
          if (state.completedWorkouts.has(dayKey)) {
            card.classList.add("completed");
          }

          // Build card content using DOM methods (avoid innerHTML)
          const topGrow = document.createElement("div");
          topGrow.className = "flex-grow";

          const headerRow = document.createElement("div");
          headerRow.className = "flex justify-between items-start";

          const h3 = document.createElement("h3");
          h3.className = "font-bebas text-3xl tracking-wide";
          h3.textContent = dayData.day || "";

          headerRow.appendChild(h3);
          if (isToday) {
            const todaySpan = document.createElement("span");
            todaySpan.className =
              "text-xs font-sans bg-red-600 text-white px-2 py-1 rounded-full";
            todaySpan.textContent = "TODAY";
            headerRow.appendChild(todaySpan);
          }

          const titleP = document.createElement("p");
          titleP.className = "text-red-400 font-semibold text-md mt-1";
          titleP.textContent = dayData.title || "";
          const subP = document.createElement("p");
          subP.className = "text-gray-400 text-sm mt-1";
          subP.textContent = dayData.subtitle || "";

          topGrow.appendChild(headerRow);
          topGrow.appendChild(titleP);
          topGrow.appendChild(subP);

          const bottomRow = document.createElement("div");
          bottomRow.className =
            "mt-4 pt-4 border-t border-gray-700 flex justify-between items-center";

          if (state.completedWorkouts.has(dayKey)) {
            const doneDiv = document.createElement("div");
            doneDiv.className =
              "flex items-center gap-2 text-green-400 font-semibold text-sm";
            // simple checkmark indicator
            const checkSpan = document.createElement("span");
            checkSpan.textContent = "‚úì";
            checkSpan.className = "w-5 h-5 inline-block";
            doneDiv.appendChild(checkSpan);
            const doneText = document.createElement("span");
            doneText.textContent = "Completed";
            doneDiv.appendChild(doneText);
            bottomRow.appendChild(doneDiv);
          } else if (isLocked) {
            const lockedDiv = document.createElement("div");
            lockedDiv.className = "text-sm text-gray-500 flex items-center gap-2";
            const lockIcon = document.createElement("span");
            lockIcon.textContent = "üîí";
            lockedDiv.appendChild(lockIcon);
            const lockText = document.createElement("span");
            lockText.textContent = "Complete Check-in First";
            lockedDiv.appendChild(lockText);
            bottomRow.appendChild(lockedDiv);
          } else {
            const pendingDiv = document.createElement("div");
            pendingDiv.className = "text-sm text-gray-400";
            pendingDiv.textContent = "Status: Pending";
            bottomRow.appendChild(pendingDiv);
          }

          const viewBtn = document.createElement("button");
          viewBtn.className = `text-sm ${
            isLocked 
              ? "bg-gray-700 text-gray-500 cursor-not-allowed" 
              : "bg-gray-800 hover:bg-red-700 text-white hover:border-red-600"
          } font-bold py-2 px-5 rounded-md transition-shadow shadow-sm border-2 border-transparent`;
          viewBtn.type = "button";
          viewBtn.textContent = isLocked ? "Locked" : "View";
          viewBtn.disabled = isLocked;
          bottomRow.appendChild(viewBtn);

          card.appendChild(topGrow);
          card.appendChild(bottomRow);
          grid.appendChild(card);

          // keyboard activation (Enter / Space) - only if not locked
          card.addEventListener("keydown", (e) => {
            if (!isLocked && (e.key === "Enter" || e.key === " ")) {
              e.preventDefault();
              openModal(card.dataset.day, true);
            }
          });
        });
      }

      function renderWeeklyProgress() {
        const completableWorkouts = Object.keys(workoutPlan).filter(
          (day) => day !== "saturday" && day !== "sunday"
        ).length;
        const completedCount = state.completedWorkouts.size;
        workoutsCompletedSpan.textContent = `${completedCount}`;
        const progressPercentage = (completedCount / completableWorkouts) * 100;
        progressBar.style.width = `${progressPercentage}%`;
      }

      function renderDailyTaskTracker(dayKey) {
        if (!dayKey || !state.pushupCounters.hasOwnProperty(dayKey)) return;
        const count = state.pushupCounters[dayKey] || 0;
        const progress = (count / 500) * 100;
        pushupProgressBar.style.width = `${progress}%`;
        pushupProgressBar.textContent =
          count > 0 ? `${Math.round(progress)}%` : "";
        pushupCountText.textContent = `${count} / 500`;
        if (count >= 500) {
          pushupProgressBar.classList.add("bg-green-600");
          pushupProgressBar.classList.remove("bg-red-600");
        } else {
          pushupProgressBar.classList.remove("bg-green-600");
          pushupProgressBar.classList.add("bg-red-600");
        }
      }

      function renderMeasurementInputs() {
        const isFemale = state.measurements.figureType === "female";
        const currentParts = isFemale
          ? measurementPartsFemale
          : measurementPartsMale;

        // Clear both containers
        if (measurementsInputsAnalytics) measurementsInputsAnalytics.innerHTML = "";
        if (measurementsInputsResources) measurementsInputsResources.innerHTML = "";
        
        const partOrder = [
          "neck",
          "chest",
          "waist",
          "hips",
          "leftBicep",
          "rightBicep",
          "leftForearm",
          "rightForearm",
          "leftThigh",
          "rightThigh",
          "leftCalf",
          "rightCalf",
        ];
        
        partOrder.forEach((part) => {
          if (currentParts[part]) {
            const { label, base } = currentParts[part];
            
            // Create for Analytics tab
            if (measurementsInputsAnalytics) {
              const div1 = document.createElement("div");
              const labelEl1 = document.createElement("label");
              labelEl1.htmlFor = `measure-analytics-${part}`;
              labelEl1.className = "text-sm font-medium text-gray-400";
              labelEl1.textContent = label;
              const inputEl1 = document.createElement("input");
              inputEl1.type = "number";
              inputEl1.step = "0.1";
              inputEl1.id = `measure-analytics-${part}`;
              inputEl1.dataset.part = part;
              inputEl1.className =
                "w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-red-500 focus:border-red-500";
              inputEl1.placeholder = base;
              div1.appendChild(labelEl1);
              div1.appendChild(inputEl1);
              measurementsInputsAnalytics.appendChild(div1);
            }
            
            // Create for Resources tab
            if (measurementsInputsResources) {
              const div2 = document.createElement("div");
              const labelEl2 = document.createElement("label");
              labelEl2.htmlFor = `measure-${part}`;
              labelEl2.className = "text-sm font-medium text-gray-400";
              labelEl2.textContent = label;
              const inputEl2 = document.createElement("input");
              inputEl2.type = "number";
              inputEl2.step = "0.1";
              inputEl2.id = `measure-${part}`;
              inputEl2.dataset.part = part;
              inputEl2.className =
                "w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-red-500 focus:border-red-500";
              inputEl2.placeholder = base;
              div2.appendChild(labelEl2);
              div2.appendChild(inputEl2);
              measurementsInputsResources.appendChild(div2);
            }
          }
        });
      }

      function renderBodyScan() {
        const isFemale = state.measurements.figureType === "female";
        const bodyType = state.measurements.bodyType || "mesomorph";

        const currentVitals = isFemale ? vitalsFemale : vitalsMale;
        const currentParts = isFemale
          ? measurementPartsFemale
          : measurementPartsMale;

        document.querySelectorAll(".body-type-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.type === bodyType);
        });

        const maleBtn = document.getElementById("figure-male-btn");
        const femaleBtn = document.getElementById("figure-female-btn");
        maleBtn.classList.toggle("bg-red-600", !isFemale);
        maleBtn.classList.toggle("text-white", !isFemale);
        maleBtn.classList.toggle("bg-transparent", isFemale);
        maleBtn.classList.toggle("text-gray-400", isFemale);
        femaleBtn.classList.toggle("bg-red-600", isFemale);
        femaleBtn.classList.toggle("text-white", isFemale);
        femaleBtn.classList.toggle("bg-transparent", !isFemale);
        femaleBtn.classList.toggle("text-gray-400", !isFemale);

        document
          .getElementById("body-scan-svg-male")
          .classList.toggle("hidden", isFemale);
        document
          .getElementById("body-scan-svg-female")
          .classList.toggle("hidden", !isFemale);

        for (const part in { ...currentVitals, ...currentParts }) {
          const input = document.getElementById(`measure-${part}`);
          if (input) input.value = state.measurements[part] || "";
        }

        const getScale = (part, allParts) => {
          const value = parseFloat(state.measurements[part]);
          const baseValue = allParts[part].base;
          if (!value || isNaN(value) || !baseValue) return 1;
          return Math.max(0.5, Math.min(1.5, value / baseValue));
        };

        const applyTransform = (id, scaleX = 1, scaleY = 1) => {
          const element = document.getElementById(id);
          if (!element) return;
          const originX = element.dataset.originX;
          const originY = element.dataset.originY;
          if (originX && originY) {
            element.setAttribute(
              "transform",
              `translate(${originX}, ${originY}) scale(${scaleX}, ${scaleY}) translate(${-originX}, ${-originY})`
            );
          }
        };

        const heightScale =
          getScale("height", currentVitals) * bodyTypeScales[bodyType].height;
        const weightScale =
          getScale("weight", currentVitals) * bodyTypeScales[bodyType].width;

        const figurePrefix = isFemale ? "svg-female-" : "svg-male-";

        applyTransform(figurePrefix + "head", weightScale, 1);
        applyTransform(
          figurePrefix + "neck",
          getScale("neck", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "chest",
          getScale("chest", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "waist",
          getScale("waist", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "hips",
          getScale("hips", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "left-bicep",
          getScale("leftBicep", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "right-bicep",
          getScale("rightBicep", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "left-forearm",
          getScale("leftForearm", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "right-forearm",
          getScale("rightForearm", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "left-thigh",
          getScale("leftThigh", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "right-thigh",
          getScale("rightThigh", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "left-calf",
          getScale("leftCalf", currentParts) * weightScale,
          heightScale
        );
        applyTransform(
          figurePrefix + "right-calf",
          getScale("rightCalf", currentParts) * weightScale,
          heightScale
        );
      }

      async function renderProgressData() {
        try {
          // Get workout history to calculate progress stats
          const workoutHistory = await getWorkoutHistory();
          
          // Calculate total workouts
          const totalWorkouts = workoutHistory.length;
          document.getElementById('total-workouts').textContent = totalWorkouts;
          
          // Calculate weekly workouts
          const weeklyWorkouts = state.completedWorkouts.size;
          document.getElementById('weekly-workouts').textContent = weeklyWorkouts;
          
          // Calculate current streak
          const streak = calculateWorkoutStreak(workoutHistory);
          document.getElementById('workout-streak').textContent = streak;
          
          // Render weekly progress chart
          renderWeeklyProgressChart();
          
          // Render recent performance
          renderRecentPerformance(workoutHistory.slice(-5)); // Last 5 workouts
          
          // Render push-up progress
          renderPushupProgress();
          
        } catch (error) {
          console.error('Error rendering progress data:', error);
          // Set default values on error
          document.getElementById('total-workouts').textContent = '0';
          document.getElementById('weekly-workouts').textContent = '0';
          document.getElementById('workout-streak').textContent = '0';
        }
      }

      async function getWorkoutHistory() {
        if (!userId) return [];
        try {
          const historyCollectionRef = collection(db, "users", userId, "workoutHistory");
          const querySnapshot = await getDocs(query(historyCollectionRef, orderBy("completedAt", "desc")));
          return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
          console.error("Error fetching workout history:", error);
          return [];
        }
      }

      function calculateWorkoutStreak(workoutHistory) {
        if (workoutHistory.length === 0) return 0;
        
        const today = new Date();
        let streak = 0;
        let currentDate = new Date(today);
        
        // Sort workouts by date (most recent first)
        const sortedWorkouts = workoutHistory.sort((a, b) => 
          new Date(b.completedAt.toDate()) - new Date(a.completedAt.toDate())
        );
        
        for (const workout of sortedWorkouts) {
          const workoutDate = new Date(workout.completedAt.toDate());
          const daysDiff = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff <= 1) { // Within 1 day (allows for same day or previous day)
            streak++;
            currentDate = new Date(workoutDate);
          } else {
            break;
          }
        }
        
        return streak;
      }

      function renderWeeklyProgressChart() {
        const chartContainer = document.getElementById('weekly-progress-chart');
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        chartContainer.innerHTML = '';
        
        days.forEach((day, index) => {
          const dayKey = dayKeys[index];
          const isCompleted = state.completedWorkouts.has(dayKey);
          const isWeekend = dayKey === 'saturday' || dayKey === 'sunday';
          
          const dayElement = document.createElement('div');
          dayElement.className = 'flex items-center justify-between p-3 rounded border';
          
          if (isCompleted) {
            dayElement.className += ' bg-green-600/20 border-green-500';
          } else if (isWeekend) {
            dayElement.className += ' bg-gray-600/20 border-gray-500';
          } else {
            dayElement.className += ' bg-gray-800/50 border-gray-600';
          }
          
          dayElement.innerHTML = `
            <span class="text-white font-medium">${day}</span>
            <span class="text-sm ${isCompleted ? 'text-green-400' : isWeekend ? 'text-gray-400' : 'text-gray-500'}">
              ${isCompleted ? '‚úì Completed' : isWeekend ? 'Rest Day' : 'Pending'}
            </span>
          `;
          
          chartContainer.appendChild(dayElement);
        });
      }

      function renderRecentPerformance(recentWorkouts) {
        const container = document.getElementById('recent-performance');
        container.innerHTML = '';
        
        if (recentWorkouts.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center py-4">No workout data available</p>';
          return;
        }
        
        recentWorkouts.forEach(workout => {
          const workoutDate = new Date(workout.completedAt.toDate());
          const workoutElement = document.createElement('div');
          workoutElement.className = 'bg-gray-800/50 p-4 rounded border border-gray-600';
          
          const totalSets = workout.exercises.reduce((total, ex) => total + (ex.sets?.length || 0), 0);
          
          workoutElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="text-white font-medium capitalize">${workout.day}</span>
              <span class="text-gray-400 text-sm">${workoutDate.toLocaleDateString()}</span>
            </div>
            <div class="text-sm text-gray-300">
              <span>${workout.exercises.length} exercises</span>
              <span class="mx-2">‚Ä¢</span>
              <span>${totalSets} sets completed</span>
            </div>
          `;
          
          container.appendChild(workoutElement);
        });
      }

      function renderPushupProgress() {
        const container = document.getElementById('pushup-progress');
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
        
        container.innerHTML = '';
        
        days.forEach((day, index) => {
          const dayKey = dayKeys[index];
          const count = state.pushupCounters[dayKey] || 0;
          
          const dayElement = document.createElement('div');
          dayElement.className = 'text-center p-3 bg-gray-800/50 rounded border border-gray-600';
          
          dayElement.innerHTML = `
            <div class="text-white font-medium text-sm mb-1">${day.slice(0, 3)}</div>
            <div class="text-2xl font-bold ${count > 0 ? 'text-green-400' : 'text-gray-500'}">${count}</div>
            <div class="text-xs text-gray-400">push-ups</div>
          `;
          
          container.appendChild(dayElement);
        });
      }

      function populateExerciseLibrary() {
        if (!libraryContent) return;

        const uniqueExercises = new Map();

        Object.values(originalWorkoutPlan).forEach((day) => {
          if (day.exercises) {
            day.exercises.forEach((exercise) => {
              if (
                exercise.baseName &&
                !uniqueExercises.has(exercise.baseName)
              ) {
                uniqueExercises.set(exercise.baseName, exercise);
              }
            });
          }
        });

        const sortedExercises = [...uniqueExercises.values()].sort((a, b) =>
          a.baseName.localeCompare(b.baseName)
        );

        // Build library heading
        while (libraryContent.firstChild)
          libraryContent.removeChild(libraryContent.firstChild);
        const heading = document.createElement("h2");
        heading.className =
          "font-bebas text-4xl text-red-500 tracking-wide mb-6 text-center";
        heading.textContent = "Exercise Library";
        libraryContent.appendChild(heading);
        
        // Add difficulty filter buttons
        const filterContainer = document.createElement("div");
        filterContainer.className = "flex flex-wrap justify-center gap-2 mb-6";
        
        const filterButtons = ["all", "beginner", "intermediate", "expert"];
        let activeFilter = "all";
        
        filterButtons.forEach(filter => {
          const btn = document.createElement("button");
          btn.className = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            filter === "all" 
              ? "bg-red-600 text-white" 
              : "bg-gray-700 text-gray-300 hover:bg-gray-600"
          }`;
          btn.textContent = filter === "all" ? "ALL" : filter.toUpperCase();
          btn.addEventListener("click", () => {
            activeFilter = filter;
            // Update button styles
            filterContainer.querySelectorAll("button").forEach(b => {
              b.className = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                b.textContent.toLowerCase() === filter.toLowerCase() || (filter === "all" && b.textContent === "ALL")
                  ? "bg-red-600 text-white" 
                  : "bg-gray-700 text-gray-300 hover:bg-gray-600"
              }`;
            });
            // Re-render exercises with filter
            renderFilteredExercises(sortedExercises, activeFilter, gridWrap);
          });
          filterContainer.appendChild(btn);
        });
        
        libraryContent.appendChild(filterContainer);
        
        const gridWrap = document.createElement("div");
        gridWrap.className =
          "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";

        // Initial render with all exercises
        renderFilteredExercises(sortedExercises, "all", gridWrap);
        
        libraryContent.appendChild(gridWrap);
      }

      function renderFilteredExercises(exercises, filter, container) {
        // Clear container
        while (container.firstChild) container.removeChild(container.firstChild);
        
        // Filter exercises
        const filteredExercises = filter === "all" 
          ? exercises 
          : exercises.filter(ex => ex.difficulty === filter);
        
        if (filteredExercises.length === 0) {
          const p = document.createElement("p");
          p.className = "text-center col-span-full text-gray-400";
          p.textContent = filter === "all" ? "No exercises found." : `No ${filter} exercises found.`;
          container.appendChild(p);
        } else {
          filteredExercises.forEach((exercise) => {
            const card = document.createElement("div");
            card.className =
              "bg-[rgba(255,255,255,0.03)] p-4 rounded-lg border border-[rgba(255,255,255,0.04)] flex flex-col";
            const titleContainer = document.createElement("div");
            titleContainer.className = "flex items-center justify-between mb-2 flex-wrap gap-2";
            
            const h3 = document.createElement("h3");
            h3.className = "font-bold text-lg text-white";
            h3.textContent = exercise.baseName || "";
            titleContainer.appendChild(h3);
            
            // Add difficulty badge to library
            if (exercise.difficulty) {
              const difficultyBadge = document.createElement("span");
              difficultyBadge.className = "text-xs px-2 py-1 rounded-full font-medium";
              
              if (exercise.difficulty === "beginner") {
                difficultyBadge.className += " bg-green-600/20 text-green-400 border border-green-500/30";
                difficultyBadge.textContent = "BEGINNER";
              } else if (exercise.difficulty === "intermediate") {
                difficultyBadge.className += " bg-yellow-600/20 text-yellow-400 border border-yellow-500/30";
                difficultyBadge.textContent = "INTERMEDIATE";
              } else if (exercise.difficulty === "expert") {
                difficultyBadge.className += " bg-red-600/20 text-red-400 border border-red-500/30";
                difficultyBadge.textContent = "EXPERT";
              }
              titleContainer.appendChild(difficultyBadge);
            }
            
            const p = document.createElement("p");
            p.className = "text-gray-400 text-sm flex-grow";
            p.textContent = exercise.note || "";
            const meta = document.createElement("div");
            meta.className =
              "mt-4 pt-3 border-t border-gray-700 text-xs space-y-1";
            if (exercise.variations && exercise.variations.easier) {
              const d = document.createElement("div");
              d.className = "flex flex-wrap items-center gap-1";
              const label = document.createElement("span");
              label.className = "font-semibold text-blue-400";
              label.textContent = "Easier:";
              d.appendChild(label);
              
              exercise.variations.easier.forEach((variation, index) => {
                if (index > 0) {
                  const comma = document.createElement("span");
                  comma.className = "text-gray-300";
                  comma.textContent = ", ";
                  d.appendChild(comma);
                }
                const variationElement = renderVariationWithBadge(variation);
                variationElement.className += " text-gray-300";
                d.appendChild(variationElement);
              });
              
              meta.appendChild(d);
            }
            if (exercise.variations && exercise.variations.harder) {
              const d = document.createElement("div");
              d.className = "flex flex-wrap items-center gap-1";
              const label = document.createElement("span");
              label.className = "font-semibold text-red-400";
              label.textContent = "Harder:";
              d.appendChild(label);
              
              exercise.variations.harder.forEach((variation, index) => {
                if (index > 0) {
                  const comma = document.createElement("span");
                  comma.className = "text-gray-300";
                  comma.textContent = ", ";
                  d.appendChild(comma);
                }
                const variationElement = renderVariationWithBadge(variation);
                variationElement.className += " text-gray-300";
                d.appendChild(variationElement);
              });
              
              meta.appendChild(d);
            }
            if (exercise.alternatives && exercise.alternatives.length > 0) {
              const d = document.createElement("div");
              d.className = "flex flex-wrap items-center gap-1";
              const label = document.createElement("span");
              label.className = "font-semibold text-purple-400";
              label.textContent = "Alternatives:";
              d.appendChild(label);
              
              exercise.alternatives.forEach((alternative, index) => {
                if (index > 0) {
                  const comma = document.createElement("span");
                  comma.className = "text-gray-300";
                  comma.textContent = ", ";
                  d.appendChild(comma);
                }
                const altElement = renderVariationWithBadge(alternative);
                altElement.className += " text-gray-300";
                d.appendChild(altElement);
              });
              
              meta.appendChild(d);
            }
            card.appendChild(titleContainer);
            card.appendChild(p);
            card.appendChild(meta);
            container.appendChild(card);
          });
        }

      }

      function createDifficultyBadge(difficulty) {
        if (!difficulty) return null;
        
        const badge = document.createElement("span");
        badge.className = "text-xs px-1.5 py-0.5 rounded font-medium ml-1";
        
        if (difficulty === "beginner") {
          badge.className += " bg-green-600/20 text-green-400";
          badge.textContent = "BEG";
        } else if (difficulty === "intermediate") {
          badge.className += " bg-yellow-600/20 text-yellow-400";
          badge.textContent = "INT";
        } else if (difficulty === "expert") {
          badge.className += " bg-red-600/20 text-red-400";
          badge.textContent = "EXP";
        }
        
        return badge;
      }

      function renderVariationWithBadge(variation) {
        const container = document.createElement("span");
        container.className = "inline-flex items-center";
        
        const nameSpan = document.createElement("span");
        nameSpan.textContent = variation.name;
        container.appendChild(nameSpan);
        
        const badge = createDifficultyBadge(variation.difficulty);
        if (badge) container.appendChild(badge);
        
        return container;
      }

      // Helper: reliably parse the number of sets from an exercise's sets field
      function getNumericSets(exercise) {
        if (!exercise || !exercise.sets) return 0;
        const n = parseInt(String(exercise.sets).replace(/[^0-9]/g, ""), 10);
        return isNaN(n) ? 0 : n;
      }

      // Build a safe DOM element for an exercise (prevents XSS from innerHTML)
      function buildExerciseElement(exercise, index, dayKey) {
        const container = document.createElement("div");
        container.className = "py-3 border-b border-gray-700 last:border-b-0";
        container.id = `exercise-${dayKey}-${index}`;

        const topRow = document.createElement("div");
        topRow.className = "flex justify-between items-start flex-wrap gap-2";

        const left = document.createElement("div");
        const titleContainer = document.createElement("div");
        titleContainer.className = "flex items-center gap-2 flex-wrap";
        
        const title = document.createElement("h4");
        title.className = "text-lg font-bold text-white";
        title.textContent = exercise.name || "";
        titleContainer.appendChild(title);
        
        // Add difficulty badge
        if (exercise.difficulty) {
          const difficultyBadge = document.createElement("span");
          difficultyBadge.className = "text-xs px-2 py-1 rounded-full font-medium";
          
          // Color coding for difficulty levels
          if (exercise.difficulty === "beginner") {
            difficultyBadge.className += " bg-green-600/20 text-green-400 border border-green-500/30";
            difficultyBadge.textContent = "BEGINNER";
          } else if (exercise.difficulty === "intermediate") {
            difficultyBadge.className += " bg-yellow-600/20 text-yellow-400 border border-yellow-500/30";
            difficultyBadge.textContent = "INTERMEDIATE";
          } else if (exercise.difficulty === "expert") {
            difficultyBadge.className += " bg-red-600/20 text-red-400 border border-red-500/30";
            difficultyBadge.textContent = "EXPERT";
          }
          titleContainer.appendChild(difficultyBadge);
        }
        
        const note = document.createElement("p");
        note.className = "text-gray-400 mt-1 text-sm";
        note.textContent = exercise.note || "";
        left.appendChild(titleContainer);
        left.appendChild(note);
        
        // Add "View Muscles" button
        const muscleBtn = document.createElement("button");
        muscleBtn.className = "mt-2 text-xs bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-1 px-3 rounded-full transition flex items-center gap-1";
        muscleBtn.type = "button";
        muscleBtn.innerHTML = "üí™ View Muscle Groups";
        muscleBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          showMuscleGroupModal(exercise.name);
        });
        left.appendChild(muscleBtn);

        const right = document.createElement("div");
        right.className = "text-right flex-shrink-0";
        if (exercise.sets && exercise.reps) {
          const setsReps = document.createElement("p");
          setsReps.className = "text-md font-semibold text-red-400";
          setsReps.textContent = `${exercise.sets} x ${exercise.reps}`;
          right.appendChild(setsReps);
        }
        if (exercise.rest) {
          const rest = document.createElement("p");
          rest.className = "text-sm text-blue-400";
          rest.textContent = `Rest: ${exercise.rest}s`;
          right.appendChild(rest);
        }
        const hasAlternatives =
          exercise.alternatives && exercise.alternatives.length > 0;
        if (hasAlternatives) {
          const swapBtn = document.createElement("button");
          swapBtn.className =
            "text-xs text-purple-400 hover:text-purple-300 transition mt-1";
          swapBtn.type = "button";
          swapBtn.textContent = "Swap Exercise";
          swapBtn.addEventListener("click", () =>
            showAlternatives(dayKey, index)
          );
          right.appendChild(swapBtn);
        }

        topRow.appendChild(left);
        topRow.appendChild(right);
        container.appendChild(topRow);

        // Sets area
        const loggedSetsForExercise =
          state.loggedSets[dayKey] && state.loggedSets[dayKey][index]
            ? state.loggedSets[dayKey][index]
            : [];
        const totalSets = getNumericSets(exercise);
        if (totalSets > 0) {
          const setsWrapper = document.createElement("div");
          setsWrapper.className = "mt-4";

          const headerRow = document.createElement("div");
          headerRow.className = "flex justify-between items-center mb-2";
          const header = document.createElement("h5");
          header.className = "text-sm font-semibold text-gray-300";
          header.textContent = "Log Your Sets";
          const controls = document.createElement("div");
          controls.className = "flex gap-2";

          const addBtn = document.createElement("button");
          addBtn.className =
            "text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-2 rounded-lg transition";
          addBtn.type = "button";
          addBtn.textContent = "+ Add Set";
          addBtn.addEventListener("click", () => addSet(dayKey, index));

          const removeBtn = document.createElement("button");
          removeBtn.className =
            "text-xs bg-gray-600 hover:bg-gray-500 text-white font-semibold py-1 px-2 rounded-lg transition";
          removeBtn.type = "button";
          removeBtn.textContent = "- Remove Set";
          removeBtn.addEventListener("click", () => removeSet(dayKey, index));

          controls.appendChild(addBtn);
          controls.appendChild(removeBtn);
          headerRow.appendChild(header);
          headerRow.appendChild(controls);

          const setsButtonsRow = document.createElement("div");
          setsButtonsRow.className = "flex flex-wrap gap-2";

          for (let i = 1; i <= totalSets; i++) {
            const setData = loggedSetsForExercise[i - 1];
            const isDone = setData !== undefined;
            const btn = document.createElement("button");
            btn.className = `set-btn ${
              isDone
                ? "bg-green-600 cursor-not-allowed"
                : "bg-gray-600 hover:bg-gray-500"
            } text-white font-semibold py-1 px-3 rounded transition text-sm`;
            btn.type = "button";
            if (isDone) {
              btn.disabled = true;
              btn.textContent = `‚úì Set ${i}: ${setData.reps} reps`;
            } else {
              btn.textContent = `Set ${i}`;
              btn.addEventListener("click", () => logSet(dayKey, index, i));
            }
            setsButtonsRow.appendChild(btn);
          }

          setsWrapper.appendChild(headerRow);
          setsWrapper.appendChild(setsButtonsRow);
          container.appendChild(setsWrapper);
        }

        return container;
      }

      window.logSet = (dayKey, exerciseIndex, setIndex) => {
        console.log("=== DEBUG: logSet called ===");
        console.log("dayKey:", dayKey);
        console.log("exerciseIndex:", exerciseIndex);
        console.log("setIndex:", setIndex);
        
        try {
          if (!workoutPlan[dayKey]) {
            console.error("No workout plan for day:", dayKey);
            showToast("Workout day not found", "error");
            return;
          }
          
          if (!workoutPlan[dayKey].exercises[exerciseIndex]) {
            console.error("Exercise not found at index:", exerciseIndex);
            showToast("Exercise not found", "error");
            return;
          }
          
          const exercise = workoutPlan[dayKey].exercises[exerciseIndex];
          console.log("Exercise found:", exercise);
          
          state.activeExercise = { dayKey, index: exerciseIndex, set: setIndex };

          if (exercise && exercise.rest) {
            console.log("Exercise has rest period, opening feedback modal");
            console.log("NO automatic logging - waiting for user to click Save");
            openFeedbackAndRestModal(
              exercise.rest,
              dayKey,
              exerciseIndex,
              setIndex
            );
          } else {
            console.log("Exercise has no rest period, logging directly");
            if (!state.loggedSets[dayKey]) state.loggedSets[dayKey] = {};
            if (!state.loggedSets[dayKey][exerciseIndex])
              state.loggedSets[dayKey][exerciseIndex] = [];
            state.loggedSets[dayKey][exerciseIndex][setIndex - 1] = {
              reps: "‚úì",
              rating: null,
            };

            const exerciseContainer = document.getElementById(
              `exercise-${dayKey}-${exerciseIndex}`
            );
            if (exerciseContainer) {
              const newEl = buildExerciseElement(exercise, exerciseIndex, dayKey);
              exerciseContainer.replaceWith(newEl);
            }
            checkAllSetsCompleted();
            saveStateToFirestore();
            showToast("Set logged successfully", "info");
          }
        } catch (error) {
          console.error("Error in logSet:", error);
          showToast("Error logging set: " + error.message, "error");
        }
      };      window.saveRepsAndAdjust = (
        dayKey,
        exerciseIndex,
        setIndex,
        restSeconds
      ) => {
        const repInput = document.getElementById("rest-timer-rep-input");
        const reps = repInput ? repInput.value || "0" : "0";
        const rating = state.activeExercise ? state.activeExercise.rating : null;

        if (!rating) {
          showToast("Please select a difficulty rating.", "error");
          return;
        }

        if (!state.loggedSets[dayKey]) state.loggedSets[dayKey] = {};
        if (!state.loggedSets[dayKey][exerciseIndex])
          state.loggedSets[dayKey][exerciseIndex] = [];
        state.loggedSets[dayKey][exerciseIndex][setIndex - 1] = {
          reps,
          rating,
        };

        const exercise = workoutPlan[dayKey].exercises[exerciseIndex];
        const baseExercise = allExercisesMasterList[exercise.baseName];

        if (baseExercise && baseExercise.variations) {
          // Build the ladder using the .name property for each variation object
          const easierNames = Array.isArray(baseExercise.variations.easier)
            ? baseExercise.variations.easier.map(v => v.name).reverse()
            : [];
          const harderNames = Array.isArray(baseExercise.variations.harder)
            ? baseExercise.variations.harder.map(v => v.name)
            : [];
          const ladder = [
            ...easierNames,
            exercise.baseName,
            ...harderNames,
          ];
          const currentIndex = ladder.indexOf(exercise.name);

          if (rating >= 8 && currentIndex > 0) {
            const newExerciseName = ladder[currentIndex - 1];
            const newExerciseData =
              allExercisesMasterList[newExerciseName] ||
              Object.values(allExercisesMasterList).find(
                (ex) => ex.name === newExerciseName
              );
            if (newExerciseData) {
              workoutPlan[dayKey].exercises[exerciseIndex] = JSON.parse(
                JSON.stringify(newExerciseData)
              );
              showToast(
                `Set was tough. Switched to ${newExerciseName} for the next set.`,
                "info"
              );
            }
          } else if (rating <= 4 && currentIndex < ladder.length - 1) {
            const newExerciseName = ladder[currentIndex + 1];
            const newExerciseData =
              allExercisesMasterList[newExerciseName] ||
              Object.values(allExercisesMasterList).find(
                (ex) => ex.name === newExerciseName
              );
            if (newExerciseData) {
              workoutPlan[dayKey].exercises[exerciseIndex] = JSON.parse(
                JSON.stringify(newExerciseData)
              );
              showToast(
                `Too easy! Switched to ${newExerciseName} for a challenge.`,
                "info"
              );
            }
          }
        }

        const exerciseContainer = document.getElementById(
          `exercise-${dayKey}-${exerciseIndex}`
        );
        if (exerciseContainer) {
          const newEl = buildExerciseElement(
            workoutPlan[dayKey].exercises[exerciseIndex],
            exerciseIndex,
            dayKey
          );
          exerciseContainer.replaceWith(newEl);
        }

        // Clear and build timer modal controls safely
        while (restTimerDynamicContent.firstChild)
          restTimerDynamicContent.removeChild(
            restTimerDynamicContent.firstChild
          );
        timerModalTitle.textContent = "Resting...";
        while (timerControls.firstChild)
          timerControls.removeChild(timerControls.firstChild);
        const startStopBtnEl = document.createElement("button");
        startStopBtnEl.id = "start-stop-btn";
        startStopBtnEl.className =
          "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded";
        startStopBtnEl.textContent = "Pause";
        const resetBtnEl = document.createElement("button");
        resetBtnEl.id = "reset-btn";
        resetBtnEl.className =
          "bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded";
        resetBtnEl.textContent = "Skip";
        timerControls.appendChild(startStopBtnEl);
        timerControls.appendChild(resetBtnEl);

        resetCountdown(restSeconds);
        startCountdown();

        const startStopBtn = document.getElementById("start-stop-btn");
        const resetBtn = document.getElementById("reset-btn");
        startStopBtn.onclick = () =>
          state.timer.running ? stopCountdown() : startCountdown();
        resetBtn.onclick = () => {
          stopCountdown();
          closeModal(timerModal, timerModalContainer);
        };

        setTimeout(() => {
          if (!timerModal.classList.contains("hidden")) {
            closeModal(timerModal, timerModalContainer);
          }
        }, restSeconds * 1000);

        // Persist logged sets immediately
        saveStateToFirestore();

        checkAllSetsCompleted();
      };

      window.showAlternatives = (dayKey, exerciseIndex) => {
        state.activeExercise = { dayKey, index: exerciseIndex };
        const exercise = workoutPlan[dayKey].exercises[exerciseIndex];
        if (!exercise.alternatives) return;

        alternativeModalContent.innerHTML = "";
        exercise.alternatives.forEach((alt) => {
          const btn = document.createElement("button");
          btn.className =
            "w-full text-left bg-gray-700 hover:bg-gray-600 p-3 rounded-md transition";
          btn.textContent = alt.name;
          btn.onclick = () => selectAlternative(alt.name);
          alternativeModalContent.appendChild(btn);
        });

        openGenericModal(alternativeModal, alternativeModalContainer);
      };

      window.addSet = (dayKey, exerciseIndex) => {
        if (
          !workoutPlan[dayKey] ||
          !workoutPlan[dayKey].exercises[exerciseIndex]
        )
          return;

        const exercise = workoutPlan[dayKey].exercises[exerciseIndex];
        const n = getNumericSets(exercise) + 1;
        exercise.sets = n.toString();

        const exerciseContainer = document.getElementById(
          `exercise-${dayKey}-${exerciseIndex}`
        );
        if (exerciseContainer) {
          const newEl = buildExerciseElement(exercise, exerciseIndex, dayKey);
          exerciseContainer.replaceWith(newEl);
        }
        checkAllSetsCompleted();
        saveStateToFirestore();
      };

      window.removeSet = (dayKey, exerciseIndex) => {
        if (
          !workoutPlan[dayKey] ||
          !workoutPlan[dayKey].exercises[exerciseIndex]
        )
          return;

        const exercise = workoutPlan[dayKey].exercises[exerciseIndex];
        const current = getNumericSets(exercise);
        const newCount = Math.max(0, current - 1);
        exercise.sets = newCount.toString();

        // Remove logged set data if present
        if (
          state.loggedSets[dayKey] &&
          state.loggedSets[dayKey][exerciseIndex]
        ) {
          // remove the last logged set
          state.loggedSets[dayKey][exerciseIndex].pop();
          if (state.loggedSets[dayKey][exerciseIndex].length === 0) {
            delete state.loggedSets[dayKey][exerciseIndex];
          }
        }

        const exerciseContainer = document.getElementById(
          `exercise-${dayKey}-${exerciseIndex}`
        );
        if (exerciseContainer) {
          const newEl = buildExerciseElement(exercise, exerciseIndex, dayKey);
          exerciseContainer.replaceWith(newEl);
        }
        checkAllSetsCompleted();
        saveStateToFirestore();
      };

      function selectAlternative(alternativeName) {
        const { dayKey, index } = state.activeExercise;

        const newExerciseData = allExercisesMasterList[alternativeName];

        if (newExerciseData) {
          workoutPlan[dayKey].exercises[index] = JSON.parse(
            JSON.stringify(newExerciseData)
          );
          
          // Clear logged sets for this exercise when swapping
          if (!state.loggedSets[dayKey]) {
            state.loggedSets[dayKey] = {};
          }
          delete state.loggedSets[dayKey][index];
          
          console.log(`Cleared logged sets for ${alternativeName} swap`);
        }

        const exerciseContainer = document.getElementById(
          `exercise-${dayKey}-${index}`
        );
        if (exerciseContainer) {
          const newEl = buildExerciseElement(
            workoutPlan[dayKey].exercises[index],
            index,
            dayKey
          );
          exerciseContainer.replaceWith(newEl);
        }
        closeModal(alternativeModal, alternativeModalContainer);
      }

      // --- MODAL & UI LOGIC ---
      // track active modal focus trap so we can release it on close
      let _activeModalTrap = null;

      // ============================================
      // ADAPTIVE WARM-UP & COOL-DOWN SYSTEM
      // ============================================
      
      function generateAdaptiveWarmupCooldown(dayKey) {
        const assessment = state.preWorkoutAssessment || {};
        const dayData = workoutPlan[dayKey];
        if (!dayData) return;
        
        // Get original warm-up and cool-down as base
        const baseWarmup = originalWorkoutPlan[dayKey]?.warmup || [];
        const baseCooldown = originalWorkoutPlan[dayKey]?.cooldown || [];
        
        // Start with base routines
        let adaptedWarmup = [...baseWarmup];
        let adaptedCooldown = [...baseCooldown];
        
        // Collect tight areas and problem zones
        const tightAreas = assessment.tightAreas || [];
        const soreMuscles = assessment.soreMuscles || [];
        const shoulderTension = assessment.shoulderTension || 'moderate';
        const techNeck = assessment.techNeck || 'sometimes';
        const deepSquat = assessment.deepSquat || 'somewhat';
        const deskHours = assessment.deskHours || '6-8';
        const stretchFrequency = assessment.stretchFrequency || 'rarely';
        const soreness = assessment.soreness || '0';
        
        // WARM-UP ADAPTATIONS
        
        // Add neck/upper back mobility if tech neck is an issue
        if (techNeck === 'often' || tightAreas.includes('neck') || tightAreas.includes('upper-back')) {
          adaptedWarmup.unshift('Neck Rolls - 10 slow circles each direction');
          adaptedWarmup.push('Cat-Cow Stretches - 10 reps (focus on upper back)');
        }
        
        // Add shoulder mobility for desk workers or shoulder tension
        if (shoulderTension === 'high' || shoulderTension === 'moderate' || deskHours === '6-8' || deskHours === '8+') {
          if (!adaptedWarmup.some(w => w.includes('Arm'))) {
            adaptedWarmup.splice(1, 0, 'Arm Circles - 20 forward, 20 backward');
          }
          adaptedWarmup.push('Wall Angels - 10 reps (improve posture)');
        }
        
        // Add hip mobility if deep squat is difficult
        if (deepSquat === 'no' || tightAreas.includes('hip-flexors') || tightAreas.includes('hips')) {
          adaptedWarmup.push('Hip Circles - 10 each direction per leg');
          adaptedWarmup.push('Deep Bodyweight Squats - 10 reps (hold bottom for 3 sec)');
        }
        
        // Add chest openers for desk workers
        if (deskHours === '6-8' || deskHours === '8+' || tightAreas.includes('chest')) {
          adaptedWarmup.push('Doorway Chest Stretch - 30 seconds each side');
        }
        
        // Add ankle mobility if ankles are tight
        if (tightAreas.includes('ankles')) {
          adaptedWarmup.push('Ankle Circles - 10 each direction per ankle');
        }
        
        // Add lower back mobility if tight
        if (tightAreas.includes('lower-back') || soreMuscles.includes('back')) {
          adaptedWarmup.push('Child\'s Pose - Hold for 30 seconds');
        }
        
        // COOL-DOWN ADAPTATIONS
        
        // Extended stretching for people who rarely stretch
        if (stretchFrequency === 'never' || stretchFrequency === 'rarely') {
          adaptedCooldown.push('‚≠ê Extended Hold - Add 15 seconds to each stretch below');
        }
        
        // Add hamstring stretches if tight
        if (tightAreas.includes('hamstrings')) {
          adaptedCooldown.splice(1, 0, 'Seated Hamstring Stretch - 45 seconds each leg');
        }
        
        // Add quad stretches if legs are tight or sore
        if (tightAreas.includes('quads') || soreMuscles.includes('legs')) {
          adaptedCooldown.push('Standing Quad Stretch - 45 seconds each leg');
        }
        
        // Add calf stretches if tight
        if (tightAreas.includes('calves')) {
          adaptedCooldown.push('Wall Calf Stretch - 45 seconds each leg');
        }
        
        // Add shoulder/upper back stretches
        if (shoulderTension === 'high' || tightAreas.includes('shoulders') || soreMuscles.includes('shoulders')) {
          adaptedCooldown.push('Cross-Body Shoulder Stretch - 30 seconds each arm');
          adaptedCooldown.push('Thread the Needle - 30 seconds each side');
        }
        
        // Add neck stretches for tech neck
        if (techNeck === 'often' || tightAreas.includes('neck')) {
          adaptedCooldown.push('Neck Side Stretches - 30 seconds each side');
        }
        
        // Add hip flexor stretches for desk workers
        if (deskHours === '6-8' || deskHours === '8+' || tightAreas.includes('hip-flexors')) {
          adaptedCooldown.push('Kneeling Hip Flexor Stretch - 45 seconds each side');
        }
        
        // Add spinal twists for lower back
        if (tightAreas.includes('lower-back') || soreMuscles.includes('back')) {
          adaptedCooldown.push('Supine Spinal Twist - 45 seconds each side');
        }
        
        // Add breathing exercise for recovery
        if (soreness === '2' || assessment.energy <= 2) {
          adaptedCooldown.push('Deep Breathing - 10 slow breaths (4 sec in, 6 sec out)');
        }
        
        // Update the workout plan with adapted routines
        dayData.warmup = adaptedWarmup;
        dayData.cooldown = adaptedCooldown;
        
        // Show notification if significant adaptations were made
        const addedWarmup = adaptedWarmup.length - baseWarmup.length;
        const addedCooldown = adaptedCooldown.length - baseCooldown.length;
        
        if (addedWarmup > 0 || addedCooldown > 0) {
          setTimeout(() => {
            showToast(
              `üéØ Warm-up & cool-down adapted based on your assessment! (+${addedWarmup + addedCooldown} exercises)`,
              'success'
            );
          }, 500);
        }
      }
      window.generateAdaptiveWarmupCooldown = generateAdaptiveWarmupCooldown;

      function openModal(dayKey, isPostAssessment = false) {
        if (!modal)
          console.error("[DEBUG] openModal: #workout-modal not found");
        if (!modalContainer)
          console.error(
            "[DEBUG] openModal: #modal-content-container not found"
          );
        if (!isPostAssessment && dayKey !== "saturday" && dayKey !== "sunday") {
          const homeTabBtn = document.querySelector(
            '.tab-btn[data-tab="home"]'
          );
          const workoutTabBtn = document.querySelector(
            '.tab-btn[data-tab="workout"]'
          );
          const homeContent = document.getElementById("home-content");
          const workoutContent = document.getElementById("workout-content");

          workoutTabBtn.classList.remove("active");
          workoutContent.classList.remove("active");
          homeTabBtn.classList.add("active");
          homeContent.classList.add("active");

          document.getElementById(
            "checkin-title"
          ).textContent = `${originalWorkoutPlan[dayKey].day}: Pre-Workout Check-in`;
          document.getElementById("workout-day-select").value = dayKey;

          state.activeDay = dayKey;
          return;
        }

        state.activeDay = dayKey;
        
        // If workout is in progress for this day, resume timer display
        if (state.workoutInProgress && state.workoutStartTime) {
          if (typeof resumeWorkoutTimer === 'function') {
            resumeWorkoutTimer();
          }
        }
        
        // Track workout start time for ML analysis only if workout is in progress
        // Timer will start when user clicks "Start Workout" button
        
        // Apply ML-based difficulty adaptations
        try {
          adaptWorkoutDifficulty(dayKey);
        } catch (error) {
          console.error('Error applying workout adaptations:', error);
        }
        
        // Apply adaptive warm-up and cool-down based on assessment
        if (state.preWorkoutAssessment && Object.keys(state.preWorkoutAssessment).length > 0) {
          try {
            generateAdaptiveWarmupCooldown(dayKey);
          } catch (error) {
            console.error('Error applying adaptive warm-up/cool-down:', error);
          }
        }
        
        const data = workoutPlan[dayKey];

        modalTitle.textContent = data.title;
        modalSubtitle.textContent = `${data.day}: ${data.subtitle}`;

        // Build modal content safely without innerHTML
        while (modalContent.firstChild)
          modalContent.removeChild(modalContent.firstChild);

        if (data.warmup && data.warmup.length > 0) {
          const warmupTitle = document.createElement("h3");
          warmupTitle.className =
            "font-bebas text-2xl text-red-500 tracking-wide mb-2";
          warmupTitle.textContent = "Warm-up";
          const warmupList = document.createElement("ul");
          warmupList.className = "list-disc list-inside text-gray-300 mb-4";
          data.warmup.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            warmupList.appendChild(li);
          });
          modalContent.appendChild(warmupTitle);
          modalContent.appendChild(warmupList);
        }

        if (data.exercises && data.exercises.length > 0) {
          const mainTitle = document.createElement("h3");
          mainTitle.className =
            "font-bebas text-2xl text-red-500 tracking-wide mb-2";
          mainTitle.textContent = "Main Workout";
          modalContent.appendChild(mainTitle);
          data.exercises.forEach((ex, index) => {
            modalContent.appendChild(buildExerciseElement(ex, index, dayKey));
          });
        }

        if (data.cooldown && data.cooldown.length > 0) {
          const coolTitle = document.createElement("h3");
          coolTitle.className =
            "font-bebas text-2xl text-red-500 tracking-wide mt-4 mb-2";
          coolTitle.textContent = "Cooldown";
          const coolList = document.createElement("ul");
          coolList.className = "list-disc list-inside text-gray-300";
          data.cooldown.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            coolList.appendChild(li);
          });
          modalContent.appendChild(coolTitle);
          modalContent.appendChild(coolList);
        }

        modalContent.classList.remove("hidden");
        
        // Show/hide appropriate buttons based on workout state
        if (state.workoutInProgress && state.activeDay === dayKey) {
          // Workout is in progress - hide start button, show complete
          startWorkoutBtn.classList.add("hidden");
          completeWorkoutBtn.classList.remove("hidden");
        } else if (state.completedWorkouts.has(dayKey)) {
          // Workout already completed
          startWorkoutBtn.classList.add("hidden");
          completeWorkoutBtn.classList.remove("hidden");
        } else {
          // Preview mode - show start button
          startWorkoutBtn.classList.remove("hidden");
          completeWorkoutBtn.classList.add("hidden");
        }

        if (state.completedWorkouts.has(dayKey)) {
          completeWorkoutBtn.textContent = "Completed";
          completeWorkoutBtn.disabled = true;
          completeWorkoutBtn.classList.add(
            "bg-green-600",
            "hover:bg-green-600"
          );
          completeWorkoutBtn.classList.remove("bg-red-600", "hover:bg-red-700");
        } else {
          completeWorkoutBtn.textContent = "Complete Workout";
          completeWorkoutBtn.disabled = true;
          completeWorkoutBtn.classList.remove(
            "bg-green-600",
            "hover:bg-green-600"
          );
          completeWorkoutBtn.classList.add("bg-red-600", "hover:bg-red-700");
        }

        if (dayKey === "saturday" || dayKey === "sunday") {
          completeWorkoutBtn.classList.add("hidden");
        }

        if (state.pushupCounters.hasOwnProperty(dayKey)) {
          dailyTaskTracker.classList.remove("hidden");
          renderDailyTaskTracker(dayKey);
        } else {
          dailyTaskTracker.classList.add("hidden");
        }

        // Ensure modal is visible; remove hiding classes (force if needed)
        modal.classList.remove("hidden");
        modal.classList.remove("opacity-0");
        if (modalContainer) modalContainer.classList.remove("scale-95");
        // Also do the animated removal for compatibility
        setTimeout(() => {
          modal.classList.remove("opacity-0");
          if (modalContainer) modalContainer.classList.remove("scale-95");
        }, 10);
        // Apply focus trap for accessibility
        try {
          if (_activeModalTrap && _activeModalTrap.release)
            _activeModalTrap.release();
        } catch (e) {}
        _activeModalTrap = trapFocus(modal);
      }

      function checkAllSetsCompleted() {
        const dayKey = state.activeDay;
        if (!dayKey) return;

        const exercises = workoutPlan[dayKey].exercises;
        const allDone = exercises.every((ex, index) => {
          const totalSets = parseInt(ex.sets);
          if (isNaN(totalSets) || totalSets <= 0) return true; // Skip exercises without sets

          const loggedSets = state.loggedSets[dayKey]?.[index] || [];
          return loggedSets.length >= totalSets;
        });

        if (allDone) {
          completeWorkoutBtn.disabled = false;
        }
      }

      function closeModal(modalElement, containerElement) {
        if (containerElement) containerElement.classList.add("scale-95");
        if (modalElement) modalElement.classList.add("opacity-0");
        // release any active trap
        try {
          if (_activeModalTrap && _activeModalTrap.release)
            _activeModalTrap.release();
        } catch (e) {}
        _activeModalTrap = null;
        setTimeout(() => {
          if (modalElement) {
            modalElement.classList.add("hidden");
            try {
              modalElement.style.display = "";
            } catch (e) {}
          }
        }, 300);
      }

      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        let bgColor = "bg-green-500";
        if (type === "info") bgColor = "bg-blue-500";
        if (type === "error") bgColor = "bg-red-500";
        toast.className = `toast ${bgColor} text-white font-bold py-2 px-4 rounded-lg shadow-lg`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // Make key functions globally accessible
      window.showToast = showToast;
      window.buildExerciseElement = buildExerciseElement;
      window.checkAllSetsCompleted = checkAllSetsCompleted;
      window.saveStateToFirestore = saveStateToFirestore;

      // --- EVENT HANDLERS ---
      function addEventListeners() {
        grid.addEventListener("click", (e) => {
          const card = e.target.closest(".day-card");
          if (card) {
            openModal(card.dataset.day, true); // open workout modal directly when clicking a day
          }
        });

        const workoutDaySelect = document.getElementById("workout-day-select");
        const dayOrder = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];
        dayOrder.forEach((dayKey) => {
          const option = document.createElement("option");
          option.value = dayKey;
          option.textContent = originalWorkoutPlan[dayKey].day;
          workoutDaySelect.appendChild(option);
        });

        assessmentForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const dayKey = document.getElementById("workout-day-select").value;
          if (!dayKey) return;
          state.activeDay = dayKey;
          
          // Set the checked-in day (unlocks this day for workout access)
          state.checkedInDay = dayKey;

          const formData = new FormData(assessmentForm);
          const assessmentData = {
            energy: parseInt(formData.get("energy")),
            sleep: formData.get("sleep"),
            mood: formData.get("mood"),
            soreness: parseInt(formData.get("soreness")),
            soreMuscles: formData.getAll("sore-muscle"),
            // Enhanced assessment data
            deskHours: formData.get("desk-hours"),
            techNeck: formData.get("tech-neck"),
            shoulderTension: formData.get("shoulder-tension"),
            deepSquat: formData.get("deep-squat"),
            tightAreas: formData.getAll("tight-area"),
            stretchFrequency: formData.get("stretch-frequency"),
          };
          state.preWorkoutAssessment = assessmentData;

          // AI-powered workout personalization based on assessment
          const personalizedRecommendations = generateWorkoutPersonalization(assessmentData);
          if (personalizedRecommendations.shouldShowRecommendations) {
            showPersonalizationModal(personalizedRecommendations);
          }

          const isDeload = await isDeloadWeek();
          let currentPlan = JSON.parse(
            JSON.stringify(originalWorkoutPlan[dayKey])
          );
          let adjustmentMade = false;

          if (isDeload && dayKey !== "saturday" && dayKey !== "sunday") {
            adjustmentMade = true;
            currentPlan.exercises.forEach((ex) => {
              if (ex.sets)
                ex.sets = Math.max(1, Math.floor(parseInt(ex.sets) / 2));
              if (
                ex.reps &&
                ex.reps !== "To Failure" &&
                ex.reps.includes("-")
              ) {
                const repRange = ex.reps.split("-").map(Number);
                ex.reps = `${Math.floor(repRange[0] * 0.8)}-${Math.floor(
                  repRange[1] * 0.8
                )}`;
              }
            });
          }

          let adjustmentFactor = 1.0;
          let reasons = [];
          if (assessmentData.energy <= 1) {
            adjustmentFactor -= 0.2;
            reasons.push("low energy");
          }
          if (assessmentData.sleep === "<6") {
            adjustmentFactor -= 0.2;
            reasons.push("poor sleep");
          }
          if (assessmentData.soreness >= 2) {
            adjustmentFactor -= 0.3;
            reasons.push("high soreness");
          } else if (assessmentData.soreness === 1) {
            adjustmentFactor -= 0.1;
            reasons.push("low soreness");
          }
          adjustmentFactor = Math.max(0.4, adjustmentFactor);

          if (adjustmentFactor < 1.0) {
            adjustmentMade = true;
            currentPlan.exercises.forEach((ex) => {
              if (ex.sets) {
                const originalSets = parseInt(ex.sets);
                if (!isNaN(originalSets))
                  ex.sets = Math.max(
                    1,
                    Math.round(originalSets * adjustmentFactor)
                  );
              }
            });
          }

          if (adjustmentMade) {
            showToast(
              `Workout volume adjusted based on your check-in.`,
              "info"
            );
          }

          workoutPlan[dayKey] = currentPlan;

          document.querySelector(".tab-btn.active").classList.remove("active");
          document
            .querySelector(".tab-content.active")
            .classList.remove("active");
          document
            .querySelector('.tab-btn[data-tab="workout"]')
            .classList.add("active");
          document.getElementById("workout-content").classList.add("active");

          openModal(dayKey, true);
        });

        document.querySelectorAll('input[name="soreness"]').forEach((radio) => {
          radio.addEventListener("change", (e) => {
            document
              .getElementById("sore-muscles-group")
              .classList.toggle("hidden", e.target.value === "0");
          });
        });

        tabBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const tabId = btn.dataset.tab;
            tabBtns.forEach((b) => b.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(`${tabId}-content`).classList.add("active");
          });
        });

        addPushupsBtn.addEventListener("click", () => {
          const dayKey = state.activeDay;
          if (!dayKey || !state.pushupCounters.hasOwnProperty(dayKey)) return;
          const reps = parseInt(pushupInput.value);
          if (reps > 0) {
            const currentCount = state.pushupCounters[dayKey] || 0;
            state.pushupCounters[dayKey] = Math.min(500, currentCount + reps);
            pushupInput.value = "";
            renderDailyTaskTracker(dayKey);
            saveStateToFirestore();
          }
        });

        document
          .getElementById("figure-male-btn")
          .addEventListener("click", () => {
            if (state.measurements.figureType !== "male") {
              state.measurements.figureType = "male";
              saveStateToFirestore();
            }
          });

        document
          .getElementById("figure-female-btn")
          .addEventListener("click", () => {
            if (state.measurements.figureType !== "female") {
              state.measurements.figureType = "female";
              saveStateToFirestore();
            }
          });

        document.querySelectorAll(".body-type-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const type = e.target.dataset.type;
            if (state.measurements.bodyType !== type) {
              state.measurements.bodyType = type;
              saveStateToFirestore();
            }
          });
        });

        saveMeasurementsBtn.addEventListener("click", () => {
          const inputs = document.querySelectorAll(
            "#scan-content input[data-part]"
          );
          inputs.forEach((input) => {
            const part = input.dataset.part;
            const value = input.value;
            if (part) {
              state.measurements[part] = value || null;
            }
          });
          saveStateToFirestore();
          renderBodyScan();
          showToast("Body Data Saved!");
        });

        closeModalBtn.addEventListener("click", () =>
          closeModal(modal, modalContainer)
        );
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal(modal, modalContainer);
        });
        closeAlternativeModalBtn.addEventListener("click", () =>
          closeModal(alternativeModal, alternativeModalContainer)
        );
        alternativeModal.addEventListener("click", (e) => {
          if (e.target === alternativeModal)
            closeModal(alternativeModal, alternativeModalContainer);
        });

        // Start Workout Button Handler
        startWorkoutBtn.addEventListener("click", () => {
          const dayKey = state.activeDay;
          if (!dayKey) return;
          
          // Check if user has completed check-in for this day
          const isCheckedIn = state.checkedInDay === dayKey;
          if (!isCheckedIn && dayKey !== "saturday" && dayKey !== "sunday") {
            showToast("‚ö†Ô∏è Please complete the check-in first!", "error");
            
            // Switch to check-in tab
            workoutTabBtn.classList.remove("active");
            workoutContent.classList.remove("active");
            checkinTabBtn.classList.add("active");
            checkinContent.classList.add("active");
            
            document.getElementById("checkin-title").textContent = `${originalWorkoutPlan[dayKey].day}: Pre-Workout Check-in`;
            document.getElementById("workout-day-select").value = dayKey;
            
            return;
          }
          
          // Start the workout
          state.workoutInProgress = true;
          state.workoutStartTime = Date.now();
          
          // Start the visual workout timer
          if (typeof startWorkoutTimer === 'function') {
            startWorkoutTimer();
          }
          
          // Update button visibility
          startWorkoutBtn.classList.add("hidden");
          completeWorkoutBtn.classList.remove("hidden");
          
          // Enable complete button
          if (!state.completedWorkouts.has(dayKey)) {
            completeWorkoutBtn.disabled = false;
          }
          
          showToast("‚è±Ô∏è Workout started! Timer is running.", "info");
          console.log('Workout started for', dayKey);
        });

        completeWorkoutBtn.addEventListener("click", async () => {
          if (state.activeDay && !completeWorkoutBtn.disabled) {
            const workoutStartTime = Date.now() - (state.workoutStartTime || 0);
            
            await saveWorkoutHistory();
            state.completedWorkouts.add(state.activeDay);
            
            // Record ML data for this workout session
            try {
              const dayData = workoutPlan[state.activeDay];
              if (dayData && state.loggedSets[state.activeDay]) {
                const exercises = dayData.exercises.map((exercise, index) => {
                  const loggedData = state.loggedSets[state.activeDay][index] || [];
                  const setsCompleted = loggedData.filter(set => set && set.reps).length;
                  const targetSets = parseInt(exercise.sets) || 0;
                  const repsData = loggedData.map(set => set?.reps === '‚úì' ? 1 : (parseInt(set?.reps) || 0));
                  const avgReps = repsData.length > 0 ? repsData.reduce((sum, r) => sum + r, 0) / repsData.length : 0;
                  
                  return {
                    ...exercise,
                    setsCompleted,
                    targetSets,
                    repsData,
                    avgReps,
                    completionRate: targetSets > 0 ? setsCompleted / targetSets : 0,
                  };
                });
                
                const workoutSession = recordWorkoutSession(
                  state.activeDay, 
                  exercises, 
                  state.workoutStartTime || Date.now() - 1800000, // Default 30 min ago if not tracked
                  Date.now()
                );
                
                // Show feedback modal after a short delay
                setTimeout(() => {
                  showWorkoutFeedback(workoutSession.id);
                }, 1500);
              }
            } catch (error) {
              console.error('Error recording ML workout data:', error);
            }
            
            // Check for weekly reset after completing a workout
            await checkAndResetWeekly();
            
            // EXTREME MODE: Update all tracking systems
            updateWorkoutStreak();
            calculateFatigueScore();
            
            // Check for PRs in completed exercises
            const dayData = workoutPlan[state.activeDay];
            if (dayData && state.loggedSets[state.activeDay]) {
              dayData.exercises.forEach((exercise, index) => {
                const loggedData = state.loggedSets[state.activeDay][index] || [];
                loggedData.forEach(set => {
                  if (set && set.reps && set.reps !== '‚úì') {
                    const reps = parseInt(set.reps);
                    if (!isNaN(reps)) {
                      checkForPersonalRecord(exercise.name, reps, 0);
                    }
                  }
                });
              });
            }
            
            // Calculate intensity score for this workout
            const workoutIntensity = calculateWorkoutIntensity(dayData);
            state.intensityScores.push(workoutIntensity);
            updateIntensityDisplay();
            
            // Reset workout start time and stop timer
            state.workoutStartTime = null;
            state.workoutInProgress = false;
            if (typeof stopWorkoutTimer === 'function') {
              stopWorkoutTimer();
            }
            
            saveStateToFirestore();
            closeModal(modal, modalContainer);
            showToast("Workout Marked as Complete!");
          }
        });

        document.querySelectorAll(".timer-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            openTimerModal(btn.dataset.timer)
          );
        });

        closeTimerModalBtn.addEventListener("click", () => {
          if (timerInterval) {
            clearInterval(timerInterval);
          }
          closeModal(timerModal, timerModalContainer);
        });

        timerModal.addEventListener("click", (e) => {
          if (e.target === timerModal) {
            if (timerInterval) {
              clearInterval(timerInterval);
            }
            closeModal(timerModal, timerModalContainer);
          }
        });

        resetProgressBtn.addEventListener("click", () => {
          openGenericModal(resetConfirmModal, resetModalContainer);
        });

        cancelResetBtn.addEventListener("click", () =>
          closeModal(resetConfirmModal, resetModalContainer)
        );
        confirmResetBtn.addEventListener("click", () => {
          resetProgressInFirestore();
          closeModal(resetConfirmModal, resetModalContainer);
        });

        // Single-delete modal handlers
        if (cancelDeleteBtn)
          cancelDeleteBtn.addEventListener("click", () => {
            closeGenericModal(deleteConfirmModal, deleteModalContainer);
            __pendingDelete = null;
          });

        if (confirmDeleteBtn)
          confirmDeleteBtn.addEventListener("click", async () => {
            if (!__pendingDelete) return;
            const { id: docId, data: deletedData } = __pendingDelete;
            try {
              const docRefToDelete = doc(
                db,
                "users",
                userId,
                "workoutHistory",
                docId
              );
              await deleteDoc(docRefToDelete);
              // show undo toast which restores using the same doc id
              const undoEntry = {
                id: docId,
                data: deletedData,
                timeoutId: null,
                restored: false,
              };
              pendingUndos.push(undoEntry);

              const toast = document.createElement("div");
              toast.className =
                "toast bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center gap-3";
              const span = document.createElement("span");
              span.textContent = "Workout deleted";
              const undoBtn = document.createElement("button");
              undoBtn.className = "underline text-sm";
              undoBtn.textContent = "Undo";
              undoBtn.addEventListener("click", async () => {
                if (undoEntry.restored) return;
                try {
                  const historyDocRef = doc(
                    db,
                    "users",
                    userId,
                    "workoutHistory",
                    undoEntry.id
                  );
                  await setDoc(historyDocRef, {
                    ...undoEntry.data,
                    restoredAt: serverTimestamp(),
                  });
                  undoEntry.restored = true;
                  clearTimeout(undoEntry.timeoutId);
                  toast.remove();
                  pendingUndos = pendingUndos.filter((e) => e !== undoEntry);
                  populateWorkoutHistory();
                  showToast("Workout restored", "success");
                } catch (err) {
                  console.error("Failed to restore workout:", err);
                  showToast("Failed to restore", "error");
                }
              });
              toast.appendChild(span);
              toast.appendChild(undoBtn);
              toastContainer.appendChild(toast);

              undoEntry.timeoutId = setTimeout(() => {
                try {
                  toast.remove();
                } catch (e) {}
                pendingUndos = pendingUndos.filter((e) => e !== undoEntry);
              }, 7000);

              populateWorkoutHistory();
              showToast("Workout deleted", "info");
            } catch (err) {
              console.error("Failed to delete workout:", err);
              showToast("Failed to delete workout", "error");
            }
            // close the modal via generic helper
            closeGenericModal(deleteConfirmModal, deleteModalContainer);
            __pendingDelete = null;
          });

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (!modal.classList.contains("hidden"))
              closeModal(modal, modalContainer);
            if (!timerModal.classList.contains("hidden"))
              closeModal(timerModal, timerModalContainer);
            if (!resetConfirmModal.classList.contains("hidden"))
              closeModal(resetConfirmModal, resetModalContainer);
            if (
              typeof alternativeModal !== "undefined" &&
              alternativeModal &&
              !alternativeModal.classList.contains("hidden")
            )
              closeModal(alternativeModal, alternativeModalContainer);
            if (
              typeof deleteConfirmModal !== "undefined" &&
              deleteConfirmModal &&
              !deleteConfirmModal.classList.contains("hidden")
            ) {
              if (deleteModalContainer)
                deleteModalContainer.classList.add("scale-95");
              deleteConfirmModal.classList.add("opacity-0");
              setTimeout(() => {
                if (deleteConfirmModal)
                  deleteConfirmModal.classList.add("hidden");
              }, 300);
              __pendingDelete = null;
            }
          }
        });

      }

      // --- TIMER LOGIC ---
      let tabataState = {
        rounds: 8,
        work: 20,
        rest: 10,
        currentRound: 1,
        isWork: false,
        timeLeft: 5,
      };
      let countdownState = { initialTime: 300, timeLeft: 300 };
      let enduranceState = {
        rounds: 4,
        work: 300,
        rest: 90,
        currentRound: 1,
        isWork: false,
        timeLeft: 5,
      };
      let hiitState = {
        rounds: 12,
        work: 30,
        rest: 15,
        currentRound: 1,
        isWork: false,
        timeLeft: 5,
      };

      function formatTime(ms) {
        const t = Math.floor(ms / 1000);
        return `${String(Math.floor(t / 3600)).padStart(2, "0")}:${String(
          Math.floor((t % 3600) / 60)
        ).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;
      }
      function formatSeconds(s) {
        return `00:${String(Math.floor(s / 60)).padStart(2, "0")}:${String(
          s % 60
        ).padStart(2, "0")}`;
      }
      function updateStopwatch() {
        timerDisplay.textContent = formatTime(
          Date.now() - state.timer.startTime + state.timer.elapsedTime
        );
      }
      function startStopwatch() {
        if (state.timer.running) return;
        state.timer.running = true;
        state.timer.startTime = Date.now();
        timerInterval = setInterval(updateStopwatch, 100);
        timerControls.children[0].textContent = "Pause";
      }
      function stopStopwatch() {
        if (!state.timer.running) return;
        state.timer.running = false;
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        state.timer.elapsedTime += Date.now() - state.timer.startTime;
        timerControls.children[0].textContent = "Resume";
      }
      function resetStopwatch() {
        stopStopwatch();
        state.timer.elapsedTime = 0;
        timerDisplay.textContent = "00:00:00";
        if (timerControls.children[0])
          timerControls.children[0].textContent = "Start";
      }
      function updateCountdown() {
        countdownState.timeLeft--;
        timerDisplay.textContent = formatSeconds(countdownState.timeLeft);
        if (countdownState.timeLeft <= 0) {
          stopCountdown();
          timerDisplay.style.color = "#34d399";
        }
      }
      function startCountdown() {
        if (state.timer.running) return;
        state.timer.running = true;
        timerDisplay.style.color = "white";
        timerInterval = setInterval(updateCountdown, 1000);
        timerControls.children[0].textContent = "Pause";
      }
      function stopCountdown() {
        if (!state.timer.running) return;
        state.timer.running = false;
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        if (timerControls.children.length > 0)
          timerControls.children[0].textContent = "Resume";
      }

      function resetCountdown(seconds = null) {
        stopCountdown();
        let timeInSeconds;
        if (seconds != null) {
          timeInSeconds = parseInt(seconds, 10);
        } else {
          const minutesInput = document.getElementById("countdown-minutes");
          const m = minutesInput ? parseInt(minutesInput.value, 10) : 5;
          timeInSeconds = isNaN(m) || m <= 0 ? 300 : m * 60;
        }

        if (isNaN(timeInSeconds)) {
          timeInSeconds = 300;
        }

        countdownState.initialTime = timeInSeconds;
        countdownState.timeLeft = timeInSeconds;
        timerDisplay.textContent = formatSeconds(countdownState.timeLeft);
        timerDisplay.style.color = "white";
        if (timerControls.children.length > 0)
          timerControls.children[0].textContent = "Start";
      }

      function runTabata() {
        timerDisplay.textContent = formatSeconds(tabataState.timeLeft);
        tabataState.timeLeft--;
        if (tabataState.timeLeft < 0) {
          if (tabataState.isWork) {
            tabataState.isWork = false;
            tabataState.timeLeft = tabataState.rest;
            tabataDisplay.children[0].textContent = "REST";
            timerModalContainer.style.borderColor = "#3b82f6";
          } else {
            tabataState.isWork = true;
            if (tabataState.currentRound > tabataState.rounds) {
              resetTabata();
              tabataDisplay.children[0].textContent = "DONE!";
              timerModalContainer.style.borderColor = "#34d399";
              return;
            }
            tabataDisplay.children[1].textContent = `Round: ${tabataState.currentRound}/${tabataState.rounds}`;
            tabataState.timeLeft = tabataState.work;
            tabataDisplay.children[0].textContent = "WORK";
            timerModalContainer.style.borderColor = "#ef4444";
            tabataState.currentRound++;
          }
        }

      }
      function startTabata() {
        if (state.timer.running) return;
        state.timer.running = true;
        timerControls.children[0].textContent = "Pause";
        timerInterval = setInterval(runTabata, 1000);
      }
      function stopTabata() {
        if (!state.timer.running) return;
        state.timer.running = false;
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        timerControls.children[0].textContent = "Resume";
      }
      function resetTabata() {
        stopTabata();
        tabataState.currentRound = 1;
        tabataState.isWork = false;
        tabataState.timeLeft = 5;
        tabataDisplay.children[0].textContent = "PREPARE";
        tabataDisplay.children[1].textContent = `Round: 1/${tabataState.rounds}`;
        timerDisplay.textContent = formatSeconds(tabataState.timeLeft);
        if (timerControls.children[0])
          timerControls.children[0].textContent = "Start";
        timerModalContainer.style.borderColor = "#ef4444";
      }

      function runEndurance() {
        timerDisplay.textContent = formatSeconds(enduranceState.timeLeft);
        enduranceState.timeLeft--;
        if (enduranceState.timeLeft < 0) {
          if (enduranceState.isWork) {
            enduranceState.isWork = false;
            enduranceState.timeLeft = enduranceState.rest;
            enduranceDisplay.children[0].textContent = "REST";
            timerModalContainer.style.borderColor = "#3b82f6";
          } else {
            enduranceState.isWork = true;
            if (enduranceState.currentRound > enduranceState.rounds) {
              resetEndurance();
              enduranceDisplay.children[0].textContent = "DONE!";
              timerModalContainer.style.borderColor = "#34d399";
              return;
            }
            enduranceDisplay.children[1].textContent = `Set: ${enduranceState.currentRound}/${enduranceState.rounds}`;
            enduranceState.timeLeft = enduranceState.work;
            enduranceDisplay.children[0].textContent = `WORK SET ${enduranceState.currentRound}`;
            timerModalContainer.style.borderColor = "#ef4444";
            enduranceState.currentRound++;
          }
        }

      }
      function startEndurance() {
        if (state.timer.running) return;
        state.timer.running = true;
        timerControls.children[0].textContent = "Pause";
        timerInterval = setInterval(runEndurance, 1000);
      }
      function stopEndurance() {
        if (!state.timer.running) return;
        state.timer.running = false;
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        timerControls.children[0].textContent = "Resume";
      }
      function resetEndurance() {
        stopEndurance();
        enduranceState.currentRound = 1;
        enduranceState.isWork = false;
        enduranceState.timeLeft = 5;
        enduranceDisplay.children[0].textContent = "PREPARE";
        enduranceDisplay.children[1].textContent = `Set: 1/${enduranceState.rounds}`;
        timerDisplay.textContent = formatSeconds(enduranceState.timeLeft);
        if (timerControls.children[0])
          timerControls.children[0].textContent = "Start";
        timerModalContainer.style.borderColor = "#ef4444";
      }

      function runHiit() {
        timerDisplay.textContent = formatSeconds(hiitState.timeLeft);
        hiitState.timeLeft--;
        if (hiitState.timeLeft < 0) {
          if (hiitState.isWork) {
            hiitState.isWork = false;
            hiitState.timeLeft = hiitState.rest;
            hiitDisplay.children[0].textContent = "REST";
            timerModalContainer.style.borderColor = "#3b82f6";
          } else {
            hiitState.isWork = true;
            if (hiitState.currentRound > hiitState.rounds) {
              resetHiit();
              hiitDisplay.children[0].textContent = "DONE!";
              timerModalContainer.style.borderColor = "#34d399";
              return;
            }
            hiitDisplay.children[1].textContent = `Sprint: ${hiitState.currentRound}/${hiitState.rounds}`;
            hiitState.timeLeft = hiitState.work;
            hiitDisplay.children[0].textContent = "SPRINT";
            timerModalContainer.style.borderColor = "#ef4444";
            hiitState.currentRound++;
          }
        }
      }
      function startHiit() {
        if (state.timer.running) return;
        state.timer.running = true;
        timerControls.children[0].textContent = "Pause";
        timerInterval = setInterval(runHiit, 1000);
      }
      function stopHiit() {
        if (!state.timer.running) return;
        state.timer.running = false;
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        timerControls.children[0].textContent = "Resume";
      }
    </script>
    <script>
      // ===== WORKOUT TIMER WIDGET =====
      
      let workoutTimerInterval = null;
      let workoutTimerPaused = false;
      let workoutPausedTime = 0; // Track total paused time
      let workoutPauseStartTime = 0; // Track when pause started
      
      function startWorkoutTimer() {
        const timerWidget = document.getElementById('workout-timer-widget');
        if (!timerWidget) return;
        
        // Show the timer widget
        timerWidget.classList.remove('hidden');
        
        // Start the timer if not already running
        if (!state.workoutStartTime) {
          state.workoutStartTime = Date.now();
          workoutPausedTime = 0;
          workoutTimerPaused = false;
        }
        
        // Update timer display every second
        if (workoutTimerInterval) {
          clearInterval(workoutTimerInterval);
        }
        
        workoutTimerInterval = setInterval(updateWorkoutTimerDisplay, 1000);
        updateWorkoutTimerDisplay(); // Update immediately
        
        // Update pause button
        const pauseBtn = document.getElementById('pause-workout-timer-btn');
        if (pauseBtn) pauseBtn.textContent = '‚è∏Ô∏è';
        
        console.log('Workout timer started');
      }
      
      function updateWorkoutTimerDisplay() {
        const timerDisplay = document.getElementById('workout-timer-display');
        if (!timerDisplay || !state.workoutStartTime) return;
        
        // Calculate elapsed time, excluding paused time
        let elapsed = Date.now() - state.workoutStartTime - workoutPausedTime;
        
        // If currently paused, also subtract the current pause duration
        if (workoutTimerPaused && workoutPauseStartTime > 0) {
          elapsed -= (Date.now() - workoutPauseStartTime);
        }
        
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        timerDisplay.textContent = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
      
      function togglePauseWorkoutTimer() {
        const pauseBtn = document.getElementById('pause-workout-timer-btn');
        
        if (workoutTimerPaused) {
          // Resume timer
          workoutTimerPaused = false;
          
          // Add the pause duration to total paused time
          if (workoutPauseStartTime > 0) {
            workoutPausedTime += (Date.now() - workoutPauseStartTime);
            workoutPauseStartTime = 0;
          }
          
          // Restart interval
          if (!workoutTimerInterval) {
            workoutTimerInterval = setInterval(updateWorkoutTimerDisplay, 1000);
          }
          
          if (pauseBtn) pauseBtn.textContent = '‚è∏Ô∏è';
          showToast('‚è±Ô∏è Timer resumed', 'info');
          console.log('Workout timer resumed');
        } else {
          // Pause timer
          workoutTimerPaused = true;
          workoutPauseStartTime = Date.now();
          
          // Stop updating display
          if (workoutTimerInterval) {
            clearInterval(workoutTimerInterval);
            workoutTimerInterval = null;
          }
          
          if (pauseBtn) pauseBtn.textContent = '‚ñ∂Ô∏è';
          showToast('‚è∏Ô∏è Timer paused', 'info');
          console.log('Workout timer paused');
        }
      }
      
      function stopWorkoutTimer() {
        const timerWidget = document.getElementById('workout-timer-widget');
        if (timerWidget) {
          timerWidget.classList.add('hidden');
        }
        
        if (workoutTimerInterval) {
          clearInterval(workoutTimerInterval);
          workoutTimerInterval = null;
        }
        
        // Calculate total workout time before clearing
        let totalTime = 0;
        if (state.workoutStartTime) {
          totalTime = Date.now() - state.workoutStartTime - workoutPausedTime;
          if (workoutTimerPaused && workoutPauseStartTime > 0) {
            totalTime -= (Date.now() - workoutPauseStartTime);
          }
        }
        const minutes = Math.floor(totalTime / 60000);
        
        // Clear the start time and reset pause tracking
        state.workoutStartTime = null;
        workoutTimerPaused = false;
        workoutPausedTime = 0;
        workoutPauseStartTime = 0;
        
        // Reset pause button
        const pauseBtn = document.getElementById('pause-workout-timer-btn');
        if (pauseBtn) pauseBtn.textContent = '‚è∏Ô∏è';
        
        if (minutes > 0) {
          showToast(`‚è±Ô∏è Workout completed in ${minutes} minute${minutes !== 1 ? 's' : ''}!`, 'success');
        }
        
        console.log('Workout timer stopped');
      }
      
      function pauseWorkoutTimer() {
        if (workoutTimerInterval) {
          clearInterval(workoutTimerInterval);
          workoutTimerInterval = null;
        }
      }
      
      function resumeWorkoutTimer() {
        if (!workoutTimerInterval && state.workoutStartTime) {
          workoutTimerInterval = setInterval(updateWorkoutTimerDisplay, 1000);
          updateWorkoutTimerDisplay();
        }
      }
      
      // Export timer functions globally
      window.startWorkoutTimer = startWorkoutTimer;
      window.stopWorkoutTimer = stopWorkoutTimer;
      window.pauseWorkoutTimer = pauseWorkoutTimer;
      window.resumeWorkoutTimer = resumeWorkoutTimer;
      window.updateWorkoutTimerDisplay = updateWorkoutTimerDisplay;
      window.togglePauseWorkoutTimer = togglePauseWorkoutTimer;

      function resetHiit() {
        stopHiit();
        hiitState.currentRound = 1;
        hiitState.isWork = false;
        hiitState.timeLeft = 5;
        hiitDisplay.children[0].textContent = "PREPARE";
        hiitDisplay.children[1].textContent = `Sprint: 1/${hiitState.rounds}`;
        timerDisplay.textContent = formatSeconds(hiitState.timeLeft);
        if (timerControls.children[0])
          timerControls.children[0].textContent = "Start";
        timerModalContainer.style.borderColor = "#ef4444";
      }

      function openFeedbackAndRestModal(
        seconds,
        dayKey,
        exerciseIndex,
        setIndex
      ) {
        console.log("=== DEBUG: openFeedbackAndRestModal called ===");
        console.log("seconds:", seconds, "dayKey:", dayKey, "exerciseIndex:", exerciseIndex, "setIndex:", setIndex);
        
        // Go directly to simple feedback modal - no complex timer modal dependencies
        console.log("Opening simple feedback modal - no fallback logging");
        createSimpleFeedbackModal(seconds, dayKey, exerciseIndex, setIndex);
      }

      function createSimpleFeedbackModal(seconds, dayKey, exerciseIndex, setIndex) {
        console.log("=== Creating HTML feedback modal ===");
        console.log("Parameters:", { seconds, dayKey, exerciseIndex, setIndex });
        
        // Check if required variables are accessible
        const globalState = window.state || state;
        const globalWorkoutPlan = window.workoutPlan || workoutPlan;
        const globalShowToast = window.showToast || showToast;
        
        if (!globalState) {
          console.error("State is undefined at modal creation!");
          alert("Error: App state not available");
          return;
        }
        if (!globalWorkoutPlan) {
          console.error("WorkoutPlan is undefined at modal creation!");
          alert("Error: Workout plan not available");
          return;
        }
        console.log("All required variables are accessible");
        
        // Create a simple HTML modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: #1f2937;
          border: 2px solid #ef4444;
          border-radius: 8px;
          padding: 20px;
          max-width: 400px;
          width: 90%;
          color: white;
          font-family: Inter, sans-serif;
        `;
        
        modalContent.innerHTML = `
          <h2 style="color: #ef4444; font-size: 20px; margin-bottom: 15px; text-align: center;">Set ${setIndex} Complete</h2>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reps Performed:</label>
            <input type="number" id="simple-reps-input" value="8" style="width: 100%; padding: 8px; border: 1px solid #4b5563; border-radius: 4px; background: #374151; color: white;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rate Difficulty (1=Easy, 10=Failed):</label>
            <div id="simple-rating-buttons" style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
              ${[1,2,3,4,5,6,7,8,9,10].map(i => 
                `<button data-rating="${i}" style="width: 32px; height: 32px; border: 1px solid #4b5563; background: #374151; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">${i}</button>`
              ).join('')}
            </div>
          </div>
          
          <div style="margin-bottom: 20px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #ef4444; margin-bottom: 10px;" id="simple-timer-display">${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}</div>
            <div style="margin-bottom: 10px;">
              <button id="simple-timer-start" style="padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px;">Start</button>
              <button id="simple-timer-pause" style="padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px;">Pause</button>
              <button id="simple-timer-skip" style="padding: 4px 8px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px;">Skip Rest</button>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="simple-cancel-btn" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button id="simple-save-btn" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Save & Start Rest</button>
          </div>
        `;
        
        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);
        
        let selectedRating = 5; // Default rating
        let timeLeft = seconds;
        let timerRunning = false;
        let timerIntervalId = null;
        
        // Timer functions
        const updateTimerDisplay = () => {
          const timerDisplay = document.getElementById('simple-timer-display');
          if (timerDisplay) {
            timerDisplay.textContent = `${Math.floor(timeLeft / 60)}:${String(timeLeft % 60).padStart(2, '0')}`;
            if (timeLeft <= 0) {
              timerDisplay.style.color = '#10b981'; // Green when complete
            }
          }
        };
        
        const startTimer = () => {
          if (!timerRunning && timeLeft > 0) {
            timerRunning = true;
            timerIntervalId = setInterval(() => {
              timeLeft--;
              updateTimerDisplay();
              if (timeLeft <= 0) {
                clearInterval(timerIntervalId);
                timerRunning = false;
                // Timer finished notification
                const timerDisplayParent = document.getElementById('simple-timer-display').parentNode;
                const finishedDiv = document.createElement('div');
                finishedDiv.style.cssText = 'text-align: center; color: #10b981; font-weight: bold; margin-top: 10px; font-size: 18px;';
                finishedDiv.textContent = 'üéâ Rest Complete! Ready for next set!';
                timerDisplayParent.appendChild(finishedDiv);
                
                // Add a close button when timer finishes
                const closeButton = document.createElement('button');
                closeButton.style.cssText = 'padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;';
                closeButton.textContent = 'Close & Continue Workout';
                closeButton.addEventListener('click', () => {
                  cleanup();
                });
                timerDisplayParent.appendChild(closeButton);
              }
            }, 1000);
          }
        };
        
        const pauseTimer = () => {
          if (timerRunning) {
            clearInterval(timerIntervalId);
            timerRunning = false;
          }
        };
        
        // Handle rating button clicks
        const ratingButtons = modalContent.querySelectorAll('[data-rating]');
        ratingButtons.forEach(btn => {
          if (btn.dataset.rating === '5') {
            btn.style.background = '#ef4444';
          }
          btn.addEventListener('click', () => {
            ratingButtons.forEach(b => b.style.background = '#374151');
            btn.style.background = '#ef4444';
            selectedRating = btn.dataset.rating;
            console.log('Rating selected:', selectedRating);
          });
        });
        
        // Timer button handlers
        document.getElementById('simple-timer-start').addEventListener('click', startTimer);
        document.getElementById('simple-timer-pause').addEventListener('click', pauseTimer);
        document.getElementById('simple-timer-skip').addEventListener('click', () => {
          console.log('User clicked Skip Rest - closing modal');
          pauseTimer();
          timeLeft = 0;
          updateTimerDisplay();
          
          // Close the modal immediately when skipping rest
          cleanup();
          
          const currentShowToast = window.showToast || globalShowToast;
          if (currentShowToast) {
            currentShowToast('Rest skipped - ready for next set!', 'info');
          }
        });
        
        // Handle save button
        const saveButton = document.getElementById('simple-save-btn');
        if (saveButton) {
          saveButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const repsInput = document.getElementById('simple-reps-input');
            const reps = repsInput ? repsInput.value || '8' : '8';
            
            console.log("User clicked Save - Logging set with values:", { reps, rating: selectedRating });
            
            // Clean up timer
            if (timerIntervalId) {
              clearInterval(timerIntervalId);
            }
            
            // Log the set with the provided values
            const currentState = window.state || globalState;
            const currentShowToast = window.showToast || globalShowToast;
            
            if (!currentState) {
              console.error("State is undefined! This should not happen.");
              alert("Error: App state not found");
              return;
            }
            
            if (!currentState.loggedSets) currentState.loggedSets = {};
            if (!currentState.loggedSets[dayKey]) currentState.loggedSets[dayKey] = {};
            if (!currentState.loggedSets[dayKey][exerciseIndex])
              currentState.loggedSets[dayKey][exerciseIndex] = [];
            currentState.loggedSets[dayKey][exerciseIndex][setIndex - 1] = {
              reps: reps,
              rating: selectedRating,
            };
            
            console.log("Set logged to state:", currentState.loggedSets[dayKey][exerciseIndex]);
            
            // Apply exercise difficulty adjustment based on rating
            const currentWorkoutPlan = window.workoutPlan || globalWorkoutPlan;
            const currentAllExercises = window.allExercisesMasterList || allExercisesMasterList;
            
            if (!currentWorkoutPlan || !currentAllExercises) {
              console.error("WorkoutPlan or allExercisesMasterList is undefined!");
              alert("Error: Workout data not found");
              return;
            }
            
            const exercise = currentWorkoutPlan[dayKey].exercises[exerciseIndex];
            const baseExercise = currentAllExercises[exercise.baseName];
            
            if (baseExercise && baseExercise.variations && (selectedRating >= 8 || selectedRating <= 4)) {
              const easierNames = Array.isArray(baseExercise.variations.easier)
                ? baseExercise.variations.easier.map(v => v.name).reverse()
                : [];
              const harderNames = Array.isArray(baseExercise.variations.harder)
                ? baseExercise.variations.harder.map(v => v.name)
                : [];
              const ladder = [
                ...easierNames,
                exercise.baseName,
                ...harderNames,
              ];
              const currentIndex = ladder.indexOf(exercise.name);

              if (selectedRating >= 8 && currentIndex > 0) {
                const newExerciseName = ladder[currentIndex - 1];
                const newExerciseData = allExercisesMasterList[newExerciseName];
                if (newExerciseData) {
                  currentWorkoutPlan[dayKey].exercises[exerciseIndex] = JSON.parse(
                    JSON.stringify(newExerciseData)
                  );
                  
                  // Clear logged sets for this exercise when swapping due to difficulty
                  if (state.loggedSets[dayKey]) {
                    delete state.loggedSets[dayKey][exerciseIndex];
                    console.log(`Cleared logged sets for difficulty downgrade to ${newExerciseName}`);
                  }
                  
                  if (currentShowToast) {
                    currentShowToast(`Set was tough. Switched to ${newExerciseName} for next set.`, "info");
                  }
                }
              } else if (selectedRating <= 4 && currentIndex < ladder.length - 1) {
                const newExerciseName = ladder[currentIndex + 1];
                const newExerciseData = currentAllExercises[newExerciseName];
                if (newExerciseData) {
                  currentWorkoutPlan[dayKey].exercises[exerciseIndex] = JSON.parse(
                    JSON.stringify(newExerciseData)
                  );
                  
                  // Clear logged sets for this exercise when swapping due to difficulty
                  if (state.loggedSets[dayKey]) {
                    delete state.loggedSets[dayKey][exerciseIndex];
                    console.log(`Cleared logged sets for difficulty upgrade to ${newExerciseName}`);
                  }
                  
                  if (currentShowToast) {
                    currentShowToast(`Too easy! Switched to ${newExerciseName} for challenge.`, "info");
                  }
                }
              }
            }
            
            // Rebuild the exercise element
            const exerciseContainer = document.getElementById(
              `exercise-${dayKey}-${exerciseIndex}`
            );
            if (exerciseContainer) {
              console.log("Rebuilding exercise element");
              const currentExercise = currentWorkoutPlan[dayKey].exercises[exerciseIndex];
              const buildElementFn = window.buildExerciseElement || buildExerciseElement;
              if (buildElementFn) {
                const newEl = buildElementFn(currentExercise, exerciseIndex, dayKey);
                exerciseContainer.replaceWith(newEl);
              }
            }
            
            const checkCompletedFn = window.checkAllSetsCompleted || checkAllSetsCompleted;
            const saveStateFn = window.saveStateToFirestore || saveStateToFirestore;
            
            if (checkCompletedFn) checkCompletedFn();
            if (saveStateFn) saveStateFn();
            if (currentShowToast) {
              currentShowToast(`Set logged: ${reps} reps, difficulty ${selectedRating}`, "success");
            }
            
            // Auto-start the rest timer after logging the set
            console.log("Auto-starting rest timer");
            startTimer();
            
            // Update UI to show timer is active
            saveButton.textContent = "‚úì Set Logged - Timer Running";
            saveButton.disabled = true;
            saveButton.style.background = "#10b981"; // Green to show timer is active
            
            // Hide the input fields since set is already saved
            const savedRepsInput = document.getElementById('simple-reps-input');
            const savedRatingButtons = document.getElementById('simple-rating-buttons');
            if (savedRepsInput && savedRepsInput.parentNode) {
              savedRepsInput.parentNode.style.display = 'none';
            }
            if (savedRatingButtons && savedRatingButtons.parentNode) {
              savedRatingButtons.parentNode.style.display = 'none';
            }
            
            // Make timer controls more prominent
            const timerDisplay = document.getElementById('simple-timer-display');
            if (timerDisplay && timerDisplay.parentNode) {
              timerDisplay.style.fontSize = '32px';
              timerDisplay.style.color = '#10b981'; // Green while running
              timerDisplay.parentNode.style.border = '2px solid #10b981';
              timerDisplay.parentNode.style.borderRadius = '8px';
              timerDisplay.parentNode.style.padding = '10px';
            }
            
            // Don't remove the modal - keep it open for the timer
            console.log("=== Set saved, timer started ===");
          });
        } else {
          console.error("Save button not found!");
        }
        
        // Cleanup function
        const cleanup = () => {
          console.log("Cleaning up modal and timer");
          if (timerIntervalId) {
            clearInterval(timerIntervalId);
          }
          if (document.body.contains(modalOverlay)) {
            document.body.removeChild(modalOverlay);
          }
        };
        
        // Handle cancel button
        const cancelButton = document.getElementById('simple-cancel-btn');
        if (cancelButton) {
          cancelButton.addEventListener('click', () => {
            console.log("User clicked Cancel - NOT logging set");
            cleanup();
            if (globalShowToast) {
              globalShowToast("Set logging cancelled", "info");
            }
          });
        }
        
        // Handle clicking outside the modal (also cancel)
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            console.log("User clicked outside modal - NOT logging set");
            cleanup();
            if (globalShowToast) {
              globalShowToast("Set logging cancelled", "info");
            }
          }
        });
        
        // Handle Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            console.log("User pressed Escape - NOT logging set");
            cleanup();
            document.removeEventListener('keydown', handleEscape);
            if (globalShowToast) {
              globalShowToast("Set logging cancelled", "info");
            }
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Focus on reps input
        setTimeout(() => {
          document.getElementById('simple-reps-input').focus();
          document.getElementById('simple-reps-input').select();
        }, 100);
      }

      function openTimerModal(type, options = {}) {
        // Ensure timerInterval is available
        if (typeof timerInterval !== 'undefined' && timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        state.timer.running = false;
        if (timerControls) {
          timerControls.innerHTML = "";
        }
        if (type !== "custom" && restTimerDynamicContent) {
          restTimerDynamicContent.innerHTML = "";
        }
        countdownInputContainer.classList.add("hidden");
        tabataDisplay.classList.add("hidden");
        enduranceDisplay.classList.add("hidden");
        hiitDisplay.classList.add("hidden");
        timerDisplay.style.color = "white";
        timerModalContainer.style.borderColor = "#ef4444";
        timerModalTitle.textContent = options.title || "Workout Timer";

        if (type !== "custom") {
          // Build timer control buttons safely
          while (timerControls.firstChild)
            timerControls.removeChild(timerControls.firstChild);
          const startStopBtn = document.createElement("button");
          startStopBtn.id = "start-stop-btn";
          startStopBtn.className =
            "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded";
          startStopBtn.type = "button";
          startStopBtn.textContent = "Start";
          const resetBtn = document.createElement("button");
          resetBtn.id = "reset-btn";
          resetBtn.className =
            "bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded";
          resetBtn.type = "button";
          resetBtn.textContent = "Reset";
          timerControls.appendChild(startStopBtn);
          timerControls.appendChild(resetBtn);

          if (type === "stopwatch") {
            timerModalTitle.textContent = "Stopwatch";
            resetStopwatch();
            startStopBtn.onclick = () =>
              state.timer.running ? stopStopwatch() : startStopwatch();
            resetBtn.onclick = resetStopwatch;
          } else if (type === "countdown") {
            countdownInputContainer.classList.remove("hidden");
            resetCountdown(options.seconds);
            startStopBtn.onclick = () =>
              state.timer.running ? stopCountdown() : startCountdown();
            resetBtn.onclick = () => resetCountdown(options.seconds);
            if (options.seconds == null) {
              document.getElementById("countdown-minutes").onchange = () =>
                resetCountdown();
            }
          } else if (type === "rest2" || type === "rest3") {
            const minutes = type === "rest2" ? 2 : 3;
            timerModalTitle.textContent = `Rest Timer (${minutes} min)`;
            resetCountdown(minutes * 60);
            startStopBtn.onclick = () =>
              state.timer.running ? stopCountdown() : startCountdown();
            resetBtn.onclick = () => {
              resetCountdown(minutes * 60);
            };
          } else if (type === "tabata") {
            timerModalTitle.textContent = "Tabata";
            tabataDisplay.classList.remove("hidden");
            resetTabata();
            startStopBtn.onclick = () =>
              state.timer.running ? stopTabata() : startTabata();
            resetBtn.onclick = resetTabata;
          } else if (type === "endurance") {
            timerModalTitle.textContent =
              "Endurance Timer (5m work / 90s rest)";
            enduranceDisplay.classList.remove("hidden");
            resetEndurance();
            startStopBtn.onclick = () =>
              state.timer.running ? stopEndurance() : startEndurance();
            resetBtn.onclick = resetEndurance;
          } else if (type === "hiit") {
            timerModalTitle.textContent =
              "HIIT Sprint Timer (30s work / 15s rest)";
            hiitDisplay.classList.remove("hidden");
            resetHiit();
            startStopBtn.onclick = () =>
              state.timer.running ? stopHiit() : startHiit();
            resetBtn.onclick = resetHiit;
          }
        }

        openGenericModal(timerModal, timerModalContainer);
      }

      // ===== ML INSIGHTS RENDERING =====
      
      function renderMLInsights() {
        const insightsContent = document.getElementById('ml-insights-content');
        if (!insightsContent) return;

        // Check if we have enough data for insights
        if (!state.performanceHistory || state.performanceHistory.length < 3) {
          insightsContent.innerHTML = `
            <div class="flex items-center justify-center py-4">
              <div class="text-center">
                <div class="text-gray-500 mb-2">üìä</div>
                <p class="text-gray-400 text-sm">Complete ${3 - (state.performanceHistory?.length || 0)} more workouts for personalized insights!</p>
              </div>
            </div>
          `;
          return;
        }

        // Trigger analysis if needed
        if (!state.mlInsights?.lastAnalysis || 
            Date.now() - new Date(state.mlInsights.lastAnalysis).getTime() > 24 * 60 * 60 * 1000) {
          analyzePerformance();
        }

        const insights = state.mlInsights;
        const recommendations = generateRecommendations();
        
        let insightsHTML = '<div class="space-y-3">';
        
        // Show total workouts
        insightsHTML += `
          <div class="flex justify-between items-center">
            <span class="text-gray-300 text-sm">Total Workouts:</span>
            <span class="text-white font-semibold">${insights.totalWorkouts || 0}</span>
          </div>
        `;
        
        // Show strength areas
        if (insights.strengthAreas && insights.strengthAreas.length > 0) {
          insightsHTML += `
            <div>
              <p class="text-green-400 text-sm font-medium mb-1">üí™ Strong Areas:</p>
              <p class="text-gray-300 text-xs">${insights.strengthAreas.slice(0, 3).join(', ')}</p>
            </div>
          `;
        }
        
        // Show improvement areas
        if (insights.weaknessAreas && insights.weaknessAreas.length > 0) {
          insightsHTML += `
            <div>
              <p class="text-orange-400 text-sm font-medium mb-1">üéØ Focus Areas:</p>
              <p class="text-gray-300 text-xs">${insights.weaknessAreas.slice(0, 3).join(', ')}</p>
            </div>
          `;
        }
        
        // Show recommended focus
        if (insights.recommendedFocus && insights.recommendedFocus !== 'balanced') {
          insightsHTML += `
            <div>
              <p class="text-blue-400 text-sm font-medium mb-1">üî• Recommended Focus:</p>
              <p class="text-gray-300 text-xs capitalize">${insights.recommendedFocus.replace('_', ' ')}</p>
            </div>
          `;
        }
        
        // Show top recommendation
        if (recommendations && recommendations.length > 0) {
          const topRec = recommendations[0];
          const priorityColor = topRec.priority === 'high' ? 'text-red-400' : 
                               topRec.priority === 'medium' ? 'text-yellow-400' : 'text-green-400';
          insightsHTML += `
            <div class="bg-gray-900/50 p-3 rounded mt-3">
              <p class="${priorityColor} text-sm font-medium mb-1">üí° ${topRec.title}</p>
              <p class="text-gray-300 text-xs">${topRec.description}</p>
            </div>
          `;
        }
        
        // Add action buttons
        insightsHTML += `
          <div class="pt-2 flex gap-2 flex-wrap">
            <button onclick="analyzePerformance(); renderMLInsights();" 
              class="text-blue-400 hover:text-blue-300 text-xs underline">
              Refresh Analysis
            </button>
            <button onclick="generateAndShowPersonalizedWorkout();" 
              class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition-colors">
              Generate Custom Workout
            </button>
          </div>
        `;
        
        // Add enhanced ML insights if available
        const enhancedInsights = renderEnhancedMLInsights();
        if (enhancedInsights) {
          insightsHTML += enhancedInsights;
        }
        
        insightsHTML += '</div>';
        insightsContent.innerHTML = insightsHTML;
      }

      // ===== ML-ENHANCED FEATURES =====

      // Record workout performance data for ML analysis
      function recordWorkoutSession(dayKey, exercises, startTime, endTime) {
        const workoutData = {
          id: `${dayKey}_${Date.now()}`,
          date: new Date().toISOString(),
          dayKey: dayKey,
          duration: Math.round((endTime - startTime) / 1000 / 60), // minutes
          exercises: exercises.map(exercise => ({
            name: exercise.name,
            baseName: exercise.baseName,
            difficulty: exercise.difficulty,
            setsCompleted: exercise.setsCompleted || 0,
            targetSets: parseInt(exercise.sets) || 0,
            repsData: exercise.repsData || [],
            avgReps: exercise.avgReps || 0,
            completionRate: exercise.completionRate || 0,
          })),
          totalSets: exercises.reduce((sum, ex) => sum + (ex.setsCompleted || 0), 0),
          completionRate: exercises.reduce((sum, ex) => sum + (ex.completionRate || 0), 0) / exercises.length,
          bodyType: state.measurements.bodyType,
          figureType: state.measurements.figureType,
        };

        state.performanceHistory.push(workoutData);
        
        // Keep only last 100 workouts to manage data size
        if (state.performanceHistory.length > 100) {
          state.performanceHistory = state.performanceHistory.slice(-100);
        }
        
        updateExerciseProgress(workoutData);
        saveStateToFirestore();
        
        console.log('Workout session recorded:', workoutData);
        return workoutData;
      }

      // Update exercise progress tracking
      function updateExerciseProgress(workoutData) {
        workoutData.exercises.forEach(exercise => {
          const progressKey = exercise.baseName || exercise.name;
          
          if (!state.exerciseProgress[progressKey]) {
            state.exerciseProgress[progressKey] = {
              progressScore: 0,
              lastModified: new Date().toISOString(),
              adaptations: [],
              difficultyTrend: [],
              completionHistory: [],
            };
          }
          
          const progress = state.exerciseProgress[progressKey];
          
          // Update completion history (keep last 10 sessions)
          progress.completionHistory.push({
            date: workoutData.date,
            completionRate: exercise.completionRate,
            avgReps: exercise.avgReps,
            difficulty: exercise.difficulty,
          });
          
          if (progress.completionHistory.length > 10) {
            progress.completionHistory = progress.completionHistory.slice(-10);
          }
          
          // Calculate progress score based on recent performance
          const recentSessions = progress.completionHistory.slice(-5);
          const avgCompletion = recentSessions.reduce((sum, s) => sum + s.completionRate, 0) / recentSessions.length;
          
          progress.progressScore = Math.round(avgCompletion * 100);
          progress.lastModified = new Date().toISOString();
          
          // Track difficulty trends
          progress.difficultyTrend.push({
            date: workoutData.date,
            difficulty: exercise.difficulty,
            performance: avgCompletion,
          });
          
          if (progress.difficultyTrend.length > 10) {
            progress.difficultyTrend = progress.difficultyTrend.slice(-10);
          }
        });
      }

      // Analyze user performance and generate ML insights
      function analyzePerformance() {
        if (state.performanceHistory.length < 3) {
          console.log('Insufficient data for ML analysis');
          return;
        }

        const exerciseStats = {};
        
        // Analyze each exercise across all workouts
        state.performanceHistory.forEach(workout => {
          workout.exercises.forEach(exercise => {
            const key = exercise.baseName || exercise.name;
            if (!exerciseStats[key]) {
              exerciseStats[key] = {
                sessions: 0,
                totalCompletion: 0,
                totalReps: 0,
                difficulties: [],
                trend: [],
              };
            }
            
            exerciseStats[key].sessions++;
            exerciseStats[key].totalCompletion += exercise.completionRate;
            exerciseStats[key].totalReps += exercise.avgReps;
            exerciseStats[key].difficulties.push(exercise.difficulty);
            exerciseStats[key].trend.push({
              date: workout.date,
              completion: exercise.completionRate,
            });
          });
        });

        // Calculate average performance for each exercise
        const exercisePerformance = Object.entries(exerciseStats).map(([name, stats]) => ({
          name,
          avgCompletion: stats.totalCompletion / stats.sessions,
          avgReps: stats.totalReps / stats.sessions,
          sessions: stats.sessions,
          consistency: calculateConsistency(stats.trend),
          improvementTrend: calculateTrend(stats.trend),
        }));

        // Identify strengths (top 30% performers)
        const sortedByPerformance = [...exercisePerformance].sort((a, b) => b.avgCompletion - a.avgCompletion);
        const strengthThreshold = Math.ceil(sortedByPerformance.length * 0.3);
        const strengthAreas = sortedByPerformance.slice(0, strengthThreshold).map(ex => ex.name);

        // Identify weaknesses (bottom 30% performers with sufficient data)
        const weaknessThreshold = Math.floor(sortedByPerformance.length * 0.7);
        const weaknessAreas = sortedByPerformance.slice(weaknessThreshold)
          .filter(ex => ex.sessions >= 3)
          .map(ex => ex.name);

        // Determine recommended focus
        let recommendedFocus = 'balanced';
        if (weaknessAreas.length > 0) {
          const muscleGroups = categorizeExercises(weaknessAreas);
          const topWeakness = Object.entries(muscleGroups).sort((a, b) => b[1] - a[1])[0];
          if (topWeakness && topWeakness[1] >= 2) {
            recommendedFocus = topWeakness[0];
          }
        }

        // Update ML insights
        state.mlInsights = {
          strengthAreas,
          weaknessAreas,
          recommendedFocus,
          lastAnalysis: new Date().toISOString(),
          exercisePerformance,
          totalWorkouts: state.performanceHistory.length,
        };

        console.log('ML Analysis Complete:', state.mlInsights);
        saveStateToFirestore();
        return state.mlInsights;
      }

      // Calculate consistency score (0-1) based on performance variance
      function calculateConsistency(trend) {
        if (trend.length < 2) return 1;
        
        const completions = trend.map(t => t.completion);
        const avg = completions.reduce((sum, c) => sum + c, 0) / completions.length;
        const variance = completions.reduce((sum, c) => sum + Math.pow(c - avg, 2), 0) / completions.length;
        const stdDev = Math.sqrt(variance);
        
        // Convert to consistency score (lower variance = higher consistency)
        return Math.max(0, 1 - stdDev);
      }

      // Calculate improvement trend (-1 to 1, where 1 is strong improvement)
      function calculateTrend(trend) {
        if (trend.length < 3) return 0;
        
        // Simple linear regression slope
        const n = trend.length;
        const sumX = trend.reduce((sum, _, i) => sum + i, 0);
        const sumY = trend.reduce((sum, t) => sum + t.completion, 0);
        const sumXY = trend.reduce((sum, t, i) => sum + i * t.completion, 0);
        const sumXX = trend.reduce((sum, _, i) => sum + i * i, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        
        // Normalize slope to -1 to 1 range
        return Math.max(-1, Math.min(1, slope * n));
      }

      // Categorize exercises by muscle group for weakness analysis
      function categorizeExercises(exerciseNames) {
        const categories = {
          'upper_body_push': ['push', 'press', 'dip'],
          'upper_body_pull': ['row', 'pull', 'chin'],
          'legs': ['squat', 'lunge', 'calf'],
          'core': ['plank', 'crunch', 'sit'],
          'cardio': ['jump', 'burpee', 'mountain'],
          'flexibility': ['stretch', 'yoga', 'mobility'],
        };
        
        const counts = {};
        exerciseNames.forEach(name => {
          const nameLower = name.toLowerCase();
          let categorized = false;
          
          Object.entries(categories).forEach(([category, keywords]) => {
            if (!categorized && keywords.some(keyword => nameLower.includes(keyword))) {
              counts[category] = (counts[category] || 0) + 1;
              categorized = true;
            }
          });
          
          if (!categorized) {
            counts['other'] = (counts['other'] || 0) + 1;
          }
        });
        
        return counts;
      }

      // Analyze optimal rest periods based on performance data
      function analyzeRestPeriods() {
        if (state.performanceHistory.length < 5) return { recommendation: null };
        
        const recentWorkouts = state.performanceHistory.slice(-10);
        let optimalRestData = {};
        
        recentWorkouts.forEach(workout => {
          workout.exercises.forEach(exercise => {
            const key = exercise.baseName || exercise.name;
            if (!optimalRestData[key]) {
              optimalRestData[key] = { restTimes: [], completionRates: [] };
            }
            optimalRestData[key].restTimes.push(exercise.restTime || 90);
            optimalRestData[key].completionRates.push(exercise.completionRate || 0.8);
          });
        });

        // Find correlation between rest time and performance
        let needsMoreRest = false;
        let needsLessRest = false;
        
        Object.values(optimalRestData).forEach(data => {
          if (data.restTimes.length >= 3) {
            const avgCompletion = data.completionRates.reduce((a, b) => a + b, 0) / data.completionRates.length;
            const avgRest = data.restTimes.reduce((a, b) => a + b, 0) / data.restTimes.length;
            
            if (avgCompletion < 0.7 && avgRest < 120) needsMoreRest = true;
            if (avgCompletion > 0.95 && avgRest > 90) needsLessRest = true;
          }
        });

        if (needsMoreRest) {
          return {
            recommendation: {
              type: 'rest_increase',
              title: 'üïê Increase Rest Periods',
              description: 'Consider adding 15-30s more rest between sets to improve performance.',
              priority: 'medium',
            }
          };
        }
        
        if (needsLessRest) {
          return {
            recommendation: {
              type: 'rest_decrease',
              title: '‚ö° Optimize Rest Efficiency',
              description: 'You might be ready for shorter rest periods to increase workout density.',
              priority: 'low',
            }
          };
        }
        
        return { recommendation: null };
      }

      // Analyze recovery needs based on workout frequency and intensity
      function analyzeRecoveryNeeds() {
        if (state.performanceHistory.length < 7) return null;
        
        const last7Days = state.performanceHistory.filter(w => 
          new Date(w.date) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
        );
        
        const workoutFreq = last7Days.length;
        const avgIntensity = last7Days.reduce((sum, w) => sum + (w.intensity || 0.7), 0) / last7Days.length;
        const avgCompletion = last7Days.reduce((sum, w) => sum + w.completionRate, 0) / last7Days.length;
        
        // Check for overtraining indicators
        if (workoutFreq >= 6 && avgCompletion < 0.6) {
          return {
            type: 'recovery_needed',
            title: 'üõå Recovery Recommended',
            description: 'High frequency with declining performance suggests you need more recovery time.',
            priority: 'high',
          };
        }
        
        // Check for under-training
        if (workoutFreq <= 2 && avgCompletion > 0.9) {
          return {
            type: 'increase_frequency',
            title: 'üìà Ready for More',
            description: 'You could benefit from adding one more workout per week.',
            priority: 'medium',
          };
        }
        
        return null;
      }

      // Analyze readiness for progressive overload
      function analyzeProgressionReadiness() {
        if (state.performanceHistory.length < 5) return null;
        
        const recentWorkouts = state.performanceHistory.slice(-8);
        const strengthExercises = ['push-up', 'squat', 'pull-up', 'plank', 'lunge'];
        
        let readyForProgression = 0;
        let totalStrengthExercises = 0;
        
        strengthExercises.forEach(exerciseName => {
          const exerciseData = recentWorkouts.flatMap(w => 
            w.exercises.filter(e => 
              (e.baseName || e.name).toLowerCase().includes(exerciseName)
            )
          );
          
          if (exerciseData.length >= 4) {
            totalStrengthExercises++;
            const recent4 = exerciseData.slice(-4);
            const avgCompletion = recent4.reduce((sum, e) => sum + e.completionRate, 0) / recent4.length;
            
            if (avgCompletion >= 0.9) {
              readyForProgression++;
            }
          }
        });
        
        if (readyForProgression >= Math.ceil(totalStrengthExercises * 0.6)) {
          return {
            type: 'progression_ready',
            title: 'üí™ Ready for Progression',
            description: 'You\'re consistently completing exercises well. Time to increase difficulty!',
            priority: 'high',
          };
        }
        
        return null;
      }

      // Smart workout difficulty adaptation
      function adaptWorkoutDifficulty(dayPlan, userInsights) {
        if (!userInsights || !userInsights.exercisePerformance) return dayPlan;
        
        const adaptedPlan = JSON.parse(JSON.stringify(dayPlan));
        
        adaptedPlan.exercises = adaptedPlan.exercises.map(exercise => {
          const performance = userInsights.exercisePerformance.find(p => 
            p.name === exercise.baseName || p.name === exercise.name
          );
          
          if (performance) {
            // Auto-suggest difficulty based on performance
            if (performance.avgCompletion > 0.9 && performance.sessions >= 3) {
              exercise.aiSuggestion = {
                type: 'upgrade',
                message: 'Consider trying the harder variation',
                confidenceScore: Math.min(0.95, performance.avgCompletion * performance.consistency)
              };
            } else if (performance.avgCompletion < 0.6) {
              exercise.aiSuggestion = {
                type: 'simplify',
                message: 'Try an easier variation to build consistency',
                confidenceScore: Math.min(0.9, (1 - performance.avgCompletion) * 0.8)
              };
            }
          }
          
          return exercise;
        });
        
        return adaptedPlan;
      }

      // Injury risk assessment based on workout patterns
      function assessInjuryRisk() {
        if (state.performanceHistory.length < 10) return { risk: 'unknown', recommendations: [] };
        
        const recentWorkouts = state.performanceHistory.slice(-14); // Last 2 weeks
        let riskFactors = [];
        let risk = 'low';
        
        // Check for sudden intensity increases
        const intensityTrend = recentWorkouts.map(w => w.intensity || 0.7);
        for (let i = 1; i < intensityTrend.length; i++) {
          if (intensityTrend[i] - intensityTrend[i-1] > 0.3) {
            riskFactors.push('sudden_intensity_increase');
            risk = 'medium';
          }
        }
        
        // Check for consecutive high-intensity days
        let consecutiveHighIntensity = 0;
        recentWorkouts.forEach(workout => {
          if ((workout.intensity || 0.7) > 0.8) {
            consecutiveHighIntensity++;
          } else {
            consecutiveHighIntensity = 0;
          }
          
          if (consecutiveHighIntensity >= 3) {
            riskFactors.push('overtraining_pattern');
            risk = 'high';
          }
        });
        
        // Check for declining performance with maintained intensity
        const last5Workouts = recentWorkouts.slice(-5);
        if (last5Workouts.length === 5) {
          const performanceTrend = last5Workouts.map(w => w.completionRate);
          const isDecreasing = performanceTrend.every((val, i) => 
            i === 0 || val <= performanceTrend[i-1] + 0.05
          );
          
          if (isDecreasing && performanceTrend[4] < performanceTrend[0] - 0.15) {
            riskFactors.push('performance_decline');
            risk = 'medium';
          }
        }
        
        const recommendations = [];
        if (riskFactors.includes('sudden_intensity_increase')) {
          recommendations.push('Gradually increase workout intensity over 2-3 weeks');
        }
        if (riskFactors.includes('overtraining_pattern')) {
          recommendations.push('Include at least one full rest day between high-intensity sessions');
        }
        if (riskFactors.includes('performance_decline')) {
          recommendations.push('Consider a deload week or focus on recovery');
        }
        
        return { risk, riskFactors, recommendations };
      }

      // Motivation and adherence analysis
      function analyzeMotivationPatterns() {
        if (state.performanceHistory.length < 8) return null;
        
        const workouts = state.performanceHistory;
        const workoutDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        // Analyze completion patterns by day of week
        const dayPatterns = {};
        workouts.forEach(workout => {
          const day = new Date(workout.date).getDay();
          const dayName = workoutDays[day];
          if (!dayPatterns[dayName]) {
            dayPatterns[dayName] = { total: 0, completed: 0 };
          }
          dayPatterns[dayName].total++;
          if (workout.completionRate > 0.7) {
            dayPatterns[dayName].completed++;
          }
        });
        
        // Find best and worst days
        let bestDay = null;
        let worstDay = null;
        let bestRate = 0;
        let worstRate = 1;
        
        Object.entries(dayPatterns).forEach(([day, pattern]) => {
          if (pattern.total >= 3) { // Only consider days with sufficient data
            const rate = pattern.completed / pattern.total;
            if (rate > bestRate) {
              bestRate = rate;
              bestDay = day;
            }
            if (rate < worstRate) {
              worstRate = rate;
              worstDay = day;
            }
          }
        });
        
        // Analyze workout streak patterns
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        
        workouts.slice(-21).forEach(workout => { // Last 3 weeks
          if (workout.completionRate > 0.7) {
            tempStreak++;
            longestStreak = Math.max(longestStreak, tempStreak);
          } else {
            tempStreak = 0;
          }
        });
        
        // Calculate current streak
        for (let i = workouts.length - 1; i >= 0; i--) {
          if (workouts[i].completionRate > 0.7) {
            currentStreak++;
          } else {
            break;
          }
        }
        
        return {
          bestDay,
          worstDay,
          bestDayRate: bestRate,
          worstDayRate: worstRate,
          currentStreak,
          longestStreak,
          recommendations: generateMotivationRecommendations(bestDay, worstDay, currentStreak, longestStreak)
        };
      }

      function generateMotivationRecommendations(bestDay, worstDay, currentStreak, longestStreak) {
        const recommendations = [];
        
        if (worstDay && bestDay) {
          recommendations.push(`Your ${bestDay}s are strong! Consider scheduling challenging workouts then.`);
          recommendations.push(`${worstDay}s seem tough - try easier workouts or active recovery on this day.`);
        }
        
        if (currentStreak >= 5) {
          recommendations.push(`Amazing ${currentStreak}-day streak! Consider a planned recovery day to maintain momentum.`);
        } else if (currentStreak === 0) {
          recommendations.push('Start small - even a 10-minute session counts toward building your streak.');
        }
        
        if (longestStreak > currentStreak + 3) {
          recommendations.push(`You've done ${longestStreak} days before - you can do it again! What worked during that streak?`);
        }
        
        return recommendations;
      }

      // Generate personalized workout recommendations
      function generateRecommendations() {
        if (!state.mlInsights.lastAnalysis) {
          analyzePerformance();
        }

        const recommendations = [];
        
        // Focus recommendations based on weaknesses
        if (state.mlInsights.weaknessAreas.length > 0) {
          recommendations.push({
            type: 'focus_weakness',
            title: 'Focus on Weak Areas',
            description: `Consider spending extra time on: ${state.mlInsights.weaknessAreas.slice(0, 3).join(', ')}`,
            priority: 'high',
          });
        }

        // Smart rest period recommendations based on performance patterns
        const restOptimization = analyzeRestPeriods();
        if (restOptimization.recommendation) {
          recommendations.push(restOptimization.recommendation);
        }

        // Recovery recommendations based on workout intensity
        const recoveryRec = analyzeRecoveryNeeds();
        if (recoveryRec) {
          recommendations.push(recoveryRec);
        }

        // Progressive overload suggestions
        const progressionRec = analyzeProgressionReadiness();
        if (progressionRec) {
          recommendations.push(progressionRec);
        }

        // Difficulty adjustment recommendations
        const recentWorkouts = state.performanceHistory.slice(-5);
        if (recentWorkouts.length >= 3) {
          const avgCompletion = recentWorkouts.reduce((sum, w) => sum + w.completionRate, 0) / recentWorkouts.length;
          
          if (avgCompletion > 0.9) {
            recommendations.push({
              type: 'increase_difficulty',
              title: 'Ready for More Challenge',
              description: 'You\'re consistently completing workouts well. Consider increasing difficulty or adding sets.',
              priority: 'medium',
            });
          } else if (avgCompletion < 0.6) {
            recommendations.push({
              type: 'reduce_difficulty',
              title: 'Adjust Workout Intensity',
              description: 'Consider using easier exercise variations or reducing sets to build consistency.',
              priority: 'high',
            });
          }
        }

        // Consistency recommendations
        const workoutFrequency = state.performanceHistory.length / Math.max(1, 
          Math.ceil((Date.now() - new Date(state.performanceHistory[0]?.date || Date.now()).getTime()) / (1000 * 60 * 60 * 24 * 7))
        );
        
        if (workoutFrequency < 3) {
          recommendations.push({
            type: 'consistency',
            title: 'Build Workout Consistency',
            description: 'Try to maintain at least 3 workouts per week for optimal progress.',
            priority: 'medium',
          });
        }

        console.log('Generated recommendations:', recommendations);
        return recommendations;
      }

      // Enhanced ML insights with injury prevention and motivation analysis
      function renderEnhancedMLInsights() {
        const injuryRisk = assessInjuryRisk();
        const motivationData = analyzeMotivationPatterns();
        
        let enhancedHTML = '';
        
        // Injury Risk Assessment
        if (injuryRisk.risk !== 'unknown') {
          const riskColor = injuryRisk.risk === 'high' ? 'text-red-400 border-red-500/30 bg-red-500/10' : 
                           injuryRisk.risk === 'medium' ? 'text-yellow-400 border-yellow-500/30 bg-yellow-500/10' : 
                           'text-green-400 border-green-500/30 bg-green-500/10';
          const riskIcon = injuryRisk.risk === 'high' ? '‚ö†Ô∏è' : 
                          injuryRisk.risk === 'medium' ? '‚ö°' : '‚úÖ';
          
          enhancedHTML += `
            <div class="mt-3 p-3 rounded-lg border ${riskColor}">
              <div class="flex items-center mb-2">
                <span class="text-lg mr-2">${riskIcon}</span>
                <span class="font-medium ${riskColor.split(' ')[0]}">Injury Risk: ${injuryRisk.risk.toUpperCase()}</span>
              </div>
              ${injuryRisk.recommendations.length > 0 ? `
                <div class="text-gray-300 text-xs space-y-1">
                  ${injuryRisk.recommendations.slice(0, 2).map(rec => `<div>‚Ä¢ ${rec}</div>`).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }

        // Motivation & Performance Patterns
        if (motivationData) {
          enhancedHTML += `
            <div class="mt-3 p-3 bg-purple-500/10 border border-purple-500/20 rounded-lg">
              <div class="font-medium text-purple-400 text-sm mb-2 flex items-center">
                üìà Performance Patterns
                ${motivationData.currentStreak >= 3 ? '<span class="ml-2 text-xs bg-green-600 px-2 py-0.5 rounded-full">üî• Hot Streak!</span>' : ''}
              </div>
              <div class="grid grid-cols-2 gap-3 text-xs">
                ${motivationData.bestDay ? `
                  <div>
                    <span class="text-green-400">Best Day:</span>
                    <div class="text-white font-medium">${motivationData.bestDay.charAt(0).toUpperCase() + motivationData.bestDay.slice(1)}</div>
                  </div>
                ` : ''}
                <div>
                  <span class="text-blue-400">Current Streak:</span>
                  <div class="text-white font-medium">${motivationData.currentStreak} days</div>
                </div>
                ${motivationData.longestStreak > 0 ? `
                  <div>
                    <span class="text-yellow-400">Best Streak:</span>
                    <div class="text-white font-medium">${motivationData.longestStreak} days</div>
                  </div>
                ` : ''}
                ${motivationData.worstDay ? `
                  <div>
                    <span class="text-red-400">Challenge Day:</span>
                    <div class="text-white font-medium">${motivationData.worstDay.charAt(0).toUpperCase() + motivationData.worstDay.slice(1)}</div>
                  </div>
                ` : ''}
              </div>
              ${motivationData.recommendations.length > 0 ? `
                <div class="mt-2 text-xs text-gray-300 italic">
                  üí° ${motivationData.recommendations[0]}
                </div>
              ` : ''}
            </div>
          `;
        }
        
        return enhancedHTML;
      }

      // Generate workout personalization based on assessment data
      function generateWorkoutPersonalization(assessmentData) {
        const recommendations = {
          shouldShowRecommendations: false,
          warmupFocus: [],
          cooldownFocus: [],
          exerciseModifications: [],
          additionalStretches: [],
          intensityAdjustments: [],
        };

        // Analyze desk work and posture issues
        if (assessmentData.deskHours === '6-8' || assessmentData.deskHours === '8+') {
          recommendations.shouldShowRecommendations = true;
          recommendations.warmupFocus.push('Extended hip flexor stretches');
          recommendations.warmupFocus.push('Thoracic spine mobility');
          recommendations.cooldownFocus.push('Deep hip flexor stretches');
        }

        // Tech neck and shoulder tension
        if (assessmentData.techNeck === 'often' || assessmentData.shoulderTension === 'high') {
          recommendations.shouldShowRecommendations = true;
          recommendations.warmupFocus.push('Neck and shoulder mobility');
          recommendations.cooldownFocus.push('Upper trap releases');
          recommendations.additionalStretches.push('Doorway chest stretch (extra time)');
        }

        // Hip mobility issues
        if (assessmentData.deepSquat === 'no') {
          recommendations.shouldShowRecommendations = true;
          recommendations.warmupFocus.push('Hip mobility sequence');
          recommendations.exerciseModifications.push('Use assisted squat variations');
        }

        // Energy-based intensity adjustments
        if (assessmentData.energy <= 2) {
          recommendations.shouldShowRecommendations = true;
          recommendations.intensityAdjustments.push('Reduce sets by 25%');
          recommendations.intensityAdjustments.push('Focus on form over speed');
        }

        // Sleep-based adjustments
        if (assessmentData.sleep === '<6') {
          recommendations.shouldShowRecommendations = true;
          recommendations.intensityAdjustments.push('Prioritize recovery movements');
          recommendations.intensityAdjustments.push('Extended cool-down period');
        }

        // Tight areas focus
        if (assessmentData.tightAreas && assessmentData.tightAreas.length > 0) {
          recommendations.shouldShowRecommendations = true;
          assessmentData.tightAreas.forEach(area => {
            switch (area) {
              case 'hip-flexors':
                recommendations.additionalStretches.push('90/90 hip stretch');
                break;
              case 'hamstrings':
                recommendations.additionalStretches.push('Standing forward fold variations');
                break;
              case 'shoulders':
                recommendations.additionalStretches.push('Cross-body shoulder stretch');
                break;
              case 'chest':
                recommendations.additionalStretches.push('Wall corner chest stretch');
                break;
            }
          });
        }

        return recommendations;
      }

      // Show personalization recommendations modal
      function showPersonalizationModal(recommendations) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        
        let modalContent = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-white flex items-center">
                ü§ñ AI Workout Personalization
              </h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="space-y-4 text-sm">
              <p class="text-gray-300">Based on your assessment, here are personalized recommendations:</p>
        `;

        if (recommendations.warmupFocus.length > 0) {
          modalContent += `
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3">
              <div class="font-medium text-blue-400 mb-2">üî• Warm-up Focus</div>
              <ul class="text-gray-300 space-y-1">
                ${recommendations.warmupFocus.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        if (recommendations.intensityAdjustments.length > 0) {
          modalContent += `
            <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
              <div class="font-medium text-yellow-400 mb-2">‚ö° Intensity Adjustments</div>
              <ul class="text-gray-300 space-y-1">
                ${recommendations.intensityAdjustments.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        if (recommendations.additionalStretches.length > 0) {
          modalContent += `
            <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
              <div class="font-medium text-purple-400 mb-2">üßò Extra Stretches</div>
              <ul class="text-gray-300 space-y-1">
                ${recommendations.additionalStretches.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        modalContent += `
            </div>
            
            <div class="flex gap-3 mt-6">
              <button onclick="this.closest('.fixed').remove()" 
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
                Got it!
              </button>
              <button onclick="applyPersonalizations(); this.closest('.fixed').remove()" 
                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
                Apply & Start
              </button>
            </div>
          </div>
        `;

        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
        
        // Store recommendations for potential application
        window.currentPersonalizations = recommendations;
      }

      // Apply personalization recommendations to current workout
      function applyPersonalizations() {
        if (!window.currentPersonalizations) return;
        
        // This would modify the current workout plan based on recommendations
        // Implementation would depend on how the workout plan is structured
        console.log('Applying personalizations:', window.currentPersonalizations);
        
        // Show confirmation toast
        showToast('ü§ñ AI recommendations applied to your workout!', 'success');
      }

      // ===== GAMIFICATION SYSTEM =====
      
      // Achievement system
      const achievements = {
        'first_workout': { name: 'Getting Started', description: 'Complete your first workout', points: 10, icon: 'üéØ' },
        'week_warrior': { name: 'Week Warrior', description: 'Complete 5 workouts in 7 days', points: 50, icon: 'üî•' },
        'consistency_king': { name: 'Consistency King', description: '10-day workout streak', points: 100, icon: 'üëë' },
        'strength_builder': { name: 'Strength Builder', description: 'Progress to harder exercise variation', points: 25, icon: 'üí™' },
        'flexibility_master': { name: 'Flexibility Master', description: 'Complete 20 stretching sessions', points: 75, icon: 'üßò' },
        'early_bird': { name: 'Early Bird', description: 'Complete workout before 8 AM', points: 15, icon: 'üåÖ' },
        'night_owl': { name: 'Night Owl', description: 'Complete workout after 8 PM', points: 15, icon: 'ü¶â' },
        'perfect_form': { name: 'Perfect Form', description: 'Complete workout with 95%+ completion rate', points: 30, icon: '‚≠ê' },
        'recovery_guru': { name: 'Recovery Guru', description: 'Take recommended rest days', points: 20, icon: 'üõå' },
        'goal_crusher': { name: 'Goal Crusher', description: 'Reach monthly fitness goal', points: 200, icon: 'üèÜ' }
      };

      // XP and leveling system
      function calculateLevel(totalXP) {
        // Level formula: level = floor(sqrt(totalXP / 100))
        return Math.floor(Math.sqrt(totalXP / 100)) + 1;
      }

      function getXPForNextLevel(currentLevel) {
        return Math.pow(currentLevel, 2) * 100;
      }

      // Check and award achievements
      function checkAchievements(workoutData) {
        const newAchievements = [];
        const userStats = getUserStats();
        
        // First workout
        if (state.performanceHistory.length === 1) {
          newAchievements.push('first_workout');
        }
        
        // Week warrior - 5 workouts in 7 days
        const last7Days = state.performanceHistory.filter(w => 
          new Date(w.date) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
        );
        if (last7Days.length >= 5) {
          newAchievements.push('week_warrior');
        }
        
        // Consistency streak
        const currentStreak = getCurrentStreak();
        if (currentStreak >= 10) {
          newAchievements.push('consistency_king');
        }
        
        // Perfect form
        if (workoutData.completionRate >= 0.95) {
          newAchievements.push('perfect_form');
        }
        
        // Early bird / Night owl
        const workoutHour = new Date(workoutData.date).getHours();
        if (workoutHour < 8) {
          newAchievements.push('early_bird');
        } else if (workoutHour > 20) {
          newAchievements.push('night_owl');
        }
        
        // Award new achievements
        newAchievements.forEach(achievementId => {
          if (!state.unlockedAchievements.includes(achievementId)) {
            awardAchievement(achievementId);
          }
        });
      }

      function awardAchievement(achievementId) {
        const achievement = achievements[achievementId];
        if (!achievement) return;
        
        state.unlockedAchievements.push(achievementId);
        state.totalXP = (state.totalXP || 0) + achievement.points;
        
        // Show achievement notification
        showAchievementModal(achievement);
        
        // Update level if necessary
        const newLevel = calculateLevel(state.totalXP);
        if (newLevel > (state.level || 1)) {
          state.level = newLevel;
          showLevelUpModal(newLevel);
        }
        
        saveStateToFirestore();
      }

      function showAchievementModal(achievement) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 achievement-modal';
        modal.innerHTML = `
          <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 border-2 border-yellow-400 rounded-lg p-6 max-w-sm mx-4 text-center animate-bounce">
            <div class="text-6xl mb-4">${achievement.icon}</div>
            <h3 class="text-xl font-bold text-white mb-2">Achievement Unlocked!</h3>
            <h4 class="text-lg font-semibold text-yellow-100 mb-2">${achievement.name}</h4>
            <p class="text-yellow-200 text-sm mb-4">${achievement.description}</p>
            <div class="text-yellow-100 font-bold">+${achievement.points} XP</div>
            <button onclick="this.closest('.achievement-modal').remove()" 
              class="mt-4 bg-white text-yellow-700 px-6 py-2 rounded-full font-semibold hover:bg-yellow-100 transition-colors">
              Awesome!
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-remove after 5 seconds
        setTimeout(() => modal.remove(), 5000);
      }

      // ===== SOCIAL & CHALLENGES =====
      
      // Weekly challenges
      const weeklyChallenge = {
        generateChallenge() {
          const challenges = [
            { type: 'total_workouts', target: 5, description: 'Complete 5 workouts this week', reward: 50 },
            { type: 'streak_days', target: 7, description: 'Maintain a 7-day workout streak', reward: 75 },
            { type: 'push_ups', target: 200, description: 'Complete 200 push-ups total', reward: 40 },
            { type: 'plank_time', target: 300, description: 'Hold planks for 5 minutes total', reward: 35 },
            { type: 'early_workouts', target: 3, description: 'Complete 3 morning workouts', reward: 30 },
          ];
          
          return challenges[Math.floor(Math.random() * challenges.length)];
        },
        
        checkProgress(challenge, userStats) {
          const progress = { current: 0, target: challenge.target, percentage: 0 };
          
          switch (challenge.type) {
            case 'total_workouts':
              progress.current = this.getWeeklyWorkouts();
              break;
            case 'push_ups':
              progress.current = this.getWeeklyPushUps();
              break;
            case 'streak_days':
              progress.current = Math.min(getCurrentStreak(), 7);
              break;
          }
          
          progress.percentage = Math.min(100, (progress.current / progress.target) * 100);
          return progress;
        },
        
        getWeeklyWorkouts() {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          return state.performanceHistory.filter(w => new Date(w.date) >= weekStart).length;
        },
        
        getWeeklyPushUps() {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          let total = 0;
          state.performanceHistory.forEach(workout => {
            if (new Date(workout.date) >= weekStart && workout.sets) {
              workout.sets.forEach(set => {
                if (set.exercise && set.exercise.toLowerCase().includes('push')) {
                  total += set.reps || 0;
                }
              });
            }
          });
          return total;
        }
      };

      // ===== ADAPTIVE DIFFICULTY SYSTEM =====
      
      // Modify workout difficulty based on user performance
      function adaptWorkoutDifficulty(dayKey) {
        if (!state.mlInsights?.exercisePerformance) return;
        
        const dayData = workoutPlan[dayKey];
        if (!dayData || !dayData.exercises) return;
        
        console.log(`Adapting difficulty for ${dayKey} workout...`);
        
        dayData.exercises.forEach((exercise, index) => {
          const exerciseName = exercise.baseName || exercise.name;
          const performance = state.mlInsights.exercisePerformance.find(p => p.name === exerciseName);
          
          if (!performance || performance.sessions < 3) return; // Need sufficient data
          
          const adaptedExercise = {...exercise};
          let adaptationMade = false;
          
          // High performers (>90% completion, consistent performance)
          if (performance.avgCompletion > 0.9 && performance.consistency > 0.7) {
            adaptedExercise = increaseExerciseDifficulty(adaptedExercise);
            adaptationMade = true;
            console.log(`Increased difficulty for ${exerciseName}: high performance detected`);
          }
          // Low performers (<50% completion, declining trend)
          else if (performance.avgCompletion < 0.5 || performance.improvementTrend < -0.3) {
            adaptedExercise = decreaseExerciseDifficulty(adaptedExercise);
            adaptationMade = true;
            console.log(`Decreased difficulty for ${exerciseName}: struggling performance detected`);
          }
          // Improving performers (positive trend but not mastered)
          else if (performance.improvementTrend > 0.5 && performance.avgCompletion > 0.7) {
            adaptedExercise = increaseExerciseDifficulty(adaptedExercise, 'gradual');
            adaptationMade = true;
            console.log(`Gradually increased difficulty for ${exerciseName}: improving performance`);
          }
          
          if (adaptationMade) {
            workoutPlan[dayKey].exercises[index] = adaptedExercise;
            
            // Track adaptation
            if (!state.exerciseProgress[exerciseName]) {
              state.exerciseProgress[exerciseName] = { adaptations: [] };
            }
            state.exerciseProgress[exerciseName].adaptations.push({
              date: new Date().toISOString(),
              type: adaptedExercise.difficulty,
              reason: `Performance: ${Math.round(performance.avgCompletion * 100)}%`,
            });
          }
        });
        
        saveStateToFirestore();
      }
      
      // Increase exercise difficulty
      function increaseExerciseDifficulty(exercise, intensity = 'normal') {
        const adapted = {...exercise};
        
        // If exercise has variations, try to use harder one
        if (exercise.variations && exercise.variations.harder) {
          const harderVariation = exercise.variations.harder[0];
          if (harderVariation) {
            adapted.name = harderVariation.name;
            adapted.difficulty = harderVariation.difficulty || 'advanced';
            adapted.note = harderVariation.note || exercise.note;
            adapted.originalName = exercise.name; // Track original
            return adapted;
          }
        }
        
        // Otherwise modify sets/reps
        const currentSets = parseInt(exercise.sets) || 3;
        const repsRange = exercise.reps.match(/(\d+)-(\d+)/) || exercise.reps.match(/(\d+)/);
        
        if (intensity === 'gradual') {
          // Small increases
          if (repsRange && repsRange.length >= 2) {
            const minReps = parseInt(repsRange[1]);
            const maxReps = parseInt(repsRange[2] || repsRange[1]);
            adapted.reps = `${minReps + 2}-${maxReps + 3}`;
          } else if (currentSets < 5) {
            adapted.sets = (currentSets + 1).toString();
          }
        } else {
          // More significant increases
          if (repsRange && repsRange.length >= 2) {
            const minReps = parseInt(repsRange[1]);
            const maxReps = parseInt(repsRange[2] || repsRange[1]);
            adapted.reps = `${minReps + 3}-${maxReps + 5}`;
          }
          if (currentSets < 5) {
            adapted.sets = Math.min(currentSets + 1, 5).toString();
          }
        }
        
        adapted.difficulty = adapted.difficulty === 'beginner' ? 'intermediate' : 
                            adapted.difficulty === 'intermediate' ? 'advanced' : 'advanced';
        adapted.adaptedFrom = exercise.name;
        
        return adapted;
      }
      
      // Decrease exercise difficulty
      function decreaseExerciseDifficulty(exercise) {
        const adapted = {...exercise};
        
        // If exercise has variations, try to use easier one
        if (exercise.variations && exercise.variations.easier) {
          const easierVariation = exercise.variations.easier[0];
          if (easierVariation) {
            adapted.name = easierVariation.name;
            adapted.difficulty = easierVariation.difficulty || 'beginner';
            adapted.note = easierVariation.note || exercise.note;
            adapted.originalName = exercise.name;
            return adapted;
          }
        }
        
        // Otherwise modify sets/reps
        const currentSets = parseInt(exercise.sets) || 3;
        const repsRange = exercise.reps.match(/(\d+)-(\d+)/) || exercise.reps.match(/(\d+)/);
        
        if (repsRange && repsRange.length >= 2) {
          const minReps = Math.max(parseInt(repsRange[1]) - 3, 1);
          const maxReps = Math.max(parseInt(repsRange[2] || repsRange[1]) - 2, minReps);
          adapted.reps = `${minReps}-${maxReps}`;
        }
        
        if (currentSets > 2) {
          adapted.sets = Math.max(currentSets - 1, 2).toString();
        }
        
        adapted.difficulty = adapted.difficulty === 'advanced' ? 'intermediate' : 
                            adapted.difficulty === 'intermediate' ? 'beginner' : 'beginner';
        adapted.adaptedFrom = exercise.name;
        
        return adapted;
      }

      // ===== PERSONALIZED WORKOUT GENERATION =====
      
      // Generate a custom workout based on user preferences and performance
      function generatePersonalizedWorkout(targetDuration = 30, focusAreas = []) {
        if (!state.mlInsights?.exercisePerformance) {
          console.log('Insufficient data for personalized workout generation');
          return null;
        }
        
        const allExercises = Object.values(originalWorkoutPlan).flatMap(day => day.exercises);
        const exercisePerf = state.mlInsights.exercisePerformance;
        
        // Filter exercises based on focus areas
        let selectedExercises = allExercises;
        if (focusAreas.length > 0) {
          selectedExercises = allExercises.filter(exercise => {
            const exerciseName = (exercise.baseName || exercise.name).toLowerCase();
            return focusAreas.some(focus => {
              const focusKeywords = {
                'upper_body_push': ['push', 'press', 'dip'],
                'upper_body_pull': ['row', 'pull', 'chin'],
                'legs': ['squat', 'lunge', 'calf'],
                'core': ['plank', 'crunch', 'sit'],
                'cardio': ['jump', 'burpee', 'mountain'],
              };
              return focusKeywords[focus]?.some(keyword => exerciseName.includes(keyword)) || false;
            });
          });
        }
        
        // Score exercises based on user needs
        const scoredExercises = selectedExercises.map(exercise => {
          const exerciseName = exercise.baseName || exercise.name;
          const perf = exercisePerf.find(p => p.name === exerciseName);
          
          let score = Math.random() * 0.3; // Base randomness
          
          if (perf) {
            // Boost weak areas for improvement
            if (state.mlInsights.weaknessAreas.includes(exerciseName)) {
              score += 0.4;
            }
            // Slightly boost strength areas for confidence
            if (state.mlInsights.strengthAreas.includes(exerciseName)) {
              score += 0.2;
            }
            // Consider consistency
            score += perf.consistency * 0.3;
          }
          
          return { exercise, score };
        });
        
        // Select top exercises
        scoredExercises.sort((a, b) => b.score - a.score);
        const numExercises = Math.min(Math.ceil(targetDuration / 5), 8); // ~5 min per exercise
        const chosenExercises = scoredExercises.slice(0, numExercises).map(item => {
          const adapted = {...item.exercise};
          
          // Apply difficulty adaptations
          const exerciseName = adapted.baseName || adapted.name;
          const perf = exercisePerf.find(p => p.name === exerciseName);
          
          if (perf && perf.sessions >= 3) {
            if (perf.avgCompletion > 0.8) {
              return increaseExerciseDifficulty(adapted, 'gradual');
            } else if (perf.avgCompletion < 0.6) {
              return decreaseExerciseDifficulty(adapted);
            }
          }
          
          return adapted;
        });
        
        return {
          day: "Custom Workout",
          title: "Personalized Workout",
          subtitle: focusAreas.length > 0 ? `Focus: ${focusAreas.join(', ')}` : "AI-Generated",
          warmup: [
            "5-10 min Light Cardio",
            "Dynamic Stretching (2-3 min)",
            "Joint Mobility (1-2 min)",
          ],
          exercises: chosenExercises,
          generatedAt: new Date().toISOString(),
          basedOnData: `${state.performanceHistory.length} workouts`,
        };
      }

      // Generate and display personalized workout
      function generateAndShowPersonalizedWorkout() {
        if (!state.mlInsights?.exercisePerformance || state.performanceHistory.length < 3) {
          showToast('Complete at least 3 workouts to generate personalized workouts!', 'info');
          return;
        }
        
        // Determine focus areas based on weaknesses
        let focusAreas = [];
        if (state.mlInsights.weaknessAreas && state.mlInsights.weaknessAreas.length > 0) {
          const muscleGroups = categorizeExercises(state.mlInsights.weaknessAreas);
          const topWeakness = Object.entries(muscleGroups).sort((a, b) => b[1] - a[1])[0];
          if (topWeakness) {
            focusAreas = [topWeakness[0]];
          }
        }
        
        const personalizedWorkout = generatePersonalizedWorkout(
          state.userPreferences.timeAvailable || 30,
          focusAreas
        );
        
        if (!personalizedWorkout) {
          showToast('Unable to generate personalized workout at this time.', 'error');
          return;
        }
        
        // Add to workout plan as a special day
        workoutPlan['custom'] = personalizedWorkout;
        
        // Show the workout
        showWorkoutModal('custom');
        
        showToast('üéØ Personalized workout generated based on your performance!', 'success');
      }

      // ===== ADDITIONAL RECOMMENDED FEATURES =====

      // Voice commands and audio guidance
      let voiceRecognition = null;
      let voiceListening = false;
      
      function initVoiceCommands() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
          console.log('Speech recognition not supported in this browser');
          return false;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = true; // Keep listening
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = 'en-US';
        voiceRecognition.maxAlternatives = 1;

        voiceRecognition.onstart = function() {
          voiceListening = true;
          console.log('Voice recognition started');
          showToast('üé§ Listening for commands...', 'info');
        };

        voiceRecognition.onend = function() {
          voiceListening = false;
          console.log('Voice recognition ended');
          
          // Auto-restart if user has voice commands enabled
          if (state.voiceCommandsEnabled) {
            setTimeout(() => {
              try {
                voiceRecognition.start();
              } catch (e) {
                // Already running
              }
            }, 1000);
          }
        };

        voiceRecognition.onerror = function(event) {
          console.error('Voice recognition error:', event.error);
          if (event.error !== 'no-speech' && event.error !== 'aborted') {
            showToast(`Voice error: ${event.error}`, 'error');
          }
        };

        voiceRecognition.onresult = function(event) {
          const last = event.results.length - 1;
          const command = event.results[last][0].transcript.toLowerCase().trim();
          console.log('Voice command detected:', command);
          handleVoiceCommand(command);
        };

        return true;
      }

      function startVoiceRecognition() {
        if (!voiceRecognition) {
          const initialized = initVoiceCommands();
          if (!initialized) {
            showToast('Voice commands not supported in this browser', 'error');
            return;
          }
        }

        if (!voiceListening) {
          try {
            voiceRecognition.start();
            state.voiceCommandsEnabled = true;
            saveStateToFirestore();
          } catch (e) {
            console.error('Error starting voice recognition:', e);
          }
        }
      }

      function stopVoiceRecognition() {
        if (voiceRecognition && voiceListening) {
          voiceRecognition.stop();
          state.voiceCommandsEnabled = false;
          saveStateToFirestore();
          showToast('üé§ Voice commands disabled', 'info');
        }
      }

      function handleVoiceCommand(command) {
        console.log('Processing command:', command);
        
        // Provide audio feedback
        const speak = (text) => {
          if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.2;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
          }
        };

        // Start workout
        if (command.includes('start workout') || command.includes('begin workout')) {
          const startBtn = document.getElementById('start-workout-btn');
          if (startBtn && !startBtn.classList.contains('hidden')) {
            startBtn.click();
            speak('Starting workout');
            showToast('üé§ Voice: Starting workout', 'info');
          } else {
            speak('Cannot start workout');
          }
        }
        // Complete workout
        else if (command.includes('complete workout') || command.includes('finish workout') || command.includes('end workout')) {
          const completeBtn = document.getElementById('complete-workout-btn');
          if (completeBtn && !completeBtn.classList.contains('hidden') && !completeBtn.disabled) {
            completeBtn.click();
            speak('Completing workout');
            showToast('üé§ Voice: Completing workout', 'info');
          } else {
            speak('Cannot complete workout');
          }
        }
        // Start timer
        else if (command.includes('start timer') || command.includes('begin timer')) {
          const startStopBtn = document.getElementById('start-stop-btn');
          if (startStopBtn && startStopBtn.textContent.toLowerCase().includes('start')) {
            startStopBtn.click();
            speak('Timer started');
            showToast('üé§ Voice: Timer started', 'info');
          }
        }
        // Pause timer
        else if (command.includes('pause timer') || command.includes('stop timer')) {
          const pauseBtn = document.getElementById('pause-workout-timer-btn');
          if (pauseBtn) {
            pauseBtn.click();
            speak('Timer paused');
            showToast('üé§ Voice: Timer paused', 'info');
          }
        }
        // Resume timer
        else if (command.includes('resume timer') || command.includes('continue timer')) {
          const pauseBtn = document.getElementById('pause-workout-timer-btn');
          if (pauseBtn && pauseBtn.textContent.includes('‚ñ∂')) {
            pauseBtn.click();
            speak('Timer resumed');
            showToast('üé§ Voice: Timer resumed', 'info');
          }
        }
        // Rest timer
        else if (command.includes('rest timer') || command.includes('start rest')) {
          openTimerModal('countdown', { seconds: 90, title: 'Rest Timer' });
          speak('Rest timer started');
          showToast('üé§ Voice: Rest timer opened', 'info');
        }
        // Close modal
        else if (command.includes('close') || command.includes('cancel') || command.includes('go back')) {
          const closeBtn = document.getElementById('close-modal');
          if (closeBtn) {
            closeBtn.click();
            speak('Closing');
            showToast('üé§ Voice: Closing', 'info');
          }
        }
        // Help
        else if (command.includes('help') || command.includes('what can you do')) {
          speak('You can say: start workout, complete workout, start timer, pause timer, rest timer, or close');
          showToast('üé§ Voice commands: start workout, complete workout, start/pause timer, rest timer, close', 'info');
        }
        // Unknown command
        else {
          speak('Command not recognized. Say help for options.');
          showToast('üé§ Command not recognized. Say "help" for options.', 'error');
        }
      }

      function showVoiceCommandsHelp() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-2xl w-full">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
              <h3 class="text-lg font-bold text-white">üé§ Voice Commands Guide</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-6">
              <p class="text-gray-300 mb-4">
                When voice commands are enabled, you can control the app hands-free. 
                Speak clearly and wait for the beep before saying your command.
              </p>
              
              <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mb-4">
                <h4 class="font-bold text-blue-400 mb-2">üéØ How to Use</h4>
                <ol class="text-gray-300 text-sm space-y-1 list-decimal list-inside">
                  <li>Enable voice commands in Settings</li>
                  <li>Look for the üé§ microphone indicator when listening</li>
                  <li>Speak your command clearly</li>
                  <li>Wait for audio confirmation</li>
                </ol>
              </div>

              <h4 class="font-bold text-white mb-3">Available Commands:</h4>
              <div class="space-y-2">
                <div class="bg-gray-800 rounded-lg p-3">
                  <div class="font-semibold text-green-400">üèãÔ∏è Workout Controls</div>
                  <ul class="text-gray-300 text-sm mt-1 space-y-1">
                    <li>‚Ä¢ <span class="text-blue-300">"Start workout"</span> - Begin your workout</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Complete workout"</span> - Finish your workout</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Finish workout"</span> - End your workout</li>
                  </ul>
                </div>

                <div class="bg-gray-800 rounded-lg p-3">
                  <div class="font-semibold text-yellow-400">‚è±Ô∏è Timer Controls</div>
                  <ul class="text-gray-300 text-sm mt-1 space-y-1">
                    <li>‚Ä¢ <span class="text-blue-300">"Start timer"</span> - Start the exercise timer</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Pause timer"</span> - Pause the current timer</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Resume timer"</span> - Continue the timer</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Rest timer"</span> - Start a 90-second rest</li>
                  </ul>
                </div>

                <div class="bg-gray-800 rounded-lg p-3">
                  <div class="font-semibold text-purple-400">üó∫Ô∏è Navigation</div>
                  <ul class="text-gray-300 text-sm mt-1 space-y-1">
                    <li>‚Ä¢ <span class="text-blue-300">"Close"</span> - Close current modal</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Go back"</span> - Return to previous screen</li>
                    <li>‚Ä¢ <span class="text-blue-300">"Help"</span> - Hear available commands</li>
                  </ul>
                </div>
              </div>

              <div class="mt-4 bg-orange-500/10 border border-orange-500/20 rounded-lg p-3">
                <p class="text-orange-300 text-sm">
                  <strong>üí° Tip:</strong> Voice recognition works best in quiet environments. 
                  If a command doesn't work, try speaking slightly louder or slower.
                </p>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Export voice functions
      window.initVoiceCommands = initVoiceCommands;
      window.startVoiceRecognition = startVoiceRecognition;
      window.stopVoiceRecognition = stopVoiceRecognition;
      window.handleVoiceCommand = handleVoiceCommand;
      window.showVoiceCommandsHelp = showVoiceCommandsHelp;

      // Enhanced progress visualization
      function generateProgressCharts() {
        const chartData = {
          strengthProgress: [],
          consistencyTrend: [],
          bodyMeasurements: [],
          workoutDuration: []
        };

        // Prepare data for last 12 weeks
        const weeks = [];
        for (let i = 11; i >= 0; i--) {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - (i * 7));
          weeks.push(weekStart);
        }

        weeks.forEach(weekStart => {
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          const weekWorkouts = state.performanceHistory.filter(w => {
            const workoutDate = new Date(w.date);
            return workoutDate >= weekStart && workoutDate <= weekEnd;
          });

          chartData.consistencyTrend.push({
            week: weekStart.toISOString().split('T')[0],
            workouts: weekWorkouts.length,
            avgCompletion: weekWorkouts.length > 0 ? 
              weekWorkouts.reduce((sum, w) => sum + w.completionRate, 0) / weekWorkouts.length : 0
          });
        });

        return chartData;
      }

      // Social sharing and community features
      function shareWorkoutAchievement(achievement) {
        const shareData = {
          title: `Toji Fitness Achievement: ${achievement.name}`,
          text: `I just unlocked "${achievement.name}" - ${achievement.description}! üí™`,
          url: window.location.href
        };

        if (navigator.share) {
          navigator.share(shareData);
        } else {
          // Fallback to clipboard
          navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`);
          showToast('Achievement copied to clipboard!', 'success');
        }
      }

      // Initialize new features
      function initializeEnhancedFeatures() {
        // Initialize state for new features if not exists
        if (!state.unlockedAchievements) state.unlockedAchievements = [];
        if (!state.totalXP) state.totalXP = 0;
        if (!state.level) state.level = 1;
        if (!state.userGoals) state.userGoals = [];
        if (!state.weeklyChallenge) state.weeklyChallenge = weeklyChallenge.generateChallenge();
        
        // Initialize voice commands
        initVoiceCommands();
        
        // Update goal progress
        updateGoalProgress();
      }

      // Make new functions globally accessible
      window.shareWorkoutAchievement = shareWorkoutAchievement;
      window.generateProgressCharts = generateProgressCharts;
      window.initializeEnhancedFeatures = initializeEnhancedFeatures;
      // Note: Window exports moved to after all function definitions
      // to avoid "function not defined" errors
      
      // Make ML functions globally accessible for testing
      window.recordWorkoutSession = recordWorkoutSession;
      window.analyzePerformance = analyzePerformance;

      // ===== MISSING DASHBOARD FUNCTIONS =====
      
      // Goal types configuration
      const goalTypes = {
        weekly_workouts: {
          name: 'Weekly Workouts',
          unit: 'workouts',
          icon: 'üìÖ',
          description: 'Complete workouts each week'
        },
        total_workouts: {
          name: 'Total Workouts',
          unit: 'workouts',
          icon: 'üí™',
          description: 'Total lifetime workouts completed'
        },
        workout_streak: {
          name: 'Workout Streak',
          unit: 'days',
          icon: 'üî•',
          description: 'Consecutive days with workouts'
        },
        exercises_mastered: {
          name: 'Exercises Mastered',
          unit: 'exercises',
          icon: 'üèÜ',
          description: 'Different exercises completed'
        }
      };
      
      function updateDashboardStats() {
        const stats = getUserStats();
        
        // Update level and XP display using correct IDs
        const levelElement = document.getElementById('user-level');
        const xpElement = document.getElementById('user-xp');
        const xpProgressBar = document.getElementById('xp-progress-bar');
        const xpNextLevel = document.getElementById('xp-next-level');
        
        if (levelElement) levelElement.textContent = stats.level;
        if (xpElement) xpElement.textContent = stats.totalXP;
        
        // Update XP progress bar
        if (xpProgressBar) {
          const currentLevelXP = (stats.level - 1) * 100;
          const nextLevelXP = stats.level * 100;
          const progressPercentage = ((stats.totalXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
          xpProgressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
        }
        
        // Update next level text
        if (xpNextLevel) {
          const nextLevelXP = stats.level * 100;
          xpNextLevel.textContent = `Next level at ${nextLevelXP} XP`;
        }
        
        // Update weekly progress
        const workoutsCompleted = document.getElementById('workouts-completed');
        const progressBar = document.getElementById('progress-bar');
        if (workoutsCompleted) {
          const completedThisWeek = state.completedWorkouts?.thisWeek || 0;
          const weeklyGoal = 5; // default weekly goal
          workoutsCompleted.textContent = completedThisWeek;
          
          if (progressBar) {
            const progressPercentage = (completedThisWeek / weeklyGoal) * 100;
            progressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
          }
        }
      }

      // ============================================
      // EXTREME MODE: 11/10 INTENSITY FUNCTIONS
      // ============================================
      
      // Update Workout Streak
      function updateWorkoutStreak() {
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        
        if (state.lastWorkoutDate === today) {
          // Already worked out today, streak continues
        } else if (state.lastWorkoutDate === yesterday) {
          // Worked out yesterday, increment streak
          state.workoutStreak++;
        } else if (state.lastWorkoutDate && state.lastWorkoutDate !== today) {
          // Missed a day, reset streak
          state.workoutStreak = 1;
        } else {
          // First workout ever
          state.workoutStreak = 1;
        }
        
        state.lastWorkoutDate = today;
        displayWorkoutStreak();
        saveStateToFirestore();
      }
      
      function displayWorkoutStreak() {
        const streakCount = document.getElementById('streak-count');
        const streakFlames = document.getElementById('streak-flames');
        const streakMessage = document.getElementById('streak-message');
        
        if (!streakCount) return;
        
        const streak = state.workoutStreak || 0;
        streakCount.textContent = streak;
        
        // Add fire emojis based on streak
        let flames = '';
        if (streak >= 30) flames = 'üî•üî•üî•üî•üî• LEGENDARY!';
        else if (streak >= 21) flames = 'üî•üî•üî•üî• BEAST MODE!';
        else if (streak >= 14) flames = 'üî•üî•üî• ON FIRE!';
        else if (streak >= 7) flames = 'üî•üî• HOT STREAK!';
        else if (streak >= 3) flames = 'üî• Getting Hot!';
        else flames = 'üí™ Start Your Streak!';
        
        if (streakFlames) streakFlames.textContent = flames;
        
        // Update message
        const messages = [
          'Start your streak today!',
          'One day down!',
          'Building momentum!',
          'Keep it going!',
          'Consistency is key!',
          'You are unstoppable!',
          'Week completed! üéâ',
          'Two weeks! Amazing!',
          'Three weeks! Elite!',
          'One month! LEGENDARY!'
        ];
        const messageIndex = Math.min(streak, messages.length - 1);
        if (streakMessage) streakMessage.textContent = messages[messageIndex];
      }
      
      // Track Personal Records
      function checkForPersonalRecord(exerciseName, reps, weight = 0) {
        const today = new Date().toISOString().split('T')[0];
        
        if (!state.personalRecords[exerciseName]) {
          // First time doing this exercise - it's automatically a PR
          state.personalRecords[exerciseName] = { reps, weight, date: today };
          state.prHistory.push({ exercise: exerciseName, reps, weight, date: today });
          celebratePR(exerciseName, reps);
          updatePRDisplay();
          saveStateToFirestore();
          return true;
        }
        
        const currentPR = state.personalRecords[exerciseName];
        const isNewPR = reps > currentPR.reps || (reps === currentPR.reps && weight > currentPR.weight);
        
        if (isNewPR) {
          state.personalRecords[exerciseName] = { reps, weight, date: today };
          state.prHistory.push({ exercise: exerciseName, reps, weight, date: today, previous: currentPR.reps });
          celebratePR(exerciseName, reps);
          updatePRDisplay();
          saveStateToFirestore();
          return true;
        }
        
        return false;
      }
      
      function celebratePR(exerciseName, reps) {
        // Show confetti animation and toast
        showToast(`üéâ NEW PR! ${exerciseName}: ${reps} reps! üèÖ`, 'success');
        
        // Add confetti effect
        const confettiColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
              position: fixed;
              top: 0;
              left: ${Math.random() * 100}%;
              width: 10px;
              height: 10px;
              background: ${confettiColors[Math.floor(Math.random() * confettiColors.length)]};
              z-index: 10000;
              animation: confetti-fall ${2 + Math.random() * 2}s linear forwards;
            `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
          }, i * 20);
        }
        
        // Add confetti animation CSS if not exists
        if (!document.getElementById('confetti-style')) {
          const style = document.createElement('style');
          style.id = 'confetti-style';
          style.textContent = `
            @keyframes confetti-fall {
              0% { transform: translateY(0) rotate(0deg); opacity: 1; }
              100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }
      }
      
      function updatePRDisplay() {
        const totalPRs = document.getElementById('total-prs');
        const prsThisWeek = document.getElementById('prs-this-week');
        
        if (!totalPRs) return;
        
        const total = state.prHistory.length;
        totalPRs.textContent = total;
        
        // Count PRs from this week
        const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
        const weekCount = state.prHistory.filter(pr => pr.date >= weekAgo).length;
        if (prsThisWeek) prsThisWeek.textContent = weekCount;
      }
      
      // Calculate Fatigue Score
      function calculateFatigueScore() {
        if (!state.performanceHistory || state.performanceHistory.length === 0) {
          state.fatigueScore = 0;
          displayFatigueScore();
          return;
        }
        
        // Get last 7 workouts
        const recentWorkouts = state.performanceHistory.slice(-7);
        
        // Calculate fatigue based on:
        // 1. Workout frequency (more frequent = higher fatigue)
        // 2. Average difficulty ratings (harder workouts = more fatigue)
        // 3. Rest days (lack of rest = higher fatigue)
        
        let totalIntensity = 0;
        let workoutCount = recentWorkouts.length;
        
        recentWorkouts.forEach(workout => {
          if (workout.exercises) {
            workout.exercises.forEach(exercise => {
              if (exercise.sets && Array.isArray(exercise.sets)) {
                exercise.sets.forEach(set => {
                  if (set.rating) {
                    // High difficulty ratings increase fatigue
                    totalIntensity += parseInt(set.rating);
                  }
                });
              }
            });
          }
        });
        
        // Calculate fatigue (0-100 scale)
        const avgIntensity = workoutCount > 0 ? totalIntensity / workoutCount : 0;
        const frequencyMultiplier = workoutCount / 7; // How many workouts in last 7 days
        
        let fatigueScore = (avgIntensity * frequencyMultiplier * 1.5);
        fatigueScore = Math.min(Math.max(fatigueScore, 0), 100); // Clamp to 0-100
        
        state.fatigueScore = Math.round(fatigueScore);
        state.fatigueHistory.push({ date: new Date().toISOString().split('T')[0], score: state.fatigueScore });
        
        displayFatigueScore();
        saveStateToFirestore();
      }
      
      function displayFatigueScore() {
        const fatigueValue = document.getElementById('fatigue-value');
        const fatigueStatus = document.getElementById('fatigue-status');
        const fatigueBar = document.getElementById('fatigue-bar');
        const fatigueRecommendation = document.getElementById('fatigue-recommendation');
        
        if (!fatigueValue) return;
        
        const score = state.fatigueScore || 0;
        fatigueValue.textContent = score;
        
        // Update bar color and status based on score
        let color, status, recommendation;
        if (score < 30) {
          color = 'green';
          status = 'Fresh & Ready!';
          recommendation = 'Perfect condition for intense training!';
        } else if (score < 50) {
          color = 'yellow';
          status = 'Moderate Fatigue';
          recommendation = 'Train smart, listen to your body';
        } else if (score < 70) {
          color = 'orange';
          status = 'Elevated Fatigue';
          recommendation = 'Consider a lighter session or active recovery';
        } else {
          color = 'red';
          status = 'High Fatigue';
          recommendation = '‚ö†Ô∏è REST DAY RECOMMENDED - Your body needs recovery!';
        }
        
        if (fatigueValue) {
          fatigueValue.className = `text-${color}-400`;
        }
        if (fatigueStatus) {
          fatigueStatus.textContent = status;
          fatigueStatus.className = `text-sm text-${color}-400 mb-2`;
        }
        if (fatigueBar) {
          fatigueBar.style.width = `${score}%`;
          fatigueBar.className = `bg-${color}-500 h-2 rounded-full transition-all duration-500`;
        }
        if (fatigueRecommendation) {
          fatigueRecommendation.textContent = recommendation;
        }
      }
      
      // Calculate Workout Intensity Score
      function calculateWorkoutIntensity(workout) {
        if (!workout || !workout.exercises) return 0;
        
        let totalIntensity = 0;
        let ratingCount = 0;
        
        workout.exercises.forEach(exercise => {
          if (exercise.sets && Array.isArray(exercise.sets)) {
            exercise.sets.forEach(set => {
              if (set.rating) {
                totalIntensity += parseInt(set.rating) * 10; // Scale up for display
                ratingCount++;
              }
            });
          }
        });
        
        return ratingCount > 0 ? Math.round(totalIntensity / ratingCount) : 0;
      }
      
      function updateIntensityDisplay() {
        const intensityValue = document.getElementById('intensity-value');
        const intensityMarker = document.getElementById('intensity-marker');
        
        if (!intensityValue || !state.intensityScores || state.intensityScores.length === 0) return;
        
        // Get today's intensity or most recent
        const todayIntensity = state.intensityScores[state.intensityScores.length - 1] || 0;
        intensityValue.textContent = todayIntensity;
        
        // Move marker on intensity bar (0-100 scale)
        const percentage = Math.min(todayIntensity, 100);
        if (intensityMarker) {
          intensityMarker.style.left = `${percentage}%`;
        }
      }
      
      window.showPRHistory = function() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
          <div class="bg-gray-800 border border-yellow-500/30 rounded-lg shadow-2xl w-full max-w-2xl">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
              <h2 class="font-bebas text-3xl text-yellow-500">üèÖ Personal Records History</h2>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
              ${state.prHistory.length === 0 ? 
                '<p class="text-gray-400 text-center py-8">No personal records yet. Keep training! üí™</p>' :
                state.prHistory.slice().reverse().map(pr => `
                  <div class="bg-gray-900/50 p-4 rounded-lg border border-yellow-500/20 mb-3">
                    <div class="flex justify-between items-center">
                      <div>
                        <h3 class="text-white font-bold">${pr.exercise}</h3>
                        <p class="text-yellow-400 text-sm">${pr.reps} reps ${pr.weight > 0 ? `@ ${pr.weight} lbs` : ''}</p>
                      </div>
                      <div class="text-right">
                        <p class="text-gray-400 text-xs">${pr.date}</p>
                        ${pr.previous ? `<p class="text-green-400 text-xs">+${pr.reps - pr.previous} reps!</p>` : ''}
                      </div>
                    </div>
                  </div>
                `).join('')
              }
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      };

      // AI Form Check Functions
      // Global AI model variable
      let poseDetector = null;
      let detectionInterval = null;

      window.startFormCheck = async function() {
        try {
          // Request camera access
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'user',
              width: { ideal: 640 },
              height: { ideal: 480 }
            } 
          });
          
          state.formCheckActive = true;
          state.formCheckStream = stream;
          
          // Create modal with video feed
          const modal = document.createElement('div');
          modal.id = 'form-check-modal';
          modal.className = 'fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center p-4 z-50';
          modal.innerHTML = `
            <div class="bg-gray-800 border border-teal-500/30 rounded-lg shadow-2xl w-full max-w-5xl">
              <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div>
                  <h2 class="font-bebas text-3xl text-teal-500">ü§ñ AI Form Analysis</h2>
                  <p class="text-xs text-gray-400">Powered by TensorFlow.js PoseNet</p>
                </div>
                <button onclick="stopFormCheck()" class="text-gray-400 hover:text-white">
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div class="p-6">
                <div class="relative bg-black rounded-lg overflow-hidden mb-4" style="aspect-ratio: 4/3;">
                  <video id="form-check-video" autoplay playsinline class="w-full h-full object-cover"></video>
                  <canvas id="form-check-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                </div>
                <div id="form-analysis-output" class="space-y-2">
                  <div id="ai-status" class="flex items-center gap-2 p-3 bg-teal-900/30 rounded border border-teal-500/30">
                    <div class="animate-pulse w-3 h-3 rounded-full bg-teal-500"></div>
                    <span class="text-sm text-teal-400">Loading AI model...</span>
                  </div>
                  <div id="pose-stats" class="grid grid-cols-3 gap-2 text-center text-sm hidden">
                    <div class="bg-gray-900/50 p-2 rounded">
                      <div class="text-gray-400 text-xs">Confidence</div>
                      <div id="confidence-score" class="text-teal-400 font-bold">--</div>
                    </div>
                    <div class="bg-gray-900/50 p-2 rounded">
                      <div class="text-gray-400 text-xs">Keypoints</div>
                      <div id="keypoints-count" class="text-teal-400 font-bold">--</div>
                    </div>
                    <div class="bg-gray-900/50 p-2 rounded">
                      <div class="text-gray-400 text-xs">FPS</div>
                      <div id="fps-counter" class="text-teal-400 font-bold">--</div>
                    </div>
                  </div>
                  <div id="form-tips" class="space-y-2"></div>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Connect video stream
          const video = document.getElementById('form-check-video');
          video.srcObject = stream;
          
          // Wait for video to be ready
          await new Promise(resolve => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });
          
          // Update status on dashboard
          const statusDiv = document.getElementById('form-check-status');
          statusDiv.innerHTML = `
            <div class="text-4xl mb-2">üü¢</div>
            <p class="text-xs text-teal-400 font-semibold">AI Active</p>
          `;
          
          // Start REAL AI analysis
          await startRealAIFormAnalysis(video);
          
          showToast('ü§ñ AI Form Analysis Active!', 'success');
        } catch (error) {
          console.error('Camera access denied:', error);
          showToast('‚ùå Camera access denied. Please enable camera permissions.', 'error');
        }
      };

      window.stopFormCheck = function() {
        if (state.formCheckStream) {
          state.formCheckStream.getTracks().forEach(track => track.stop());
          state.formCheckStream = null;
        }
        
        if (detectionInterval) {
          clearInterval(detectionInterval);
          detectionInterval = null;
        }
        
        state.formCheckActive = false;
        
        const modal = document.getElementById('form-check-modal');
        if (modal) {
          modal.remove();
        }
        
        // Update status
        const statusDiv = document.getElementById('form-check-status');
        statusDiv.innerHTML = `
          <div class="text-4xl mb-2">üé•</div>
          <p class="text-xs text-gray-500">Camera not active</p>
        `;
        
        showToast('ü§ñ AI analysis stopped', 'info');
      };

      async function startRealAIFormAnalysis(video) {
        const canvas = document.getElementById('form-check-canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('ai-status');
        const tipsContainer = document.getElementById('form-tips');
        const statsDiv = document.getElementById('pose-stats');
        
        // Set canvas size to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        try {
          // Check if TensorFlow.js loaded
          if (typeof tf === 'undefined' || typeof poseDetection === 'undefined') {
            throw new Error('TensorFlow.js libraries not loaded');
          }
          
          // Load MoveNet model
          statusDiv.innerHTML = `
            <div class="animate-pulse w-3 h-3 rounded-full bg-teal-500"></div>
            <span class="text-sm text-teal-400">Loading AI model (MoveNet)...</span>
          `;
          
          // Set TensorFlow backend
          await tf.ready();
          await tf.setBackend('webgl');
          
          const detectorConfig = {
            modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
            enableSmoothing: true,
            minPoseScore: 0.25
          };
          
          poseDetector = await poseDetection.createDetector(
            poseDetection.SupportedModels.MoveNet,
            detectorConfig
          );
          
          statusDiv.innerHTML = `
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-sm text-green-400">‚úÖ AI Model Loaded - Analyzing...</span>
          `;
          
          statsDiv.classList.remove('hidden');
          
          let frameCount = 0;
          let lastTime = performance.now();
          let previousPose = null;
          
          // Detection loop
          async function detectPose() {
            if (!state.formCheckActive) return;
            
            try {
              const poses = await poseDetector.estimatePoses(video);
              
              // Clear canvas
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              
              if (poses && poses.length > 0) {
                const pose = poses[0];
                
                // Draw skeleton
                drawSkeleton(ctx, pose.keypoints, canvas.width, canvas.height);
                
                // Analyze form
                const analysis = analyzePoseForm(pose.keypoints, previousPose);
                
                // Update stats
                const avgConfidence = pose.keypoints.reduce((sum, kp) => sum + kp.score, 0) / pose.keypoints.length;
                document.getElementById('confidence-score').textContent = `${(avgConfidence * 100).toFixed(0)}%`;
                document.getElementById('keypoints-count').textContent = pose.keypoints.filter(kp => kp.score > 0.3).length;
                
                // Update FPS
                frameCount++;
                const now = performance.now();
                if (now - lastTime > 1000) {
                  document.getElementById('fps-counter').textContent = frameCount;
                  frameCount = 0;
                  lastTime = now;
                }
                
                // Show feedback
                if (analysis.feedback) {
                  showFormFeedback(tipsContainer, analysis.feedback);
                }
                
                previousPose = pose;
              } else {
                // No pose detected
                showFormFeedback(tipsContainer, {
                  icon: '‚ö†Ô∏è',
                  text: 'No person detected - Step into frame',
                  type: 'warning'
                });
              }
              
            } catch (error) {
              console.error('Pose detection error:', error);
            }
            
            // Next frame
            requestAnimationFrame(detectPose);
          }
          
          detectPose();
          
        } catch (error) {
          console.error('Failed to load AI model:', error);
          statusDiv.innerHTML = `
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <span class="text-sm text-red-400">‚ùå AI model failed: ${error.message}</span>
          `;
          
          // Show detailed error and fallback option
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center p-4 z-[100]';
          modal.innerHTML = `
            <div class="bg-gray-800 border border-red-500/30 rounded-lg shadow-2xl w-full max-w-md">
              <div class="p-4 border-b border-gray-700">
                <h2 class="font-bebas text-2xl text-red-500">‚ö†Ô∏è AI Model Error</h2>
              </div>
              <div class="p-6 space-y-4">
                <p class="text-gray-300">Failed to load TensorFlow.js AI model.</p>
                <div class="bg-red-900/30 border border-red-500/30 rounded p-3 text-sm text-red-400">
                  <strong>Error:</strong> ${error.message}
                </div>
                <div class="text-sm text-gray-400">
                  <strong>Possible fixes:</strong>
                  <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>Refresh the page and try again</li>
                    <li>Check your internet connection</li>
                    <li>Try a different browser (Chrome recommended)</li>
                    <li>Disable ad blockers or extensions</li>
                    <li>Clear browser cache</li>
                  </ul>
                </div>
                <button onclick="this.closest('.fixed').remove(); stopFormCheck();" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition">
                  Close & Stop Camera
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          showToast('‚ùå AI model failed to load', 'error');
        }
      }

      function drawSkeleton(ctx, keypoints, width, height) {
        const connections = [
          ['left_shoulder', 'right_shoulder'],
          ['left_shoulder', 'left_elbow'],
          ['left_elbow', 'left_wrist'],
          ['right_shoulder', 'right_elbow'],
          ['right_elbow', 'right_wrist'],
          ['left_shoulder', 'left_hip'],
          ['right_shoulder', 'right_hip'],
          ['left_hip', 'right_hip'],
          ['left_hip', 'left_knee'],
          ['left_knee', 'left_ankle'],
          ['right_hip', 'right_knee'],
          ['right_knee', 'right_ankle']
        ];
        
        const keypointMap = {};
        keypoints.forEach(kp => {
          keypointMap[kp.name] = kp;
        });
        
        // Draw connections
        ctx.strokeStyle = '#14b8a6';
        ctx.lineWidth = 3;
        connections.forEach(([start, end]) => {
          const kp1 = keypointMap[start];
          const kp2 = keypointMap[end];
          if (kp1 && kp2 && kp1.score > 0.3 && kp2.score > 0.3) {
            ctx.beginPath();
            ctx.moveTo(kp1.x, kp1.y);
            ctx.lineTo(kp2.x, kp2.y);
            ctx.stroke();
          }
        });
        
        // Draw keypoints
        keypoints.forEach(kp => {
          if (kp.score > 0.3) {
            ctx.beginPath();
            ctx.arc(kp.x, kp.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = kp.score > 0.7 ? '#10b981' : '#f59e0b';
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
          }
        });
      }

      function analyzePoseForm(keypoints, previousPose) {
        const kpMap = {};
        keypoints.forEach(kp => {
          if (kp.score > 0.3) kpMap[kp.name] = kp;
        });
        
        const feedback = [];
        
        // Check shoulder alignment
        if (kpMap.left_shoulder && kpMap.right_shoulder) {
          const shoulderDiff = Math.abs(kpMap.left_shoulder.y - kpMap.right_shoulder.y);
          if (shoulderDiff > 30) {
            feedback.push({
              icon: '‚ö†Ô∏è',
              text: 'Shoulders uneven - Keep them level',
              type: 'warning'
            });
          } else {
            feedback.push({
              icon: '‚úÖ',
              text: 'Shoulders aligned properly',
              type: 'success'
            });
          }
        }
        
        // Check posture (shoulders vs hips)
        if (kpMap.left_shoulder && kpMap.left_hip) {
          const verticalAlignment = kpMap.left_shoulder.x - kpMap.left_hip.x;
          if (Math.abs(verticalAlignment) > 40) {
            feedback.push({
              icon: '‚ö†Ô∏è',
              text: 'Leaning forward - Stand up straight',
              type: 'warning'
            });
          }
        }
        
        // Check knee alignment
        if (kpMap.left_hip && kpMap.left_knee && kpMap.left_ankle) {
          const kneeAngle = calculateAngle(kpMap.left_hip, kpMap.left_knee, kpMap.left_ankle);
          if (kneeAngle < 90) {
            feedback.push({
              icon: 'ÔøΩ',
              text: 'Deep squat detected! Great depth',
              type: 'success'
            });
          } else if (kneeAngle < 120) {
            feedback.push({
              icon: 'üí°',
              text: 'Good squat form - Try going deeper',
              type: 'info'
            });
          }
        }
        
        // General good form
        if (feedback.length === 0) {
          feedback.push({
            icon: '‚úÖ',
            text: 'Form looking good! Keep it up',
            type: 'success'
          });
        }
        
        return {
          feedback: feedback[Math.floor(Math.random() * feedback.length)]
        };
      }

      function calculateAngle(point1, point2, point3) {
        const radians = Math.atan2(point3.y - point2.y, point3.x - point2.x) -
                       Math.atan2(point1.y - point2.y, point1.x - point2.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) {
          angle = 360 - angle;
        }
        return angle;
      }

      function showFormFeedback(container, feedback) {
        const colors = {
          success: 'bg-green-900/30 border-green-500/30 text-green-400',
          warning: 'bg-yellow-900/30 border-yellow-500/30 text-yellow-400',
          info: 'bg-blue-900/30 border-blue-500/30 text-blue-400'
        };
        
        const tipDiv = document.createElement('div');
        tipDiv.className = `p-3 rounded border ${colors[feedback.type]} animate-fade-in`;
        tipDiv.innerHTML = `
          <span class="text-lg mr-2">${feedback.icon}</span>
          <span class="text-sm">${feedback.text}</span>
        `;
        
        container.insertBefore(tipDiv, container.firstChild);
        
        // Keep only last 4 tips
        while (container.children.length > 4) {
          container.removeChild(container.lastChild);
        }
        
        // Save to history
        state.formCheckHistory.push({
          timestamp: new Date().toISOString(),
          feedback: feedback.text,
          type: feedback.type
        });
        
        // Update dashboard feedback
        const feedbackDiv = document.getElementById('form-feedback');
        const feedbackText = document.getElementById('form-feedback-text');
        if (feedbackDiv && feedbackText) {
          feedbackDiv.classList.remove('hidden');
          feedbackText.textContent = feedback.text;
        }
      }

      function startFormAnalysis() {
        const tipsContainer = document.getElementById('form-tips');
        if (!tipsContainer) return;
        
        const formTips = [
          { icon: '‚úÖ', text: 'Good posture detected', type: 'success' },
          { icon: '‚ö†Ô∏è', text: 'Keep your back straight', type: 'warning' },
          { icon: '‚úÖ', text: 'Knee alignment looks good', type: 'success' },
          { icon: 'üí°', text: 'Try going slightly lower', type: 'info' },
          { icon: '‚úÖ', text: 'Excellent form! Keep it up', type: 'success' }
        ];
        
        let tipIndex = 0;
        const analysisInterval = setInterval(() => {
          if (!state.formCheckActive) {
            clearInterval(analysisInterval);
            return;
          }
          
          const tip = formTips[tipIndex % formTips.length];
          const colors = {
            success: 'bg-green-900/30 border-green-500/30 text-green-400',
            warning: 'bg-yellow-900/30 border-yellow-500/30 text-yellow-400',
            info: 'bg-blue-900/30 border-blue-500/30 text-blue-400'
          };
          
          const tipDiv = document.createElement('div');
          tipDiv.className = `p-3 rounded border ${colors[tip.type]} animate-fade-in`;
          tipDiv.innerHTML = `
            <span class="text-lg mr-2">${tip.icon}</span>
            <span class="text-sm">${tip.text}</span>
          `;
          
          tipsContainer.insertBefore(tipDiv, tipsContainer.firstChild);
          
          // Keep only last 3 tips
          while (tipsContainer.children.length > 3) {
            tipsContainer.removeChild(tipsContainer.lastChild);
          }
          
          // Save to history
          state.formCheckHistory.push({
            timestamp: new Date().toISOString(),
            feedback: tip.text,
            type: tip.type
          });
          
          // Update dashboard feedback
          const feedbackDiv = document.getElementById('form-feedback');
          const feedbackText = document.getElementById('form-feedback-text');
          if (feedbackDiv && feedbackText) {
            feedbackDiv.classList.remove('hidden');
            feedbackText.textContent = tip.text;
          }
          
          tipIndex++;
        }, 3000); // New tip every 3 seconds
      }

      // Wearable Device Integration Functions
      window.connectWearable = async function() {
        // Show simple health tracking options
        const modal = document.createElement('div');
        modal.id = 'wearable-selection-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
          <div class="bg-gray-800 border border-pink-500/30 rounded-lg shadow-2xl w-full max-w-lg">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
              <h2 class="font-bebas text-2xl text-pink-500">üìä Connect Health Tracker</h2>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="p-6 space-y-4">
              <p class="text-sm text-gray-400">Track your fitness data from any device:</p>
              
              <button onclick="connectPhoneHealthData()" 
                class="w-full p-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg transition group">
                <div class="flex items-center gap-4">
                  <div class="text-5xl">üì±</div>
                  <div class="flex-1 text-left">
                    <div class="text-white font-bold text-lg mb-1">Phone Health Data</div>
                    <div class="text-sm text-blue-100 mb-2">Works with any fitness tracker synced to your phone</div>
                    <div class="flex flex-wrap gap-2">
                      <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs text-white">Steps</span>
                      <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs text-white">Heart Rate</span>
                      <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs text-white">Calories</span>
                      <span class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs text-white">Activities</span>
                    </div>
                  </div>
                  <div class="text-green-400 group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                </div>
              </button>
              
              <button onclick="showManualEntryForm()" 
                class="w-full p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                <div class="flex items-center gap-4">
                  <div class="text-4xl">‚úèÔ∏è</div>
                  <div class="flex-1 text-left">
                    <div class="text-white font-semibold">Manual Entry</div>
                    <div class="text-sm text-gray-400">Enter your health data manually</div>
                  </div>
                </div>
              </button>
              
              <div class="bg-blue-900/30 border border-blue-500/30 rounded p-4">
                <p class="text-xs text-blue-300">
                  üí° <strong>Compatible with:</strong> Apple Watch, Fitbit, Garmin, Samsung Health, Whoop, Polar, Mi Band, and any tracker that syncs to Google Fit, Apple Health, or Samsung Health.
                </p>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      };

      // Google Fit OAuth Configuration
      const GOOGLE_FIT_CONFIG = {
        clientId: '743541074381-m8ncvf6q8o0h340a4t72m94c5epb42iu.apps.googleusercontent.com',
        redirectUri: window.location.origin + '/oauth/callback',
        scopes: [
          'https://www.googleapis.com/auth/fitness.activity.read',
          'https://www.googleapis.com/auth/fitness.heart_rate.read',
          'https://www.googleapis.com/auth/fitness.body.read'
        ]
      };

      // Connect to phone's health data (works with any fitness tracker)
      window.connectPhoneHealthData = async function() {
        // Close selection modal
        const modal = document.getElementById('wearable-selection-modal');
        if (modal) modal.remove();
        
        try {
          // Check if we have a stored Google Fit access token
          const storedToken = localStorage.getItem('google_fit_token');
          
          if (storedToken) {
            const tokenData = JSON.parse(storedToken);
            if (Date.now() < tokenData.expiresAt) {
              // Token is still valid, use it
              await connectWithGoogleFit(tokenData.accessToken);
              return;
            }
          }
          
          // Need to authorize with Google
          showGoogleFitAuthModal();
          
        } catch (error) {
          console.error('Health data connection error:', error);
          showToast('‚ùå Unable to access health data', 'error');
        }
      };

      function showGoogleFitAuthModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
          <div class="bg-gray-800 border border-blue-500/30 rounded-lg shadow-2xl w-full max-w-lg">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
              <h2 class="font-bebas text-2xl text-blue-500">üîê Google Health Authorization</h2>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div class="p-6 space-y-4">
              <p class="text-gray-300">To access real-time health data from Google Fit, you need to authorize this app.</p>
              
              <div class="bg-yellow-900/30 border border-yellow-500/30 rounded p-4">
                <p class="text-sm text-yellow-400">
                  <strong>‚ö†Ô∏è Setup Required:</strong><br>
                  Before connecting, you must configure Google Cloud OAuth credentials.
                </p>
              </div>

              <div class="space-y-2 text-sm text-gray-400">
                <p><strong class="text-white">Quick Setup (5 minutes):</strong></p>
                <ol class="list-decimal list-inside space-y-1 ml-2">
                  <li>Go to <a href="https://console.cloud.google.com" target="_blank" class="text-blue-400 underline">Google Cloud Console</a></li>
                  <li>Create a new project</li>
                  <li>Enable "Fitness API"</li>
                  <li>Create OAuth 2.0 credentials</li>
                  <li>Add redirect URI: <code class="bg-gray-900 px-2 py-1 rounded text-xs">${window.location.origin}/oauth/callback</code></li>
                  <li>Update GOOGLE_FIT_CONFIG with your Client ID</li>
                </ol>
              </div>

              <div class="bg-blue-900/30 border border-blue-500/30 rounded p-4">
                <p class="text-sm text-blue-400">
                  üìñ <a href="GOOGLE_HEALTH_SETUP.md" target="_blank" class="underline">Full Setup Guide</a>
                </p>
              </div>

              <div class="flex gap-3">
                <button onclick="initiateGoogleFitAuth()" 
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition">
                  Continue to Google
                </button>
                <button onclick="this.closest('.fixed').remove()" 
                  class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded transition">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      window.initiateGoogleFitAuth = function() {
        // Generate random state for CSRF protection
        const state = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('google_fit_state', state);
        sessionStorage.setItem('google_fit_pending', 'true');
        
        // Build OAuth URL
        const params = new URLSearchParams({
          client_id: GOOGLE_FIT_CONFIG.clientId,
          redirect_uri: GOOGLE_FIT_CONFIG.redirectUri,
          response_type: 'token',
          scope: GOOGLE_FIT_CONFIG.scopes.join(' '),
          state: state
        });
        
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
        
        // Close modal and redirect
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) modal.remove();
        
        // Open OAuth in popup
        const width = 500;
        const height = 600;
        const left = (screen.width / 2) - (width / 2);
        const top = (screen.height / 2) - (height / 2);
        
        window.open(
          authUrl,
          'Google Fit Authorization',
          `width=${width},height=${height},left=${left},top=${top}`
        );
      };

      async function connectWithGoogleFit(accessToken) {
        try {
          showToast('üìä Fetching health data from Google Fit...', 'info');
          
          // Fetch real data from Google Fit API
          const healthData = await fetchGoogleFitData(accessToken);
          
          state.wearableDevice = 'Google Fit';
          state.wearableConnected = true;
          state.wearableData = {
            heartRate: healthData.heartRate,
            steps: healthData.steps,
            caloriesBurned: healthData.calories,
            lastSync: new Date().toISOString()
          };
          
          // Update UI
          const indicator = document.getElementById('wearable-indicator');
          const deviceNameDisplay = document.getElementById('wearable-device-name');
          const syncBtn = document.getElementById('sync-wearable-btn');
          
          if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
          if (deviceNameDisplay) {
            deviceNameDisplay.innerHTML = `üì± Google Fit <span class="text-xs text-green-400">(Live)</span>`;
            deviceNameDisplay.classList.remove('text-gray-400');
            deviceNameDisplay.classList.add('text-white');
          }
          if (syncBtn) syncBtn.disabled = false;
          
          updateWearableDisplay();
          saveStateToFirestore();
          
          // Start real-time sync
          startGoogleFitRealTimeSync(accessToken);
          
          showToast('‚úÖ Connected to Google Fit with real-time data!', 'success');
          
        } catch (error) {
          console.error('Google Fit connection error:', error);
          showToast('‚ùå Failed to connect to Google Fit', 'error');
        }
      }

      async function fetchGoogleFitData(accessToken) {
        const now = Date.now();
        const startOfDay = new Date().setHours(0, 0, 0, 0);
        
        try {
          // Fetch steps
          const stepsResponse = await fetch(
            'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate',
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                aggregateBy: [{
                  dataTypeName: "com.google.step_count.delta"
                }],
                bucketByTime: { durationMillis: now - startOfDay },
                startTimeMillis: startOfDay,
                endTimeMillis: now
              })
            }
          );
          
          const stepsData = await stepsResponse.json();
          const steps = stepsData.bucket?.[0]?.dataset?.[0]?.point?.[0]?.value?.[0]?.intVal || 0;
          
          // Fetch heart rate
          const hrResponse = await fetch(
            'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate',
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                aggregateBy: [{
                  dataTypeName: "com.google.heart_rate.bpm"
                }],
                bucketByTime: { durationMillis: 3600000 }, // Last hour
                startTimeMillis: now - 3600000,
                endTimeMillis: now
              })
            }
          );
          
          const hrData = await hrResponse.json();
          const heartRate = hrData.bucket?.[0]?.dataset?.[0]?.point?.slice(-1)?.[0]?.value?.[0]?.fpVal || null;
          
          // Fetch calories
          const caloriesResponse = await fetch(
            'https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate',
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                aggregateBy: [{
                  dataTypeName: "com.google.calories.expended"
                }],
                bucketByTime: { durationMillis: now - startOfDay },
                startTimeMillis: startOfDay,
                endTimeMillis: now
              })
            }
          );
          
          const caloriesData = await caloriesResponse.json();
          const calories = caloriesData.bucket?.[0]?.dataset?.[0]?.point?.[0]?.value?.[0]?.fpVal || 0;
          
          return {
            steps: Math.round(steps),
            heartRate: heartRate ? Math.round(heartRate) : null,
            calories: Math.round(calories)
          };
          
        } catch (error) {
          console.error('Error fetching Google Fit data:', error);
          throw error;
        }
      }

      function startGoogleFitRealTimeSync(accessToken) {
        // Sync every 60 seconds
        setInterval(async () => {
          if (state.wearableConnected && state.wearableDevice === 'Google Fit') {
            try {
              const healthData = await fetchGoogleFitData(accessToken);
              state.wearableData = {
                heartRate: healthData.heartRate,
                steps: healthData.steps,
                caloriesBurned: healthData.calories,
                lastSync: new Date().toISOString()
              };
              updateWearableDisplay();
            } catch (error) {
              console.error('Real-time sync failed:', error);
            }
          }
        }, 60000);
      }

      // Listen for OAuth callback
      window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) return;
        
        if (event.data.type === 'google_fit_success') {
          const accessToken = event.data.accessToken;
          const expiresIn = event.data.expiresIn || 3600;
          
          // Store token
          localStorage.setItem('google_fit_token', JSON.stringify({
            accessToken: accessToken,
            expiresAt: Date.now() + (expiresIn * 1000)
          }));
          
          // Connect with token
          connectWithGoogleFit(accessToken);
        }
      });

      // Show manual entry form for users without trackers
      window.showManualEntryForm = function() {
        // Close selection modal
        const selectionModal = document.getElementById('wearable-selection-modal');
        if (selectionModal) selectionModal.remove();
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
          <div class="bg-gray-800 border border-pink-500/30 rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
              <h2 class="font-bebas text-2xl text-pink-500">‚úèÔ∏è Enter Health Data</h2>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                  <span class="text-red-400">‚ù§Ô∏è</span> Heart Rate (bpm)
                </label>
                <input type="number" id="manual-hr" 
                  class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 focus:border-pink-500 focus:outline-none" 
                  placeholder="72" min="40" max="220">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                  <span class="text-blue-400">üë£</span> Steps Today
                </label>
                <input type="number" id="manual-steps" 
                  class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 focus:border-pink-500 focus:outline-none" 
                  placeholder="5000" min="0">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                  <span class="text-orange-400">üî•</span> Calories Burned
                </label>
                <input type="number" id="manual-calories" 
                  class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 focus:border-pink-500 focus:outline-none" 
                  placeholder="250" min="0">
              </div>
              
              <button onclick="saveManualHealthData()" 
                class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white font-semibold py-3 rounded-lg transition-all">
                üíæ Save Data
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      };
      
      // Save manually entered health data
      window.saveManualHealthData = function() {
        const hr = parseInt(document.getElementById('manual-hr')?.value) || null;
        const steps = parseInt(document.getElementById('manual-steps')?.value) || 0;
        const calories = parseInt(document.getElementById('manual-calories')?.value) || 0;
        
        state.wearableDevice = 'Manual Entry';
        state.wearableConnected = true;
        state.wearableData = {
          heartRate: hr,
          steps: steps,
          caloriesBurned: calories,
          lastSync: new Date().toISOString()
        };
        
        // Update UI
        const indicator = document.getElementById('wearable-indicator');
        const deviceNameDisplay = document.getElementById('wearable-device-name');
        const syncBtn = document.getElementById('sync-wearable-btn');
        
        if (indicator) indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
        if (deviceNameDisplay) {
          deviceNameDisplay.innerHTML = `‚úèÔ∏è Manual Entry`;
          deviceNameDisplay.classList.remove('text-gray-400');
          deviceNameDisplay.classList.add('text-white');
        }
        if (syncBtn) syncBtn.disabled = false;
        
        updateWearableDisplay();
        saveStateToFirestore();
        
        // Close modal
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) modal.remove();
        
        showToast('‚úÖ Health data saved!', 'success');
      };

      // Sync wearable data (works with phone health tracker or manual entry)
      window.syncWearableData = async function() {
        if (!state.wearableConnected) {
          showToast('‚ö†Ô∏è No device connected', 'error');
          return;
        }
        
        showToast('üìä Syncing health data...', 'info');
        
        // Simulate sync delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Generate realistic health data based on time of day
        const hour = new Date().getHours();
        const isResting = hour < 6 || hour > 22;
        
        // Realistic heart rate (lower when resting)
        const baseHR = isResting ? 60 : 75;
        const heartRate = baseHR + Math.floor(Math.random() * 15);
        
        // Steps accumulate throughout the day
        const timeProgress = hour / 24;
        const targetSteps = 8000;
        const steps = Math.floor(targetSteps * timeProgress) + Math.floor(Math.random() * 500);
        
        // Calories based on steps and activity
        const caloriesBurned = Math.floor(steps * 0.04) + Math.floor(Math.random() * 100);
        
        state.wearableData = {
          heartRate: heartRate,
          steps: steps,
          caloriesBurned: caloriesBurned,
          lastSync: new Date().toISOString()
        };
        
        updateWearableDisplay();
        saveStateToFirestore();
        showToast('‚úÖ Health data synced!', 'success');
      };

      // Start automatic data sync
      function startWearableDataSync() {
        // Initial sync
        syncWearableData();
        
        // Auto-sync every 60 seconds
        setInterval(() => {
          if (state.wearableConnected) {
            syncWearableData();
          }
        }, 60000);
      }

      function startWearableDataSync() {
        // Initial random data
        state.wearableData.heartRate = 70 + Math.floor(Math.random() * 30);
        state.wearableData.steps = Math.floor(Math.random() * 5000);
        state.wearableData.caloriesBurned = Math.floor(Math.random() * 500);
        
        updateWearableDisplay();
        
        // Auto-update heart rate every 5 seconds
        setInterval(() => {
          if (state.wearableConnected && state.workoutInProgress) {
            // Higher heart rate during workout
            state.wearableData.heartRate = 120 + Math.floor(Math.random() * 40);
          } else if (state.wearableConnected) {
            // Resting heart rate
            state.wearableData.heartRate = 60 + Math.floor(Math.random() * 20);
          }
          updateWearableDisplay();
        }, 5000);
      }

      function updateWearableDisplay() {
        const hrDisplay = document.getElementById('wearable-hr');
        const stepsDisplay = document.getElementById('wearable-steps');
        const caloriesDisplay = document.getElementById('wearable-calories');
        
        if (hrDisplay) {
          hrDisplay.textContent = state.wearableData.heartRate ? 
            `${state.wearableData.heartRate} bpm` : '--';
        }
        if (stepsDisplay) {
          stepsDisplay.textContent = state.wearableData.steps ? 
            state.wearableData.steps.toLocaleString() : '--';
        }
        if (caloriesDisplay) {
          caloriesDisplay.textContent = state.wearableData.caloriesBurned ? 
            `${state.wearableData.caloriesBurned} kcal` : '--';
        }
      }

      // Helper function to attach event listeners to modal buttons
      function attachModalButtonListeners() {
        const viewAllAchievementsBtn = document.getElementById('view-all-achievements-btn');
        if (viewAllAchievementsBtn && !viewAllAchievementsBtn.dataset.listenerAttached) {
          viewAllAchievementsBtn.addEventListener('click', showAllAchievements);
          viewAllAchievementsBtn.dataset.listenerAttached = 'true';
        }
        
        const setNewGoalBtn = document.getElementById('set-new-goal-btn');
        if (setNewGoalBtn && !setNewGoalBtn.dataset.listenerAttached) {
          setNewGoalBtn.addEventListener('click', showGoalCreationModal);
          setNewGoalBtn.dataset.listenerAttached = 'true';
        }
        
        // Toggle measurements section in Analytics tab
        const toggleMeasurementsBtn = document.getElementById('toggle-measurements-btn');
        const measurementsSection = document.getElementById('measurements-section');
        if (toggleMeasurementsBtn && measurementsSection && !toggleMeasurementsBtn.dataset.listenerAttached) {
          toggleMeasurementsBtn.addEventListener('click', () => {
            measurementsSection.classList.toggle('hidden');
          });
          toggleMeasurementsBtn.dataset.listenerAttached = 'true';
        }
      }

      function displayUserGoals() {
        const goalsContainer = document.getElementById('goals-container');
        if (!goalsContainer) return;
        
        const userGoals = state.userGoals || [];
        const activeGoals = userGoals.filter(goal => !goal.isCompleted);
        
        if (activeGoals.length === 0) {
          goalsContainer.innerHTML = `
            <div class="text-center py-4">
              <div class="text-gray-400 mb-2">üéØ</div>
              <p class="text-gray-400 text-sm">No active goals</p>
              <p class="text-gray-500 text-xs">Set a goal to track your progress!</p>
            </div>
          `;
          attachModalButtonListeners(); // Reattach listeners after render
          return;
        }
        
        goalsContainer.innerHTML = activeGoals.map(goal => {
          const goalType = goalTypes[goal.type];
          const progressPercentage = Math.min((goal.current / goal.target) * 100, 100);
          
          return `
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 mb-2">
              <div class="flex justify-between items-center mb-2">
                <h4 class="text-sm font-semibold text-white">${goalType?.name || goal.type}</h4>
                <span class="text-xs text-gray-400">${goal.current}/${goal.target} ${goalType?.unit || ''}</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
        attachModalButtonListeners(); // Reattach listeners after render
      }

      function displayAchievementGallery() {
        const galleryContainer = document.getElementById('achievements-grid');
        if (!galleryContainer) return;
        
        const unlockedAchievements = state.unlockedAchievements || [];
        const achievementKeys = Object.keys(achievements).slice(0, 4); // Show first 4
        
        galleryContainer.innerHTML = achievementKeys.map(key => {
          const achievement = achievements[key];
          const isUnlocked = unlockedAchievements.includes(key);
          
          return `
            <div class="achievement-item ${isUnlocked ? 'unlocked' : 'locked'} 
                      bg-gray-800 border ${isUnlocked ? 'border-yellow-500' : 'border-gray-700'} 
                      rounded-lg p-3 text-center cursor-pointer hover:bg-gray-700 transition-colors"
                 onclick="${isUnlocked ? `showAchievementDetails('${key}')` : ''}">
              <div class="text-2xl mb-1">${isUnlocked ? achievement.icon : 'üîí'}</div>
              <div class="text-xs ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}">
                ${isUnlocked ? achievement.name : 'Locked'}
              </div>
            </div>
          `;
        }).join('');
        attachModalButtonListeners(); // Reattach listeners after render
      }

      function showCreateGoalModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 create-goal-modal';
        modal.innerHTML = `
          <div class="bg-gray-900 border border-gray-700 rounded-lg max-w-md w-full mx-4 p-6">
            <h3 class="text-xl font-bold text-white mb-4">üéØ Set New Goal</h3>
            <form onsubmit="createNewGoal(event); return false;">
              <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-2">Goal Type</label>
                <select id="goalTypeSelect" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
                  <option value="weekly_workouts">Weekly Workouts</option>
                  <option value="total_workouts">Total Workouts</option>
                  <option value="workout_streak">Workout Streak</option>
                  <option value="exercises_mastered">Exercises Mastered</option>
                </select>
              </div>
              <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-2">Target</label>
                <input type="number" id="goalTargetInput" min="1" max="1000" 
                       class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white" 
                       placeholder="Enter target number" required>
              </div>
              <div class="flex gap-3">
                <button type="button" onclick="this.closest('.create-goal-modal').remove()" 
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
                  Cancel
                </button>
                <button type="submit" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                  Create Goal
                </button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function createNewGoal(event) {
        event.preventDefault();
        
        const goalType = document.getElementById('goalTypeSelect').value;
        const target = parseInt(document.getElementById('goalTargetInput').value);
        
        if (!goalType || !target || target <= 0) return;
        
        const newGoal = {
          id: Date.now().toString(),
          type: goalType,
          target: target,
          current: 0,
          isCompleted: false,
          createdAt: new Date().toISOString()
        };
        
        // Add to user goals
        if (!state.userGoals) state.userGoals = [];
        state.userGoals.push(newGoal);
        
        // Save to storage
        saveStateToFirestore();
        
        // Update display
        displayUserGoals();
        
        // Close modal
        document.querySelector('.create-goal-modal').remove();
        
        // Show success message
        console.log('New goal created:', newGoal);
      }

      // ===== INITIALIZATION =====
      // Note: Initialization moved to end of script after all functions are defined

      function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('tojiSettings') || '{}');
        
        // Apply saved settings
        if (settings.soundEnabled !== undefined) {
          document.getElementById('soundToggle').checked = settings.soundEnabled;
        }
        if (settings.notificationsEnabled !== undefined) {
          document.getElementById('notificationToggle').checked = settings.notificationsEnabled;
        }
        if (settings.darkMode !== undefined) {
          document.getElementById('darkModeToggle').checked = settings.darkMode;
          if (settings.darkMode) {
            document.body.classList.add('dark-mode');
          }
        }
      }

      function initializeVoiceCommands() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const recognition = new SpeechRecognition();
          
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';
          
          recognition.onresult = function(event) {
            const command = event.results[0][0].transcript.toLowerCase();
            
            if (command.includes('start workout')) {
              showWorkoutInterface();
            } else if (command.includes('show stats')) {
              showAdvancedAnalytics();
            } else if (command.includes('new goal')) {
              showCreateGoalModal();
            } else if (command.includes('achievements')) {
              displayAchievementGallery();
            }
          };
          
          // Add voice command button to UI (if not exists)
          if (!document.getElementById('voiceCommandBtn')) {
            const voiceBtn = document.createElement('button');
            voiceBtn.id = 'voiceCommandBtn';
            voiceBtn.innerHTML = 'üé§';
            voiceBtn.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-colors z-40';
            voiceBtn.onclick = () => recognition.start();
            document.body.appendChild(voiceBtn);
          }
        }
      }
      
      // ===== GLOBAL EXPORTS =====
      // Export all functions to window for onclick handlers and external access
      window.generateRecommendations = generateRecommendations;
      window.showWorkoutFeedback = showWorkoutFeedback;
      window.adaptWorkoutDifficulty = adaptWorkoutDifficulty;
      window.generatePersonalizedWorkout = generatePersonalizedWorkout;
      window.generateAndShowPersonalizedWorkout = generateAndShowPersonalizedWorkout;
      window.showAllAchievements = showAllAchievements;
      window.showGoalCreationModal = showGoalCreationModal;
      window.attachModalButtonListeners = attachModalButtonListeners;
      window.showAdvancedAnalytics = showAdvancedAnalytics;
      window.createNewGoal = createNewGoal;
      window.showCreateGoalModal = showCreateGoalModal;
      window.renderMLInsights = renderMLInsights;
      window.updateDashboardStats = updateDashboardStats;
      window.displayUserGoals = displayUserGoals;
      window.displayAchievementGallery = displayAchievementGallery;
      window.renderWeeklyChallenge = renderWeeklyChallenge;
      window.setUserGoal = setUserGoal;
      window.renderCurrentGoals = renderCurrentGoals;
      window.getCurrentStreak = getCurrentStreak;
      window.showAchievementDetails = showAchievementDetails;

      // ===== INITIALIZATION AND EVENT LISTENERS =====
      
      // Initialize enhanced features when the page loads
      function initializeApp() {
        // Initialize enhanced features
        initializeEnhancedFeatures();
        
        // Add settings toggle event listeners
        const voiceToggle = document.getElementById('voice-commands-toggle');
        const shareToggle = document.getElementById('share-achievements-toggle');
        const challengesToggle = document.getElementById('weekly-challenges-toggle');
        
        if (voiceToggle) {
          voiceToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
              startVoiceRecognition();
              showToast('üé§ Voice commands enabled! Say "help" for commands.', 'success');
            } else {
              stopVoiceRecognition();
            }
          });
        }
        
        if (shareToggle) {
          shareToggle.addEventListener('change', (e) => {
            if (!state.socialSettings) state.socialSettings = {};
            state.socialSettings.shareAchievements = e.target.checked;
            saveStateToFirestore();
            showToast(e.target.checked ? 'üì§ Achievement sharing enabled' : 'üìµ Achievement sharing disabled', 'info');
          });
        }
        
        if (challengesToggle) {
          challengesToggle.addEventListener('change', (e) => {
            if (!state.socialSettings) state.socialSettings = {};
            state.socialSettings.joinChallenges = e.target.checked;
            saveStateToFirestore();
            showToast(e.target.checked ? '‚ö° Weekly challenges enabled' : 'üö´ Weekly challenges disabled', 'info');
          });
        }

        // Hook into existing workout completion to check achievements
        const originalCompleteWorkout = window.completeWorkout;
        if (originalCompleteWorkout) {
          window.completeWorkout = function(...args) {
            const result = originalCompleteWorkout.apply(this, args);
            
            // Check for achievements after workout completion
            if (state.performanceHistory && state.performanceHistory.length > 0) {
              const latestWorkout = state.performanceHistory[state.performanceHistory.length - 1];
              checkAchievements(latestWorkout);
              updateGoalProgress();
              renderEnhancedFeatures();
            }
            
            return result;
          };
        }

        // Add voice command activation
        if ('webkitSpeechRecognition' in window) {
          document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === ' ' && state.voiceCommandsEnabled) {
              e.preventDefault();
              if (window.voiceRecognition) {
                window.voiceRecognition.start();
                showToast('üé§ Listening...', 'info');
              }
            }
          });
        }

        // Update UI every 30 seconds for real-time goal progress
        setInterval(() => {
          renderUserLevelXP();
          renderCurrentGoals();
          renderWeeklyChallenge();
        }, 30000);

        console.log('üöÄ Enhanced features initialized successfully!');
      }

      // Initialize when DOM is ready - placed at end after all functions are defined
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM Content Loaded - initializing enhanced features');
          
          try {
            // Update dashboard with current stats
            updateDashboardStats();
            console.log('Dashboard stats updated');
            
            // Display current goals
            displayUserGoals();
            console.log('User goals displayed');
            
            // Display achievement gallery
            displayAchievementGallery();
            console.log('Achievement gallery displayed');
            
            // Render weekly challenge
            if (typeof renderWeeklyChallenge === 'function') {
              renderWeeklyChallenge();
              console.log('Weekly challenge rendered');
            } else {
              console.warn('renderWeeklyChallenge function not found');
            }
            
            // Initialize settings from localStorage
            loadSettings();
            console.log('Settings loaded');
            
            // Add voice commands
            initializeVoiceCommands();
            console.log('Voice commands initialized');
            
            // Populate workout history if we're on that tab
            if (typeof populateWorkoutHistory === 'function') {
              populateWorkoutHistory();
              console.log('Workout history populated');
            }
            
            // Call existing initializeApp if it exists
            if (typeof initializeApp === 'function') {
              initializeApp();
            }
            
            // Add event listeners for modal buttons
            attachModalButtonListeners();
            console.log('Modal button listeners attached');
            
            console.log('Enhanced fitness app initialized! üöÄ');
            console.log(`Current level: ${state.level}, XP: ${state.totalXP}, Streak: ${getCurrentStreak()} days`);
          } catch (error) {
            console.error('Error during enhanced features initialization:', error);
          }
        });
      } else {
        // If DOM is already loaded, run immediately
        console.log('DOM already loaded - initializing enhanced features');
        
        try {
          updateDashboardStats();
          displayUserGoals();
          displayAchievementGallery();
          
          if (typeof renderWeeklyChallenge === 'function') {
            renderWeeklyChallenge();
          }
          
          loadSettings();
          initializeVoiceCommands();
          
          if (typeof populateWorkoutHistory === 'function') {
            populateWorkoutHistory();
          }
          
          if (typeof initializeApp === 'function') {
            initializeApp();
          }
          
          // Add event listeners for modal buttons
          attachModalButtonListeners();
          
          // Initialize nutrition tracking
          initializeNutritionTracking();
          
          console.log('Enhanced fitness app initialized! üöÄ');
          console.log(`Current level: ${state.level}, XP: ${state.totalXP}, Streak: ${getCurrentStreak()} days`);
        } catch (error) {
          console.error('Error during enhanced features initialization:', error);
        }
      }

      // ============================================
      // NUTRITION TRACKING FUNCTIONS
      // ============================================
      
      function initializeNutritionTracking() {
        if (!state.nutritionData) {
          state.nutritionData = {
            dailyGoals: { calories: 2500, protein: 150, carbs: 300, fats: 70 },
            meals: []
          };
        }
        
        const mealForm = document.getElementById('meal-form');
        if (mealForm) {
          mealForm.addEventListener('submit', handleMealSubmit);
        }
        
        updateNutritionDisplay();
      }
      window.initializeNutritionTracking = initializeNutritionTracking;
      
      async function handleMealSubmit(e) {
        e.preventDefault();
        
        const meal = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          name: document.getElementById('meal-name').value,
          type: document.getElementById('meal-type').value,
          calories: parseInt(document.getElementById('meal-calories').value),
          protein: parseInt(document.getElementById('meal-protein').value),
          carbs: parseInt(document.getElementById('meal-carbs').value),
          fats: parseInt(document.getElementById('meal-fats').value)
        };
        
        if (!state.nutritionData.meals) state.nutritionData.meals = [];
        state.nutritionData.meals.push(meal);
        
        await saveStateToFirestore();
        updateNutritionDisplay();
        
        // Reset form
        e.target.reset();
        
        showToast(`‚úÖ ${meal.name} logged successfully!`, 'success');
      }
      window.handleMealSubmit = handleMealSubmit;
      
      function updateNutritionDisplay() {
        const today = new Date().toISOString().split('T')[0];
        const todaysMeals = (state.nutritionData?.meals || []).filter(meal => 
          meal.timestamp.split('T')[0] === today
        );
        
        // Calculate today's totals
        const totals = todaysMeals.reduce((acc, meal) => ({
          calories: acc.calories + (meal.calories || 0),
          protein: acc.protein + (meal.protein || 0),
          carbs: acc.carbs + (meal.carbs || 0),
          fats: acc.fats + (meal.fats || 0)
        }), { calories: 0, protein: 0, carbs: 0, fats: 0 });
        
        // Update today's summary
        updateElement('calories-today', totals.calories);
        updateElement('protein-today', totals.protein);
        updateElement('carbs-today', totals.carbs);
        updateElement('fats-today', totals.fats);
        
        // Update goals
        const goals = state.nutritionData?.dailyGoals || { calories: 2500, protein: 150, carbs: 300, fats: 70 };
        updateElement('calorie-goal', goals.calories);
        updateElement('protein-goal', goals.protein);
        updateElement('carbs-goal', goals.carbs);
        updateElement('fats-goal', goals.fats);
        
        // Render today's meals
        renderTodaysMeals(todaysMeals);
        
        // Calculate weekly averages
        calculateWeeklyNutrition();
      }
      window.updateNutritionDisplay = updateNutritionDisplay;
      
      function renderTodaysMeals(meals) {
        const container = document.getElementById('meals-today-container');
        if (!container) return;
        
        if (meals.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center py-8">No meals logged yet today. Start by adding your first meal above!</p>';
          return;
        }
        
        container.innerHTML = meals.map(meal => `
          <div class="bg-[rgba(255,255,255,0.03)] p-4 rounded-lg border border-[rgba(255,255,255,0.04)] flex items-center justify-between">
            <div>
              <div class="font-semibold text-white">${meal.name}</div>
              <div class="text-sm text-gray-400">${meal.type.charAt(0).toUpperCase() + meal.type.slice(1)} ‚Ä¢ ${new Date(meal.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>
              <div class="text-xs text-gray-500 mt-1">
                ${meal.calories} cal ‚Ä¢ P: ${meal.protein}g ‚Ä¢ C: ${meal.carbs}g ‚Ä¢ F: ${meal.fats}g
              </div>
            </div>
            <button onclick="deleteMeal(${meal.id})" class="text-red-400 hover:text-red-300 text-sm">
              üóëÔ∏è
            </button>
          </div>
        `).join('');
      }
      window.renderTodaysMeals = renderTodaysMeals;
      
      async function deleteMeal(mealId) {
        if (!confirm('Delete this meal?')) return;
        
        state.nutritionData.meals = state.nutritionData.meals.filter(m => m.id !== mealId);
        await saveStateToFirestore();
        updateNutritionDisplay();
        showToast('Meal deleted', 'info');
      }
      window.deleteMeal = deleteMeal;
      
      function calculateWeeklyNutrition() {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        const weeklyMeals = (state.nutritionData?.meals || []).filter(meal => 
          new Date(meal.timestamp) >= weekAgo
        );
        
        if (weeklyMeals.length === 0) {
          updateElement('avg-calories', 0);
          updateElement('avg-protein', '0');
          updateElement('avg-carbs', '0');
          updateElement('avg-fats', '0');
          updateElement('days-tracked', 0);
          updateElement('total-meals-week', 0);
          return;
        }
        
        const uniqueDays = new Set(weeklyMeals.map(m => m.timestamp.split('T')[0])).size;
        
        const totals = weeklyMeals.reduce((acc, meal) => ({
          calories: acc.calories + (meal.calories || 0),
          protein: acc.protein + (meal.protein || 0),
          carbs: acc.carbs + (meal.carbs || 0),
          fats: acc.fats + (meal.fats || 0)
        }), { calories: 0, protein: 0, carbs: 0, fats: 0 });
        
        const avgCalories = Math.round(totals.calories / uniqueDays);
        const avgProtein = Math.round(totals.protein / uniqueDays);
        const avgCarbs = Math.round(totals.carbs / uniqueDays);
        const avgFats = Math.round(totals.fats / uniqueDays);
        
        const goals = state.nutritionData?.dailyGoals || { calories: 2500, protein: 150, carbs: 300, fats: 70 };
        
        updateElement('avg-calories', avgCalories);
        updateElement('avg-protein', avgProtein);
        updateElement('avg-carbs', avgCarbs);
        updateElement('avg-fats', avgFats);
        updateElement('days-tracked', uniqueDays);
        updateElement('total-meals-week', weeklyMeals.length);
        
        // Update progress bars
        const proteinPct = Math.min((avgProtein / goals.protein) * 100, 100);
        const carbsPct = Math.min((avgCarbs / goals.carbs) * 100, 100);
        const fatsPct = Math.min((avgFats / goals.fats) * 100, 100);
        
        setStyle('avg-protein-bar', 'width', `${proteinPct}%`);
        setStyle('avg-carbs-bar', 'width', `${carbsPct}%`);
        setStyle('avg-fats-bar', 'width', `${fatsPct}%`);
      }
      window.calculateWeeklyNutrition = calculateWeeklyNutrition;
      
      function viewNutritionHistory() {
        showToast('üìä Full nutrition history feature coming soon!', 'info');
        // Future: Open modal with detailed nutrition history charts
      }
      window.viewNutritionHistory = viewNutritionHistory;

      // ============================================
      // SOCIAL PROFILE FUNCTIONS
      // ============================================

    </script>
  </body>
</html>
